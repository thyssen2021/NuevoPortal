@model List<Portal_2_0.Controllers.CountryToggleViewModel>
@{
    ViewBag.Title = "Manage Countries";
    ViewBag.PrimerNivel = "ctz_catalogs";
    ViewBag.SegundoNivel = "ctz_countries";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";
}

@section estilos {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

    <style>
        .dataTables_wrapper .dataTables_filter input {
            width: 200px;
        }
        /* ajustar checboxes */
        .dt-center {
            text-align: center;
        }
    </style>
}

<div class="right_col" role="main">
    <div class="x_panel">
        <div class="x_title">
            <h2>@ViewBag.Title</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">

            @using (Html.BeginForm("CTZ_countries", "CTZ_Catalogs", FormMethod.Post, new { id = "countriesForm" }))
            {
                @Html.AntiForgeryToken()
                <table id="countriesTable" class="display table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th class="dt-center">ID</th>
                            <th>Code</th>
                            <th>Name</th>
                            <th class="dt-center">Active</th>
                            <th class="dt-center">Warning</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model)
                        {
                            <tr>
                                <td class="dt-center">
                                    @c.ID_Country
                                    <input type="hidden" class="country-id" value="@c.ID_Country" />
                                </td>
                                <td>@c.ISO3</td>
                                <td>@c.Nicename</td>
                                <td class="dt-center">
                                    <input type="checkbox" class="active-chk" @(c.Active ? "checked" : "") />
                                </td>
                                <td class="dt-center">
                                    <input type="checkbox" class="warning-chk" @(c.Warning ? "checked" : "") />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @* contendrá el JSON de todos los países *@
                <input type="hidden" id="countriesJson" name="countriesJson" />

                <button type="submit" id="saveBtn" class="btn btn-primary mt-2">
                    <i class="fa fa-save"></i> Save All
                </button>
            }
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables, Select2 y Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

    <script>
    $(document).ready(function() {
      // Inicializa Toastr
      toastr.options = {
        closeButton: true,
        positionClass: "toast-top-right",
        timeOut: "3000"
      };
      // Mensaje de éxito
      @if (TempData["Success"] != null) {
        <text>toastr.success("@TempData["Success"]");</text>
      }

      // Inicializa DataTable
      var table = $("#countriesTable").DataTable({
        paging:   true,
        searching:true,
        order:    [[0, "asc"]],
        columnDefs: [
          { orderable: false, targets: [3,4] },
          { className: "dt-center", targets: [0,3,4] }
        ]
      });

      // En el submit, construimos el JSON de **todas** las filas
      $("#countriesForm").on("submit", function() {
        var data = [];
        // `rows().nodes()` obtiene todos los TR (incluso en páginas ocultas)
        table.rows().nodes().to$().each(function() {
          var $r = $(this);
          data.push({
            ID_Country: parseInt( $r.find(".country-id").val() ),
            Active:     $r.find(".active-chk").prop("checked"),
            Warning:    $r.find(".warning-chk").prop("checked")
          });
        });
        $("#countriesJson").val(JSON.stringify(data));
      });
    });
    </script>
}


@{
    ViewBag.Title = "Manage Shifts by Plant";
    ViewBag.PrimerNivel = "cotizador";
    ViewBag.SegundoNivel = "ctz_catalogs";
    ViewBag.TercerNivel = "ctz_catalogs_data_management"; // Breadcrumb
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    bool canEdit = ViewBag.CanEdit as bool? ?? false;
}

@section estilos
{
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet" />

    <style>
        .handsontable-container {
            margin-top: 20px;
        }

        /* Encabezados de Handsontable con fondo corporativo */
        .handsontable .ht_clone_top thead th {
            background-color: #009ff5 !important;
            color: #ffffff !important;
            font-weight: bold;
        }
    </style>
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <p>Select a plant to view or edit the percentage distribution for each shift. The total percentage for all shifts must equal 100%.</p>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="plantSelect">Select Plant</label>
                                    <select id="plantSelect" class="form-control select2">
                                        <option value="">Select a plant...</option>
                                        <option value="Puebla">Puebla</option>
                                        <option value="Silao">Silao</option>
                                        <option value="San Luis Potosi">San Luis Potosi</option>
                                        <option value="Saltillo">Saltillo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="shiftsGridContainer" class="handsontable-container" style="display: none;">
                            <div id="shiftsGrid"></div>
                            <div class="mt-3">
                                @if (canEdit)
                                {
                                    <button id="saveButton" class="btn btn-success">
                                        <i class="fa fa-save"></i> Save Changes
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    @Scripts.Render(Url.Content("~/Content/vendors/sweetalert2/sweetalert2.min.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        $(document).ready(function () {

            $(".select2").select2({ width: '100%' });

            let hotInstance;
            const container = document.getElementById('shiftsGrid');
            const canEdit = @canEdit.ToString().ToLower();

            const shiftData = {
                "Puebla": [
                    { shift: "Shift 1", percentage: 85.00 },
                    { shift: "Shift 2", percentage: 15.00 },
                    { shift: "Shift 3", percentage: 0.00 },
                    { shift: "Shift 4", percentage: 0.00 }
                ],
                "Silao": [
                    { shift: "Shift 1", percentage: 100.00 },
                    { shift: "Shift 2", percentage: 0.00 },
                    { shift: "Shift 3", percentage: 0.00 },
                    { shift: "Shift 4", percentage: 0.00 }
                ],
                "San Luis Potosi": [
                    { shift: "Shift 1", percentage: 50.00 },
                    { shift: "Shift 2", percentage: 50.00 },
                    { shift: "Shift 3", percentage: 0.00 },
                    { shift: "Shift 4", percentage: 0.00 }
                ],
                "Saltillo": [
                    { shift: "Shift 1", percentage: 100.00 },
                    { shift: "Shift 2", percentage: 0.00 },
                    { shift: "Shift 3", percentage: 0.00 },
                    { shift: "Shift 4", percentage: 0.00 }
                ]
            };

            $('#plantSelect').on('change', function () {
                const selectedPlant = $(this).val();

                if (selectedPlant) {

                    // --- INICIO DE LA MODIFICACIÓN 1: Preparar datos con la columna Planta ---
                    // Tomamos los datos base para la planta seleccionada
                    const baseData = shiftData[selectedPlant];
                    // Creamos un nuevo arreglo de datos agregando el nombre de la planta a cada fila
                    const dataForTable = baseData.map(row => ({
                        plantName: selectedPlant,
                        shift: row.shift,
                        percentage: row.percentage
                    }));
                    // --- FIN DE LA MODIFICACIÓN 1 ---

                    if (!hotInstance) {
                        const settings = {
                            data: dataForTable,
                            // --- INICIO DE LA MODIFICACIÓN 2: Configuración de la tabla ---
                            colHeaders: ['Plant', 'Shift', 'Percentage (%)'],
                            columns: [
                                { data: 'plantName', readOnly: true },
                                { data: 'shift', readOnly: true },
                                {
                                    data: 'percentage',
                                    type: 'numeric',
                                    numericFormat: { pattern: '0.00' },
                                    validator: (value, callback) => callback(value >= 0 && value <= 100),
                                    readOnly: !canEdit
                                }
                            ],
                            height: 300, // Altura fija
                            colWidths: [180, 100, 120], // Anchos fijos para cada columna
                            // stretchH: 'all', // Eliminamos esta línea para que el ancho sea automático
                            // --- FIN DE LA MODIFICACIÓN 2 ---
                            rowHeaders: false,
                            licenseKey: 'non-commercial-and-evaluation',
                            afterChange: function(changes, source) {
                                if (source === 'loadData') return;
                                validateTotal();
                            }
                        };
                        hotInstance = new Handsontable(container, settings);
                    } else {
                        hotInstance.loadData(dataForTable);
                    }

                    $('#shiftsGridContainer').slideDown();
                    validateTotal();
                } else {
                    $('#shiftsGridContainer').slideUp();
                }
            });

            function validateTotal() {
                if(!hotInstance) return; // Si no hay tabla, no hacer nada
                const total = hotInstance.getSourceData().reduce((sum, row) => sum + (parseFloat(row.percentage) || 0), 0);

                if (Math.abs(total - 100) > 0.001) {
                    $('#saveButton').prop('disabled', true);
                    toastr.error(`Total must be 100%. Current total is ${total.toFixed(2)}%.`);
                } else {
                    $('#saveButton').prop('disabled', false);
                    toastr.success('Total is 100%.');
                }
            }

            $('#saveButton').on('click', function () {
                const dataToSave = hotInstance.getSourceData();
                const selectedPlant = $('#plantSelect').val();
                console.log(`Data for ${selectedPlant}:`, dataToSave);

                Swal.fire({
                    title: 'Save Action',
                    text: 'This is a demonstration. Data will not be saved to the database.',
                    icon: 'info',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#009ff5'
                });
            });

            // ... mensajes de toastr ...
        });
    </script>
}
@model Portal_2_0.Models.EditProjectViewModel
@using Portal_2_0.Models
@using Portal_2_0.Controllers

@{
    ViewBag.Title = "Edit Project";
    ViewBag.PrimerNivel = "quote";
    ViewBag.SegundoNivel = "edit_project";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    string expandedSection = ViewBag.ExpandedSection ?? "collapseOne";

    Clases.Util.MensajesSweetAlert mensajeAlerta = (Clases.Util.MensajesSweetAlert)ViewBag.MensajeAlert;

    //permisos
    bool canUpsert = ViewBag.CanUpsert as bool? ?? false;
    bool cantEditClientPartInformationSalesSection = ViewBag.CantEditClientPartInformationSalesSection as bool? ?? false;
    bool canEditClientPartInformationEngineeringSection = ViewBag.CanEditClientPartInformationEngineeringSection as bool? ?? false;
    bool canEditClientPartInformationDataManagementSection = ViewBag.CanEditClientPartInformationDataManagementSection as bool? ?? false;
    bool isAdmin = ViewBag.IsAdmin as bool? ?? false;


    // Serializamos como JSON: ["Engineering","Foreign Trade",...]
    var nextDeptsJson = new System.Web.Script.Serialization.JavaScriptSerializer()
                    .Serialize(ViewBag.NextDepartments as List<string>);

}

@section estilos {
    <!-- SweetAlert2 -->
    <link href="@Url.Content("~/Content/vendors/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css")" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <style>

        .x_title h2 {
            color: #009ff5;
            font-weight: 600;
        }
        /* Estilos para el acordeón */
        .panel-group .panel {
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e6e9ed;
        }

        .panel-heading {
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            padding: 12px 15px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #009ff5;
        }

            .panel-title a {
                text-decoration: none;
                color: #009ff5;
                display: block;
                width: 100%;
            }

        .panel-body {
            padding: 15px;
        }

        /* Paneles deshabilitados */
        .disabled-panel .panel-heading {
            background-color: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
        }

            .disabled-panel .panel-heading a {
                pointer-events: none;
                color: #aaa;
            }

        /* Botón de editar en la cabecera */
        .edit-btn {
            font-size: 12px;
            padding: 5px 10px;
        }

        .panel-heading-actions {
            margin-left: auto; /* ¡La magia! Empuja el grupo de botones a la derecha */
            display: flex;
            gap: 6px; /* Añade un espacio agradable entre los botones */
        }

        /* Tabla con color corporativo */
        #materialsTable {
            border: 1px solid #009ff5;
            width: 100%;
            border-collapse: collapse;
        }

            #materialsTable thead {
                background-color: #009ff5;
                color: #ffffff; /* Texto blanco en cabecera */
            }

            #materialsTable th,
            #materialsTable td {
                text-align: center;
                vertical-align: middle;
                border: 1px solid #009ff5;
                padding: 8px;
            }

        /* Celda con advertencia (fondo rojo suave) */
        .warning-cell {
            background-color: #f8b8be;
        }

        .action-btn.rejected {
            background-color: #dc3545 !important; /* rojo bootstrap */
            border-color: #dc3545 !important;
        }
        /*Action Panel*/

        /* Ajustes para Select2 */
        .select2-container .select2-selection--single {
            height: calc(1.5em + .75rem + 2px) !important;
            padding: .375rem .75rem !important;
            border: 1px solid #009ff5 !important;
            border-radius: 4px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #333;
            line-height: 1.5;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: #333 transparent transparent transparent;
        }

        /* Card ligero para panel de acción */
        #actionPanel {
            background: #fff;
            border: 1px solid #009ff5;
            border-radius: 6px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

            /* Separador interno */
            #actionPanel .form-group {
                margin-bottom: 1rem;
            }

            /* Mejora checkbox-list */
            #actionPanel .list-unstyled li {
                padding: .4rem .6rem;
                border: 1px solid #e2e6ea;
                border-radius: 4px;
                background: #f9f9f9;
                margin-bottom: .5rem;
            }

        /* Botón grande, alineado y corporativo */
        #actionButtonContainer .action-btn {
            background-color: #009ff5;
            border-color: #009ff5;
            color: #fff;
            padding: .6rem 1.6rem;
            font-size: 1rem;
            border-radius: 4px;
        }
    </style>
}

@*Para SweetAlert*@
@if (mensajeAlerta != null)
{
    <input type="hidden" value="@mensajeAlerta.Mensaje" id="mensajeAlert" />
    <input type="hidden" value="@mensajeAlerta.getTipoMensaje()" id="mensajeAlertTipo" />
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        @if (Model.IsSnapshot)
                        {
                            <div class="alert alert-info">
                                You are viewing snapshot version @Model.Version_Number
                                created @(Model.Creation_Date)
                            </div>
                        }
                        <!-- Recuadro informativo con datos generales del proyecto -->
                        @{ ViewBag.ShowEditButton = true; }
                        @Html.Partial("_CTZ_ProjectInfo", Model)

                        <div class="row mb-3" id="validity-container">
                            <div class="col-md-12">
                                <div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm"
                                     id="validity-alert"
                                     style="border-left: 5px solid #17a2b8; background-color: #e2e6ea; color: #383d41;">

                                    <div>
                                        <i class="fa-regular fa-calendar-check fa-lg mr-2"></i>
                                        <strong>Quote Validity Status:</strong>
                                        <span id="validity-text">Pending Verification...</span>
                                        <small class="d-block text-muted mt-1" id="validity-subtext">
                                            Policy: 15 days from creation.
                                        </small>
                                    </div>

                                    <div class="d-flex align-items-center">
                                        <button id="btnCheckValidity" onclick="verificarVigencia()" class="btn btn-sm btn-info shadow-sm mr-2">
                                            <i class="fa-solid fa-calculator"></i> Check Validity Status
                                        </button>

                                        <button id="btnExtendValidity" onclick="extenderVigencia()" class="btn btn-sm btn-danger shadow-sm" style="display:none;">
                                            <i class="fa-solid fa-clock-rotate-left"></i> Process Extension
                                        </button>

                                        <span id="status-badge" class="badge badge-secondary p-2 ml-2" style="font-size: 14px;">Unknown</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (Model.IsSnapshot)
                        {
                            <div class="row mb-3">
                                <div class="col-12 text-right">
                                    <button type="button" class="btn btn-success edit-btn"
                                            onclick="location.href='@Url.Action("ViewClientPartInformationHistory","CTZ_Projects",
              new { id = Model.ID_Project, versionId = Model.ID_Version })'">
                                        <svg width="20px" height="20px" viewBox="0 0 24 24" id="meteor-icon-kit__solid-file-search" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.5754 23.2323C17.2093 23.6996 16.6397 24 16 24H2C0.89543 24 0 23.1046 0 22V6H5C5.55228 6 6 5.55228 6 5V0H16C17.1046 0 18 0.89543 18 2V6.75463C16.6304 5.65672 14.8919 5 13 5C8.58172 5 5 8.58172 5 13C5 17.4183 8.58172 21 13 21C13.7166 21 14.4113 20.9058 15.0722 20.729L17.5754 23.2323ZM0.341411 4C0.943981 2.29517 2.29517 0.943981 4 0.341411V4H0.341411ZM17.8603 16.5189C17.9545 16.5659 18.0428 16.6286 18.1213 16.7071L23.1213 21.7071C23.5118 22.0976 23.5118 22.7308 23.1213 23.1213C22.7308 23.5118 22.0976 23.5118 21.7071 23.1213L16.7071 18.1213C16.6286 18.0428 16.5659 17.9545 16.5189 17.8603C15.5304 18.5773 14.3146 19 13 19C9.68629 19 7 16.3137 7 13C7 9.68629 9.68629 7 13 7C16.3137 7 19 9.68629 19 13C19 14.3146 18.5773 15.5304 17.8603 16.5189ZM13 17C15.2091 17 17 15.2091 17 13C17 10.7909 15.2091 9 13 9C10.7909 9 9 10.7909 9 13C9 15.2091 10.7909 17 13 17Z" fill="#ffffff"></path></g></svg>
                                        <span style="font-size:15px;">View All Data</span>
                                    </button>
                                </div>
                            </div>

                        }
                        <!-- Acordeón de secciones -->
                        <div class="panel-group" id="accordion">
                            <!-- Sección 1: Client & Part Information (activa) -->
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                                            Client & Part Information
                                        </a>
                                    </h4>
                                    <div class="panel-heading-actions">

                                        <button type="button" class="btn btn-xs btn-info edit-btn"
                                                title="View Details"
                                                onclick="location.href='@Url.Action("EditClientPartInformation", "CTZ_Projects", new { id = Model.ID_Project, details = true })'">
                                            <i class="fa fa-search"></i> Details
                                        </button>

                                        <button type="button" class="btn btn-xs btn-success edit-btn"
                                                title="Edit Information"
                                                onclick="location.href='@Url.Action("EditClientPartInformation", "CTZ_Projects", new { id = Model.ID_Project })'"
                                                style="display: @(!cantEditClientPartInformationSalesSection || Model.IsSnapshot ? "none" : string.Empty)">
                                            <i class="fa-solid fa-pen-to-square"></i> Edit
                                        </button>
                                    </div>
                                </div>
                                <div id="collapseOne" class="panel-collapse collapse @(expandedSection == "collapseOne" ? "show" : "")">
                                    <div class="panel-body">
                                        @if (!Model.Materials.Any())
                                        {
                                            <p>No part number information was found for this project. Please add them.</p>
                                        }
                                        else
                                        {
                                            <table class="table table-bordered table-responsive" id="materialsTable">
                                                <thead>
                                                    <tr>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Vehicle)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Vehicle_version)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Part_Name)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Part_Number)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Real_SOP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Real_EOP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Ship_To)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Quality)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Program_SP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().ID_Route)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.Materials)
                                                    {
                                                        <tr>
                                                            <td>@Html.DisplayFor(model => item.Vehicle)</td>
                                                            <td>@Html.DisplayFor(model => item.Vehicle_version)</td>
                                                            <td>@Html.DisplayFor(model => item.Part_Name)</td>
                                                            <td>@Html.DisplayFor(model => item.Part_Number)</td>
                                                            <td>@Html.DisplayFor(model => item.Real_EOP)</td>
                                                            <td>@Html.DisplayFor(model => item.Real_SOP)</td>
                                                            <td>@Html.DisplayFor(model => item.Ship_To)</td>
                                                            <td>@Html.DisplayFor(model => item.Quality)</td>
                                                            <td>@Html.DisplayFor(model => item.Program_SP)</td>
                                                            <td>@Html.DisplayFor(model => item.CTZ_Route.Route_Name)</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>

                            </div>

                            <!-- Sección 2: Technical Feasibility -->
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
                                            Technical Feasibility
                                        </a>
                                    </h4>
                                    <button type="button" class="btn btn-xs btn-success edit-btn"
                                            onclick="location.href='@Url.Action("EditClientPartInformation", "CTZ_Projects", new { id = Model.ID_Project })'"
                                            style="display: @(!canEditClientPartInformationEngineeringSection || Model.IsSnapshot ? "none":string.Empty)">
                                        <i class="fa-solid fa-pen-to-square"></i> Edit
                                    </button>
                                </div>
                                <div id="collapseTwo" class="panel-collapse collapse @(expandedSection == "collapseTwo" ? "show" : "")">
                                    <div class="panel-body">
                                        @if (!Model.Materials.Any())
                                        {
                                            <p>No part number information was found for this project. Please add them.</p>
                                        }
                                        else
                                        {
                                            <table class="table table-bordered table-responsive" id="materialsTable">
                                                <thead>
                                                    <tr>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Vehicle)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Vehicle_version)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Part_Name)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Part_Number)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Real_SOP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Real_EOP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().ID_Theoretical_Blanking_Line)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().ID_Real_Blanking_Line)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Ideal_Cycle_Time_Per_Tool)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().OEE)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().DM_status)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().DM_status_comment)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.Materials)
                                                    {
                                                        <tr>
                                                            <td>@Html.DisplayFor(model => item.Vehicle)</td>
                                                            <td>@Html.DisplayFor(model => item.Vehicle_version)</td>
                                                            <td>@Html.DisplayFor(model => item.Part_Name)</td>
                                                            <td>@Html.DisplayFor(model => item.Part_Number)</td>
                                                            <td>@Html.DisplayFor(model => item.Real_EOP)</td>
                                                            <td>@Html.DisplayFor(model => item.Real_SOP)</td>
                                                            <td>@Html.DisplayFor(model => item.CTZ_Production_Lines.Description)</td>
                                                            @* Línea real: si no hay Descripción, marcamos en rojo *@
                                                            <td class="@(string.IsNullOrEmpty(item.CTZ_Production_Lines1?.Description) ? "warning-cell" : "")">
                                                                @Html.DisplayFor(m => item.CTZ_Production_Lines1.Description)
                                                            </td>

                                                            @* Ideal Cycle Time: si es null, marcamos en rojo *@
                                                            <td class="@(item.Ideal_Cycle_Time_Per_Tool == null ? "warning-cell" : "")">
                                                                @Html.DisplayFor(m => item.Ideal_Cycle_Time_Per_Tool)
                                                            </td>

                                                            @* OEE *@
                                                            <td class="@(item.OEE == null ? "warning-cell" : "")">
                                                                @(item.OEE.HasValue? item.OEE.Value + "%": String.Empty)
                                                            </td>
                                                            <td>@Html.DisplayFor(model => item.DM_status)</td>
                                                            <td>@Html.DisplayFor(model => item.DM_status_comment)</td>

                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 3: Efficiency and Capacity (deshabilitada) -->
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
                                            Efficiency and Capacity
                                        </a>
                                    </h4>
                                    <button type="button" class="btn btn-xs btn-success edit-btn"
                                            onclick="location.href='@Url.Action("EditClientPartInformation", "CTZ_Projects", new { id = Model.ID_Project })'"
                                            style="display: @(!canEditClientPartInformationDataManagementSection || Model.IsSnapshot ? "none":string.Empty)">
                                        <i class="fa-solid fa-pen-to-square"></i> Edit
                                    </button>
                                </div>
                                <div id="collapseThree" class="panel-collapse collapse @(expandedSection == "collapseThree" ? "show" : "")">
                                    <div class="panel-body">
                                        @if (!Model.Materials.Any())
                                        {
                                            <p>No part number information was found for this project. Please add them.</p>
                                        }
                                        else
                                        {
                                            <table class="table table-bordered table-responsive" id="materialsTable">
                                                <thead>
                                                    <tr>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Vehicle)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Vehicle_version)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Part_Name)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Part_Number)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Real_SOP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Real_EOP)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().ID_Theoretical_Blanking_Line)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().ID_Real_Blanking_Line)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().Ideal_Cycle_Time_Per_Tool)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().OEE)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().DM_status)</th>
                                                        <th>@Html.DisplayNameFor(model => Model.Materials.First().DM_status_comment)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.Materials)
                                                    {
                                                        <tr>
                                                            <td>@Html.DisplayFor(model => item.Vehicle)</td>
                                                            <td>@Html.DisplayFor(model => item.Vehicle_version)</td>
                                                            <td>@Html.DisplayFor(model => item.Part_Name)</td>
                                                            <td>@Html.DisplayFor(model => item.Part_Number)</td>
                                                            <td>@Html.DisplayFor(model => item.Real_EOP)</td>
                                                            <td>@Html.DisplayFor(model => item.Real_SOP)</td>
                                                            <td>@Html.DisplayFor(model => item.CTZ_Production_Lines.Description)</td>
                                                            @* Línea real: si no hay Descripción, marcamos en rojo *@
                                                            <td class="@(string.IsNullOrEmpty(item.CTZ_Production_Lines1?.Description) ? "warning-cell" : "")">
                                                                @Html.DisplayFor(m => item.CTZ_Production_Lines1.Description)
                                                            </td>

                                                            @* Ideal Cycle Time: si es null, marcamos en rojo *@
                                                            <td class="@(item.Ideal_Cycle_Time_Per_Tool == null ? "warning-cell" : "")">
                                                                @Html.DisplayFor(m => item.Ideal_Cycle_Time_Per_Tool)
                                                            </td>

                                                            @* OEE *@
                                                            <td class="@(item.OEE == null ? "warning-cell" : "")">
                                                                @(item.OEE.HasValue? item.OEE.Value + "%": String.Empty)
                                                            </td>
                                                            <td>@Html.DisplayFor(model => item.DM_status)</td>
                                                            <td>@Html.DisplayFor(model => item.DM_status_comment)</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="mt-3" style="display:@(Model.IsSnapshot ? "none":string.Empty)">
                            @{
                                // Flags de permisos
                                bool hasAnyAssignment = (bool)(ViewBag.HasAnyAssignment ?? false);
                                //bool canSendSales = (bool)(ViewBag.CanSendSales ?? false);
                                bool cantSendSalesSection = cantEditClientPartInformationSalesSection;
                                // Dept actual
                                int currentDept = (int)(ViewBag.CurrentDept ?? 0);
                                var activities = ViewBag.Activities as List<Portal_2_0.Models.CTZ_Department_Activity>;
                                var completedActs = ViewBag.CompletedActs as List<int>;
                                // Permiso “enviar” para este depto
                                bool canSendForCurrent = currentDept == (int)DepartmentEnum.Sales ? cantSendSalesSection
                                                      : currentDept == (int)DepartmentEnum.Engineering ? (bool)(ViewBag.CanSendEngineering ?? false)
                                                      : currentDept == (int)DepartmentEnum.ForeignTrade ? (bool)(ViewBag.CanSendForeignTrade ?? false)
                                                      : currentDept == (int)DepartmentEnum.Disposition ? (bool)(ViewBag.CanSendDisposition ?? false)
                                                      : currentDept == (int)DepartmentEnum.DataManagement ? (bool)(ViewBag.CanSendDataManagement ?? false)
                                                      : false;
                                // Nombre de depto como string (Sales, Engineering, etc)
                                var deptName = ((DepartmentEnum)currentDept).ToString();

                                var reassignList = ViewBag.ReassignOptions as SelectList;

                            }

                            @* 1) Primera vez: Sales sin asignaciones previas *@
                            @if ((!hasAnyAssignment
                                 && cantSendSalesSection
                                 && currentDept == (int)DepartmentEnum.Sales) || isAdmin)
                            {
                                <button id="btnSubmitAction" data-dept="Sales" class="btn btn-primary">
                                    <i class="fa-regular fa-envelope"></i> Send Feasibility
                                </button>
                            }
                            @* 2) Panel dinámico para reenvíos y flujos posteriores *@
                            else if (canSendForCurrent)
                            {
                                var rejs = ViewBag.ActiveRejections as List<ActiveRejection>;


                                <div id="actionPanel" class="bg-light border border-info rounded shadow-sm p-4 mt-4">
                                    <!-- Nuevo título del panel -->
                                    <h5 class="mb-3 " style="color: #009ff5">
                                        Manage Assignment
                                    </h5>
                                    <hr />
                                    @if (rejs != null && rejs.Any())
                                    {
                                        <div class="mb-3">
                                            @foreach (var rej in rejs)
                                            {
                                                <div class="alert alert-danger d-flex align-items-start">
                                                    <i class="fa fa-exclamation-circle mr-2 mt-1"></i>
                                                    <div>
                                                        <strong>@rej.Dept rejected</strong> (@rej.DateRejection):<br />
                                                        @rej.Comment
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <small id="currentStatusInfo" class="d-block mb-3" style="color: #009ff5">
                                        Current Assignment Status: <strong>@ViewBag.CurrentAssignmentStatus</strong>
                                    </small>

                                    <!-- Select de estatus con Select2 -->
                                    <div class="form-group">
                                        <label for="statusSelect" class="font-weight-semibold">New Assignment Status</label>
                                        <select id="statusSelect"
                                                class="form-control select2"
                                                style="width:100%">
                                            @foreach (AssignmentStatusEnum s in Enum.GetValues(typeof(AssignmentStatusEnum)))
                                            {
                                                if (s == AssignmentStatusEnum.PENDING || s == AssignmentStatusEnum.ON_HOLD)
                                                {
                                                    continue;  //pending, es el estatus inicial de la asignacion y on_hold, debe ser automatico.
                                                }

                                                if (cantSendSalesSection)
                                                {
                                                    // Para Sales solo Approved e In Progress
                                                    if (s != AssignmentStatusEnum.APPROVED
                                                        && s != AssignmentStatusEnum.IN_PROGRESS)
                                                    {
                                                        continue;
                                                    }
                                                }
                                                // Para todos los demás, mostramos todo excepto Pending
                                                <option value="@((int)s)">
                                                    @if (s == AssignmentStatusEnum.APPROVED && cantSendSalesSection)
                                                    {
                                                        @("RESEND QUOTE")
                                                    }
                                                    else
                                                    {
                                                        @s.ToString().Replace("_", " ")
                                                    }

                                                </option>
                                            }
                                        </select>
                                    </div>

                                    <div class="form-group" id="rejectionPanel" style="display:none">
                                        <label for="rejectionReasonSelect">Rejection Reason</label>
                                        <select id="rejectionReasonSelect"
                                                name="rejectionReasonId"
                                                class="form-control select2"
                                                style="width:200px">
                                            <!-- 1) opción en blanco para placeholder -->
                                            <option value=""></option>

                                            @* 2) tus opciones reales *@
                                            @{
                                                var reasons = ViewBag.RejectionReasons
                                                              as IEnumerable<RejectionReasonOption>;
                                            }
                                            @foreach (var r in reasons)
                                            {
                                                <option value="@r.ID_Reason"
                                                        data-actiontype="@r.ActionType"
                                                        data-reassign="@r.ReassignToDept">
                                                    @r.Name
                                                </option>
                                            }
                                        </select>

                                        <textarea id="rejectionReasonOther"
                                                  class="form-control mt-2"
                                                  placeholder="Please specify…"
                                                  maxlength="200"
                                                  style="display:none"></textarea>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <div class="form-group" id="actionTypePanel" style="display:none">
                                                <label for="rejectionActionType">Behavior</label>
                                                <select id="rejectionActionType"
                                                        name="actionType"
                                                        class="form-control select2"
                                                        style="width:200px">
                                                    <option value="">Choose…</option>
                                                    @foreach (var e in Enum.GetValues(typeof(ActionTypeEnum)).Cast<ActionTypeEnum>())
                                                    {
                                                        <option value="@( (byte)e )">@e</option>
                                                    }
                                                </select>
                                                <!-- ——— AYUDA INLINE ——— -->
                                                <small class="form-text text-muted">
                                                    <strong>HoldOthers</strong>: reject this, put others “On Hold”, then reassign.<br />
                                                    <strong>KeepActive</strong>: reject this, leave others unchanged, then reassign.<br />
                                                    <strong>FinalizeAll</strong>: reject this, put all “On Hold”, no reassignment.
                                                </small>
                                            </div>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <div id="reassignPanel" class="form-group" style="display:none">
                                                @if (reassignList != null)
                                                {
                                                    <label for="reassignToDept">Reassign to</label>
                                                    @* Html.DropDownListFor si tuviéramos ViewModel con propiedad ReassignTo *@
                                                    @Html.DropDownList(
                                                        "reassignToDept",
                                                        reassignList,
                                                        "Choose…",
                                                        new { @class = "form-control select2", style = "width:200px;" }
                                                    )
                                                }
                                            </div>
                                        </div>

                                    </div>


                                    <!-- Checklist de actividades -->
                                    <div class="form-group" style="display:@(activities.Any()?"":"none")">
                                        <label class="font-weight-semibold">Activities</label>
                                        <ul class="list-unstyled mb-3 pl-3">
                                            @foreach (var act in activities)
                                            {
                                                var isChecked = completedActs.Contains(act.ID_Activity);
                                                <li class="mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input activity-check"
                                                               type="checkbox"
                                                               value="@act.ID_Activity"
                                                               id="act_@act.ID_Activity"
                                                               @(isChecked ? "checked" : "") />
                                                        <label class="form-check-label ml-2"
                                                               for="act_@act.ID_Activity">
                                                            @act.Description
                                                        </label>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>

                                    <!-- Textarea de comentarios -->
                                    <div class="form-group">
                                        <label for="comment" class="font-weight-semibold">Comments</label>
                                        <textarea id="comment"
                                                  class="form-control"
                                                  rows="3"
                                                  placeholder="Add your comments here…"></textarea>
                                    </div>

                                    <!-- Botón dinámico alineado a la derecha -->
                                    <div class="d-flex justify-content-end">
                                        <button id="btnSubmitAction"
                                                data-dept="@deptName"
                                                class="action-btn btn btn-info px-4 py-2">
                                            <i class="fa fa-paper-plane mr-1"></i>
                                            <span id="btnText">Submit</span>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div><!-- panel-group -->



                </div><!-- x_content -->
            </div><!-- x_panel -->
        </div><!-- col -->
    </div><!-- row -->
</div><!-- container -->


@section Scripts {
    @Scripts.Render(Url.Content("~/Content/vendors/sweetalert2/sweetalert2.min.js"))
    @Scripts.Render(Url.Content("~/Scripts/AlertasSweetAlert.js"))
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000"
        };

        $(function () {
              // 1) inicializa
                $('#rejectionReasonSelect').select2({
                    placeholder: 'Select a reason…',
                    allowClear: true,          // habilita la x para limpiar
                    width: '600px',
                    minimumResultsForSearch: Infinity
                });
            $('#rejectionActionType, #reassignToDept').select2({
                placeholder: 'Choose...',
                    allowClear: true,          // habilita la x para limpiar
                    width: '100%',
                    minimumResultsForSearch: Infinity
            });

              // valor numérico de FinalizeAll
            var finalizeVal = '@((byte)ActionTypeEnum.FinalizeAll)';

            // escucha cambios en el comportamiento
            $('#rejectionActionType').on('change', function(){
              var sel = $(this).val();
              if (sel === finalizeVal) {
                // si es FinalizeAll → limpia y deshabilita el reassign
                $('#reassignToDept')
                  .val(null)
                  .trigger('change')
                  .prop('disabled', true);
                //$('#reassignPanel').hide();
              } else {
                // cualquier otro → lo muestra y habilita
                $('#reassignToDept').prop('disabled', false);
                //$('#reassignPanel').show();
              }
            }).trigger('change');

              // 2) Sólo show cuando status=REJECTED
              $('#statusSelect').on('change',function(){
                if ($(this).val()== '@((int)AssignmentStatusEnum.REJECTED)') {
                  $('#rejectionPanel').slideDown();
                } else {
                  $('#rejectionPanel textarea').hide();
                  $('#rejectionPanel').slideUp();
                }
              }).trigger('change');

                   // sólo DataManagement + REJECTED debe mostrar reassign
            var isDM = '@currentDept' === '@((int)DepartmentEnum.DataManagement)';
              // 3) “Other” show textarea
              $('#rejectionReasonSelect').on('change',function(){
                  if ($(this).val() == '0') {
                      $('#rejectionReasonOther').slideDown().prop('required', true);

                      if (isDM) {
                          console.log('entra')
                          $('#reassignPanel, #actionTypePanel').slideDown();
                        }

                  } else {
                      $('#rejectionReasonOther').hide().prop('required', false);
                      $('#reassignPanel, #actionTypePanel').slideUp();

                }
              }).trigger('change');

            $('#statusSelect').addClass('select2').select2({
                width: '100%',
                minimumResultsForSearch: Infinity
            });

        // 1) Si existe, enlazamos el cambio de icono/texto
        if ($('#statusSelect').length) {
            $('#statusSelect').on('change', function () {



                var key = $(this).find('option:selected').text().trim();
                var $label = $('label[for="comment"]');
                var $textarea = $('#comment');

                // Reset visuales de comentario
                $label.text('Comments');
                $textarea.prop('required', false);
                $('.action-btn').removeClass('rejected');


                // después, si es Rejected, la agregamos
                if (key === 'REJECTED') {
                    // Cambiar la etiqueta
                    $label.text('Reason for rejection *');
                    // Hacer textarea obligatorio
                    $textarea.prop('required', true);
                    //cambia class
                    $('.action-btn').addClass('rejected');
                }

                var key  = $(this).find('option:selected').text().trim();
                var icon = 'fa-paper-plane';
                switch(key) {
                    case 'REJECTED':    icon = 'fa-times-circle'; break;
                    case 'ON REVIEWED': icon = 'fa-eye';          break;
                    case 'ON HOLD':     icon = 'fa-pause';        break;
                    case 'IN PROGRESS': icon = 'fa-spinner';      break;
                    case 'APPROVED':    icon = 'fa-check-circle'; break;
                }
                $('#btnSubmitAction i').attr('class','fa '+icon);
                $('#btnText').text(key);
            }).trigger('change');
        } else {
            // Si no existe, asignamos un icono y texto genéricos
            $('#btnSubmitAction i').attr('class','fa fa-paper-plane');
            $('#btnText').text('Proceed');
        }

        // 2) Confirm + AJAX
        $('#btnSubmitAction').click(function(){
          var dept       = $(this).data('dept');
          var statusVal = $('#statusSelect').length
                        ? parseInt($('#statusSelect').val(), 10)
                        : 0;  // 0 = placeholder para flujo inicial de Sales
          var statusText = $('#statusSelect').length
                            ? $('#statusSelect option:selected').text().trim()
                            : 'Proceed';
          var comment    = $('#comment').length
                            ? $('#comment').val().trim()
                            : '';
          var activities = $('.activity-check').length
                            ? $('.activity-check:checked').map(function(){
                                return this.value;
                              }).get()
                            : [];

          // Construimos el mensaje
          var text = 'You are about to set status to "' + statusText + '" for ' + dept + '.';
          if (comment) text += '\n\nComment: "' + comment + '"';

          // Preparamos el payload
          var payload = {
            projectId   : @Model.ID_Project,
            department  : dept,
            newStatus   : statusVal,
            comment     : comment,
            activities  : activities
          };

            // 1) Si aparece el panel de rechazo, siempre deberías enviar el motivo
            if ($('#rejectionPanel').is(':visible')) {
                var reasonId = $('#rejectionReasonSelect').val();
                payload.rejectionReasonId = reasonId ? parseInt(reasonId, 10) : null;

                // sólo si es “Other” (ID = 0) mandamos el texto
                if (reasonId == '0') {
                    var otherText = $('#rejectionReasonOther').val().trim();
                    payload.rejectionReasonOther = otherText;
                }
            }
            // 2) Si aparece el panel de comportamiento (actionType), lo agregamos
            if ($('#actionTypePanel').is(':visible')) {
                var act = $('#rejectionActionType').val();
                payload.actionType = act ? parseInt(act, 10) : null;
            }

            // 3) Si aparece el panel de reasignar, lo agregamos
            if ($('#reassignPanel').is(':visible')) {
                var reassign = $('#reassignToDept').val();
                payload.reassignToDept = reassign ? parseInt(reassign, 10) : null;
            }

          Swal.fire({
            title: 'Are you sure?',
            text: text,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#009ff5',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, proceed'
          }).then((result) => {
            if (!result.isConfirmed) return;

            $.ajax({
              url: '@Url.Action("ProcessProjectActivity","CTZ_Projects")',
              method: 'POST',
              data: payload,
              dataType: 'json'
            })
            .done(function(r){
              if (r.success) {
                Swal.fire('Done', r.message, 'success')
                     .then(()=> location.reload());
              } else {
                Swal.fire('Warning', r.message, 'warning');
              }
            })
                .fail(function (xhr, textStatus, errorThrown) {
                    // 1) Muestra en consola todos los detalles
                    console.error('AJAX Error:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        response: xhr.responseText,
                        error: errorThrown,
                        textStatus: textStatus
                    });

                    console.log(xhr.responseText)
                    // 2) Intenta extraer un mensaje desde el JSON de respuesta
                    var msg = 'Could not process activity.';
                    try {
                        var json = JSON.parse(xhr.responseText);
                        if (json.message) {
                            msg = json.message;
                        }
                    } catch (e) {
                        // no es JSON, lo dejamos
                    }

                    // 3) Muéstralo en SweetAlert
                    Swal.fire('Error', msg, 'error');
                });
          });
        });


        });

        // 1. Simula la validación de reglas de negocio
    function verificarVigencia() {
        const btn = $('#btnCheckValidity');
        const originalText = btn.html();

        // Simular carga
        btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Verifying...');
        $('#status-badge').text('Checking...');

        setTimeout(() => {
            // 2. Simular que detectó que expiró
            const container = $('#validity-alert');
            container.removeClass('alert-info').addClass('alert-danger');
            container.css('background-color', '#f8d7da').css('color', '#721c24').css('border-left', '5px solid #dc3545');

            $('#validity-text').html("<strong>QUOTE EXPIRED</strong> (16 days elapsed)");
            $('#validity-subtext').html("Expired on: @DateTime.Now.AddDays(-1).ToString("dd/MM/yyyy")");

            $('#status-badge').removeClass('badge-secondary').addClass('badge-danger').text('Expired');

            // Ocultar botón de check y mostrar el de extender
            btn.hide();
            $('#btnExtendValidity').fadeIn().addClass('animate__animated animate__pulse');

            toastr.warning("Validation Result: Quote validity period has ended.");

        }, 1200); // 1.2 segundos de "cálculo"
    }

    // 3. Simula la extensión (Solución)
    function extenderVigencia() {
        Swal.fire({
            title: 'Process Validity Extension?',
            text: "This will apply a 15-day extension policy to the current quote.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#009ff5',
            confirmButtonText: 'Approve Extension',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return new Promise(resolve => setTimeout(resolve, 1500));
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const container = $('#validity-alert');

                container.fadeOut(200, function() {
                    // Estilo Verde / Éxito
                    $(this).removeClass('alert-danger').addClass('alert-success');
                    $(this).css('background-color', '#d4edda').css('color', '#155724').css('border-left', '5px solid #28a745');

                    var newDate = new Date();
                    newDate.setDate(newDate.getDate() + 15);

                    $('#validity-text').html("Status: <strong>Active</strong>");
                    $('#validity-subtext').html("Valid until: " + newDate.toLocaleDateString('en-GB'));

                    $('#btnExtendValidity').hide();
                    $('#status-badge').removeClass('badge-danger').addClass('badge-success').text('Active');

                    $(this).fadeIn(400);
                });

                Swal.fire('Updated', 'Validity extended successfully.', 'success');
            }
        });
    }
    </script>
}


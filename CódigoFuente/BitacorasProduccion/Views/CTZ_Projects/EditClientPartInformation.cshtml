@model Portal_2_0.Models.CTZ_Projects
@{
    ViewBag.Title = "Edit Client & Part Information";
    ViewBag.PrimerNivel = "quote";
    ViewBag.SegundoNivel = "edit_client_part";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    var currentUser = ViewBag.EmpleadoLogeado as Portal_2_0.Models.empleados;
    var userName = currentUser != null ? currentUser.nombre : "Unknown";
    var userId = currentUser != null ? currentUser.id : 0;
}

@section estilos
{
    @* Cargamos el CSS de React manualmente aquí *@
    @{
        var cssPathStyle = Server.MapPath("~/Scripts/ReactDist/assets/main.css");
        var cssVersionStyle = System.IO.File.Exists(cssPathStyle)
            ? System.IO.File.GetLastWriteTime(cssPathStyle).Ticks.ToString()
            : DateTime.Now.Ticks.ToString();
    }
    <link rel="stylesheet" href="@Url.Content("~/Scripts/ReactDist/assets/main.css")?v=@cssVersionStyle" />
    <style>
        #client-part-information-root {
            min-height: 500px;
            background-color: #f8f9fa;
            border-radius: 5px;
            position: relative;
        }

        .react-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #009ff5;
        }
    </style>
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <div id="client-part-information-root">
                            <div class="react-loader">
                                <i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i>
                                <p class="mt-2">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. PREPARACIÓN DE DATOS (Sin dependencias externas)
        // Esto se ejecuta inmediatamente, no rompe nada.
        try {
            var serverJson = @Html.Raw(ViewBag.ReactPayload ?? "{}");
            var listsJson = @Html.Raw(ViewBag.ReactLists ?? "{}");
            var urlsJson = @Html.Raw(ViewBag.ReactUrls ?? "{}");

            window.reactInitialData = {
                project: serverJson,
                lists: listsJson,
                user: {
                    name: '@userName',
                    id: @userId
                },
                permissions: {
                    canEditSales: @((ViewBag.CanEditSales as bool? ?? false).ToString().ToLower()),
                    canEditEngineering: @((ViewBag.CanEditEngineering as bool? ?? false).ToString().ToLower()),
                    canEditDataManagement: @((ViewBag.CanEditDataManagement as bool? ?? false).ToString().ToLower()),
                    isDetailsMode: @((ViewBag.IsDetailsMode as bool? ?? false).ToString().ToLower())
                },
                urls: urlsJson
            };
        } catch (e) {
            console.error("Error inicializando datos de React:", e);
        }

        // 2. FUNCIÓN DE CARGA SEGURA
        // Esta función espera a que el entorno Legacy (jQuery) esté listo antes de soltar a React.
        (function () {

            @* TRUCO DE CACHE BUSTING:
               Obtenemos la fecha de última escritura del archivo físico en el servidor.
               Convertimos esa fecha a Ticks para usarla como versión.
            *@
            @{
                var jsPath = Server.MapPath("~/Scripts/ReactDist/assets/main.js");
                var cssPath = Server.MapPath("~/Scripts/ReactDist/assets/main.css");

                var jsVersion = System.IO.File.Exists(jsPath)
                    ? System.IO.File.GetLastWriteTime(jsPath).Ticks.ToString()
                    : DateTime.Now.Ticks.ToString();

                var cssVersion = System.IO.File.Exists(cssPath)
                    ? System.IO.File.GetLastWriteTime(cssPath).Ticks.ToString()
                    : DateTime.Now.Ticks.ToString();
            }

            var reactScriptUrl = "@Url.Content("~/Scripts/ReactDist/assets/main.js")?v=@jsVersion";
            var maxRetries = 50; // 5 segundos max
            var attempts = 0;

            function injectReact() {
                console.log("🚀 Entorno Legacy listo. Inyectando React...");
                var script = document.createElement('script');
                script.src = reactScriptUrl;
                script.type = 'module'; // Importante para Vite
                script.async = true;
                document.body.appendChild(script);
            }

            function checkDependencies() {
                // Verificamos si jQuery existe y si el documento está listo
                if (window.jQuery && document.readyState === 'complete') {
                    injectReact();
                } else {
                    attempts++;
                    if (attempts < maxRetries) {
                        // Reintentar en 100ms
                        setTimeout(checkDependencies, 100);
                    } else {
                        console.warn("⚠️ Tiempo de espera agotado para jQuery. Forzando carga de React...");
                        injectReact();
                    }
                }
            }

            // Iniciamos la comprobación
            if (document.readyState === 'complete') {
                checkDependencies();
            } else {
                window.addEventListener('load', checkDependencies);
            }
        })();
    </script>
}
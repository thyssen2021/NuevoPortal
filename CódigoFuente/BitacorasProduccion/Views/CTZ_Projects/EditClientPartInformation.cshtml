@model Portal_2_0.Models.CTZ_Projects

@{
    ViewBag.Title = "Edit Client & Part Information";
    ViewBag.PrimerNivel = "quote";
    ViewBag.SegundoNivel = "edit_client_part";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    // Captura la bandera desde el controlador
    bool isDetailsMode = ViewBag.IsDetailsMode as bool? ?? false;

    // Opcional: Cambia el título de la página si está en modo detalles
    if (isDetailsMode)
    {
        ViewBag.Title = "Details - Client & Part Information";
    }

    // ¡CLAVE! Combina los permisos con el modo de detalles.
    // Si isDetailsMode es true, todos los permisos de edición se volverán false.
    bool canEditSales = (ViewBag.CanEditSales as bool? ?? false) && !isDetailsMode;
    bool canEditDataManagement = (ViewBag.CanEditDataManagement as bool? ?? false) && !isDetailsMode;
    bool canEditEngineering = (ViewBag.CanEditEngineering as bool? ?? false) && !isDetailsMode;


}

@section estilos {
    <!-- SweetAlert2 -->
    <link href="@Url.Content("~/Content/vendors/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css")" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet" />
    <!-- DatePicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
    <!--Handsontable -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">

    <style>
        .toast {
            opacity: 0.95 !important; /* Ajusta el valor según lo que necesites */
        }

        /* Contenedor que separa claramente la sección de inputs */
        .material-form {
            border: 2px solid #009ff5; /* Borde con color corporativo */
            border-radius: 6px;
            padding: 15px;
            background-color: #f9fcff; /* Color de fondo claro para distinguir */
            margin-bottom: 30px; /* Separación de la tabla */
        }

        .material-form-title {
            color: #009ff5;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .material-form label {
            font-weight: bold;
            color: #009ff5; /* Resaltamos el texto del label con color corporativo */
        }

        .material-form .form-control {
            margin-bottom: 10px;
        }

        /* Ajustes generales de la tabla */
        .ht-like {
            border-collapse: collapse;
            width: 100%;
            border: 1px solid #ccc; /* Borde exterior */
            font-family: Arial, sans-serif; /* fuente similar a Handsontable */
        }

            /* Cabecera de la tabla */
            .ht-like thead th {
                background-color: #009ff5; /* color de fondo similar a Handsontable */
                color: #fff; /* texto en blanco */
                padding: 8px; /* algo de espaciado */
                border: 1px solid #ccc; /* bordes */
                text-align: center; /* alineación */
            }

            /* Filas del cuerpo */
            .ht-like tbody tr td {
                border: 1px solid #ccc;
                padding: 6px;
            }

            /* Alternar color de fondo en filas (opcional) */
            .ht-like tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            /* Hover en filas (opcional) */
            .ht-like tbody tr:hover {
                background-color: #e6ffe6;
            }

        /* Botón pequeño */
        .btn-xs {
            padding: 5px 10px;
            font-size: 12px;
        }

        input::placeholder {
            color: #bebbbb !important;
        }

        .btn-default {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            color: #555;
            border-radius: 3px;
            padding: 8px 15px;
        }

        /* Estilos personalizados para el tooltip */
        .tooltip-inner {
            background-color: #009ff5;
            color: #ffffff;
            font-weight: 500;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .tooltip.bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #009ff5;
        }

        .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #009ff5;
        }

        .arrow::before {
            border-left-color: #009ff5 !important;
            border-right-color: #009ff5 !important;
        }

        bs-tooltip-right .arrow::before {
        }

        /* Estilos para agrupar secciones */
        fieldset {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
        }

        legend {
            font-size: 1.2em;
            font-weight: bold;
            width: auto;
            padding: 0 10px;
            color: #009ff5;
            margin-bottom: 10px;
        }

        /* Título general del formulario */
        .material-form-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #009ff5;
        }

        /* Ejemplo de estilos para inputs */
        input.form-control, select.form-control, textarea.form-control {
            border-radius: 3px;
            border: 1px solid #ddd;
            padding: 8px;
            background-color: #fff;
            transition: border-color 0.3s ease;
        }

            input.form-control:focus, select.form-control:focus, textarea.form-control:focus {
                border-color: #009ff5;
                outline: none;
            }

        /* Opcional: estilos para mensajes de error */
        .error-message {
            font-size: 0.9em;
        }

        /* Espaciado entre filas */
        .row + .row {
            margin-top: 15px;
        }

        #archivo, #packaging_archivo, #AdditionalFile, #technicalSheetFile, #arrivalAdditionalFile,
        #coilDataAdditionalFile, #slitterDataAdditionalFile, #volumeAdditionalFile, #outboundFreightAdditionalFile, #deliveryPackagingAdditionalFile {
            display: block;
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            color: #555;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

            #archivo:hover {
                background-color: #eaeaea;
            }

        #downloadFile, #downloadPackagingFile, #downloadFileTechnicalSheetFile, #downloadFileAdditional, #downloadArrivalAdditionalFile,
        #downloadCoilDataAdditionalFile, #downloadSlitterDataAdditionalFile, #downloadVolumeAdditionalFile, #downloadOutboundFreightAdditionalFile, #downloadDeliveryPackagingAdditionalFile {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 5px 12px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }

            #downloadFile:hover {
                background-color: #218838;
            }

        .truncate-filename {
            display: inline-block; /* Permite que max-width funcione en un enlace <a> */
            max-width: 200px; /* Ancho máximo. ¡Puedes ajustar este valor! */
            white-space: nowrap; /* Evita que el texto salte a la siguiente línea */
            overflow: hidden; /* Oculta el texto que se desborda */
            text-overflow: ellipsis; /* ¡La magia! Añade los "..." */
            vertical-align: middle; /* Alinea verticalmente con los botones de al lado */
        }

        /* Texto en gris oscuro cuando está disabled */
        .select2-container--default.select2-container--disabled .select2-selection__rendered {
            color: #7d848a !important;
        }

        /* Opcional: flecha también en gris oscuro */
        .select2-container--default.select2-container--disabled .select2-selection__arrow b {
            border-color: #7d848a transparent transparent transparent !important;
        }

        #shiftLegend {
            border: solid 1px gray;
            padding-top: 8px;
            padding-bottom: 8px;
            display: none;
        }

            #shiftLegend .legend-item {
                display: inline-block;
                margin: 0 20px;
                font-size: 0.9em;
                color: #333;
            }

            #shiftLegend .legend-line {
                display: inline-block;
                width: 30px;
                height: 0;
                border-top: 2px dashed;
                margin-right: 6px;
                vertical-align: middle;
            }
        /* --- INICIO DE ESTILOS PARA PACKAGING (VERSIÓN FINAL) --- */
        .packaging-row {
            display: flex;
            flex-wrap: wrap;
        }

        .checkbox-group-container {
            display: flex; /* Permite que el contenedor se estire verticalmente */
            flex-direction: column;
        }

        .group-content-wrapper {
            border: 1px solid #ced4da;
            border-radius: .25rem;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* ¡CLAVE! Hace que este recuadro ocupe toda la altura de su columna. */
        }

        .checkbox-options-wrapper {
            padding: 10px;
            overflow-y: auto;
            /* QUITAMOS cualquier altura fija o mínima para que sea flexible */
        }

        .other-description-wrapper {
            padding: 0 10px 10px 10px;
            margin-top: auto; /* ¡MAGIA! Empuja el textarea hacia el fondo. */
            border-top: 1px solid #eee;
            padding-top: 8px;
        }

        /* Estilos para que los elementos se vean bien (sin cambios) */
        .observation-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 2px;
            font-weight: normal;
        }

        .form-check-label {
            color: #495057;
            font-weight: normal;
        }

        .limit-display {
            display: block; /* Para que ocupe su propia línea debajo del input */
            margin-top: 5px;
            font-size: 12px;
            font-style: italic;
            color: #009ff5 !important; /* Usamos tu color corporativo */
            height: 15px; /* Altura fija para que no mueva el layout */
        }
        /* --- FIN DE ESTILOS PARA PACKAGING --- */
        /* --- INICIO: Agrega estos nuevos estilos --- */
        .slitting-rule-warning {
            border-top: 3px solid #dc3545; /* Línea superior roja */
            background-color: #fef4f4; /* Fondo rojo muy claro */
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

            /* Texto principal del error */
            .slitting-rule-warning .error-text {
                color: #dc3545; /* Texto rojo */
                font-weight: 500;
                margin: 0 0 8px 0;
            }

            /* Contenedor de la tabla: quitamos la altura máxima y el scroll */
            .slitting-rule-warning .rules-table-wrapper {
                /* No se necesita ninguna regla aquí ahora */
            }

            /* Celdas de la tabla: las hacemos más compactas */
            .slitting-rule-warning .table th,
            .slitting-rule-warning .table td {
                padding: 0.25rem 0.5rem; /* Reduce el espaciado vertical y horizontal */
                font-size: 0.8rem; /* Hace la fuente un poco más pequeña */
                vertical-align: middle;
            }
        /* --- FIN DE LOS NUEVOS ESTILOS --- */
        .label-non-functional {
            color: #dc3545 !important; /* Un color rojo estándar de Bootstrap para peligro/advertencia */
            font-weight: bold;
        }

        /* --- ESTILOS PARA CHECKBOX PERSONALIZADO --- */
        .custom-checkbox-container {
            display: flex;
            align-items: center; /* Centra verticalmente el checkbox con el texto */
            position: relative;
            cursor: pointer;
            user-select: none; /* Evita que el texto se seleccione al hacer clic */
        }

            /* Oculta el checkbox original del navegador */
            .custom-checkbox-container .form-check-input {
                opacity: 0;
                cursor: pointer;
                height: 0;
                width: 0;
            }

            /* Crea el nuevo recuadro del checkbox */
            .custom-checkbox-container .form-check-label::before {
                content: '';
                display: inline-block;
                width: 20px; /* Ancho del nuevo checkbox */
                height: 20px; /* Alto del nuevo checkbox */
                margin-right: 10px;
                border: 2px solid #009ff5; /* Borde con tu color corporativo */
                border-radius: 3px;
                background-color: white;
                vertical-align: middle; /* Alineación con el texto */
            }

            /* Estilo del recuadro cuando el checkbox está seleccionado */
            .custom-checkbox-container .form-check-input:checked + .form-check-label::before {
                background-color: #009ff5; /* Fondo azul al seleccionar */
                border-color: #007fcc; /* Borde más oscuro */
            }

        /* --- ESTILOS PARA CHECKBOX PERSONALIZADO --- */
        .custom-checkbox-container {
            display: flex;
            align-items: center; /* Centra verticalmente el checkbox con el texto */
            position: relative;
            cursor: pointer;
            user-select: none; /* Evita que el texto se seleccione al hacer clic */
        }

            /* Oculta el checkbox original del navegador */
            .custom-checkbox-container .form-check-input {
                opacity: 0;
                cursor: pointer;
                height: 0;
                width: 0;
            }

            /* Haz que la etiqueta sea el punto de referencia para la palomita */
            .custom-checkbox-container .form-check-label {
                position: relative;
                padding-left: 0px; /* Pequeño ajuste para que no esté pegado al borde */
            }
                /* Crea la forma de "L" para la palomita (inicialmente oculta) */
                .custom-checkbox-container .form-check-label::after {
                    content: '';
                    position: absolute;
                    display: none;
                    left: 7px; /* Posición X dentro del recuadro */
                    top: 4px; /* Posición Y dentro del recuadro */
                    width: 6px;
                    height: 12px;
                    border: solid white;
                    border-width: 0 3px 3px 0;
                    transform: rotate(45deg); /* ¡La magia! Rota la "L" para formar la palomita */
                }

            /* Muestra la palomita cuando el checkbox está seleccionado */
            .custom-checkbox-container .form-check-input:checked + .form-check-label::after {
                display: block;
            }

        .field-warning-text {
            display: none; /* Oculto por defecto */
            color: #fd7e14; /* Color naranja para advertencias */
            font-size: 0.85em;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <fieldset class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title @isDetailsMode</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <!-- Cuadro informativo con los datos del proyecto -->
                        @{
                            // Si quieres ocultar el botón "Edit General Data":
                            ViewBag.ShowEditButton = false;
                        }
                        @Html.Partial("_CTZ_ProjectInfoCurrent", Model)

                        <!-- Form principal -->
                        @using (Html.BeginForm("EditClientPartInformation", "CTZ_Projects", FormMethod.Post, new { enctype = "multipart/form-data", id = "materialForm" }))
                        {
                            @Html.AntiForgeryToken()

                            if (!Html.ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger" role="alert">
                                    @Html.ValidationSummary("", "Advertencia:")
                                </div>
                            }

                            <!-- Hidden para el ID del proyecto -->
                            @Html.HiddenFor(model => model.ID_Project)

                            <!-- TITLE FOR THE MATERIAL FORM -->
                            <div class="material-form-title">Summary Parts Number</div>
                            <!-- TABLA DE MATERIALES -->
                            <table class="table-responsive ht-like" id="materialsTable">
                                <thead>
                                    <tr>
                                        <th nowrap>Actions</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Vehicle)</th>
                                        <th nowrap>Vehicle Version</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SOP_SP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().EOP_SP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_SOP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_EOP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To)</th>
                                        <th nowrap>Part Name</th>
                                        <th nowrap>Part Number</th>
                                        <th nowrap>Quality</th>
                                        <th nowrap>Program SP</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Tensile_Strenght)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Material_type)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Thickness)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Pitch)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Gross_Weight)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Theoretical_Blanking_Line)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Strokes)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_Strokes)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)</th>
                                        <th nowrap>Status DM</th>
                                        <th nowrap>Status DM Comment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.CTZ_Project_Materials != null && Model.CTZ_Project_Materials.Any())
                                    {
                                        var matList = Model.CTZ_Project_Materials.OrderByDescending(x => x.ID_Material).ToList();
                                        for (int i = 0; i < matList.Count; i++)
                                        {
                                            var material = matList[i];
                                            <tr data-index="@i" data-material-id="@material.ID_Material">
                                                <td nowrap>
                                                    @if (isDetailsMode)
                                                    {
                                                        <button type="button" class="btn btn-info btn-xs details-row">Details</button>
                                                    }
                                                    else
                                                    {
                                                        <button type="button" class="btn btn-warning btn-xs edit-row">Edit</button>
                                                    }

                                                    @if (canEditSales)
                                                    {
                                                        <button type="button" class="btn btn-info btn-xs copy-row">Copy</button>
                                                        <button type="button" class="btn btn-danger btn-xs remove-row">Remove</button>
                                                    }
                                                    <!-- Hidden inputs para el POST -->
                                                    <input type="hidden" name="materials[@i].ID_Material" value="@material.ID_Material" />
                                                    <input type="hidden" name="materials[@i].Vehicle" value="@material.Vehicle" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))" value="@material.Vehicle_2" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))" value="@material.Vehicle_3" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))" value="@material.Vehicle_4" />
                                                    <input type="hidden" name="materials[@i].Vehicle_version" value="@material.Vehicle_version" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))" value="@(material.SOP_SP.HasValue? material.SOP_SP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))" value="@(material.EOP_SP.HasValue? material.EOP_SP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))" value="@(material.Real_SOP.HasValue? material.Real_SOP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))" value="@(material.Real_EOP.HasValue? material.Real_EOP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))" value="@(material.Ship_To)" />
                                                    <input type="hidden" name="materials[@i].Part_Number" value="@material.Part_Number" />
                                                    <input type="hidden" name="materials[@i].Part_Name" value="@material.Part_Name" />
                                                    <input type="hidden" name="materials[@i].Quality" value="@material.Quality" />
                                                    <input type="hidden" name="materials[@i].Program_SP" value="@material.Program_SP" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))" value="@material.Max_Production_SP" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))" value="@material.Annual_Volume" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))" value="@material.Volume_Per_year" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))" value="@material.ID_Route" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))" value="@material.Tensile_Strenght" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))" value="@material.ID_Material_type" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))" value="@material.Thickness" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))" value="@material.Width" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" value="@material.Pitch" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))" value="@material.Blanks_Per_Stroke" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))" value="@material.Parts_Per_Vehicle" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))" value="@material.Theoretical_Gross_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))" value="@material.Gross_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))" value="@material.ID_Shape" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))" value="@material.Angle_A" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))" value="@material.Angle_B" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))" value="@material.ID_Real_Blanking_Line" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))" value="@material.ID_Theoretical_Blanking_Line" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))" value="@material.Theoretical_Strokes" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))" value="@material.Real_Strokes" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))" value="@material.Ideal_Cycle_Time_Per_Tool" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))" value="@material.OEE" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TonsPerShift))" value="@material.TonsPerShift" />
                                                    <input type="hidden" name="materials[@i].DM_status" data-material-id="@material.ID_Material" value="@material.DM_status" />
                                                    <input type="hidden" name="materials[@i].DM_status_comment" data-material-id="@material.ID_Material" value="@material.DM_status_comment" />
                                                    <!--Nuevos Campos -->
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))" value="@material.ThicknessToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))" value="@material.ThicknessTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))" value="@material.WidthToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))" value="@material.WidthTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))" value="@material.PitchToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))" value="@material.PitchTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))" value="@material.AngleAToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))" value="@material.AngleATolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))" value="@material.AngleBToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))" value="@material.AngleBTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))" value="@material.Multipliers" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))" value="@material.MajorBase" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))" value="@material.MajorBaseToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))" value="@material.MajorBaseTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))" value="@material.MinorBase" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))" value="@material.MinorBaseToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))" value="@material.MinorBaseTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))" value="@material.Flatness" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))" value="@material.FlatnessToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))" value="@material.FlatnessTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))" value="@material.MasterCoilWeight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))" value="@material.InnerCoilDiameterArrival" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))" value="@material.OuterCoilDiameterArrival" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))" value="@material.InnerCoilDiameterDelivery" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))" value="@material.OuterCoilDiameterDelivery" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))" value="@material.PackagingStandard" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))" value="@material.SpecialRequirement" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))" value="@material.SpecialPackaging" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))" value="@material.ID_File_CAD_Drawing" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsFile))" value="@material.IsFile" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))" value="@(material.CTZ_Files != null? material.CTZ_Files.Name : string.Empty)" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))" value="@(material.TurnOver.HasValue && material.TurnOver.Value == true ? "true" :"false")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))" value="@material.TurnOverSide" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Packaging))" value="@material.ID_File_Packaging" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsPackagingFile))" value="@material.IsPackagingFile" />
                                                    <input type="hidden" name="materials[@i].PackagingFileName" value="@(material.CTZ_Files1?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].StrapTypeObservations" value="@material.StrapTypeObservations" />
                                                    <input type="hidden" name="materials[@i].AdditionalsOtherDescription" value="@material.AdditionalsOtherDescription" />
                                                    <input type="hidden" name="materials[@i].LabelOtherDescription" value="@material.LabelOtherDescription" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))" value="@material.ID_File_TechnicalSheet" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsTechnicalSheetFile))" value="@material.IsTechnicalSheetFile" />
                                                    <input type="hidden" name="materials[@i].TechnicalSheetFileName" value="@(material.CTZ_Files2?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))" value="@material.ID_File_Additional" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsAdditionalFile))" value="@material.IsAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].AdditionalFileName" value="@(material.CTZ_Files3?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))" value="@material.ID_File_ArrivalAdditional" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsArrivalAdditionalFile))" value="@material.IsArrivalAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].ArrivalAdditionalFileName" value="@(material.CTZ_Files4?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].ID_File_CoilDataAdditional" value="@material.ID_File_CoilDataAdditional" />
                                                    <input type="hidden" name="materials[@i].IsCoilDataAdditionalFile" value="@material.IsCoilDataAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].CoilDataAdditionalFileName" value="@(material.CTZ_Files5?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].ID_File_SlitterDataAdditional" value="@material.ID_File_SlitterDataAdditional" />
                                                    <input type="hidden" name="materials[@i].IsSlitterDataAdditionalFile" value="@material.IsSlitterDataAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].SlitterDataAdditionalFileName" value="@(material.CTZ_Files6?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].ID_File_VolumeAdditional" value="@material.ID_File_VolumeAdditional" />
                                                    <input type="hidden" name="materials[@i].IsVolumeAdditionalFile" value="@material.IsVolumeAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].VolumeAdditionalFileName" value="@(material.CTZ_Files7?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].ID_File_OutboundFreightAdditional" value="@material.ID_File_OutboundFreightAdditional" />
                                                    <input type="hidden" name="materials[@i].IsOutboundFreightAdditionalFile" value="@material.IsOutboundFreightAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].OutboundFreightAdditionalFileName" value="@(material.CTZ_Files8?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].ID_File_DeliveryPackagingAdditional" value="@material.ID_File_DeliveryPackagingAdditional" />
                                                    <input type="hidden" name="materials[@i].IsDeliveryPackagingAdditionalFile" value="@material.IsDeliveryPackagingAdditionalFile" />
                                                    <input type="hidden" name="materials[@i].DeliveryPackagingAdditionalFileName" value="@(material.CTZ_Files9?.Name ?? string.Empty)" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))" value="@material.Shearing_Width" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))" value="@material.Shearing_Width_Tol_Pos" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))" value="@material.Shearing_Width_Tol_Neg" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))" value="@material.Shearing_Pitch" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))" value="@material.Shearing_Pitch_Tol_Pos" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))" value="@material.Shearing_Pitch_Tol_Neg" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))" value="@material.Shearing_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))" value="@material.Shearing_Weight_Tol_Pos" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))" value="@material.Shearing_Weight_Tol_Neg" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))" value="@material.Shearing_Pieces_Per_Stroke" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))" value="@material.Shearing_Pieces_Per_Car" />

                                                    @if (material.SelectedRackTypeIds != null)
                                                    {
                                                        foreach (var id in material.SelectedRackTypeIds)
                                                        {<input type="hidden" name="materials[@i].SelectedRackTypeIds" value="@id" />}
                                                    }
                                                    @if (material.SelectedAdditionalIds != null)
                                                    {
                                                        foreach (var id in material.SelectedAdditionalIds)
                                                        {<input type="hidden" name="materials[@i].SelectedAdditionalIds" value="@id" />}
                                                    }
                                                    @if (material.SelectedLabelIds != null)
                                                    {
                                                        foreach (var id in material.SelectedLabelIds)
                                                        {<input type="hidden" name="materials[@i].SelectedLabelIds" value="@id" />}
                                                    }
                                                    @if (material.SelectedStrapTypeIds != null)
                                                    {
                                                        foreach (var id in material.SelectedStrapTypeIds)
                                                        {<input type="hidden" name="materials[@i].SelectedStrapTypeIds" value="@id" />}
                                                    }
                                                    <!-- Nuevos anchos -->
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))" value="@material.Width_Mults" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))" value="@material.Width_Mults_Tol_Neg" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))" value="@material.Width_Mults_Tol_Pos" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))" value="@material.Width_Plates" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))" value="@material.Width_Plates_Tol_Neg" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))" value="@material.Width_Plates_Tol_Pos" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))" value="@material.ID_Coil_Position" />
                                                    <input type="hidden" name="materials[@i].ID_Arrival_Transport_Type" value="@material.ID_Arrival_Transport_Type" />
                                                    <input type="hidden" name="materials[@i].ID_Arrival_Packaging_Type" value="@material.ID_Arrival_Packaging_Type" />
                                                    <input type="hidden" name="materials[@i].ID_Arrival_Protective_Material" value="@material.ID_Arrival_Protective_Material" />
                                                    <input type="hidden" name="materials[@i].Arrival_Protective_Material_Other" value="@material.Arrival_Protective_Material_Other" />
                                                    <input type="hidden" name="materials[@i].Is_By_Container" value="@(material.Is_By_Container.HasValue && material.Is_By_Container.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].Is_Stackable" value="@(material.Is_Stackable.HasValue && material.Is_Stackable.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].Stackable_Levels" value="@material.Stackable_Levels" />
                                                    <input type="hidden" name="materials[@i].Arrival_Comments" value="@material.Arrival_Comments" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))" value="@material.Arrival_Transport_Type_Other" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))" value="@material.AnnualTonnage" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))" value="@material.PiecesPerPackage" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))" value="@material.StacksPerPackage" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))" value="@material.PackageWeight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))" value="@material.DeliveryConditions" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))" value="@(material.IsReturnableRack.HasValue && material.IsReturnableRack.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))" value="@material.ReturnableUses" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))" value="@material.ID_Delivery_Coil_Position" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))" value="@material.ID_Delivery_Transport_Type" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))" value="@material.Delivery_Transport_Type_Other" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))" value="@material.ID_FreightType" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))" value="@material.ID_Arrival_Warehouse" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))" value="@material.ClientNetWeight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))" value="@(material.IsRunningChange.HasValue && material.IsRunningChange.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].IsWeldedBlank" value="@(material.IsWeldedBlank.HasValue && material.IsWeldedBlank.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].NumberOfPlates" value="@material.NumberOfPlates" />
                                                    <input type="hidden" name="materials[@i].WeldedPlatesJson" value="@material.WeldedPlatesJson" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))" value="@(material.ScrapReconciliation.HasValue && material.ScrapReconciliation.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))" value="@material.ScrapReconciliationPercent" />
                                                    <input type="hidden" name="materials[@i].ScrapReconciliationPercent_Min" value="@material.ScrapReconciliationPercent_Min" />
                                                    <input type="hidden" name="materials[@i].ScrapReconciliationPercent_Max" value="@material.ScrapReconciliationPercent_Max" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))" value="@(material.HeadTailReconciliation.HasValue && material.HeadTailReconciliation.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))" value="@material.HeadTailReconciliationPercent" />
                                                    <input type="hidden" name="materials[@i].HeadTailReconciliationPercent_Min" value="@material.HeadTailReconciliationPercent_Min" />
                                                    <input type="hidden" name="materials[@i].HeadTailReconciliationPercent_Max" value="@material.HeadTailReconciliationPercent_Max" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))" value="@material.WeightOfFinalMults" />
                                                    <input type="hidden" name="materials[@i].WeightOfFinalMults_Min" value="@material.WeightOfFinalMults_Min" />
                                                    <input type="hidden" name="materials[@i].WeightOfFinalMults_Max" value="@material.WeightOfFinalMults_Max" />
                                                    <input type="hidden" name="materials[@i].PassesThroughSouthWarehouse" value="@(material.PassesThroughSouthWarehouse.HasValue && material.PassesThroughSouthWarehouse.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].ClientScrapReconciliationPercent" value="@material.ClientScrapReconciliationPercent" />
                                                    <input type="hidden" name="materials[@i].ClientHeadTailReconciliationPercent" value="@material.ClientHeadTailReconciliationPercent" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))" value="@(material.IsCarryOver.HasValue && material.IsCarryOver.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))" value="@(material.RequiresRackManufacturing.HasValue && material.RequiresRackManufacturing.Value ? "true" : "false")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))" value="@(material.RequiresDieManufacturing.HasValue && material.RequiresDieManufacturing.Value ? "true" : "false")" />
                                                </td>
                                                <td nowrap>@Html.DisplayFor(model => material.Vehicle)</td>
                                                <td nowrap>@material.Vehicle_version</td>
                                                <td nowrap>@(material.SOP_SP.HasValue? material.SOP_SP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@(material.EOP_SP.HasValue? material.EOP_SP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@(material.Real_SOP.HasValue? material.Real_SOP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@(material.Real_EOP.HasValue? material.Real_EOP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@material.Ship_To</td>
                                                <td nowrap>@material.Part_Name</td>
                                                <td nowrap>@material.Part_Number</td>
                                                <td nowrap>@material.Quality</td>
                                                <td nowrap>@material.Program_SP</td>
                                                <td nowrap>@material.Max_Production_SP</td>
                                                <td nowrap>@material.Annual_Volume</td>
                                                <td nowrap>@material.Volume_Per_year</td>
                                                <td nowrap>@(material.CTZ_Route != null ? material.CTZ_Route.Route_Name : "")</td>
                                                <td nowrap>@material.Tensile_Strenght</td>
                                                <td nowrap>@(material.CTZ_Material_Type != null ? material.CTZ_Material_Type.Material_Name : "")</td>
                                                <td nowrap>@material.Thickness</td>
                                                <td nowrap>@material.Width</td>
                                                <td nowrap>@material.Pitch</td>
                                                <td nowrap>@material.Blanks_Per_Stroke</td>
                                                <td nowrap>@material.Parts_Per_Vehicle</td>
                                                <td nowrap>@material.Theoretical_Gross_Weight</td>
                                                <td nowrap>@material.Gross_Weight</td>
                                                <td nowrap>@(material.SCDM_cat_forma_material != null ? material.SCDM_cat_forma_material.ConcatKey : "")</td>
                                                <td nowrap>@material.Angle_A</td>
                                                <td nowrap>@material.Angle_B</td>
                                                <td nowrap>@(material.CTZ_Production_Lines != null ? material.CTZ_Production_Lines.Description : "")</td>
                                                <td nowrap>@(material.CTZ_Production_Lines1 != null ? material.CTZ_Production_Lines1.Description : "")</td>
                                                <td nowrap>@material.Theoretical_Strokes</td>
                                                <td nowrap>@material.Real_Strokes</td>
                                                <td nowrap>@material.Ideal_Cycle_Time_Per_Tool</td>
                                                <td nowrap>@material.OEE</td>
                                                <td nowrap class="dm-status-cell" data-material-id="@material.ID_Material"> @material.DM_status</td>
                                                <td nowrap class="dm-status-comment-cell" data-material-id="@material.ID_Material"> @material.DM_status_comment</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>

                            <br />

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Part Number Information</div>

                                <input type="hidden" id="materialIndex" value="" />
                                <input type="hidden" id="materialId" value="" />
                                <input type="hidden" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))" value="" />
                                <input type="hidden" id="CADFileName" value="" />
                                <input type="hidden" id="ID_File_Packaging" value="" />
                                <input type="hidden" id="PackagingFileName" value="" />
                                <input type="hidden" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))" value="" />
                                <input type="hidden" id="TechnicalSheetFileName" value="" />
                                <input type="hidden" id="ID_File_Additional" value="" />
                                <input type="hidden" id="AdditionalFileName" value="" />
                                <input type="hidden" id="ID_File_ArrivalAdditional" value="" />
                                <input type="hidden" id="ArrivalAdditionalFileName" value="" />
                                <input type="hidden" id="ID_File_CoilDataAdditional" value="" />
                                <input type="hidden" id="CoilDataAdditionalFileName" value="" />
                                <input type="hidden" id="ID_File_SlitterDataAdditional" value="" />
                                <input type="hidden" id="SlitterDataAdditionalFileName" value="" />
                                <input type="hidden" id="ID_File_VolumeAdditional" value="" />
                                <input type="hidden" id="VolumeAdditionalFileName" value="" />
                                <input type="hidden" id="ID_File_OutboundFreightAdditional" value="" />
                                <input type="hidden" id="OutboundFreightAdditionalFileName" value="" />
                                <input type="hidden" id="ID_File_DeliveryPackagingAdditional" value="" />
                                <input type="hidden" id="DeliveryPackagingAdditionalFileName" value="" />
                                <input type="hidden" id="weldedPlatesJson" value="" />

                                <!-- VEHICLE INFORMATION -->
                                <fieldset class="mb-3" disabled="@isDetailsMode">
                                    <legend>Vehicle Information</legend>
                                    <div class="row">
                                        @if (Model.ID_VehicleType.HasValue && Model.ID_VehicleType.Value == 1)
                                        {
                                            <div class="col-md-4">
                                                <label for="ihsCountry1">S&P Country</label>
                                                @if (canEditSales)
                                                {
                                                    @Html.DropDownList("ihsCountry1", (IEnumerable<SelectListItem>)ViewBag.IHSCountries, new { @class = "form-control select2 ihs-country-selector", data_target_vehicle = "#Vehicle" })
                                                }
                                                else
                                                {
                                                    @Html.DropDownList("ihsCountry1", (IEnumerable<SelectListItem>)ViewBag.IHSCountries, new { @class = "form-control select2 ihs-country-selector", data_target_vehicle = "#Vehicle", @disabled = "disabled" })
                                                }
                                            </div>
                                            <div class="col-md-6">
                                                <label>
                                                    Vehicle
                                                    <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="Select a vehicle from the list."></i>
                                                </label>
                                                <select id="Vehicle" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value" data-sop="@item.SOP" data-eop="@item.EOP"
                                                                data-program="@item.Program" data-maxproduction="@item.MaxProduction"
                                                                data-productionjson='@item.ProductionDataJson'>
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                                <span id="VehicleError" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                            <div class="col-md-4 vehicle-row-2">
                                                <label for="ihsCountry2">S&P Country</label>
                                                @if (canEditSales)
                                                {
                                                    @Html.DropDownList("ihsCountry2", (IEnumerable<SelectListItem>)ViewBag.IHSCountries, new { @class = "form-control select2 ihs-country-selector", data_target_vehicle = "#Vehicle_2" })
                                                }
                                                else
                                                {
                                                    @Html.DropDownList("ihsCountry2", (IEnumerable<SelectListItem>)ViewBag.IHSCountries, new { @class = "form-control select2 ihs-country-selector", data_target_vehicle = "#Vehicle_2", @disabled = "disabled" })
                                                }
                                            </div>
                                            <div class="col-md-6 vehicle-row-2">
                                                <label>Vehicle 2</label>
                                                <select id="Vehicle_2" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value" data-sop="@item.SOP" data-eop="@item.EOP"
                                                                data-program="@item.Program" data-maxproduction="@item.MaxProduction"
                                                                data-productionjson='@item.ProductionDataJson'>
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                            </div>

                                            <div class="col-md-4 vehicle-row-3">
                                                <label for="ihsCountry3">S&P Country</label>
                                                @if (canEditSales)
                                                {
                                                    @Html.DropDownList("ihsCountry3", (IEnumerable<SelectListItem>)ViewBag.IHSCountries, new { @class = "form-control select2 ihs-country-selector", data_target_vehicle = "#Vehicle_3" })
                                                }
                                                else
                                                {
                                                    @Html.DropDownList("ihsCountry3", (IEnumerable<SelectListItem>)ViewBag.IHSCountries, new { @class = "form-control select2 ihs-country-selector", data_target_vehicle = "#Vehicle_3", @disabled = "disabled" })
                                                }
                                            </div>
                                            <div class="col-md-6 vehicle-row-3">
                                                <label>Vehicle 3</label>
                                                <select id="Vehicle_3" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value" data-sop="@item.SOP" data-eop="@item.EOP"
                                                                data-program="@item.Program" data-maxproduction="@item.MaxProduction"
                                                                data-productionjson='@item.ProductionDataJson'>
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                            </div>

                                            <div class="col-md-6" style="display:none">
                                                <label>Vehicle 4</label>
                                                <select id="Vehicle_4" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value" data-sop="@item.SOP" data-eop="@item.EOP"
                                                                data-program="@item.Program" data-maxproduction="@item.MaxProduction"
                                                                data-productionjson='@item.ProductionDataJson'>
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                            </div>
                                        }
                                        else
                                        {
                                            // El caso para vehículos no automotrices no cambia
                                            <div class="col-md-8">
                                                <label>
                                                    Vehicle
                                                    <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="Enter the vehicle name."></i>
                                                </label>
                                                <input type="text" id="Vehicle" name="Vehicle" class="form-control" placeholder="Enter Vehicle" maxlength="120" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                <span id="VehicleError" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                        }

                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label>Vehicle Version</label>
                                            <input type="text" id="vehicleVersion" class="form-control" placeholder="Vehicle Version" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="vehicleVersionError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-2">
                                            <label>Program SP</label>
                                            <input type="text" id="programSP" class="form-control" placeholder="Program SP" readonly />
                                        </div>
                                        <div class="col-md-3 d-flex align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isRunningChange" @(!canEditSales ? "disabled" : "")>
                                                <label class="form-check-label" for="isRunningChange">
                                                    Is Running Change?
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-center" id="IsCarryOver_container">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="IsCarryOver" @(!canEditSales ? "disabled" : "")>
                                                <label class="form-check-label" for="IsCarryOver">
                                                    Is Carry Over?
                                                </label>
                                                <span id="IsCarryOverError" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- PRODUCTION & SHIPPING DATES -->
                                <fieldset class="mb-3">
                                    <legend>Production & Route</legend>
                                    <div class="row">
                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SOP_SP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Planned Start Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))" class="form-control" placeholder="yyyy-MM" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().EOP_SP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Planned End Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))" class="form-control" placeholder="yyyy-MM" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Real_SOP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Actual Start Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text"
                                                   id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"
                                                   name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"
                                                   class="form-control"
                                                   placeholder="yyyy‑MM"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Real_EOP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Actual End Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text"
                                                   id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"
                                                   name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"
                                                   class="form-control"
                                                   placeholder="yyyy‑MM"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To)</label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))" class="form-control" placeholder="Ship To" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-4">
                                            <label>Part Name</label>
                                            <input type="text" id="partName" class="form-control" placeholder="Part Name" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="partNameError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Part Number</label>
                                            <input type="text" id="partNumber" class="form-control" placeholder="Part Number" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="partNumberError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)</label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route)</label>
                                            @if (canEditSales) //enabled
                                            {
                                                @Html.DropDownList("ID_Route", new SelectList(ViewBag.ID_RouteList, "Value", "Text"), "Select a Route", new { @class = "form-control select2", id = "ID_Route" })
                                            }
                                            else //disabled
                                            {
                                                @Html.DropDownList("ID_Route", new SelectList(ViewBag.ID_RouteList, "Value", "Text"), "Select a Route", new { @class = "form-control select2", id = "ID_Route", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- COIL INFORMATION -->
                                <fieldset class="mb-3">
                                    <legend>Coil Data</legend>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))_container" class="col-md-3">
                                            <label>Quality</label>
                                            <select id="quality" name="quality" class="form-control select2-quality" @(!canEditSales ? "disabled" : String.Empty)></select>
                                            <span id="qualityError" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Material_type)</label>
                                            @if (canEditSales) //enabled
                                            {
                                                @Html.DropDownList("ID_Material_type", (SelectList)ViewBag.MaterialTypeList, "Select Material Type", new { @class = "form-control select2" })
                                            }
                                            else //disabled
                                            {
                                                @Html.DropDownList("ID_Material_type", (SelectList)ViewBag.MaterialTypeList, "Select Material Type", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))_container" class="col-md-2">
                                            @Html.LabelFor(model => model.CTZ_Project_Materials.First().Tensile_Strenght)
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))" class="form-control" placeholder="Tensile Strength" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <small id="tensil-limit-display" class="form-text text-muted limit-display"></small>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))_container" class="col-md-2">
                                            @Html.LabelFor(model => model.CTZ_Project_Materials.First().Thickness)
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))" class="form-control" placeholder="Thickness" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <small id="thickness-limit-display" class="form-text text-muted limit-display"></small>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))_container" class="col-md-2">
                                            @Html.LabelFor(model => model.CTZ_Project_Materials.First().Width)
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))" class="form-control" placeholder="Width" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <small id="width-limit-display" class="form-text text-muted limit-display"></small>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MasterCoilWeight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MasterCoilWeight)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterArrival)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterArrival)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterArrival)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterArrival)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="file_container_coilDataAdditionalFile" class="col-md-4">
                                            <label for="coilDataAdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_CoilDataAdditional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="coilDataAdditionalFile" name="coilDataAdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <button type="button" class="btn btn-danger btn-sm" id="coilDataAdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="coilDataAdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="fileActions_containerCoilDataAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_CoilDataAdditional)</label>
                                            <div class="col-md-12">
                                                <a id="downloadCoilDataAdditionalFile" href="#" class="truncate-filename">Download File</a>
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileCoilDataAdditionalFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- Slitter Data -->
                                <fieldset class="mb-3">
                                    <legend>Slitter Data</legend>
                                    <div id="slittingRuleError" class="slitting-rule-warning" style="display: none;">
                                        <p class="error-text">
                                            <i class="fa fa-times-circle"></i>
                                            <strong>Rule Not Found:</strong> No valid slitting rule for the current Thickness/Tensile.
                                        </p>
                                        <div class="rules-table-wrapper">
                                            @if (ViewBag.SlittingRules != null && ((List<Portal_2_0.Controllers.SlittingRuleViewModel>)ViewBag.SlittingRules).Any())
                                            {
                                                <table class="table table-bordered table-sm">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th>Slitter</th>
                                                            <th>Thickness</th>
                                                            <th>Tensile (TS)</th>
                                                            <th>Width</th>
                                                            <th>Max. Strips</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var rule in (List<Portal_2_0.Controllers.SlittingRuleViewModel>)ViewBag.SlittingRules)
                                                        {
                                                            <tr>
                                                                <td>@rule.LineName</td>
                                                                <td>@rule.ThicknessRange</td>
                                                                <td>@rule.TensileRange</td>
                                                                <td>@rule.WidthRange</td>
                                                                <td>@rule.MaxStrips</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Multipliers)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Multipliers)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <small id="mults-limit-display" class="form-text text-muted limit-display"></small>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width_Mults)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))" class="form-control" placeholder="Mults Width" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width_Mults_Tol_Neg)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))" class="form-control" placeholder="Tol. (-)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width_Mults_Tol_Pos)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))" class="form-control" placeholder="Tol. (+)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="WeightOfFinalMults_Min_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WeightOfFinalMults_Min)</label>
                                            <input type="number" step="any" id="WeightOfFinalMults_Min" class="form-control" placeholder="Min" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="WeightOfFinalMults_MinError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WeightOfFinalMults)</label>
                                            <input type="number" step="any" id="WeightOfFinalMults" class="form-control" placeholder="Optimal" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="WeightOfFinalMultsError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="WeightOfFinalMults_Max_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WeightOfFinalMults_Max)</label>
                                            <input type="number" step="any" id="WeightOfFinalMults_Max" class="form-control" placeholder="Max" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="WeightOfFinalMults_MaxError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterDelivery)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterDelivery)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterDelivery)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterDelivery)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="file_container_slitterDataAdditionalFile" class="col-md-4">
                                            <label for="slitterDataAdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_SlitterDataAdditional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="slitterDataAdditionalFile" name="slitterDataAdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <button type="button" class="btn btn-danger btn-sm" id="slitterDataAdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="slitterDataAdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="fileActions_containerSlitterDataAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_SlitterDataAdditional)</label>
                                            <div class="col-md-12">
                                                <a id="downloadSlitterDataAdditionalFile" href="#" class="truncate-filename">Download File</a>
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileSlitterDataAdditionalFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- Shearing -->
                                <fieldset class="mb-3">
                                    <legend>Shearing Data</legend>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Width)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))" class="form-control" placeholder="Shearing Width" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Width_Tol_Pos)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))" class="form-control" placeholder="Tol. Pos" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Width_Tol_Neg)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))" class="form-control" placeholder="Tol. Neg" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Pitch)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))" class="form-control" placeholder="Shearing Pitch" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Pitch_Tol_Pos)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))" class="form-control" placeholder="Tol. Pos" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Pitch_Tol_Neg)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))" class="form-control" placeholder="Tol. Neg" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Weight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))" class="form-control" placeholder="Shearing Weight" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Weight_Tol_Pos)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))" class="form-control" placeholder="Tol. Pos" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Weight_Tol_Neg)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))" class="form-control" placeholder="Tol. Neg" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Pieces_Per_Stroke)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))" class="form-control" placeholder="Pieces / Stroke" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Shearing_Pieces_Per_Car)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))" name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))" class="form-control" placeholder="Pieces / Car" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>


                                <!-- Blank Data -->
                                <fieldset id="blankDataDiv" class="mb-3">
                                    <legend>Blank Data</legend>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape)</label>
                                            @if (canEditSales) //enabled
                                            {
                                                @Html.DropDownList("ID_Shape", (SelectList)ViewBag.ShapeList, "Select Shape", new { @class = "form-control select2" })
                                            }
                                            else //disabled
                                            {
                                                @Html.DropDownList("ID_Shape", (SelectList)ViewBag.ShapeList, "Select Shape", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width_Plates)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))" class="form-control" placeholder="Plates Width" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width_Plates_Tol_Neg)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))" class="form-control" placeholder="Tol. (-)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width_Plates_Tol_Pos)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))" class="form-control" placeholder="Tol. (+)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))_container" class="col-md-2">
                                            @Html.LabelFor(model => model.CTZ_Project_Materials.First().Pitch)
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" class="form-control" placeholder="Pitch" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <small id="pitch-limit-display" class="form-text text-muted limit-display"></small>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Flatness)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Flatness)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessToleranceNegative)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessTolerancePositive)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))" class="form-control" placeholder="Blanks Per Stroke" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))" class="form-control" placeholder="Parts Per Vehicle" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Gross_Weight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))" class="form-control" placeholder="Theoretical Gross Weight" min="0" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))" class="form-control" placeholder="Gross Weight" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))_container" class="col-md-2">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ClientNetWeight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))" class="form-control" placeholder="Client Net Weight" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))Error" class="error-message" style="color: red; display: none;"></span>
                                            <span id="runningChangeWarning" class="field-warning-text">For a Running Change, this value should be entered.</span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))" class="form-control" placeholder="Angle A" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleAToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleAToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleATolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleATolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))" class="form-control" placeholder="Angle B" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBase)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBase)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseToleranceNegative)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseTolerancePositive)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBase)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBase)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseToleranceNegative)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseTolerancePositive)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))_container" class="col-md-1">
                                            <label class="form-check-label"
                                                   for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))">
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().TurnOver)
                                            </label>

                                            @* El label dentro de form-check para que al hacer clic active el checkbox *@
                                            @if (canEditSales)
                                            {
                                                <input class="form-check-input form-control"
                                                       type="checkbox"
                                                       id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))" />
                                            }
                                            else
                                            {
                                                <input class="form-check-input form-control"
                                                       type="checkbox"
                                                       id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))"
                                                       disabled="disabled" />
                                            }

                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;">
                                            </span>
                                        </div>


                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))_container" class="col-md-2">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))">
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().TurnOverSide)
                                            </label>

                                            @if (canEditSales)
                                            {
                                                <select id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))"
                                                        name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))"
                                                        class="form-control select2">
                                                    <option value="">Select an option</option>
                                                    <option value="Left">Left</option>
                                                    <option value="Right">Right</option>
                                                </select>
                                            }
                                            else
                                            {
                                                <select id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))"
                                                        name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))"
                                                        class="form-control select2" disabled="disabled">
                                                    <option value="">Select an option</option>
                                                    <option value="Left">Left</option>
                                                    <option value="Right">Right</option>
                                                </select>
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))_container" class="col-md-1">
                                            <label class="form-check-label"
                                                   for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))">
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().IsWeldedBlank)
                                            </label>

                                            @* El label dentro de form-check para que al hacer clic active el checkbox *@
                                            @if (canEditSales)
                                            {
                                                <input class="form-check-input form-control"
                                                       type="checkbox"
                                                       id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))" />
                                            }
                                            else
                                            {
                                                <input class="form-check-input form-control"
                                                       type="checkbox"
                                                       id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))"
                                                       disabled="disabled" />
                                            }

                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;">
                                            </span>
                                        </div>

                                        @*<div id="IsWeldedBlank_container" class="col-md-2 d-flex align-items-center">
                                                <div class="form-check custom-checkbox-container">
                                                    @if (canEditSales)
                                                    {
                                                    <input class="form-check-input" type="checkbox" id="IsWeldedBlank" @(canEditSales ? "" : "disabled")>
                                                    }else{
                                                    }
                                                    <label class="form-check-label" for="IsWeldedBlank">
                                                        Is Welded Blank?
                                                    </label>
                                                </div>
                                            </div>*@
                                        <div class="col-md-3" id="numberOfPlates_container" style="display: none;">
                                            <label for="numberOfPlates">Number of plates</label>
                                            <input type="number" id="numberOfPlates" class="form-control" placeholder="Enter number" min="2" @(canEditSales ? "" : "readonly") />

                                            <span id="numberOfPlatesError" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="" id="weldedPlatesThickness_container" style="display: none;">
                                        </div>


                                        <div id="cat_file_container" class="col-md-4">
                                            <label>CAD Drawings (C)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="archivo" name="archivo" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-danger btn-sm" id="cancelFileButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="CADFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <!-- Contenedor para las acciones sobre el archivo existente -->
                                        <div id="fileActions_container" class="col-md-4" style="display: none;">
                                            <label>CAD Drawings</label>
                                            <div class="col-md-12">
                                                <!-- Enlace para descargar; el href se asignará dinámicamente (o se puede generar en el servidor) -->
                                                <a id="downloadFile" href="#" class="truncate-filename">Descargar Archivo</a>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileButton" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>

                                        <div id="file_container_technicalSheetFile" class="col-md-4">
                                            <label for="technicalSheetFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_TechnicalSheet)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="technicalSheetFile" name="technicalSheetFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-danger btn-sm" id="technicalSheetFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="technicalSheetFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <!-- Contenedor para las acciones sobre el archivo existente -->
                                        <div id="fileActions_containerTechnicalSheetFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_TechnicalSheet)</label>
                                            <div class="col-md-12">
                                                <!-- Enlace para descargar; el href se asignará dinámicamente (o se puede generar en el servidor) -->
                                                <a id="downloadFileTechnicalSheetFile" href="#" class="truncate-filename">Download File</a>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileButtonTechnicalSheetFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>

                                        <div id="file_container_AdditionalFile" class="col-md-4">
                                            <label for="AdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_Additional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="AdditionalFile" name="AdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-danger btn-sm" id="AdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="AdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <!-- Contenedor para las acciones sobre el archivo existente -->
                                        <div id="fileActions_containerAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_Additional)</label>
                                            <div class="col-md-12">
                                                <!-- Enlace para descargar; el href se asignará dinámicamente (o se puede generar en el servidor) -->
                                                <a id="downloadFileAdditional" href="#" class="truncate-filename">Download File</a>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileAdditional" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>


                                    </div>
                                </fieldset>

                                <!-- Volume -->
                                <fieldset class="mb-3">
                                    <legend>Volume</legend>
                                    <div class="row">

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)</label>

                                            <input type="text"
                                                   inputmode="numeric"
                                                   pattern="[0-9]*"
                                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                                   id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))"
                                                   class="form-control"
                                                   placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)"
                                                   min="0"
                                                   autocomplete="off"
                                                   @(canEditSales ? "" : "readonly") />

                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="WeightPerPart_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WeightPerPart)</label>
                                            <input type="text" id="WeightPerPart" class="form-control" placeholder="Weight per Part" readonly />
                                            <span id="WeightPerPartError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Initial_Weight)</label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Initial_Weight)" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))_container" class="col-md-2">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AnnualTonnage)</label>
                                            <input type="number" step="any"
                                                   id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))"
                                                   class="form-control"
                                                   placeholder="Annual Tonnage"
                                                   readonly /> <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="file_container_volumeAdditionalFile" class="col-md-4">
                                            <label for="volumeAdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_VolumeAdditional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="volumeAdditionalFile" name="volumeAdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <button type="button" class="btn btn-danger btn-sm" id="volumeAdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="volumeAdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="fileActions_containerVolumeAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_VolumeAdditional)</label>
                                            <div class="col-md-12">
                                                <a id="downloadVolumeAdditionalFile" href="#" class="truncate-filename">Download File</a>
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileVolumeAdditionalFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="mb-3">
                                    <legend>Outbound Freight & Conditions</legend>

                                    <div class="row">
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_FreightType)</label>
                                            @if (canEditSales)
                                            {
                                                @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType), (SelectList)ViewBag.FreightTypeList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType), (SelectList)ViewBag.FreightTypeList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-9" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().DeliveryConditions)</label>
                                            <textarea id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))" class="form-control" rows="1" placeholder="Describe delivery conditions..." @(canEditSales ? "" : "readonly")></textarea>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-2 d-flex align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))" @(canEditSales ? "" : "disabled")>
                                                <label class="form-check-label" for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))">
                                                    @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().IsReturnableRack)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))_container" style="display: none;">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ReturnableUses)</label>
                                            <input type="number" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))" class="form-control" placeholder="e.g., 5" min="0" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-2 d-flex align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))" @(canEditSales ? "" : "disabled")>
                                                <label class="form-check-label" for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))">
                                                    @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ScrapReconciliation)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-9" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))_container" style="display: none;">
                                            <div class="row">
                                                <div id="ScrapReconciliationPercent_Min_container" class="col-md-3">
                                                    <label for="ScrapReconciliationPercent_Min">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ScrapReconciliationPercent_Min)</label>
                                                    <input type="number" step="any" id="ScrapReconciliationPercent_Min" class="form-control" placeholder="Min %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="ScrapReconciliationPercent_MinError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="ScrapReconciliationPercent_Optimal_container" class="col-md-3">
                                                    <label for="ScrapReconciliationPercent">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ScrapReconciliationPercent)</label>
                                                    <input type="number" step="any" id="ScrapReconciliationPercent" class="form-control" placeholder="Optimal %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="ScrapReconciliationPercentError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="ScrapReconciliationPercent_Max_container" class="col-md-3">
                                                    <label for="ScrapReconciliationPercent_Max">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ScrapReconciliationPercent_Max)</label>
                                                    <input type="number" step="any" id="ScrapReconciliationPercent_Max" class="form-control" placeholder="Max %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="ScrapReconciliationPercent_MaxError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="ClientScrapReconciliationPercent_container" class="col-md-3">
                                                    <label for="ClientScrapReconciliationPercent">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ClientScrapReconciliationPercent)</label>
                                                    <input type="number" step="any" id="ClientScrapReconciliationPercent" class="form-control" placeholder="Client %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="ClientScrapReconciliationPercentError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-md-2 d-flex align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))" @(canEditSales ? "" : "disabled")>
                                                <label class="form-check-label" for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))">
                                                    @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().HeadTailReconciliation)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-9" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))_container" style="display: none;">
                                            <div class="row">
                                                <div id="HeadTailReconciliationPercent_Min_container" class="col-md-3">
                                                    <label for="HeadTailReconciliationPercent_Min">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().HeadTailReconciliationPercent_Min)</label>
                                                    <input type="number" step="any" id="HeadTailReconciliationPercent_Min" class="form-control" placeholder="Min %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="HeadTailReconciliationPercent_MinError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="HeadTailReconciliationPercent_Optimal_container" class="col-md-3">
                                                    <label for="HeadTailReconciliationPercent">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().HeadTailReconciliationPercent)</label>
                                                    <input type="number" step="any" id="HeadTailReconciliationPercent" class="form-control" placeholder="Optimal %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="HeadTailReconciliationPercentError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="HeadTailReconciliationPercent_Max_container" class="col-md-3">
                                                    <label for="HeadTailReconciliationPercent_Max">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().HeadTailReconciliationPercent_Max)</label>
                                                    <input type="number" step="any" id="HeadTailReconciliationPercent_Max" class="form-control" placeholder="Max %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="HeadTailReconciliationPercent_MaxError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="ClientHeadTailReconciliationPercent_container" class="col-md-3">
                                                    <label for="ClientHeadTailReconciliationPercent">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ClientHeadTailReconciliationPercent)</label>
                                                    <input type="number" step="any" id="ClientHeadTailReconciliationPercent" class="form-control" placeholder="Client %" min="0" max="100" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                    <span id="ClientHeadTailReconciliationPercentError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div id="file_container_outboundFreightAdditionalFile" class="col-md-4">
                                            <label for="outboundFreightAdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_OutboundFreightAdditional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="outboundFreightAdditionalFile" name="outboundFreightAdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <button type="button" class="btn btn-danger btn-sm" id="outboundFreightAdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="outboundFreightAdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="fileActions_containerOutboundFreightAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_OutboundFreightAdditional)</label>
                                            <div class="col-md-12">
                                                <a id="downloadOutboundFreightAdditionalFile" href="#" class="truncate-filename">Download File</a>
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileOutboundFreightAdditionalFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="mb-3">
                                    <legend>Arrival Packaging</legend>

                                    <div class="row">
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))_container">
                                            <label>
                                                Coil Position
                                            </label>
                                            @if (canEditSales)
                                            {
                                                @Html.DropDownList("ID_Coil_Position", (SelectList)ViewBag.CoilPositionList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList("ID_Coil_Position", (SelectList)ViewBag.CoilPositionList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3" id="ID_Arrival_Transport_Type_container">
                                            <label for="ID_Arrival_Transport_Type">Transport Type</label>
                                            @if (canEditSales)
                                            {
                                                @Html.DropDownList("ID_Arrival_Transport_Type", (SelectList)ViewBag.ArrivalTransportTypeList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList("ID_Arrival_Transport_Type", (SelectList)ViewBag.ArrivalTransportTypeList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="ID_Arrival_Transport_TypeError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3" id="Arrival_Transport_Type_Other_container" style="display: none;">
                                            <label for="Arrival_Transport_Type_Other">Specify "Other" Transport</label>
                                            <input type="text" id="Arrival_Transport_Type_Other" class="form-control"
                                                   placeholder="Specify transport..." maxlength="50"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="Arrival_Transport_Type_OtherError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3" id="ID_Arrival_Packaging_Type_container">
                                            <label for="ID_Arrival_Packaging_Type">Packaging Type</label>
                                            @if (canEditSales) // O el permiso que corresponda
                                            {
                                                @Html.DropDownList("ID_Arrival_Packaging_Type", (SelectList)ViewBag.RackTypeList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList("ID_Arrival_Packaging_Type", (SelectList)ViewBag.RackTypeList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="ID_Arrival_Packaging_TypeError" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-3" id="ID_Arrival_Protective_Material_container">
                                            <label for="ID_Arrival_Protective_Material">Protective Material</label>
                                            @if (canEditSales) // O el permiso que corresponda
                                            {
                                                @Html.DropDownList("ID_Arrival_Protective_Material", (SelectList)ViewBag.AdditionalList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList("ID_Arrival_Protective_Material", (SelectList)ViewBag.AdditionalList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="ID_Arrival_Protective_MaterialError" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-3" id="Arrival_Protective_Material_Other_container" style="display: none;">
                                            <label for="Arrival_Protective_Material_Other">Specify "Other" Material</label>
                                            <input type="text" id="Arrival_Protective_Material_Other" class="form-control"
                                                   placeholder="Specify material..." maxlength="120"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="Arrival_Protective_Material_OtherError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>

                                    <div class="row" style="margin-top: 15px;">
                                        <div class="col-md-3" id="Is_By_Container_container">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="Is_By_Container" @(canEditSales ? "" : "disabled")>
                                                <label class="form-check-label" for="Is_By_Container">
                                                    By Container?
                                                </label>
                                            </div>
                                        </div>

                                        <div class="col-md-3" id="Is_Stackable_container">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="Is_Stackable" @(canEditSales ? "" : "disabled")>
                                                <label class="form-check-label" for="Is_Stackable">
                                                    Is it stackable?
                                                </label>
                                            </div>
                                        </div>

                                        <div class="col-md-3" id="Stackable_Levels_container" style="display: none;">
                                            <label for="Stackable_Levels">Stackable Levels</label>
                                            <input type="number" id="Stackable_Levels" class="form-control" placeholder="Levels" min="0" @(canEditSales ? "" : "readonly") />
                                            <span id="Stackable_LevelsError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>

                                    <div class="row" style="margin-top: 15px;">
                                        @if ((int)ViewBag.ProjectPlantId == 1)
                                        {  // 1 es el ID de Puebla

                                            <div class="col-md-4" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))_container">
                                                <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Arrival_Warehouse)</label>
                                                @if (canEditSales)
                                                {
                                                    @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse), (SelectList)ViewBag.WarehouseList, "Select an option", new { @class = "form-control select2" })
                                                }
                                                else
                                                {
                                                    @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse), (SelectList)ViewBag.WarehouseList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                                }
                                                <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))Error" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                            <div id="PassesThroughSouthWarehouse_container" class="col-md-3 d-flex align-items-center">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="PassesThroughSouthWarehouse" @(canEditSales ? "" : "disabled")>
                                                    <label class="form-check-label" for="PassesThroughSouthWarehouse">
                                                        @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PassesThroughSouthWarehouse)
                                                    </label>
                                                </div>
                                                <span id="PassesThroughSouthWarehouseError" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                        }
                                        <div id="file_container_arrivalAdditionalFile" class="col-md-4">
                                            <label for="arrivalAdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_ArrivalAdditional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="arrivalAdditionalFile" name="arrivalAdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <button type="button" class="btn btn-danger btn-sm" id="arrivalAdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="arrivalAdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="fileActions_containerArrivalAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_ArrivalAdditional)</label>
                                            <div class="col-md-12">
                                                <a id="downloadArrivalAdditionalFile" href="#" class="truncate-filename">Download File</a>
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileArrivalAdditionalFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row" style="margin-top: 15px;">
                                        <div class="col-md-12" id="Arrival_Comments_container">
                                            <label for="Arrival_Comments">Comments</label>
                                            <textarea id="Arrival_Comments" class="form-control" rows="3" placeholder="Comments..." @(canEditSales ? "" : "readonly")></textarea>
                                            <span id="Arrival_CommentsError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- PACKAGING INFORMATION -->
                                <fieldset class="mb-3">
                                    <legend>Delivery Packaging</legend>

                                    <div class="row">
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))">
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Delivery_Coil_Position)
                                            </label>
                                            @if (canEditSales)
                                            {
                                                @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position), (SelectList)ViewBag.CoilPositionList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position), (SelectList)ViewBag.CoilPositionList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3 form-group" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Delivery_Transport_Type)</label>
                                            @if (canEditSales)
                                            {
                                                @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type), (SelectList)ViewBag.ArrivalTransportTypeList, "Select an option", new { @class = "form-control select2" })
                                            }
                                            else
                                            {
                                                @Html.DropDownList(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type), (SelectList)ViewBag.ArrivalTransportTypeList, "Select an option", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))_container" style="display: none;">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Delivery_Transport_Type_Other)</label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))" class="form-control"
                                                   placeholder="Specify transport..." maxlength="50"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))_container" class="form-group">
                                                <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PackagingStandard)</label>
                                                <select id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select an option</option>
                                                    <option value="OWN">Developed by tkMM</option>
                                                    <option value="CM">Provided by Client</option>
                                                </select>
                                                <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))Error" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-center" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))_container" style="display: none;">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))" @(!canEditSales ? "disabled" : "")>
                                                <label class="form-check-label" for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))">
                                                    @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().RequiresRackManufacturing)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-center" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))_container" style="display: none;">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))" @(!canEditSales ? "disabled" : "")>
                                                <label class="form-check-label" for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))">
                                                    @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().RequiresDieManufacturing)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PiecesPerPackage)</label>
                                            <input type="number" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))" class="form-control" placeholder="Qty" min="0" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().StacksPerPackage)</label>
                                            <input type="number" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))" class="form-control" placeholder="Qty" min="0" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))_container">
                                            <label for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PackageWeight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))" class="form-control" placeholder="Package Weight" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-8">
                                            <div id="packaging-file-div_container" class="form-group">
                                                <div id="packaging_file_container">
                                                    <label>Packaging Drawing / Standard</label>
                                                    <input type="file" id="packaging_archivo" name="packaging_archivo" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <span id="PackagingFileError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                                <div id="packagingFileActions_container" style="display: none;">
                                                    <label>Packaging Drawing / Standard</label>
                                                    <div>
                                                        <a id="downloadPackagingFile" href="#" class="truncate-filename">Download File</a>
                                                        <button type="button" class="btn btn-success btn-xs" id="changePackagingFileButton" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                                        <button type="button" class="btn btn-danger btn-xs" id="cancelPackagingFileButton" style="display: none;">Cancel</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="file_container_deliveryPackagingAdditionalFile" class="col-md-4">
                                            <label for="deliveryPackagingAdditionalFile">@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_DeliveryPackagingAdditional)</label>
                                            <div class="col-md-12">
                                                <input type="file" id="deliveryPackagingAdditionalFile" name="deliveryPackagingAdditionalFile" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales ? "disabled" : string.Empty)>
                                                <button type="button" class="btn btn-danger btn-sm" id="deliveryPackagingAdditionalFileCancelButton" style="display: none;" @(!canEditSales ? "disabled" : string.Empty)>Cancel</button>
                                            </div>
                                            <span id="deliveryPackagingAdditionalFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="fileActions_containerDeliveryPackagingAdditionalFile" class="col-md-4" style="display: none;">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_File_DeliveryPackagingAdditional)</label>
                                            <div class="col-md-12">
                                                <a id="downloadDeliveryPackagingAdditionalFile" href="#" class="truncate-filename">Download File</a>
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileDeliveryPackagingAdditionalFile" @(!canEditSales ? "disabled" : string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row packaging-row" style="margin-top: 15px;">
                                        <div id="rack-types-group_container" class="col-md-6 checkbox-group-container">
                                            <label>Rack Types</label>
                                            <div class="group-content-wrapper">
                                                <div id="rack-types-container" class="checkbox-options-wrapper">
                                                    @foreach (var rackType in (SelectList)ViewBag.RackTypeList)
                                                    {
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input rack-type-checkbox" type="checkbox" id="rack-type-@rackType.Value" value="@rackType.Value" @(!canEditSales ? "disabled" : "")>
                                                            <label class="form-check-label" for="rack-type-@rackType.Value">@rackType.Text</label>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        <div id="labels-group_container" class="col-md-6 checkbox-group-container">
                                            <label>Labels</label>
                                            <div class="group-content-wrapper">
                                                <div id="labels-container" class="checkbox-options-wrapper">
                                                    @foreach (var item in (SelectList)ViewBag.LabelList)
                                                    {
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input label-checkbox" type="checkbox" id="label-@item.Value" value="@item.Value" @(!canEditSales ? "disabled" : "")>
                                                            <label class="form-check-label" for="label-@item.Value">@item.Text</label>
                                                        </div>
                                                    }
                                                </div>
                                                <div id="LabelOtherDescription_container" class="other-description-wrapper" style="display: none;">
                                                    <label for="LabelOtherDescription" class="observation-label">Specify "Other" Label</label>
                                                    <textarea id="LabelOtherDescription" class="form-control form-control-sm" rows="1" @(!canEditSales ? "readonly" : "")></textarea>
                                                    <span id="LabelOtherDescriptionError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row packaging-row" style="margin-top: 15px;">
                                        <div id="additionals-group_container" class="col-md-6 checkbox-group-container">
                                            <label>Additionals</label>
                                            <div class="group-content-wrapper">
                                                <div id="additionals-container" class="checkbox-options-wrapper">
                                                    @foreach (var item in (SelectList)ViewBag.AdditionalList)
                                                    {
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input additional-checkbox" type="checkbox" id="additional-@item.Value" value="@item.Value" @(!canEditSales ? "disabled" : "")>
                                                            <label class="form-check-label" for="additional-@item.Value">@item.Text</label>
                                                        </div>
                                                    }
                                                </div>
                                                <div id="AdditionalsOtherDescription_container" class="other-description-wrapper" style="display: none;">
                                                    <label for="AdditionalsOtherDescription" class="observation-label">Specify "Other" Additional</label>
                                                    <textarea id="AdditionalsOtherDescription" class="form-control form-control-sm" rows="1" @(!canEditSales ? "readonly" : "")></textarea>
                                                    <span id="AdditionalsOtherDescriptionError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="straps-group_container" class="col-md-6 checkbox-group-container">
                                            <label>Strap Types</label>
                                            <div class="group-content-wrapper">
                                                <div id="straps-container" class="checkbox-options-wrapper">
                                                    @foreach (var item in (SelectList)ViewBag.StrapTypeList)
                                                    {
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input strap-checkbox" type="checkbox" id="strap-@item.Value" value="@item.Value" @(!canEditSales ? "disabled" : "")>
                                                            <label class="form-check-label" for="strap-@item.Value">@item.Text</label>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="other-description-wrapper">
                                                    <label for="StrapTypeObservations" class="observation-label">Observations</label>
                                                    <textarea id="StrapTypeObservations" class="form-control form-control-sm" rows="1" placeholder="Strap type observations..." @(!canEditSales ? "readonly" : "")></textarea>
                                                    <span id="StrapTypeObservationsError" class="error-message" style="color: red; display: none;"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr />
                                    <div class="row" style="margin-top:15px;">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))_container" class="col-md-6">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement)</label>
                                            <textarea id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))" class="form-control" rows="3" @(canEditSales ? "" : "readonly")></textarea>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))_container" class="col-md-6">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging)</label>
                                            <textarea id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))" class="form-control" rows="3" @(canEditSales ? "" : "readonly")></textarea>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>
                                <br />
                                <button type="button" class="btn btn-success btn-xs btn-add-material" style="display:@(!canEditSales?"none":string.Empty)"><i class="fa-solid fa-plus"></i> Add Material</button>
                                <button type="button" class="btn btn-danger btn-xs btn-clear-form" style="display:@(!canEditSales?"none":string.Empty)"><i class="fa-solid fa-eraser"></i> Clear Form</button>
                            </div>

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Technical Feasibility</div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="hidden" id="ID_Theoretical_Blanking_Line" name="ID_Theoretical_Blanking_Line" />
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Theoretical_Blanking_Line)</label>
                                        <input type="text" id="theoretical_blk_line" class="form-control" placeholder="Theoretical Blanking Line" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Strokes)</label>
                                        <input type="text" id="Theoretical_Strokes" class="form-control" placeholder="Theoretical Strokes" readonly />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line)</label>
                                        @if (canEditEngineering)
                                        {
                                            @Html.DropDownList("ID_Real_Blanking_Line", (SelectList)ViewBag.LinesList, "Select Line", new { @class = "form-control select2" })
                                        }
                                        else
                                        {
                                            @Html.DropDownList("ID_Real_Blanking_Line", (SelectList)ViewBag.LinesList, "Select Line", new { @class = "form-control select2", disabled = "disabled" })
                                        }
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_Strokes)</label>
                                        <input type="text" id="Real_Strokes" class="form-control" placeholder="Real Strokes" readonly />
                                    </div>

                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)" min="0" autocomplete="off" @(canEditEngineering ? "" : "readonly") />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)</label>
                                        <div style="position: relative; display: inline-block; width: 100%;">
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)" min="0" max="100" style="padding-right: 25px;text-align:right" autocomplete="off" @(canEditEngineering ? "" : "readonly") />
                                            <span style="position: absolute; right: 10px; top: 44%; transform: translateY(-50%); pointer-events: none; color: #555; font-weight: bold;">%</span>

                                        </div>
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error" class="error-message" style="color: red; display: none;"></span>
                                        <small id="oeeCalculationNote" class="form-text text-muted" style="display:none; font-style: italic;"></small>

                                    </div>
                                </div>

                                <div class="row">
                                    <div id="TonsPerShift_container" class="col-md-3">
                                        <label>Tons per shift</label>
                                        <input type="number" step="any" id="TonsPerShift" name="TonsPerShift" class="form-control" placeholder="Tons per shift" min="0" autocomplete="off" @(canEditEngineering ? "" : "readonly") />
                                        <span id="TonsPerShiftError" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div id="SlittingLine_container" class="col-md-3">
                                        <label>Slitting Line</label>
                                        <select id="ID_Slitting_Line" name="ID_Slitting_Line" class="form-control select2" @(!canEditEngineering ? "disabled" : "")>
                                            <option value="">Select a slitting line</option>
                                        </select>
                                        <span id="ID_Slitting_LineError" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                </div>
                                <br />
                                <button type="button" class="btn btn-success btn btn-add-material" id="id-btn-save-engineering" style="display:none"><i class="fa-solid fa-save"></i> Save Changes</button>
                            </div>

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Efficiency and Capacity</div>
                                <div class="row">
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Parts/Auto</label>
                                        <input type="text" id="parts_auto" class="form-control" placeholder="Parts/Auto" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Stroke/Auto</label>
                                        <input type="text" id="strokes_auto" class="form-control" placeholder="Stroke/Auto" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Blanks/Year</label>
                                        <input type="text" id="blanks_per_year" class="form-control" placeholder="Blanks/Year" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Min Max Reales</label>
                                        <input type="text" id="min_max_reales" class="form-control" placeholder="Min Max Reales" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Min Max Reales / OEE</label>
                                        <input type="text" id="min_max_reales_oee" class="form-control" placeholder="Min Max Reales / OEE" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Actual Shifts</label>
                                        <input type="text" id="actual_shifts" class="form-control" placeholder="Actual Shifts" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Stroke / shift</label>
                                        <input type="text" id="strokes_shift" class="form-control" placeholder="Stroke / shift" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Status DM</label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DM_status))" class="form-control" placeholder="Status DM" readonly />
                                    </div>
                                    <div class="col-md-6">
                                        <label>&emsp;</label>
                                        <span class="form-control" style="font-weight:bold; background-color:#f4f4f4; border: 0px;" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DM_status_comment))"></span>
                                    </div>

                                </div>
                                <label> Project's Impact on Line Capacity</label>
                                <!-- Contenedor para el Handsontable de "What‑If Capacity" para el material seleccionado -->
                                <div id="capacityTableContainer"></div>
                                <div style="margin-bottom: 10px;display:@(!canEditDataManagement?"none":string.Empty);">
                                    <strong>Color Legend:</strong>
                                    <div style="display: flex; gap: 20px; margin-top: 5px;">
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 20px; height: 20px; background-color: #c1fcac; border: 1px solid #ccc; margin-right: 5px;"></div>
                                            <span> < 95% (ACCEPTED)</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 20px; height: 20px; background-color: #ffd53b; border: 1px solid #ccc; margin-right: 5px; "></div>
                                            <span>95% to 98% (ON REVIEWED)</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 20px; height: 20px; background-color: #ff7c4f; border: 1px solid #ccc; margin-right: 5px;"></div>
                                            <span>> 98% (REJECTED)</span>
                                        </div>
                                    </div>
                                </div>
                                <label>Summary Capacity</label>
                                <div id="chartsContainer"></div>
                                <div id="slitterChartContainer" style="display:none; margin-top: 20px;">
                                    <hr>
                                    <h4 class="text-center">Slitter Capacity Utilization</h4>
                                </div>
                                <!-- LEGEND: leyenda de turnos fuera del canvas -->
                                <div id="shiftLegend" class="mt-3 text-center"></div>
                            </div>


                            <!-- Botón final para guardar todo en la base de datos -->
                            @*<button type="submit" class="btn btn-success"><i class="fa-regular fa-floppy-disk"></i> Save All Materials</button>*@
                        }
                    </div>
                    <div class="text-right mt-3">
                        <button type="button"
                                class="btn btn-default"
                                onclick="window.location='@Url.Action("EditProject", "CTZ_Projects", new { id = Model.ID_Project })'">
                            <i class="fa-regular fa-circle-left"></i> Back
                        </button>
                    </div>
            </div>
        </div>

    </div>
</div>
</div>

<div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 10000;
">
    <div style="
        position: absolute;
        top: 20px;
        left:30px;
        color: #b0a9a9;
        font-size: 1.8em;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px 20px;
        border-radius: 6px;
    ">
        <i class="fa-solid fa-spinner fa-spin"></i> Guardando Cambios...
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <!-- SweetAlert2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/sweetalert2/sweetalert2.min.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- Select2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <!-- DatePicker -->
    @Scripts.Render(Url.Content("~/Content/vendors/moment/moment.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <!-- Hansontable -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>

    <script>

        //variables para activar/desactivar campos
        // Objeto que mapea el ID de la ruta (o su valor) a la lista de campos que deben estar activos.
        const routeFieldMap = {
            //Route con ID = 1 = "BLK"
            "1": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                //SHAPE
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))",
                //Weight & Volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //Packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
                "TechnicalSheetFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
                "AdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",

            ],
            //Route con ID = 2 = "BLK + RP"
            "2": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                //Mechanical Properties
                //Pendiente Width de platina para repaletizado
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                //SHAPE
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))",
                //Weight & Volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //Packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",

            ],
            //Route con ID = 4 = "BLK + SH"
            "4": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                //Mechanical Properties
                //Pendiente Width de platina para repaletizado
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                //SHAPE
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))",
                //Weight & Volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //Packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
                "TechnicalSheetFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
                "AdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
                'Shearing_Width', 'Shearing_Width_Tol_Pos', 'Shearing_Width_Tol_Neg',
                'Shearing_Pitch', 'Shearing_Pitch_Tol_Pos', 'Shearing_Pitch_Tol_Neg',
                'Shearing_Weight', 'Shearing_Weight_Tol_Pos', 'Shearing_Weight_Tol_Neg',
                'Shearing_Pieces_Per_Stroke', 'Shearing_Pieces_Per_Car',
            ],
            //Route con ID = 5 = "BLK + WLD"
            "5": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                //Mechanical Properties
                //Pendiente Width de platina para repaletizado
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                //SHAPE
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))",
                //Weight & Volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //Packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
            //Route con ID = 6 = "COIL TO COIL"
            "6": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                //weight and volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //inicio packaging y Special Requirement
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                //Fin Special Requirement
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
             //Route con ID = 7 = "REWINDED" //pendiente
            "7": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",

            ],
              //Route con ID = 8 = "SLT"
            "8": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
                //weight and volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "TonsPerShift",
                "SlittingLine",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
              "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
               "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
               "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
            //Route con ID = 9 = "SLT + BLK"
            "9": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                //weight and volume
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                //packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "TonsPerShift",
                "SlittingLine",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
             "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
              "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
              "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
              "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                            "WeightPerPart",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
             //Route con ID = 10 = "SLT + BLK + WLD"
            "10": [
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                    //weight and volume
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                    //packaging
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                    "rack-types-group",
                    "labels-group",
                    "additionals-group",
                    "straps-group",
                    "packaging-file-div",
                    "TonsPerShift",
                    "SlittingLine",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                     "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                     "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
            //Route con ID = 11 = "WAREHOUSING"
            "11": [
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                    //weight and volume
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                    //inicio packaging y Special Requirement
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                    "rack-types-group",
                    "labels-group",
                    "additionals-group",
                    "straps-group",
                   "packaging-file-div",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
            //Route con ID = 12 = "WAREHOUSING / REPALLETIZING" (Platinas)
            "12": [
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
                        //Packaging
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                "rack-types-group",
                "labels-group",
                "additionals-group",
                "straps-group",
                "packaging-file-div",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                 "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
             "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
             "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
             "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
             "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            ],
            //Route con ID = 13 = "WEIGHT DIVISION"
            "13": [
                  //coil
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
                    //dimension - Mechaical Properties
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
                    //Packaging
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
                    "rack-types-group",
                    "labels-group",
                    "additionals-group",
                    "straps-group",
                    "packaging-file-div",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
                     "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
                    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
                     "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
                        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
"TechnicalSheetFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
"AdditionalFileName",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
                "ArrivalAdditionalFileName",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
                "WeightOfFinalMults_Min",
                "WeightOfFinalMults_Max",
                "ScrapReconciliationPercent_Min",
                "ScrapReconciliationPercent_Max",
                "HeadTailReconciliationPercent_Min",
                "HeadTailReconciliationPercent_Max",
                "PassesThroughSouthWarehouse",
                "WeightPerPart",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
                "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
                ],
        };

        // Lista de TODOS los campos que podrían activarse/desactivarse
        const allFields = [
            //coil
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
            //dimension - Mechaical Properties
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))",

            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
            //SHAPE
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))",
            //Weight & Volume
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))",
            //pendiente Initial Weight (SLT)
            //Packaging
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
            "rack-types-group",
            "labels-group",
            "additionals-group",
            "straps-group",
            "packaging-file-div",
            "TonsPerShift",   //sliter
            "SlittingLine",     //slitter
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Transport_Type))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Packaging_Type))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Protective_Material))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Protective_Material_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_By_Container))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Is_Stackable))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Stackable_Levels))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Arrival_Comments))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))",
             "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientScrapReconciliationPercent))",
"@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientHeadTailReconciliationPercent))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))",
            "TechnicalSheetFileName",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))",
            "AdditionalFileName",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))",
            "ArrivalAdditionalFileName",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsWeldedBlank))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.NumberOfPlates))",
            "WeightOfFinalMults_Min",
            "WeightOfFinalMults_Max",
            "ScrapReconciliationPercent_Min",
            "ScrapReconciliationPercent_Max",
            "HeadTailReconciliationPercent_Min",
            "HeadTailReconciliationPercent_Max",
            "PassesThroughSouthWarehouse",
            "WeightPerPart",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsCarryOver))",
            //Shearing
            'Shearing_Width', 'Shearing_Width_Tol_Pos', 'Shearing_Width_Tol_Neg',
            'Shearing_Pitch', 'Shearing_Pitch_Tol_Pos', 'Shearing_Pitch_Tol_Neg',
            'Shearing_Weight', 'Shearing_Weight_Tol_Pos', 'Shearing_Weight_Tol_Neg',
            'Shearing_Pieces_Per_Stroke', 'Shearing_Pieces_Per_Car',
        ];

        // Lista de nombres de campos que están dentro del fieldset "Blank Data"
        var blankDataFields = [
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))"
        ];

        const blankingRouteIds = [1, 2, 4, 5, 9, 10];
        const slittingRouteIds = [8, 9, 10];


        var availableSlitterLines = [];
        var slittingRanges = null; // Variable global para los rangos específicos de slitting
        var maxMultsAllowed = null; // Guardará el máximo de mults permitido


        // Si no tiene valor, asumimos 0 (no automotriz)
        var vehicleType = @(Model.ID_VehicleType.HasValue ? Model.ID_VehicleType.Value : 0);

        let volumeTimeout; //variable global para timeout de annual volume

        var previousTheoreticalLine = $("#ID_Theoretical_Blanking_Line").val();

        const isDetailsMode = @isDetailsMode.ToString().ToLower();
        let numberOfPlatesTimeout;

        // Configuración de Toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000",
            "extendedTimeOut": "1000"
        };

        var lineMap = {
            "PUEBLA-BLK1": 1,
            "PUEBLA-BLK2": 2,
            "PUEBLA-BLK3": 3,
            "SILAO-BLK1": 4,
            "SILAO-BLK2": 5,
            "SILAO-BLK3": 6,
            "SLP-BLK1": 7
                };


        // Mapeo de ID_Status => color
        var statusColors = {
            "POH": "#0098f7",   // POH
            "Casi Casi": "#ffd400",   // Casi Casi
            "Carry Over": "#aaaaaa",   // Carry Over
            "Quotes": "#01c401",    // Quotes
            "Spare Parts": "#94c149" 
        };

        // Mapeo de ID_Status => etiqueta legible
        var statusLabels = {
            "POH": "POH",
            "Casi Casi": "Casi Casi",
            "Carry Over": "Carry Over",
            "Quotes": "Quotes",
            "Spare Parts": "Spare Parts" 
        };

        const totalLabelPlugin = {
            id: 'totalLabelPlugin',
            // Se ejecuta después de dibujar los datasets
            afterDatasetsDraw(chart, args, options) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;

                ctx.save();
                ctx.font = options.font || 'bold 12px sans-serif';
                ctx.fillStyle = options.textColor || '#000';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';

                //las etiquetas se reparten uniformemente a lo largo del eje X
                const numLabels = chart.data.labels.length;
                const colWidth = (chartArea.right - chartArea.left) / numLabels;

                chart.data.labels.forEach((label, index) => {
                    // Calcular la suma de los valores en esa posición (acumulado)
                    let total = 0;
                    chart.data.datasets.forEach(dataset => {
                        total += dataset.data[index] || 0;
                    });

                    // Obtener la posición en Y para el valor total
                    let yPos = yScale.getPixelForValue(total);
                    // Obtener la posición en X como el centro de la "columna"
                    let xPos = chartArea.left + colWidth * index + colWidth / 2;

                    // Dibujar el texto (con dos decimales y "%")
                    ctx.fillText(total.toFixed(1) + "%", xPos, yPos - 2);
                });

                ctx.restore();
            }
        };

        // Plugin personalizado para dibujar una línea vertical al mover el mouse
        const verticalLinePlugin = {
            id: 'verticalLinePlugin',
            afterDatasetsDraw(chart, args, options) {

                // Verificar si hay un punto activo (tooltip visible)
                if (chart.tooltip && chart.tooltip._active && chart.tooltip._active.length) {
                    // Tomamos el primer punto activo (index)
                    let activePoint = chart.tooltip._active[0];
                    let ctx = chart.ctx;
                    let x = activePoint.element.x;
                    let topY = chart.chartArea.top;
                    let bottomY = chart.chartArea.bottom;

                    // Dibujamos la línea
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, topY);
                    ctx.lineTo(x, bottomY);
                    ctx.lineWidth = options.lineWidth || 2;       // grosor
                    ctx.strokeStyle = options.lineColor || 'pink'; // color
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };

        // Inyectamos el C# bool como literal JS
        var canEditSales = @canEditSales.ToString().ToLower();
        var canEditDataManagement = @canEditDataManagement.ToString().ToLower();
        var canEditEngineering = @canEditEngineering.ToString().ToLower();
        const allVehicleDropdowns = ['#Vehicle', '#Vehicle_2', '#Vehicle_3'];
        var statusId = @Model.ID_Status;
        const hasExternalProcessor = @(Model.HasExternalProcessor ? "true" : "false");
        const externalProcessorId = @(Model.ID_ExternalProcessor ?? 0);

    $(document).ready(function () {

        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                toastr.success("@TempData["SuccessMessage"]");
            </text>
        }

        //obtiene las lineas de sliter disponibles
        $.getJSON('@Url.Action("GetSlitterLines", "CTZ_Projects")', { plantId: @Model.ID_Plant })
        .done(function (data) {
            availableSlitterLines = data;
        });

        // Desactiva los eventos globales de AJAX para esta página.
        // Esto previene que la pantalla de "Cargando..." aparezca en cada llamada.
        setTimeout(function () {
            $(document).off('ajaxStart ajaxStop');
            console.log("Global AJAX events have been disabled for this page.");
        }, 0);

        //    Cualquier llamada a esta nueva función esperará 500ms antes de ejecutarse.
        const debouncedUpdateTheoreticalLine = debounce(updateTheoreticalLine, 600);
        const debouncedFetchAndApplyValidationRanges = debounce(fetchAndApplyValidationRanges, 600);

        const debouncedUpdateSlitterChart = debounce(function () {
            toastr.info("Recalculating slitter graph...");
            updateSlitterCapacityChart(false, @Model.ID_Project);
        }, 800);

        // Inicializar Select2 en los selects
        $(".select2").select2({ width: '100%' });

        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });

        // --- MANEJO DE EVENTOS DE IHS ---

        // Cuando el usuario cambia el país, se recarga la lista de vehículos de forma asíncrona.
        $(document).on('change', '.ihs-country-selector', function () {
            const country = $(this).val();
            const targetVehicleSelector = $(this).data('target-vehicle'); // Obtenemos el selector del vehículo asociado

            if (country && targetVehicleSelector) {
                // Llamamos a la nueva función que carga vehículos para un dropdown específico.
                loadVehiclesForDropdown(country, targetVehicleSelector);
            }
        });

        $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))').on('change', function() {
            toggleTkmmPackagingFields(); // Mantenemos la llamada a la otra función que ya existía

        });

        $('#IsWeldedBlank').on('change', handleWeldedBlankChange);
        $('#numberOfPlates').on('input', function () {
            // Limpia el temporizador anterior cada vez que se presiona una tecla.
            clearTimeout(numberOfPlatesTimeout);

            // Establece un nuevo temporizador.
            numberOfPlatesTimeout = setTimeout(function () {
                // Esta función solo se ejecutará 500ms después de que el usuario deje de escribir.
                generateThicknessInputs();
                validateNumberOfPlates();
            }, 500); // 500 milisegundos de espera (puedes ajustar este valor)
        });
        // Manejador para el checkbox 'Returnable Rack'
        $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))').on('change', function () {
            handleReturnableRackChange();
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))"); // La validación se queda aquí
        });

             

        // Llamar a la función al cargar la página para establecer el estado inicial
        updateDeliveryTransportationTypeState();



        // Llama a la función una vez al cargar la página para establecer el estado inicial
        toggleTkmmPackagingFields();
        // Activa la lógica para los textareas condicionales
        setupConditionalTextareas();

        //updateSlitterCapacityChart();

        // 1. Asocia el evento 'input' a los campos que disparan el cálculo.
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))")
.on("input", function () {
    updateWeightCalculations(); // <-- CAMBIO DE NOMBRE DE LA FUNCIÓN
});

        $("#Real_SOP, #Real_EOP").on("input changeDate", function () {
            // No necesitamos validar aquí, solo recalcular la gráfica.
            debouncedUpdateSlitterChart();
        });


        // Asociar el evento al dropdown
        $("#ID_Arrival_Protective_Material").on("change", handleArrivalProtectiveMaterialChange);
        // Asociar el evento al checkbox "Is Stackable"
        $("#Is_Stackable").on("change", handleStackableChange);
        // Asociar el evento al dropdown "Arrival Transport Type"
        $("#ID_Arrival_Transport_Type").on("change", handleArrivalTransportTypeChange);


        if (isDetailsMode) {
            // --- MODO DETALLES ACTIVADO ---

            // 1. Asegurarse de que los Select2 se vean correctamente deshabilitados
            $(".select2").select2({
                disabled: true
            });

            // 2. Desactivar los eventos de click para editar o copiar, como doble seguro
            $(document).off("click", ".edit-row");
            $(document).off("click", ".copy-row");
            $(document).off("click", ".remove-row");

            // 3. Notificar al usuario que está en modo de solo lectura
            toastr.info('Displaying in read-only details mode.', 'Details Mode');
        }

        // Evento para el botón EDITAR
        // En tu sección de $(document).ready(function () { ... });

        $(document).on("click", ".edit-row", function () {
            const row = $(this).closest("tr"); // Obtenemos la fila inmediatamente

            // 1. Mostrar una alerta de confirmación con SweetAlert2
            Swal.fire({
                title: 'Edit Material?',
                text: "This will discard any unsaved changes in the form and load data from the selected row. Are you sure you want to continue?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#009ff5',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, continue!'
            }).then((result) => {
                // 2. Si el usuario confirma, procedemos a cargar los datos
                if (result.isConfirmed) {

                    // --- INICIO DE TU LÓGICA DE EDICIÓN ---

                    //hace visible el boton para ingenieria.
                    if (canEditEngineering) {
                        $("#id-btn-save-engineering").show();
                    }

                    // Poblar el formulario con los datos de la fila
                    loadRowDataIntoForm(row);

                    // Cambiar el texto del botón principal
                    $('.btn-add-material').html('<i class="fa-solid fa-pen-to-square"></i> Save Changes');

                    // --- FIN DE TU LÓGICA DE EDICIÓN ---

                    // 3. Mostrar el toast de éxito DESPUÉS de que todo ha cargado
                    toastr.success('Material data has been loaded into the form.');
                }
            });
        });

        $(document).on("click", ".details-row", function () {
            // Obtenemos la fila de la tabla
            const row = $(this).closest("tr");

            // Llamamos directamente a la función que carga los datos, SIN confirmación
            loadRowDataIntoForm(row);

            // Notificamos al usuario que los datos se han cargado
            toastr.success('Material details have been loaded into the form for viewing.');
        });


        // Evento para el botón COPIAR
        $(document).on("click", ".copy-row", function () {
            let row = $(this).closest("tr");

            Swal.fire({
                title: 'Copy Material?',
                text: "This will load the selected material's data into the form.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#009ff5',
                confirmButtonText: 'Yes, copy it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 1. Poblar el formulario con los datos de la fila
                    loadRowDataIntoForm(row);

                    // 2. Realizar acciones específicas de la copia
                    $("#materialIndex").val("");
                    $("#materialId").val("0");
                    // a. Limpiar los valores de los archivos CAD y de Empaque
                    $("#ID_File_CAD_Drawing").val("");
                    $("#CADFileName").val("");
                    $("#ID_File_Packaging").val("");
                    $("#PackagingFileName").val("");
                    $("#ID_File_TechnicalSheet").val("");
                    $("#TechnicalSheetFileName").val("");
                    $("#ID_File_Additional").val("");
                    $("#AdditionalFileName").val("");
                    $("#ID_File_ArrivalAdditional").val("");
                    $("#ArrivalAdditionalFileName").val("");
                    $("#ID_File_CoilDataAdditional").val(""); $("#CoilDataAdditionalFileName").val("");
                    $("#ID_File_SlitterDataAdditional").val(""); $("#SlitterDataAdditionalFileName").val("");
                    $("#ID_File_VolumeAdditional").val(""); $("#VolumeAdditionalFileName").val("");
                    $("#ID_File_OutboundFreightAdditional").val(""); $("#OutboundFreightAdditionalFileName").val("");
                    $("#ID_File_DeliveryPackagingAdditional").val(""); $("#DeliveryPackagingAdditionalFileName").val("");

                    // b. Llamar a las funciones que actualizan la UI de los archivos.
                    //    Estas funciones verán que los IDs están vacíos y mostrarán los selectores de archivo.
                    updateFileUI();
                    updatePackagingFileUI();
                    updateFileUIGeneric('ID_File_TechnicalSheet', 'TechnicalSheetFileName', 'file_container_technicalSheetFile', 'fileActions_containerTechnicalSheetFile','downloadFileTechnicalSheetFile');
                    updateFileUIGeneric('ID_File_Additional', 'AdditionalFileName', 'file_container_AdditionalFile', 'fileActions_containerAdditionalFile','downloadFileAdditional');
                    updateFileUIGeneric('ID_File_CoilDataAdditional', 'CoilDataAdditionalFileName', 'file_container_coilDataAdditionalFile', 'fileActions_containerCoilDataAdditionalFile', 'downloadCoilDataAdditionalFile');
                    updateFileUIGeneric('ID_File_SlitterDataAdditional', 'SlitterDataAdditionalFileName', 'file_container_slitterDataAdditionalFile', 'fileActions_containerSlitterDataAdditionalFile', 'downloadSlitterDataAdditionalFile');
                    updateFileUIGeneric('ID_File_VolumeAdditional', 'VolumeAdditionalFileName', 'file_container_volumeAdditionalFile', 'fileActions_containerVolumeAdditionalFile', 'downloadVolumeAdditionalFile');
                    updateFileUIGeneric('ID_File_OutboundFreightAdditional', 'OutboundFreightAdditionalFileName', 'file_container_outboundFreightAdditionalFile', 'fileActions_containerOutboundFreightAdditionalFile', 'downloadOutboundFreightAdditionalFile');
                    updateFileUIGeneric('ID_File_DeliveryPackagingAdditional', 'DeliveryPackagingAdditionalFileName', 'file_container_deliveryPackagingAdditionalFile', 'fileActions_containerDeliveryPackagingAdditionalFile', 'downloadDeliveryPackagingAdditionalFile');

                    // Limpiar los campos Part Name y Part Number
                    $('#partName').val('');
                    $('#partNumber').val('');

                    $('.btn-add-material').html('<i class="fa-solid fa-plus"></i> Add as New Copy');
                    toastr.success("Material data copied.");
                }
            });
        });

         // --- FUNCIONES AUXILIARES PARA IHS ---
        function loadRowDataIntoForm(row) {

            // 1. Obtener datos y sincronizar IHS (sin cambios)
            let hiddenInputs = row.find("input[name^='materials']");
            let vehicleCode = row.find("input[name$='.Vehicle']").val();
            syncAllVehicleSections(row);

            // Limpiar todos
            $('.rack-type-checkbox, .additional-checkbox, .label-checkbox, .strap-checkbox').prop('checked', false);


            // 2. Poblar los campos del formulario
            hiddenInputs.each(function () {
                let nameAttr = $(this).attr("name");
                let val = $(this).val();

                // Si es un ID de RackType, márcalo y continúa
                if (nameAttr.endsWith('.SelectedRackTypeIds')) {
                    if (val) {
                        $(`#rack-type-${val}`).prop('checked', true);
                    }
                    return; // Continúa con el siguiente input oculto
                }
                if (nameAttr.endsWith('.SelectedAdditionalIds')) {
                    if (val) {
                        $(`#additional-${val}`).prop('checked', true);
                    }
                    return; // Continúa con el siguiente input oculto
                }
                if (nameAttr.endsWith('.SelectedLabelIds')) {
                    if (val) {
                        $(`#label-${val}`).prop('checked', true);
                    }
                    return; // Continúa con el siguiente input oculto
                }
                if (nameAttr.endsWith('.SelectedStrapTypeIds')) {
                    if (val) {
                        $(`#strap-${val}`).prop('checked', true);
                    }
                    return; // Continúa con el siguiente input oculto
                }

                for (let col of columnDefs) {
                    if (nameAttr.endsWith(`.${col.key}`)) {

                        if (col.type === "check") {
                            $(col.selector).prop("checked", val === "true");
                        }
                        else if (col.key === 'Quality') {
                            const $qualitySelect = $(col.selector);

                            // Paso A: Asegurarse de que la opción exista en el <select> (para valores nuevos)
                            if (val && $qualitySelect.find(`option[value="${val}"]`).length === 0) {
                                let newOption = new Option(val, val, true, true);
                                $qualitySelect.append(newOption);
                            }

                            // Paso B: Asignar el valor y disparar el evento 'change' INMEDIATAMENTE
                            // en este elemento específico para forzar la actualización visual de Select2.
                            $qualitySelect.val(val).trigger('change');
                        }
                        else {
                            // Manejo normal para otros campos
                            $(col.selector).val(val);
                        }
                    }
                }



            });

         // 3. Forzamos la actualización del resto de los combos Select2 (excluyendo Quality que ya se actualizó)
            $('.select2:not(#quality)').trigger('change.select2');

            // --- INICIO DE LA LÓGICA CORREGIDA PARA WELDER BLANKS ---
            // --- INICIO DEPURACIÓN DE PLATINAS SOLDADAS ---
            const isWelded = row.find("input[name$='.IsWeldedBlank']").val() === "true";
            $('#IsWeldedBlank').prop('checked', isWelded);

            if (isWelded) {
                // 1. Mostrar el contenedor del número de platinas
                $('#numberOfPlates_container').show(); // <-- ¡LA LÍNEA CLAVE QUE FALTABA!

                // 2. Establecer el número de platinas
                const numPlates = row.find("input[name$='.NumberOfPlates']").val();
                $('#numberOfPlates').val(numPlates);

                // 3. Generar y poblar los inputs de espesor (esto ya estaba bien)
                generateThicknessInputs();

                const weldedPlatesJson = row.find("input[name$='.WeldedPlatesJson']").val();
                if (weldedPlatesJson && weldedPlatesJson !== '[]') {
                    $("#weldedPlatesJson").val(weldedPlatesJson);
                    try {
                        const plates = JSON.parse(weldedPlatesJson);
                        plates.forEach(plate => {
                            $(`#thicknessPlate${plate.PlateNumber}`).val(plate.Thickness);
                        });
                    } catch (e) {
                        console.error("Error al parsear el JSON de las platinas:", e);
                    }
                }
            } else {
                // Lógica para ocultar si NO es Welded Blank
                $('#numberOfPlates_container').hide();
                $('#weldedPlatesThickness_container').empty().hide();
            }
            // --- FIN DE LA LÓGICA CORREGIDA ---


            // 4. Asignar el texto de la línea teórica desde la celda de la tabla
            $('#theoretical_blk_line').val(row.find('td').eq(28).text());

            // 4. Se actualiza el resto de la UI
            $("#ID_Route").trigger("change");

            let slittingLineId = row.find("input[name$='.ID_Slitting_Line']").val();
            if (slittingLineId === "8") {
                $("#slitting_line_name").val("SLITTER");
            } else {
                $("#slitting_line_name").val("");
            }

            updateVehicleVisibility();
            shapeVisibility();
            updatePackagingFileUI();
            updateFileUIGeneric('ID_File_TechnicalSheet', 'TechnicalSheetFileName', 'file_container_technicalSheetFile', 'fileActions_containerTechnicalSheetFile', 'downloadFileTechnicalSheetFile');
            updateFileUIGeneric('ID_File_Additional', 'AdditionalFileName', 'file_container_AdditionalFile', 'fileActions_containerAdditionalFile', 'downloadFileAdditional');
            updateFileUIGeneric('ID_File_ArrivalAdditional', 'ArrivalAdditionalFileName', 'file_container_arrivalAdditionalFile', 'fileActions_containerArrivalAdditionalFile', 'downloadArrivalAdditionalFile');
            updateFileUIGeneric('ID_File_CoilDataAdditional', 'CoilDataAdditionalFileName', 'file_container_coilDataAdditionalFile', 'fileActions_containerCoilDataAdditionalFile', 'downloadCoilDataAdditionalFile');
            updateFileUIGeneric('ID_File_SlitterDataAdditional', 'SlitterDataAdditionalFileName', 'file_container_slitterDataAdditionalFile', 'fileActions_containerSlitterDataAdditionalFile', 'downloadSlitterDataAdditionalFile');
            updateFileUIGeneric('ID_File_VolumeAdditional', 'VolumeAdditionalFileName', 'file_container_volumeAdditionalFile', 'fileActions_containerVolumeAdditionalFile', 'downloadVolumeAdditionalFile');
            updateFileUIGeneric('ID_File_OutboundFreightAdditional', 'OutboundFreightAdditionalFileName', 'file_container_outboundFreightAdditionalFile', 'fileActions_containerOutboundFreightAdditionalFile', 'downloadOutboundFreightAdditionalFile');
            updateFileUIGeneric('ID_File_DeliveryPackagingAdditional', 'DeliveryPackagingAdditionalFileName', 'file_container_deliveryPackagingAdditionalFile', 'fileActions_containerDeliveryPackagingAdditionalFile', 'downloadDeliveryPackagingAdditionalFile');


            toggleTkmmPackagingFields(); // <-- Añadir esta llamada
            handleArrivalProtectiveMaterialChange();
            handleStackableChange();
            handleArrivalTransportTypeChange();
            toggleRunningChangeWarning();

            $("#materialIndex").val(row.data("index"));
            $("#materialId").val(row.data("material-id"));


              // -- INICIO Calculo oee --
            console.log("Datos cargados en el formulario. Disparando cálculo de OEE...");
            // 1. Obtenemos los IDs de las líneas que acabamos de cargar en los campos del formulario.
            const realLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").val();
            const theoreticalLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val();

            // 2. Determinamos qué línea usar: la Real tiene prioridad.
            const lineIdToUseForOee = (realLineId && realLineId !== "0" && realLineId !== "")
                ? realLineId
                : theoreticalLineId;
            // 3. Llamamos a nuestra función para calcular el OEE con la línea correspondiente.
            fetchAndApplyOee(lineIdToUseForOee);
            // -- FIN DEL Calculo oee --

            // 5. Llamamos a la función que actualiza las gráficas
            debouncedUpdateCapacityGraphs();

            // dispara el evento 'change' en los checkboxes "Other"
            $('#additional-6').trigger('change');
            $('#label-3').trigger('change');
            updateWeightCalculations();
            updateAnnualTonnage();
            updatePackageWeight();

            // Disparar los handlers para ajustar la UI de los campos dependientes
            $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))').trigger('change');
            $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))').trigger('change');
            $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))').trigger('change');
            $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))').trigger('change');
            $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))').trigger('change');

            // Usamos 'false' porque estamos cargando datos al formulario para una posible edición (escenario what-if).
            debouncedUpdateSlitterChart();



        }

        // Función central para obtener y aplicar todas las reglas de validación
        function fetchAndApplyValidationRanges() {
            // 1. Guardamos el estado ACTUAL de los rangos antes de hacer nada.
            const previousRangesJSON = JSON.stringify(window.engineeringRanges);
            const previousMaxMults = window.maxMultsAllowed;


            const selectedRouteId = parseInt($("#ID_Route").val(), 10);
            const materialTypeId = $("#ID_Material_type").val();
            const realLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").val();
            const theoreticalLineId = $("#ID_Theoretical_Blanking_Line").val();
            const slitterLineId = $("#ID_Slitting_Line").val();
            const thicknessValue = parseFloat($("#Thickness").val()) || null;
            const tensileValue = parseFloat($("#Tensile_Strenght").val()) || null;


            if (!materialTypeId) {
                window.engineeringRanges = null;
                window.maxMultsAllowed = null;
                updateLimitsDisplay();
                return;
            }

            let ajaxData = {
                materialTypeId: materialTypeId,
                thickness: thicknessValue,       // <--- NUEVO
                tensile: tensileValue            // <--- NUEVO
            };

            let isCallNeeded = false;

            // 3. Determinar qué IDs de línea enviar al backend
            if (blankingRouteIds.includes(selectedRouteId)) {
                ajaxData.primaryLineId = realLineId || theoreticalLineId;
                isCallNeeded = !!ajaxData.primaryLineId;
            }

            if (slittingRouteIds.includes(selectedRouteId)) {
                ajaxData.slitterLineId = slitterLineId;
                // Si no hay una línea primaria (ej. ruta solo SLT), la línea de slitter también es la primaria.
                if (!ajaxData.primaryLineId) {
                    ajaxData.primaryLineId = slitterLineId;
                }
                isCallNeeded = !!ajaxData.primaryLineId;
            }

            if (!isCallNeeded) {
                window.engineeringRanges = null;
                window.maxMultsAllowed = null;
                updateLimitsDisplay();
                return;
            }


            $.getJSON('@Url.Action("GetEngineeringDimensions", "CTZ_Projects")', ajaxData)
                .done(function (response) {
                    if (response.success) {
                        const newRangesJSON = JSON.stringify(response.validationRanges);
                        const newMaxMults = response.maxMultsAllowed;

                        window.engineeringRanges = response.validationRanges;
                        window.maxMultsAllowed = newMaxMults; // Guardar el nuevo máximo permitido

                        // 5. Mostrar notificaciones solo si los datos cambiaron
                        if (newRangesJSON !== previousRangesJSON) {
                            toastr.info("Validation limits for dimensions have been updated.");
                        }

                        // --- INICIO DE LA MODIFICACIÓN ---
                        const errorDiv = $('#slittingRuleError');
                        const isSlittingRoute = slittingRouteIds.includes(selectedRouteId);

                        // Solo mostramos/ocultamos la advertencia si la ruta es de slitting
                        if (isSlittingRoute) {
                            if (newMaxMults !== null && newMaxMults > 0) {
                                // Regla válida encontrada: OCULTAR advertencia
                                errorDiv.slideUp();
                                if (newMaxMults !== previousMaxMults) { // Notificar solo si el valor cambió
                                    toastr.info(`Maximum allowed strips updated to: ${newMaxMults}`);
                                }
                            } else {
                                // No se encontró regla: MOSTRAR advertencia
                                errorDiv.slideDown();
                            }
                        } else {
                            // Si NO es una ruta de slitting, SIEMPRE ocultar la advertencia.
                            errorDiv.slideUp();
                        }
                        // --- FIN DE LA MODIFICACIÓN ---

                    } else {
                        window.engineeringRanges = null;
                        window.maxMultsAllowed = null;
                        toastr.error(response.message || "Could not load validation limits.");
                    }
                })
                .fail(function() {
                    window.engineeringRanges = null;
                    // Solo mostramos error si realmente se perdieron los rangos.
                    if (previousRangesJSON !== 'null') {
                        toastr.error("Could not load validation limits.");
                    }
                })
                .always(function() {
                    updateLimitsDisplay();
                    validateMultipliers();

                    // Re-validamos los campos principales afectados por los rangos
                    validateTensileStrength();
                    validateThickness();
                    validateWidth();
                    validatePitch();
                });
        }


        // Evento para campos de texto que SIEMPRE disparan el cálculo de línea teórica
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght)), " +
          "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), " +
          "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), " +
          "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))")
            .on("change keyup", function () {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(debouncedUpdateTheoreticalLine, 800);
            });

        // Evento para los DropDowns y campos que deben disparar la lógica INMEDIATAMENTE
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route)), " +
          "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)), " +
          "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)), " +
          "#ID_Slitting_Line, " +
          "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))")
            .on("change", function () {
                const fieldId = $(this).attr('id');

                // Ejecuta la validación básica del campo que cambió
                if (fieldId === '@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))' ||
                    fieldId === '@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))') {
                    validateMaterial(fieldId);
                }

                // Si el cambio fue en la RUTA, actualizamos la UI de las líneas de producción
                if (fieldId === '@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))') {
                    const selectedId = parseInt($(this).val(), 10);
                    const $slittingLineSelect = $("#ID_Slitting_Line");

                    if (slittingRouteIds.includes(selectedId)) {
                        $slittingLineSelect.empty().append('<option value="">Select slitter</option>');
                        $.each(availableSlitterLines, function(i, item) {
                            $slittingLineSelect.append($('<option>', { value: item.Value, text: item.Text }));
                        });
                        if (availableSlitterLines.length === 1) {
                            $slittingLineSelect.val(availableSlitterLines[0].Value).trigger('change.select2');
                        }
                    }
                }

                // Si el cambio fue en la Ruta o en la Línea de Slitter, actualizamos el dropdown de Material Type.
                if (fieldId === 'ID_Route' || fieldId === 'ID_Slitting_Line') {
                    updateMaterialTypeDropdown();
                }

                // La acción principal es siempre llamar a updateTheoreticalLine.
                // Esta función ahora contiene la lógica para decidir si debe continuar o no.
                debouncedUpdateTheoreticalLine();
            });

        function syncAllVehicleSections(row) {
            // Obtenemos los códigos de los 4 vehículos desde los inputs ocultos de la fila.
            const vehicleCode1 = row.find("input[name$='.Vehicle']").val();
            const vehicleCode2 = row.find("input[name$='.Vehicle_2']").val();
            const vehicleCode3 = row.find("input[name$='.Vehicle_3']").val();
            //const vehicleCode4 = row.find("input[name$='.Vehicle_4']").val();

            // Sincronizamos cada par. La función interna se encarga de todo.
            syncSingleVehicleAndCountry(vehicleCode1, '#ihsCountry1', '#Vehicle');
            syncSingleVehicleAndCountry(vehicleCode2, '#ihsCountry2', '#Vehicle_2');
            syncSingleVehicleAndCountry(vehicleCode3, '#ihsCountry3', '#Vehicle_3');
            //syncSingleVehicleAndCountry(vehicleCode4, '#ihsCountry4', '#Vehicle_4');
        }

        /**
         * Orquesta la sincronización del país y el vehículo usando llamadas SÍNCRONAS.
         */
       function syncSingleVehicleAndCountry(vehicleCode, countrySelector, vehicleSelector) {
            const $countryDropdown = $(countrySelector);
            const $vehicleDropdown = $(vehicleSelector);

            // Si no hay código de vehículo, reseteamos los dropdowns y terminamos.
            if (!vehicleCode) {
                $countryDropdown.val("MEX").trigger('change.select2'); // Opcional: poner un país por defecto
                loadVehiclesForDropdown("MEX", vehicleSelector);
                return;
            }

            const mnemonic = vehicleCode.split('_')[0];
            let country = "MEX"; // País por defecto

            // 1. PRIMERA LLAMADA SÍNCRONA: Obtener el país para este vehículo.
            // Es síncrona (async: false) para asegurar que tenemos el país antes de continuar.
            $.ajax({
                url: '@Url.Action("GetCountryForIHS", "CTZ_Projects")',
                data: { ihsCode: vehicleCode },
                async: false,
                success: function(response) {
                    if (response.success) {
                        country = response.country;
                    }
                }
            });

            // 2. SEGUNDA LLAMADA SÍNCRONA: Obtener la lista de vehículos para ese país.
            // También es síncrona para asegurar que la lista esté cargada antes de intentar seleccionar un valor.
            $.ajax({
                url: '@Url.Action("GetIHSByCountry", "CTZ_Projects")',
                data: { country: country },
                async: false,
                success: function(vehicleData) {
                    // 3. POBLAR Y SELECCIONAR: Ahora que todo está cargado, podemos asignar valores.
                    $countryDropdown.val(country).trigger('change.select2');

                    let newOptions = '<option value="">Select a Vehicle</option>';
                    $.each(vehicleData, (i, item) => {
                        newOptions += `<option value="${item.Value}" data-sop="${item.SOP}" data-eop="${item.EOP}"
                                       data-program="${item.Program}" data-maxproduction="${item.MaxProduction}"
                                       data-productionjson='${item.ProductionDataJson}'>${item.Text}</option>`;
                    });
                    $vehicleDropdown.html(newOptions);

                    // Buscamos el código exacto en la nueva lista y lo seleccionamos.
                    const matchingVehicle = vehicleData.find(v => v.Value.startsWith(mnemonic + '_'));
                    const finalVehicleCode = matchingVehicle ? matchingVehicle.Value : vehicleCode;
                    $vehicleDropdown.val(finalVehicleCode).trigger('change.select2');
                }
            });
        }

        /**
         * Carga la lista de vehículos de forma asíncrona (usada solo si el usuario cambia el país manualmente).
         */
        function loadVehiclesForDropdown(country, targetVehicleSelector) {
            const $vehicleDropdown = $(targetVehicleSelector);

            // Mostramos un mensaje de "cargando" mientras se obtienen los datos.
            $vehicleDropdown.prop('disabled', true).html('<option>Loading vehicles...</option>').trigger('change.select2');

            $.getJSON('@Url.Action("GetIHSByCountry", "CTZ_Projects")', { country: country }, function (data) {
                let newOptions = '<option value="">Select a Vehicle</option>';
                $.each(data, (i, item) => {
                    newOptions += `<option value="${item.Value}" data-sop="${item.SOP}" data-eop="${item.EOP}"
                                       data-program="${item.Program}" data-maxproduction="${item.MaxProduction}"
                                       data-productionjson='${item.ProductionDataJson}'>${item.Text}</option>`;
                });

                // Habilitamos y poblamos el dropdown de vehículo con los nuevos datos.
                $vehicleDropdown.html(newOptions).prop('disabled', !canEditSales).trigger('change.select2');
            });
        }

        //previene enter en formulario
        $(window).keydown(function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                return false;
            }
        });


        //Función que envuelve la llamada a UpdateCapacityGraphs con debounce
        const debouncedUpdateCapacityGraphs = debounce(function () {
            UpdateCapacityGraphs();
            //llama al metodo para actualizar el ht de capacidad.
            UpdateCapacityHansontable();
        }, 300); // 300 ms de espera

    //agrega el evento para el cambio de archivo
     $("#changeFileButton").on("click", function () {
         let fileUploadContainer = $("#cat_file_container");
         let fileActionsContainer = $("#fileActions_container");
         let archivoInput = $("#archivo");
         let cancelButton = $("#cancelFileButton");

         fileUploadContainer.show();
         fileActionsContainer.hide();
         cancelButton.show();

         archivoInput.prop("disabled", false);
     });

     $("#cancelFileButton").on("click", function () {
         let fileUploadContainer = $("#cat_file_container");
         let fileActionsContainer = $("#fileActions_container");
         let archivoInput = $("#archivo");
         let cancelButton = $("#cancelFileButton");

         fileUploadContainer.hide();
         fileActionsContainer.show();
         cancelButton.hide();

         archivoInput.prop("disabled", true);
    });

        // Evento para el botón CHANGE del archivo de empaque
        $("#changePackagingFileButton").on("click", function () {
            // Seleccionamos los contenedores específicos del packaging
            let fileUploadContainer = $("#packaging_file_container");
            let fileActionsContainer = $("#packagingFileActions_container");
            let archivoInput = $("#packaging_archivo");
            let cancelButton = $("#cancelPackagingFileButton");

            // Mostramos el input para subir archivo y ocultamos los botones de acción
            fileUploadContainer.show();
            fileActionsContainer.hide();
            cancelButton.show(); // Mostramos el botón de cancelar cambio

            // Habilitamos el input de archivo si el usuario puede editar
            if (canEditSales) {
                archivoInput.prop("disabled", false);
            }
        });

        // Evento para el botón CANCEL del archivo de empaque
        $("#cancelPackagingFileButton").on("click", function () {
            let fileUploadContainer = $("#packaging_file_container");
            let fileActionsContainer = $("#packagingFileActions_container");
            let archivoInput = $("#packaging_archivo");
            let cancelButton = $(this);

            // Si ya había un archivo guardado, volvemos a mostrar el enlace de descarga
            if ($("#ID_File_Packaging").val()) {
                fileUploadContainer.hide();
                fileActionsContainer.show();
            }

            // Limpiamos el input por si el usuario seleccionó un archivo nuevo y luego canceló
            archivoInput.val('');
            cancelButton.hide();
        });

        $("#changeFileButtonTechnicalSheetFile").on("click", function () {
            let fileUploadContainer = $("#file_container_technicalSheetFile");
            let fileActionsContainer = $("#fileActions_containerTechnicalSheetFile");
            let archivoInput = $("#technicalSheetFile");
            let cancelButton = $("#technicalSheetFileCancelButton");

            fileUploadContainer.show();
            fileActionsContainer.hide();
            cancelButton.show();

            archivoInput.prop("disabled", false);
        });

        $("#technicalSheetFileCancelButton").on("click", function () {
            let fileUploadContainer = $("#file_container_technicalSheetFile");
            let fileActionsContainer = $("#fileActions_containerTechnicalSheetFile");
            let archivoInput = $("#technicalSheetFile");
            let cancelButton = $("#technicalSheetFileCancelButton");

            fileUploadContainer.hide();
            fileActionsContainer.show();
            cancelButton.hide();

            archivoInput.prop("disabled", true);
        });

        $("#changeFileAdditional").on("click", function () {
            let fileUploadContainer = $("#file_container_AdditionalFile");
            let fileActionsContainer = $("#fileActions_containerAdditionalFile");
            let archivoInput = $("#AdditionalFile");
            let cancelButton = $("#AdditionalFileCancelButton");

            fileUploadContainer.show();
            fileActionsContainer.hide();
            cancelButton.show();

            archivoInput.prop("disabled", false);
        });

        $("#AdditionalFileCancelButton").on("click", function () {
            let fileUploadContainer = $("#file_container_AdditionalFile");
            let fileActionsContainer = $("#fileActions_containerAdditionalFile");
            let archivoInput = $("#AdditionalFile");
            let cancelButton = $("#AdditionalFileCancelButton");

            fileUploadContainer.hide();
            fileActionsContainer.show();
            cancelButton.hide();
            archivoInput.prop("disabled", true);
        });

        $("#changeFileArrivalAdditionalFile").on("click", function () {
            let fileUploadContainer = $("#file_container_arrivalAdditionalFile");
            let fileActionsContainer = $("#fileActions_containerArrivalAdditionalFile");
            let archivoInput = $("#arrivalAdditionalFile");
            let cancelButton = $("#arrivalAdditionalFileCancelButton");

            fileUploadContainer.show();
            fileActionsContainer.hide();
            cancelButton.show();
            archivoInput.prop("disabled", false);
        });

        $("#arrivalAdditionalFileCancelButton").on("click", function () {
            let fileUploadContainer = $("#file_container_arrivalAdditionalFile");
            let fileActionsContainer = $("#fileActions_containerArrivalAdditionalFile");
            let archivoInput = $("#arrivalAdditionalFile");
            let cancelButton = $("#arrivalAdditionalFileCancelButton");

            fileUploadContainer.hide();
            fileActionsContainer.show();
            cancelButton.hide();
            archivoInput.prop("disabled", true);
        });

        // Coil Data Additional File
        $("#changeFileCoilDataAdditionalFile").on("click", function () {
            $("#file_container_coilDataAdditionalFile").show();
            $("#fileActions_containerCoilDataAdditionalFile").hide();
            $("#coilDataAdditionalFileCancelButton").show();
            $("#coilDataAdditionalFile").prop("disabled", false);
        });
        $("#coilDataAdditionalFileCancelButton").on("click", function () {
            $("#file_container_coilDataAdditionalFile").hide();
            $("#fileActions_containerCoilDataAdditionalFile").show();
            $(this).hide();
            $("#coilDataAdditionalFile").prop("disabled", true).val('');
        });

        // Slitter Data Additional File
        $("#changeFileSlitterDataAdditionalFile").on("click", function () {
            $("#file_container_slitterDataAdditionalFile").show();
            $("#fileActions_containerSlitterDataAdditionalFile").hide();
            $("#slitterDataAdditionalFileCancelButton").show();
            $("#slitterDataAdditionalFile").prop("disabled", false);
        });
        $("#slitterDataAdditionalFileCancelButton").on("click", function () {
            $("#file_container_slitterDataAdditionalFile").hide();
            $("#fileActions_containerSlitterDataAdditionalFile").show();
            $(this).hide();
            $("#slitterDataAdditionalFile").prop("disabled", true).val('');
        });

        // Volume Additional File
        $("#changeFileVolumeAdditionalFile").on("click", function () {
            $("#file_container_volumeAdditionalFile").show();
            $("#fileActions_containerVolumeAdditionalFile").hide();
            $("#volumeAdditionalFileCancelButton").show();
            $("#volumeAdditionalFile").prop("disabled", false);
        });
        $("#volumeAdditionalFileCancelButton").on("click", function () {
            $("#file_container_volumeAdditionalFile").hide();
            $("#fileActions_containerVolumeAdditionalFile").show();
            $(this).hide();
            $("#volumeAdditionalFile").prop("disabled", true).val('');
        });

        // Outbound Freight Additional File
        $("#changeFileOutboundFreightAdditionalFile").on("click", function () {
            $("#file_container_outboundFreightAdditionalFile").show();
            $("#fileActions_containerOutboundFreightAdditionalFile").hide();
            $("#outboundFreightAdditionalFileCancelButton").show();
            $("#outboundFreightAdditionalFile").prop("disabled", false);
        });
        $("#outboundFreightAdditionalFileCancelButton").on("click", function () {
            $("#file_container_outboundFreightAdditionalFile").hide();
            $("#fileActions_containerOutboundFreightAdditionalFile").show();
            $(this).hide();
            $("#outboundFreightAdditionalFile").prop("disabled", true).val('');
        });

        // Delivery Packaging Additional File
        $("#changeFileDeliveryPackagingAdditionalFile").on("click", function () {
            $("#file_container_deliveryPackagingAdditionalFile").show();
            $("#fileActions_containerDeliveryPackagingAdditionalFile").hide();
            $("#deliveryPackagingAdditionalFileCancelButton").show();
            $("#deliveryPackagingAdditionalFile").prop("disabled", false);
        });
        $("#deliveryPackagingAdditionalFileCancelButton").on("click", function () {
            $("#file_container_deliveryPackagingAdditionalFile").hide();
            $("#fileActions_containerDeliveryPackagingAdditionalFile").show();
            $(this).hide();
            $("#deliveryPackagingAdditionalFile").prop("disabled", true).val('');
        });

    // Ocultar inicialmente los selects de Vehicle 2, 3 y 4
    $("#Vehicle_2").closest(".col-md-6").hide();
    $("#Vehicle_3").closest(".col-md-6").hide();
    $("#Vehicle_4").closest(".col-md-6").hide();

    // Llamar a la función al cargar la página
    updateVehicleVisibility();

    // Asociar el evento change a cada select para actualizar la visibilidad
    $("#Vehicle").on("change", updateVehicleVisibility);
    $("#Vehicle_2").on("change", updateVehicleVisibility);
    $("#Vehicle_3").on("change", updateVehicleVisibility);

    // Inicializa el select2 para Quality con tags y sugerencias
    var qualityData = @Html.Raw(Json.Encode(ViewBag.QualityList));

    //llama al evento de update shape
    shapeVisibility();

        //llama al metodo para mostrar las graficas, OnlyBDMaterials = true
        UpdateCapacityGraphs(true)
        UpdateCapacityHansontable(true)

    $(".select2-quality").select2({
        tags: true,
        data: qualityData,
        width: '100%',
        placeholder: "Select or enter quality"
    }).val(null).trigger("change");  //vacio por defecto


        //solo inicializa datepicker si puede editar
        if (canEditSales) {

            // Inicializa datepicker para Real_SOP
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").datepicker({
                format: "yyyy-mm",       // Formato año-mes (en minúsculas, ya que bootstrap-datepicker usa "mm" para mes)
                startView: "months",     // Inicia mostrando meses
                minViewMode: "months",   // Permite seleccionar solo meses
                autoclose: true
            });

            // Inicializa datepicker para Real_EOP
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").datepicker({
                format: "yyyy-mm",
                startView: "months",
                minViewMode: "months",
                autoclose: true
            });

        }
    var columnDefs = [
        { key: "Vehicle", selector: "#Vehicle", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))", type: "dropdown" },
        { key: "Vehicle_version", selector: "#vehicleVersion", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))", type: "text" },
        { key: "Part_Name", selector: "#partName", type: "text" },
        { key: "Part_Number", selector: "#partNumber", type: "text" },
        { key: "Quality", selector: "#quality", type: "dropdown" },
        { key: "Program_SP", selector: "#programSP", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))", type: "number" },
        { key: "TonsPerShift", selector: "#TonsPerShift", type: "number" },
        { key: "ID_Slitting_Line", selector: "#ID_Slitting_Line", type: "hidden" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DM_status))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DM_status))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))", type: "dropdown" },
        { key: "ID_File_Packaging", selector: "#ID_File_Packaging", type: "text" },
        { key: "PackagingFileName", selector: "#PackagingFileName", type: "text" }, // Para el nombre del archivo
        { key: "StrapTypeObservations", selector: "#StrapTypeObservations", type: "text" },
        { key: "AdditionalsOtherDescription", selector: "#AdditionalsOtherDescription", type: "text" },
        { key: "LabelOtherDescription", selector: "#LabelOtherDescription", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))", type: "number" },
        { key: "ID_Coil_Position", selector: "#ID_Coil_Position", type: "dropdown" },
        { key: "ID_Arrival_Transport_Type", selector: "#ID_Arrival_Transport_Type", type: "dropdown" },
        { key: "Arrival_Transport_Type_Other", selector: "#Arrival_Transport_Type_Other", type: "text" },
        { key: "ID_Arrival_Packaging_Type", selector: "#ID_Arrival_Packaging_Type", type: "dropdown" },
        { key: "ID_Arrival_Protective_Material", selector: "#ID_Arrival_Protective_Material", type: "dropdown" },
        { key: "Arrival_Protective_Material_Other", selector: "#Arrival_Protective_Material_Other", type: "text" },
        { key: "Is_By_Container", selector: "#Is_By_Container", type: "check" },
        { key: "Is_Stackable", selector: "#Is_Stackable", type: "check" },
        { key: "Stackable_Levels", selector: "#Stackable_Levels", type: "number" },
        { key: "Arrival_Comments", selector: "#Arrival_Comments", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))", type: "number" },
        { key: "ClientScrapReconciliationPercent", selector: "#ClientScrapReconciliationPercent", type: "number" },
        { key: "ClientHeadTailReconciliationPercent", selector: "#ClientHeadTailReconciliationPercent", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsRunningChange))", selector: "#isRunningChange", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_TechnicalSheet))", type: "hidden" },
        { key: "TechnicalSheetFileName", selector: "#TechnicalSheetFileName", type: "hidden" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_Additional))", type: "hidden" },
        { key: "AdditionalFileName", selector: "#AdditionalFileName", type: "hidden" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_ArrivalAdditional))", type: "hidden" },
        { key: "ArrivalAdditionalFileName", selector: "#ArrivalAdditionalFileName", type: "hidden" },
        { key: "@nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CoilDataAdditional)", selector: "#ID_File_CoilDataAdditional", type: "hidden" },
        { key: "CoilDataAdditionalFileName", selector: "#CoilDataAdditionalFileName", type: "hidden" },
        { key: "@nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_SlitterDataAdditional)", selector: "#ID_File_SlitterDataAdditional", type: "hidden" },
        { key: "SlitterDataAdditionalFileName", selector: "#SlitterDataAdditionalFileName", type: "hidden" },
        { key: "@nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_VolumeAdditional)", selector: "#ID_File_VolumeAdditional", type: "hidden" },
        { key: "VolumeAdditionalFileName", selector: "#VolumeAdditionalFileName", type: "hidden" },
        { key: "@nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_OutboundFreightAdditional)", selector: "#ID_File_OutboundFreightAdditional", type: "hidden" },
        { key: "OutboundFreightAdditionalFileName", selector: "#OutboundFreightAdditionalFileName", type: "hidden" },
        { key: "@nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_DeliveryPackagingAdditional)", selector: "#ID_File_DeliveryPackagingAdditional", type: "hidden" },
        { key: "DeliveryPackagingAdditionalFileName", selector: "#DeliveryPackagingAdditionalFileName", type: "hidden" },
        { key: "IsWeldedBlank", selector: "#IsWeldedBlank", type: "check" },
        { key: "NumberOfPlates", selector: "#numberOfPlates", type: "number" },
        { key: "WeldedPlatesJson", selector: "#weldedPlatesJson", type: "hidden" },
        { key: "ScrapReconciliationPercent_Min", selector: "#ScrapReconciliationPercent_Min", type: "number" },
        { key: "ScrapReconciliationPercent_Max", selector: "#ScrapReconciliationPercent_Max", type: "number" },
        { key: "HeadTailReconciliationPercent_Min", selector: "#HeadTailReconciliationPercent_Min", type: "number" },
        { key: "HeadTailReconciliationPercent_Max", selector: "#HeadTailReconciliationPercent_Max", type: "number" },
        { key: "WeightOfFinalMults_Min", selector: "#WeightOfFinalMults_Min", type: "number" },
        { key: "WeightOfFinalMults_Max", selector: "#WeightOfFinalMults_Max", type: "number" },
        { key: "PassesThroughSouthWarehouse", selector: "#PassesThroughSouthWarehouse", type: "check" },
        { key: "WeightPerPart", selector: "#WeightPerPart", type: "text" },
        { key: "IsCarryOver", selector: "#IsCarryOver", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))", type: "check" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))", type: "number" },
    ];

    // Declaramos una variable para el timeout
    let updateTimeout;

    //inicia eventos para validacion en tiempo real
    IniciaValidacionTiempoReal();


    // Botón para agregar/actualizar material
    $(document).on("click", ".btn-add-material", function () {

        // Realizar la validación antes de continuar
        if (!validateMaterial()) {

            toastr.warning("Please check the material data. Some fields are missing or contain invalid information.");

            return; // Detener si la validación falla
        }

        let index = $("#materialIndex").val().trim();
        let materialData = {};

        // Recoge valores de los inputs
        for (let col of columnDefs) {
            let $input = $(col.selector);
            let val;

            // Checkbox
            if (col.type === "check") {
                // .is(':checked') devuelve true/false
                val = $input.is(":checked").toString();
            }
            // Hidden siempre lo tomamos
            else if ($input.attr("type") === "hidden") {
                val = $input.val();
            }
            // Visible normal
            else if ($input.is(":visible")) {
                val = $input.val();
            }
            // Oculto → vacío
            else {
                val = "";
            }

            materialData[col.key] = val;
        }

        // V V V --- AÑADIR ESTA LÓGICA --- V V V
        // Recoger los IDs de los Rack Types seleccionados
        materialData.SelectedRackTypeIds = [];
        $('#rack-types-container .rack-type-checkbox:checked').each(function () {
            materialData.SelectedRackTypeIds.push($(this).val());
        });

        materialData.SelectedAdditionalIds = [];
        $('#additionals-container .additional-checkbox:checked').each(function () { materialData.SelectedAdditionalIds.push($(this).val()); });

        materialData.SelectedLabelIds = [];
        $('#labels-container .label-checkbox:checked').each(function () { materialData.SelectedLabelIds.push($(this).val()); });

        materialData.SelectedStrapTypeIds = [];
        $('#straps-container .strap-checkbox:checked').each(function () { materialData.SelectedStrapTypeIds.push($(this).val()); });
        // ^ ^ ^ --- FIN DE LA LÓGICA AÑADIDA --- ^ ^ ^


        // Aquí: si el input de archivo (#archivo) tiene algún valor, marcamos este material.
        // Consideramos que solo el material que se agregue cuando se tenga un archivo tendrá la bandera.
        materialData["IsFile"] = $("#archivo").val() ? "true" : "false";
        materialData["IsPackagingFile"] = $("#packaging_archivo").val() ? "true" : "false";
        materialData["IsTechnicalSheetFile"] = $("#technicalSheetFile").val() ? "true" : "false";
        materialData["IsAdditionalFile"] = $("#AdditionalFile").val() ? "true" : "false";
        materialData["IsArrivalAdditionalFile"] = $("#arrivalAdditionalFile").val() ? "true" : "false";
        materialData["IsCoilDataAdditionalFile"] = $("#coilDataAdditionalFile").val() ? "true" : "false";
        materialData["IsSlitterDataAdditionalFile"] = $("#slitterDataAdditionalFile").val() ? "true" : "false";
        materialData["IsVolumeAdditionalFile"] = $("#volumeAdditionalFile").val() ? "true" : "false";
        materialData["IsOutboundFreightAdditionalFile"] = $("#outboundFreightAdditionalFile").val() ? "true" : "false";
        materialData["IsDeliveryPackagingAdditionalFile"] = $("#deliveryPackagingAdditionalFile").val() ? "true" : "false";

        console.log("%c--- DEPURANDO LA CREACIÓN DEL JSON ---", "color: orange; font-weight: bold;");

        let platesData = [];
        const isChecked = $('#IsWeldedBlank').is(':checked');
        // La visibilidad del contenedor de 'numberOfPlates' es un mejor indicador
        const isContainerVisible = $('#numberOfPlates_container').is(':visible');

        console.log("Checkbox 'IsWeldedBlank' está marcado?:", isChecked);
        console.log("Contenedor de 'numberOfPlates' es visible?:", isContainerVisible);

        // Cambiamos la condición para que dependa del contenedor de 'numberOfPlates' que es más fiable
        if (isChecked && isContainerVisible) {
            const numPlatesValue = $('#numberOfPlates').val();
            console.log("Valor leído de '#numberOfPlates':", `"${numPlatesValue}"`); // Se muestra entre comillas para ver si está vacío

            const numPlates = parseInt(numPlatesValue, 10);
            console.log("Valor después de parseInt:", numPlates);

            if (!isNaN(numPlates) && numPlates > 0) {
                console.log(`El bucle 'for' se ejecutará ${numPlates} veces.`);
                for (let i = 1; i <= numPlates; i++) {
                    const selector = `#thicknessPlate${i}`;
                    const thicknessInput = $(selector);
                    const thicknessValue = thicknessInput.val();

                    console.log(`Iteración ${i}: Selector: '${selector}', ¿Input encontrado?: ${thicknessInput.length > 0}, Valor leído: '${thicknessValue}'`);

                    platesData.push({
                        PlateNumber: i,
                        Thickness: parseFloat(thicknessValue) || 0
                    });
                }
            } else {
                console.error("ERROR: numPlates no es un número válido. El bucle no se ejecutará.");
            }
        } else {
            console.log("Condición principal (if) no cumplida. No se recopilarán datos de platinas.");
        }

        materialData["WeldedPlatesJson"] = JSON.stringify(platesData);
        $("#weldedPlatesJson").val(materialData["WeldedPlatesJson"]);

        console.log("Array final 'platesData':", platesData);
        console.log("JSON String final que se usará en la fila:", materialData["WeldedPlatesJson"]);
        console.log("%c--- FIN DE LA DEPURACIÓN ---", "color: orange; font-weight: bold;");


        if (index === "") {
            // AGREGAR NUEVO
            let rowCount = $("#materialsTable tbody tr").length;
            let rowHtml = buildRowHtml(materialData, rowCount);
            $("#materialsTable tbody").append(rowHtml);
        //    toastr.success("Material added successfully.");
        } else {
            // EDITAR MATERIAL EXISTENTE
            let row = $("#materialsTable tbody").find(`tr[data-index='${index}']`);
            let indice = 1; // El incice empieza en 1 porque se moite 0 de la columna de acciones
            let colCells = row.find("td");

            // Actualizar hidden inputs
            let hiddenInputs = row.find("input[name^='materials']");

            hiddenInputs.each(function () {
                let nameAttr = $(this).attr("name");
                for (let col of columnDefs) {
                    if (nameAttr.endsWith(`.${col.key}`)) {
                        let newVal;
                        if (col.type === "check") {
                            newVal = materialData[col.key];
                        }
                        else if ($(this).attr("type") === "hidden") {
                            newVal = materialData[col.key];
                        }
                        else {
                            newVal = $(col.selector).is(":visible") ? materialData[col.key] : "";
                        }
                        $(this).val(newVal);
                    }
                }
                if (nameAttr.indexOf("IsFile") !== -1) {
                    $(this).val(materialData["IsFile"]);
                }
                if (nameAttr.indexOf("IsPackagingFile") !== -1) {
                    $(this).val(materialData["IsPackagingFile"]);
                }
                if (nameAttr.indexOf("IsTechnicalSheetFile") !== -1) {
                    $(this).val(materialData["IsTechnicalSheetFile"]);
                }
                if (nameAttr.indexOf("IsAdditionalFile") !== -1) {
                    $(this).val(materialData["IsAdditionalFile"]);
                }
                if (nameAttr.indexOf("IsArrivalAdditionalFile") !== -1) {
                    $(this).val(materialData["IsArrivalAdditionalFile"]);
                }
                if (nameAttr.indexOf("IsCoilDataAdditionalFile") !== -1) {
                    $(this).val(materialData["IsCoilDataAdditionalFile"]);
                }
                if (nameAttr.indexOf("IsSlitterDataAdditionalFile") !== -1) {
                    $(this).val(materialData["IsSlitterDataAdditionalFile"]);
                }
                if (nameAttr.indexOf("IsVolumeAdditionalFile") !== -1) {
                    $(this).val(materialData["IsVolumeAdditionalFile"]);
                }
                if (nameAttr.indexOf("IsOutboundFreightAdditionalFile") !== -1) {
                    $(this).val(materialData["IsOutboundFreightAdditionalFile"]);
                }
                if (nameAttr.indexOf("IsDeliveryPackagingAdditionalFile") !== -1) {
                    $(this).val(materialData["IsDeliveryPackagingAdditionalFile"]);
                }
            });

            let actionsCell = row.find('td:first');

            // 2. ELIMINAR LOS INPUTS OCULTOS ANTERIORES PARA LOS RACK TYPES DE ESTA FILA
            row.find("input[name$='.SelectedRackTypeIds']").remove();
            row.find("input[name$='.SelectedAdditionalIds']").remove();
            row.find("input[name$='.SelectedLabelIds']").remove();
            row.find("input[name$='.SelectedStrapTypeIds']").remove();
            row.find("input[name$='.WeldedPlatesJson']").val(materialData["WeldedPlatesJson"]);


            // 3. AGREGAR NUEVOS INPUTS OCULTOS BASADOS EN LA SELECCIÓN ACTUAL
            if (materialData.SelectedRackTypeIds && materialData.SelectedRackTypeIds.length > 0) {
                materialData.SelectedRackTypeIds.forEach(function (id) {
                    actionsCell.append(`<input type="hidden" name="materials[${index}].SelectedRackTypeIds" value="${id}" />`);
                });
            }

            // 4c. RECREAR los inputs para Additionals
            if (materialData.SelectedAdditionalIds && materialData.SelectedAdditionalIds.length > 0) {
                materialData.SelectedAdditionalIds.forEach(function (id) {
                    actionsCell.append(`<input type="hidden" name="materials[${index}].SelectedAdditionalIds" value="${id}" />`);
                });
            }

            // 4d. RECREAR los inputs para Labels
            if (materialData.SelectedLabelIds && materialData.SelectedLabelIds.length > 0) {
                materialData.SelectedLabelIds.forEach(function (id) {
                    actionsCell.append(`<input type="hidden" name="materials[${index}].SelectedLabelIds" value="${id}" />`);
                });
            }

            // 4e. RECREAR los inputs para Strap Types
            if (materialData.SelectedStrapTypeIds && materialData.SelectedStrapTypeIds.length > 0) {
                materialData.SelectedStrapTypeIds.forEach(function (id) {
                    actionsCell.append(`<input type="hidden" name="materials[${index}].SelectedStrapTypeIds" value="${id}" />`);
                });
            }

        }


        //envia el formulario
        $("#materialForm").submit();

        //clearMaterialForm(columnDefs);
    });

        //Al enviar el formularrio muestra un mensaje
        $("#materialForm").on("submit", function () {
            $("#loadingOverlay").show();
        });

        $(".btn-clear-form").click(function () {
            Swal.fire({
                title: 'Clear Form?',
                text: "This will erase all data currently entered in the form fields.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, clear it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    clearMaterialForm(columnDefs);
                    toastr.success('Form cleared.');
                }
            });
        });


        function setupConditionalTextareas() {
            // Escuchar cambios en los checkboxes de "Additionals"
            $('#additionals-container').on('change', '.additional-checkbox', function () {
                // La opción "Other" para Additionals tiene el ID 6
                const isOtherChecked = $('#additional-6').is(':checked');
                const otherContainer = $('#AdditionalsOtherDescription_container');

                if (isOtherChecked) {
                    otherContainer.slideDown();
                } else {
                    otherContainer.slideUp();
                    otherContainer.find('textarea').val(''); // Limpia el valor al ocultar
                }
            });

            // Escuchar cambios en los checkboxes de "Labels"
            $('#labels-container').on('change', '.label-checkbox', function () {
                // La opción "Other" para Labels tiene el ID 3
                const isOtherChecked = $('#label-3').is(':checked');
                const otherContainer = $('#LabelOtherDescription_container');

                if (isOtherChecked) {
                    otherContainer.slideDown();
                } else {
                    otherContainer.slideUp();
                    otherContainer.find('textarea').val(''); // Limpia el valor al ocultar
                }
            });
        }
    // Muestra u oculta los campos de empaque de tkMM según la selección
   function toggleTkmmPackagingFields() {
            const standard = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))').val();

            // Contenedores a controlar
            const rackContainer = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))_container');
            const dieContainer = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))_container');
            const additionalGroup = $('#additionals-group_container');
            const strapGroup = $('#straps-group_container');

            if (standard === 'OWN') {
                // --- LÓGICA PARA MOSTRAR ---
                // Primero nos aseguramos de que los contenedores tengan la clase d-flex ANTES de animar.
                rackContainer.addClass('d-flex');
                dieContainer.addClass('d-flex');

                // Ahora ejecutamos la animación para todos.
                additionalGroup.slideDown();
                strapGroup.slideDown();
                rackContainer.slideDown();
                dieContainer.slideDown();

            } else {
                // --- LÓGICA PARA OCULTAR (LA CORRECCIÓN) ---
                // Animamos hacia arriba y, en el callback (que se ejecuta al terminar),
                // quitamos la clase 'd-flex' que causa el conflicto.
                rackContainer.slideUp(function() {
                    $(this).removeClass('d-flex');
                });
                dieContainer.slideUp(function() {
                    $(this).removeClass('d-flex');
                });

                // Los otros dos contenedores también usan flexbox a través de la clase 'checkbox-group-container',
                // por lo que aplicamos la misma lógica para ser consistentes.
                additionalGroup.slideUp();
                strapGroup.slideUp();

                // Limpiamos los valores (esta parte no cambia)
                rackContainer.find('input[type="checkbox"]').prop('checked', false);
                dieContainer.find('input[type="checkbox"]').prop('checked', false);
                additionalGroup.find('input[type="checkbox"]').prop('checked', false).trigger('change');
                strapGroup.find('input[type="checkbox"]').prop('checked', false).trigger('change');
                strapGroup.find('textarea').val('');
            }
        }

    $("#ID_Route").on("change", function () {
        let selectedValue = $(this).val();
        let selectedId = parseInt(selectedValue, 10);
        const $realLineSelect = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
        const $slittingLineSelect = $("#ID_Slitting_Line");
        // --- LÓGICA CENTRALIZADA Y COMPLETA ---

        // 1. Limpiar los rangos de validación y la visualización INMEDIATAMENTE.
        // Esto asegura que al cambiar a una ruta sin límites, los antiguos desaparezcan.
        window.engineeringRanges = null;
        updateLimitsDisplay(); // Usamos la nueva función unificada

        // 2. Lógica de visibilidad de campos (oculta todo y luego muestra lo relevante)
        allFields.forEach(field => {
            $(`#${field}`).prop("disabled", true);
            $(`#${field}_container`).fadeOut(0);
        });

        if (routeFieldMap[selectedValue]) {
            routeFieldMap[selectedValue].forEach(field => {
                $(`#${field}_container`).fadeIn(0);

                if (canEditSales) {
                    $(`#${field}`).prop("disabled", false);
                }
            });
        }

        // 3. Visibilidad de secciones especiales como "Shape & Angles"
        //if (routeFieldMap[selectedValue] && routeFieldMap[selectedValue].some(field => blankDataFields.includes(field))) {
        //    $("#blankDataDiv").fadeIn(0);
        //} else {
        //    $("#blankDataDiv").fadeOut(0);
        //}
        shapeVisibility();

        // 4. Comportamiento específico para las líneas de producción

        // A. Lógica para el campo "Slitting Line"
        if (slittingRouteIds.includes(selectedId)) {
            // Poblamos el dropdown con las líneas de slitter que cargamos al inicio
            $slittingLineSelect.empty().append('<option value="">Select slitter</option>');
            $.each(availableSlitterLines, function(i, item) {
                $slittingLineSelect.append($('<option>', { value: item.Value, text: item.Text }));
            });

            // Si solo hay una línea de slitter en la planta, la seleccionamos por defecto
            if (availableSlitterLines.length === 1) {
                $slittingLineSelect.val(availableSlitterLines[0].Value);
            }
        }


        // B. Lógica para los campos de "Blanking Line"
        if (blankingRouteIds.includes(selectedId)) {
            // Si la ruta incluye BLANKING, habilitamos la línea real y disparamos el cálculo de la teórica.
            $realLineSelect.prop("disabled", !canEditEngineering);
            debouncedUpdateTheoreticalLine();
        } else {
            // Si la ruta NO incluye BLANKING, deshabilitamos y limpiamos todo lo relacionado.
            $realLineSelect.prop("disabled", true).val("");
            $("#theoretical_blk_line").val("N/A for this route");
            $("#ID_Theoretical_Blanking_Line, #Theoretical_Strokes, #Real_Strokes").val("");
        }


        handleArrivalProtectiveMaterialChange();
        handleStackableChange()
        handleArrivalTransportTypeChange();

        // 5. Disparamos la actualización de los rangos de validación y de la UI de los selects
        debouncedFetchAndApplyValidationRanges();
        $(".select2").trigger('change.select2');

        // 6. Lógica de mensajes para el usuario (Toastr)
        const selectedText = $(this).find('option:selected').text();
        let messageParts = [];


        if (slittingRouteIds.includes(selectedId) && blankingRouteIds.includes(selectedId)) {
            messageParts.push("Combined process detected: Slitting followed by Blanking.");
        } else if (slittingRouteIds.includes(selectedId)) {
            messageParts.push("Slitting process detected; validation will be against slitting line dimensions.");
            // (Tu código de Swal.fire para mostrar las dimensiones del slitter se mantiene si lo deseas)
        } else if (blankingRouteIds.includes(selectedId)) {
            messageParts.push("Validation will be against the chosen theoretical or real blanking line.");
        } else {
            messageParts.push("Theoretical/Slitting line is not required for this route.");
        }

        if (messageParts.length > 0) {
            const finalMessage = `Route selected: <strong>${selectedText}</strong>. <br>` + messageParts.join('<br>');
            //toastr.info(finalMessage, "Route Information", { timeOut: 7000 });
        }

        handleScrapReconciliationChange();
        handleHeadTailReconciliationChange();
        handleReturnableRackChange();
        handleDeliveryTransportTypeChange();
        updateDeliveryTransportationTypeState();

        // --- LÓGICA DE VISIBILIDAD DE GRÁFICAS ---
        console.log(`--- Lógica de Visibilidad de Gráficas ---`);
        console.log(`Ruta seleccionada ID: ${selectedId}`);

        // Gráfica de Blanking
        if (blankingRouteIds.includes(selectedId)) {
            console.log("✅ La ruta incluye BLANKING. Mostrando gráficas de capacidad de línea.");
            $("#chartsContainer").slideDown(); // Muestra el contenedor de gráficas de BLK
        } else {
            console.log("❌ La ruta NO incluye BLANKING. Ocultando gráficas de capacidad de línea.");
            $("#chartsContainer").slideUp(); // Oculta el contenedor de gráficas de BLK
        }

        // Gráfica de Slitter
        if (slittingRouteIds.includes(selectedId)) {
            console.log("✅ La ruta incluye SLITTER. Llamando a updateSlitterCapacityChart().");
            updateSlitterCapacityChart(); // Llama a la función para cargar y mostrar la gráfica
        } else {
            console.log("❌ La ruta NO incluye SLITTER. Ocultando gráfica de capacidad de Slitter.");
            $("#slitterChartContainer").slideUp(); // Oculta la gráfica si la ruta no es de slitter
        }
        console.log(`--- Fin de Lógica de Visibilidad ---`);
        // --- FIN DE LÓGICA DE VISIBILIDAD ---

    });

    // Botón Remove
    $(document).on("click", ".remove-row", function () {
        var row = $(this).closest("tr");
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to remove this material?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#009ff5',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                row.remove();
                renumberRows();
                //envia el formulario
                $("#materialForm").submit();
            }
        });
    });



        function UpdateCapacityGraphs(OnlyBDMaterials = false) {
            console.log('entra UpdateCapacityGraphs');

            // Obtiene el valor de la línea teórica
            let theoricalBLKID = $("#ID_Theoretical_Blanking_Line").val();

            let materialId = $("#materialId").val();

            // Obtiene el ID de la línea real (del select correspondiente)
            var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

            // Si la línea real es vacía o 0, se utiliza la línea teórica
            if (productionLineId === "" || productionLineId === "0") {
                productionLineId = theoricalBLKID;
                console.log('Usando linea teorica para calculos');
            }

            // Obtener los valores de los campos necesarios
            var vehicle = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle))").val();
            var partsPerVehicle = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val()) || null;
            var idealCycleTimePerTool = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val()) || null;
            var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val()) || null;
            var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val()) || null;
            var realSOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").val();
            var realEOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val();
            var annualVol = parseInt($("#Annual_Volume").val()) || null;

            // Campos de fallback para idealCycleTimePerTool
            var realStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val()) || null;
            var theoreticalStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val()) || null;

            // Limpiar el contenedor de gráficos
            $("#chartsContainer").html("<p style='color:gray;'>Loading <i class='fa-solid fa-spinner fa-spin-pulse'></i></p>");

            // Validar que existan los campos obligatorios
            var missingFields = [];
            if (!vehicle || vehicle.trim() === "") {
                missingFields.push("Vehicle");
            }
            if (partsPerVehicle === null) {
                missingFields.push("Parts per Vehicle");
            }
            if (blanksPerStroke === null) {
                missingFields.push("Blanks per Stroke");
            }
            if (!realSOP || realSOP.trim() === "") {
                missingFields.push("Real SOP");
            }
            if (!realEOP || realEOP.trim() === "") {
                missingFields.push("Real EOP");
            }
            if (annualVol === null) {
                missingFields.push("Annual Volume");
            }

            // Fallback para idealCycleTimePerTool
            if (idealCycleTimePerTool === null) {
                if (realStrokes !== null) {
                    idealCycleTimePerTool = realStrokes;
                } else if (theoreticalStrokes !== null) {
                    idealCycleTimePerTool = theoreticalStrokes;
                } else {
                    missingFields.push("Ideal Cycle Time (or Real/Theoretical Strokes)");
                }
            }

            // Si faltan campos, no se ejecuta la llamada AJAX; se limpia el contenedor y se muestra un mensaje
            if (missingFields.length > 0 && !OnlyBDMaterials) {
                $("#chartsContainer").html(
                    "<p style='color:red;'>Missing required fields: " + missingFields.join(", ") + "</p>"
                );
                return;
            }

            // Realizar la llamada AJAX
            $.ajax({
                url: '@Url.Action("GetMaterialCapacityScenariosGraphs", "CTZ_Projects")',
                type: 'GET',
                data: {
                    projectId: @Model.ID_Project,
                    materialId: materialId,  // Puede ser null
                    blkID: productionLineId,
                    vehicle: vehicle,
                    partsPerVehicle: partsPerVehicle,
                    idealCycleTimePerTool: idealCycleTimePerTool,
                    blanksPerStroke: blanksPerStroke,
                    oee: oee,
                    realSOP: realSOP,
                    realEOP: realEOP,
                    annualVol: annualVol,
                    OnlyBDMaterials: OnlyBDMaterials
                },
                success: function (response) {
                    var container = document.getElementById("chartsContainer");
                    container.innerHTML = ""; // Limpiar contenedor
                    if (response.success) {
                        generateCharts(response.data, response.dateRanges || {});

                        // 2) Relleno los inputs dm_status
                        //    Asumo que cada fila/material tiene un <input name="dm_status" data-material-id="…">
                        console.log(response.dmStatuses)

                        // 2) Rellenas los campos ocultos DM_status
                        $.each(response.dmStatuses, function (matId, status) {
                            // busca el input cuyo data-material-id coincida y cuyo name termine en '.DM_status'
                            $('input[data-material-id="' + matId + '"][name$=".DM_status"]')
                                .val(status);
                        });

                        // 3) Rellenas los campos ocultos DM_status_comment
                        $.each(response.dmStatusComments, function (matId, comment) {
                            $('input[data-material-id="' + matId + '"][name$=".DM_status_comment"]')
                                .val(comment);
                        });

                        // 3) Relleno el campo de texto "Status DM" para el material seleccionado
                        var selMatId = $("#materialId").val();
                        var dm = response.dmStatuses[selMatId];
                        if (dm !== undefined) {
                            // este es tu input de texto
                            $("#DM_status").val(dm);
                        }

                        var dmc = response.dmStatusComments[selMatId];
                        if (dmc !== undefined) {
                            // este es tu input de texto
                            $("#DM_status_comment").html(dmc);
                        }

                        // 4) **Actualiza el <td> visible** para cada material
                        $.each(response.dmStatuses, function (matId, status) {
                            $('td.dm-status-cell[data-material-id="' + matId + '"]')
                                .text(status);
                        });
                        $.each(response.dmStatusComments, function (matId, comment) {
                            $('td.dm-status-comment-cell[data-material-id="' + matId + '"]')
                                .text(comment);
                        });

                    } else {
                        $("#DM_status").val('');
                        $("#DM_status_comment").html('');

                        $("#chartsContainer").html(
                            "<p style='color:red;'>Warning: " + response.message + "</p>"
                        );
                        //toastr.error("Error: " + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    $("#DM_status").val('');
                    $("#DM_status_comment").html('');

                    $("#chartsContainer").html(
                        "<p style='color:red;'>Error: " + error + "</p>"
                    );
                   // toastr.error("An error occurred: " + error);
                },
                async: true
            });
        }


        function generateCharts(data, fyRanges = {}, containerSelector = "#chartsContainer") {
            // Limpiar el contenedor principal de gráficos
            const container = $(containerSelector);
            container.empty(); // Esto ahora limpiará el contenedor correcto (sea el de BLK o el de SLT)


            // Si no hay datos, muestra un mensaje y termina.
            if (!data || data.length === 0) {
                container.html("<p>No capacity data available to display.</p>");
                return;
            }

            var currentRow = null;
            var charts = [];      // <-- aquí acumularemos las instancias

            // Iterar sobre cada línea de producción (cada gráfica)
            data.forEach(function (lineData, index) {
                // Comenzar una nueva fila cada 2 gráficos
                if (index % 2 === 0) {
                    currentRow = $('<div class="row" style="margin-bottom:20px;"></div>');
                    container.append(currentRow);
                }

                // Crear un contenedor de columna (col-md-6)
                var colDiv = $('<div class="col-md-6"></div>');

                // --- INICIO DE LA MODIFICACIÓN: FILTRAR DATOS POR RANGO DE FY ---
                var fyData = lineData.DataByFY;
                var range = fyRanges[lineData.LineId];
                var filteredFYData = fyData; // Por defecto, usamos todos los datos.

                // Solo filtramos si tenemos un rango válido para esta línea.
                if (range && range.MinFY && range.MaxFY) {
                    let startIndex = fyData.findIndex(fy => fy.FiscalYear === range.MinFY);
                    let endIndex = fyData.findIndex(fy => fy.FiscalYear === range.MaxFY);

                    // Si encontramos el FY de inicio y no es el primer elemento, retrocedemos uno.
                    //if (startIndex > 0) {
                    //    startIndex--;
                    //}

                    // Si encontramos el FY de fin y no es el último elemento, avanzamos uno.
                    if (endIndex !== -1 && endIndex < fyData.length - 1) {
                        endIndex++;
                    }

                    // Aseguramos que los índices sean válidos antes de cortar el array.
                    if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                        filteredFYData = fyData.slice(startIndex, endIndex + 1);
                    }
                }

                var labels = filteredFYData.map(fy => fy.FiscalYear);

                // --- Paso 2: Armar datasets agrupados por estatus ---
                var statusMap = {};  // Key: StatusId, Value: { label, data: [], backgroundColor }
                filteredFYData.forEach(function (fyItem) {
                    if (fyItem.Breakdown) {
                        fyItem.Breakdown.forEach(function (b) {
                            if (!statusMap[b.StatusId]) {
                                statusMap[b.StatusId] = {
                                    statusId: b.StatusId,
                                    label: statusLabels[b.StatusId] || ("Status " + b.StatusId),
                                    data: [],
                                    backgroundColor: statusColors[b.StatusId] || "#999999"
                                };
                            }
                        });
                    }
                });
                Object.keys(statusMap).forEach(function (statusId) {
                    filteredFYData.forEach(function (fyItem) {
                        var entry = (fyItem.Breakdown || []).find(b => b.StatusId == statusId);
                        statusMap[statusId].data.push(entry ? entry.Percentage : 0);
                    });
                });
                // Ordenar los datasets según el orden deseado
                var desiredOrder = ["POH", "Casi Casi", "Carry Over", "Quotes"];
                var datasets = Object.values(statusMap).sort(function (a, b) {
                    var indexA = desiredOrder.indexOf(a.label);
                    var indexB = desiredOrder.indexOf(b.label);
                    indexA = indexA === -1 ? desiredOrder.length : indexA;
                    indexB = indexB === -1 ? desiredOrder.length : indexB;
                    return indexA - indexB;
                });

                // --- Paso 3: Calcular el máximo acumulado para configurar el eje Y ---
                var maxAcc = 0;
                for (let i = 0; i < filteredFYData.length; i++) {
                    let sum = 0;
                    datasets.forEach(ds => {
                        sum += ds.data[i] || 0;
                    });
                    if (sum > maxAcc) {
                        maxAcc = sum;
                    }
                }
                var maxPercentage = Math.ceil(Math.max(100, maxAcc) * 1.1);

                // --- Paso 4: Crear el canvas para la gráfica y agregarlo a la columna ---
                colDiv.append('<h4>' + lineData.LineName + '</h4>');
                var canvasId = "chartLine_" + lineData.LineId;
                colDiv.append('<canvas id="' + canvasId + '"></canvas>');
                currentRow.append(colDiv);

                // --- Paso 5: Generar la gráfica con Chart.js ---
                var ctx = document.getElementById(canvasId).getContext("2d");
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets.map(function (ds) {
                            return {
                                label: ds.label,
                                data: ds.data,
                                backgroundColor: ds.backgroundColor,
                                borderColor: ds.backgroundColor,
                                fill: true,
                                stack: 'CapacityStack',
                                tension: 0,  // Líneas rectas
                                pointRadius: 0
                            };
                        })
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: "Fiscal Year"
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: maxPercentage,
                                title: {
                                    display: true,
                                    text: "Capacity (%)"
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var label = context.dataset.label || "";
                                        var value = context.parsed.y;
                                        return label + ": " + value + "%";
                                    },
                                    footer: function (tooltipItems) {
                                        var total = tooltipItems.reduce((acc, item) => acc + item.parsed.y, 0);
                                        return "Total: " + total.toFixed(1) + "%";
                                    },
                                    title: function (tooltipItems) {
                                        return "Fiscal Year: " + tooltipItems[0].label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line100: {
                                        type: 'line',
                                        yMin: 100,
                                        yMax: 100,
                                        borderColor: 'red',
                                        borderDash: [8, 8],
                                        borderWidth: 3,
                                        label: {
                                            enabled: false,
                                            content: '100% capacity',
                                            position: 'end',
                                            backgroundColor: 'rgba(255,0,0,0.7)',
                                            color: '#fff'
                                        }
                                    },
                                    line85: {
                                        type: 'line',
                                        yMin: 85,
                                        yMax: 85,
                                        borderColor: 'red',
                                        borderDash: [8, 8],
                                        borderWidth: 3,
                                        label: {
                                            enabled: false,
                                            content: '85% capacity',
                                            position: 'end',
                                            backgroundColor: 'rgba(255,165,0,0.7)',
                                            color: '#fff'
                                        }
                                    },
                                    line25: {
                                        type: 'line',
                                        yMin: 25,
                                        yMax: 25,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [8, 3, 3, 3],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '1st shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line53: {
                                        type: 'line',
                                        yMin: 53,
                                        yMax: 53,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [3, 3],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '2nd shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line80: {
                                        type: 'line',
                                        yMin: 80,
                                        yMax: 80,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [8, 4],        // guion-espacio
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '3rd shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line100_2: {
                                        type: 'line',
                                        yMin: 100,
                                        yMax: 100,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [5, 10],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '4th shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                }
                            },
                            // Opcional: configuración para verticalLinePlugin
                            verticalLinePlugin: {
                                lineWidth: 1,
                                lineColor: '#e91e63'
                            },
                            totalLabelPlugin: {
                                font: "bold 14px sans-serif",
                                textColor: "#555555"
                            }
                        }
                    },
                    plugins: [totalLabelPlugin, verticalLinePlugin]
                });

                // --- NUEVO BLOQUE: si existe fyRanges para esta línea, anotar inicio/fin de FY ---
                var range = fyRanges[lineData.LineId];
                if (range && range.MinFY && range.MaxFY) {
                    chart.options.plugins.annotation.annotations['fyStart_' + lineData.LineId] = {
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: range.MinFY,
                        borderColor: '#888888',      // azul corporativo
                        borderWidth: 2,
                        label: { enabled: true, content: 'FY Start', position: 'top', backgroundColor: 'rgba(128,128,128,0.5)', color: '#fff' }
                    };
                    chart.options.plugins.annotation.annotations['fyEnd_' + lineData.LineId] = {
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        value: range.MaxFY,
                        borderColor: '#888888',      // naranja complementario
                        borderWidth: 2,
                        label: { enabled: true, content: 'FY End', position: 'top', backgroundColor: 'rgba(128,128,128,0.5)', color: '#fff' }
                    };
                    chart.update();
                }

                charts.push(chart);   // <-- lo guardamos

            });

            if (charts.length > 0) {
                // Usamos la primera gráfica para extraer las anotaciones
                buildShiftLegend(charts[0].options.plugins.annotation.annotations);
            }

            // Mostrar el mensaje solo si hay alguna gráfica generada
            if ($("#chartsContainer").children().length > 0) {
                $("#chartsNote").show();
                $("#shiftLegend").show();
            } else {
                $("#chartsNote").hide();
                $("#shiftLegend").hide();

            }
        }

        function buildShiftLegend(annotations) {
            var legend = document.getElementById('shiftLegend');
            legend.innerHTML = '';

            // Contador de turnos
            Object.values(annotations).forEach(function (a) {
                // Solo procesamos las anotaciones con borderDash definido
                if (Array.isArray(a.borderDash)) {
                    // Construimos el atributo dash-array si existe
                    var dashArray = a.borderDash.length
                        ? ' stroke-dasharray="' + a.borderDash.join(',') + '"'
                        : '';

                    // Creamos un SVG con una línea horizontal
                    var svg =
                        '<svg width="30" height="6" ' +
                        'style="vertical-align:middle;">' +
                        '<line x1="0" y1="3" x2="30" y2="3" ' +
                        'stroke="' + a.borderColor + '" ' +
                        'stroke-width="2"' +
                        dashArray +
                        '/>' +
                        '</svg>';

                    // Obtenemos el texto de la etiqueta (si lo tenías guardado en label.content)
                    var text = (a.label && a.label.content)
                        ? a.label.content
                        : '';

                    // Añadimos al contenedor
                    var item = document.createElement('span');
                    item.className = 'legend-item';
                    item.innerHTML = svg + ' ' + text;
                    legend.appendChild(item);
                }
            });
        }

        function UpdateCapacityHansontable(OnlyBDMaterials = false) {
            //si no tiene el permiso se sale
            //if (!canEditDataManagement) {
            //    console.warn("UpdateCapacityHansontable: Acceso denegado, no puede editar DM. Faltan permisos.");
            //    return;
            //}

            console.log('entra UpdateCapacityHansontable');

            let materialId = $("#materialId").val();

             // obtiene el valor de la linea teorica
            let theoricalBLKID = $("#ID_Theoretical_Blanking_Line").val();

            // Obtiene los ids que se enviaran
            var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

            //si la linea real es igual a vacio 0, se utiliza la linea teorica
            if (productionLineId == "" || productionLineId == 0) {
                productionLineId = theoricalBLKID;
                console.log('Usando linea teorica para calculos HT')
            }

            var vehicle = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle))").val();
            var partsPerVehicle = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val()) || null;
            var idealCycleTimePerTool = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val()) || null;
            var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val()) || null;
            var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val()) || null;
            var realSOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").val();
            var realEOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val();
            var annualVol = parseInt($("#Annual_Volume").val()) || null;

            // Campos de fallback para idealCycleTimePerTool
            var realStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val()) || null;
            var theoreticalStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val()) || null;

            // Limpiar el contenedor de gráficos
            $("#capacityTableContainer").html("<p style='color:gray;'>Loading <i class='fa-solid fa-spinner fa-spin-pulse'></i></p>");

            // Validar que existan los campos obligatorios
            var missingFields = [];
            if (!vehicle || vehicle.trim() === "") {
                missingFields.push("Vehicle");
            }
            if (partsPerVehicle === null) {
                missingFields.push("Parts per Vehicle");
            }
            if (blanksPerStroke === null) {
                missingFields.push("Blanks per Stroke");
            }
            if (!realSOP || realSOP.trim() === "") {
                missingFields.push("Real SOP");
            }
            if (!realEOP || realEOP.trim() === "") {
                missingFields.push("Real EOP");
            }
            if (annualVol === null) {
                missingFields.push("Annual Volume");
            }

            // Fallback para idealCycleTimePerTool
            if (idealCycleTimePerTool === null) {
                if (realStrokes !== null) {
                    idealCycleTimePerTool = realStrokes;
                } else if (theoreticalStrokes !== null) {
                    idealCycleTimePerTool = theoreticalStrokes;
                } else {
                    missingFields.push("Ideal Cycle Time (or Real/Theoretical Strokes)");
                }
            }

            // Si faltan campos, no se ejecuta la llamada AJAX; se limpia el contenedor y se muestra un mensaje
            if (missingFields.length > 0 && !OnlyBDMaterials) {
                $("#capacityTableContainer").html(
                    "<p style='color:red;'>Missing required fields: " + missingFields.join(", ") + "</p>"
                );
                return;
            }

            // Llamada AJAX para obtener el "what‑if" de capacidad para el material seleccionado.
            // Se envían además projectId, materialId y blkID (que es la línea real consultada)
            $.ajax({
                url: '@Url.Action("GetMaterialCapacityScenarios", "CTZ_Projects")',
                type: 'GET',
                data: {
                    projectId: @Model.ID_Project,
                    materialId: materialId, // Puede ser null
                    blkID: productionLineId,
                    vehicle: vehicle,
                    partsPerVehicle: partsPerVehicle,
                    idealCycleTimePerTool: idealCycleTimePerTool,
                    blanksPerStroke: blanksPerStroke,
                    oee: oee,
                    realSOP: realSOP,
                    realEOP: realEOP,
                    annualVol: annualVol,
                    OnlyBDMaterials: OnlyBDMaterials
                },
                success: function (response) {
                    var container = document.getElementById("capacityTableContainer");
                    container.innerHTML = ""; // Limpiar contenedor
                    if (response.success) {
                        // 1. Actualizamos el input status_dm con el valor calculado en el servidor
                        if (OnlyBDMaterials == false) {
                            $("#status_dm").val(response.status_dm);
                        }
                        // 2. Convertir la data (array de objetos) a una matriz para Handsontable
                        var arrayData = convertToHandsontableMatrix(response.data);
                        // arrayData.rows es una matriz donde:
                        //   columna 0: LineId (oculta)
                        //   columna 1: Line (nombre)
                        //   columnas siguientes: valores de los FY

                        // 3. Inicializar Handsontable
                        new Handsontable(container, {
                            data: arrayData.rows,
                            readOnly: true,
                            colHeaders: arrayData.headers,
                            rowHeaders: true,
                            // Ocultamos la primera columna (LineId)
                            hiddenColumns: {
                                columns: [0],
                            },
                            //colWidths: [0, 150, 250], // Agregamos un ancho para la nueva columna PartNumbers (ej. 250px)
                            // Hook para modificar los encabezados de columna.
                            // Si el encabezado (por ejemplo, "FY 22/23") se encuentra en response.highlightedFY, se le aplica fondo dorado.
                            afterGetColHeader: function (col, TH) {
                                // Las columnas FY comienzan en el índice 2 (0: LineId, 1: Line)
                                if (col >= 3) {
                                    var headerText = this.getColHeader(col);
                                    if (response.highlightedFY.indexOf(headerText) !== -1) {
                                        TH.style.backgroundColor = "#FFD700"; // Dorado
                                    } else {
                                        TH.style.backgroundColor = "#009ff5"; // Valor por defecto
                                        TH.style.color = "#ffffff";           // Texto en blanco
                                    }
                                } else {
                                    TH.style.backgroundColor = "#009ff5"; // Valor por defecto
                                    TH.style.color = "#ffffff";           // Texto en blanco
                                }
                            },
                            // Configuración de las celdas
                            cells: function (row, col, prop) {
                                var cellProperties = {};
                                cellProperties.readOnly = true;

                                cellProperties.renderer = function (instance, td, row, col, prop, value, cellProperties) {
                                    // Render base de texto
                                    Handsontable.renderers.TextRenderer.apply(this, arguments);

                                    // Obtenemos los datos de la fila (en formato array)
                                    var rowData = instance.getSourceDataAtRow(row);
                                    // La primera columna (índice 0) es el LineId (oculto)
                                    //var isSelectedLine = (rowData[0] == productionLineId);

                                    // Para la columna 1 (nombre de la línea), si es la línea consultada se resalta
                                    if (col === 1) {
                                        //if (isSelectedLine) {
                                            //td.style.backgroundColor = "#c1fcac"; // Verde claro para la fila seleccionada
                                        //}
                                    }
                                    // Columna 2: PartNumbers (NUEVO)
                                    else if (col === 2) {
                                        td.style.whiteSpace = 'normal'; // Permite el ajuste de línea
                                        //if (isSelectedLine) {
                                            //td.style.backgroundColor = "#e0f7de"; // Un verde más suave para esta celda
                                        //}
                                    }
                                    else {
                                        // Para las demás columnas, se asume que contienen valores numéricos (decimales)
                                        if (typeof value === "number") {
                                            var percentage = value * 100;
                                            td.innerHTML = percentage.toFixed(2) + "%";

                                            // Aplicar colores según el valor (sin importar la fila seleccionada)
                                            if (percentage < 95) {
                                                //if (isSelectedLine)
                                                    //td.style.backgroundColor = "#c1fcac";  // Menor a 95%
                                            } else if (percentage < 98) {
                                                td.style.backgroundColor = "#ffd53b"; // Entre 95% y 98%
                                            } else {
                                                td.style.backgroundColor = "#ff7c4f";    // 98% o mayor
                                            }
                                            // Si además es la fila consultada, se puede optar por fusionar el estilo;
                                            // por ejemplo, si quieres que tenga un tinte extra, podrías modificar el color.
                                            // Aquí se deja el color calculado.
                                        } else {
                                            td.innerHTML = value;
                                        }
                                    }
                                    return td;
                                };

                                return cellProperties;
                            },
                            licenseKey: 'non-commercial-and-evaluation'
                        });
                    } else {
                        $(container).html("<p style='color:red;'>" + response.message + "</p>");
                    }
                },
                error: function () {
                    $("#capacityTableContainer").html("<p style='color:red;'>Error al cargar datos de capacidad.</p>");
                }
            });
         }

    // Función para convertir la respuesta en un formato tabular para Handsontable.
    function convertToHandsontableMatrix(dataArray) {
        // 1) Recopilar todas las claves únicas de todos los objetos
        let allKeys = new Set();
        dataArray.forEach(obj => {
            Object.keys(obj).forEach(k => allKeys.add(k));
        });
        let keysArray = Array.from(allKeys);

        // 2) Definir el orden deseado:
        //    a) "LineId" en primer lugar, si existe.
        //    b) "Line" en segundo lugar, si existe.
        //    c) Las claves que comiencen con "FY" (ordenadas alfabéticamente).
        //    d) Cualquier otra clave (opcional, en orden ascendente).
        const lineIdKey = keysArray.includes("LineId") ? ["LineId"] : [];
        const lineKey = keysArray.includes("Line") ? ["Line"] : [];
        const partNumbersKey = keysArray.includes("PartNumbers") ? ["PartNumbers"] : []; // <-- AÑADIR ESTA LÍNEA
        const fyKeys = keysArray.filter(k => k.startsWith("FY"));
        fyKeys.sort(); // Ordena las claves de FY alfabéticamente.
        const remainingKeys = keysArray.filter(k => k !== "LineId" && k !== "Line" && k !== "PartNumbers" && !k.startsWith("FY"));
        remainingKeys.sort(); // Opcional.

        // 3) Construir el arreglo final de claves en el orden deseado.
        let sortedKeys = [].concat(lineIdKey, lineKey, partNumbersKey, fyKeys, remainingKeys);

        // 4) Construir la cabecera (headers) y las filas (rows)
        let headers = sortedKeys;
        let rows = dataArray.map(obj => {
            return sortedKeys.map(k => obj[k] !== undefined ? obj[k] : "");
        });

        return { headers, rows };
    }

    // Construye fila para la tabla
    function buildRowHtml(materialData, rowIndex) {
        let tdVehicle = `<td nowrap>${materialData["Vehicle"]}</td>`;
        let tdVehicleVersion = `<td nowrap>${materialData["Vehicle_version"]}</td>`;
        let tdSOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))"]}</td>`;
        let tdEOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))"]}</td>`;
        let tdRealSOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"]}</td>`;
        let tdRealEOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"]}</td>`;
        let tdShipTo = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))"]}</td>`;
        let tdPartName = `<td nowrap>${materialData["Part_Name"]}</td>`;
        let tdPartNumber = `<td nowrap>${materialData["Part_Number"]}</td>`;
        let tdQuality = `<td nowrap>${materialData["Quality"]}</td>`;
        let tdProgramSP = `<td nowrap>${materialData["Program_SP"]}</td>`;
        let tdMaxProduction = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))"]}</td>`;
        let tdAnnualVolume = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))"]}</td>`;
        let tdVolumePerYear = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))"]}</td>`;

        // Para ID_Route, buscamos el texto en el combo:
        let routeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))"];
        let routeText = $("#ID_Route option[value='" + routeId + "']").text() || routeId;  // Si no se encuentra, muestra el id
        let tdIDRoute = `<td nowrap>${routeText}</td>`;

        //tensile
        let tdTensileStrenght = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))"]}</td>`;

        // Para ID_Material_type
        let materialTypeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))"];
        let materialTypeText = $("#ID_Material_type option[value='" + materialTypeId + "']").text() || materialTypeId;  // Si no se encuentra, muestra el id
        let tdMaterialType = `<td nowrap>${materialTypeText}</td>`;

        //thickness, width, pitch
        let tdThickness = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))"]}</td>`;
        let tdWidth = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))"]}</td>`;
        let tdPitch = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))"]}</td>`;
        let tdTheoricalGrossWeight = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))"]}</td>`;
        let tdGrossWeight = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"]}</td>`;

        // Para ID_Shape
        let shapeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))"];
        let shapeText = $("#ID_Shape option[value='" + shapeId + "']").text() || shapeId;  // Si no se encuentra, muestra el id
        let tdShape = `<td nowrap>${shapeText}</td>`;

        let tdAngleA = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]}</td>`;
        let tdAngleB = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]}</td>`;
        let tdBlanksPerStroke = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))"]}</td>`;
        let tdPartsPerVehicle = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))"]}</td>`;

        // Para ID_Real_Blanking_Line
        let realLineId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))"];
        let realLineText = $("#ID_Real_Blanking_Line option[value='" + realLineId + "']").text() || realLineId;  // Si no se encuentra, muestra el id
        let tdRealLine = `<td nowrap>${realLineText}</td>`;

        let tdTheoricalStrokes = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))"]}</td>`;
        let tdRealStrokes = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))"]}</td>`;
        let tdIdealCycleTimePerTool = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))"]}</td>`;
        let tdOEE = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))"]}</td>`;
        let tdStatusDM = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))"]}</td>`;


        let hiddenInputs = "";
        for (let col of columnDefs) {
            let inputValue;

            if (col.type === "check") {
                // Para checkbox siempre usamos el verdadero "true" o "false"
                inputValue = materialData[col.key] === "true" ? "true" : "false";
            }
            else {
                let $input = $(col.selector);
                if ($input.attr("type") === "hidden") {
                    // Hidden: tomamos siempre materialData
                    inputValue = materialData[col.key];
                } else {
                    // Visible → su valor, Oculto → vacío
                    inputValue = $input.is(":visible") ? materialData[col.key] : "";
                }
            }

            hiddenInputs +=
                `<input type="hidden" name="materials[${rowIndex}].${col.key}" value="${inputValue}" />`;
        }

        // V V V --- AÑADIR ESTE BUCLE --- V V V
        // Generar un input hidden por cada ID de RackType seleccionado
        if (materialData.SelectedRackTypeIds && materialData.SelectedRackTypeIds.length > 0) {
            materialData.SelectedRackTypeIds.forEach(function (id) {
                hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].SelectedRackTypeIds" value="${id}" />`;
            });
        }
        if (materialData.SelectedAdditionalIds) { materialData.SelectedAdditionalIds.forEach(function (id) { hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].SelectedAdditionalIds" value="${id}" />`; }); }
        if (materialData.SelectedLabelIds) { materialData.SelectedLabelIds.forEach(function (id) { hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].SelectedLabelIds" value="${id}" />`; }); }
        if (materialData.SelectedStrapTypeIds) { materialData.SelectedStrapTypeIds.forEach(function (id) { hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].SelectedStrapTypeIds" value="${id}" />`; }); }

        // Agregar bandera para identificar que este material es el que tendrá el archivo.
        // Si materialData["IsFile"] está definido, úsalo; en caso contrario, asigna "false".
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsFile" value="${materialData["IsFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsPackagingFile" value="${materialData["IsPackagingFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsTechnicalSheetFile" value="${materialData["IsTechnicalSheetFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsAdditionalFile" value="${materialData["IsAdditionalFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsArrivalAdditionalFile" value="${materialData["IsArrivalAdditionalFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsCoilDataAdditionalFile" value="${materialData["IsCoilDataAdditionalFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsSlitterDataAdditionalFile" value="${materialData["IsSlitterDataAdditionalFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsVolumeAdditionalFile" value="${materialData["IsVolumeAdditionalFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsOutboundFreightAdditionalFile" value="${materialData["IsOutboundFreightAdditionalFile"] || "false"}" />`;
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsDeliveryPackagingAdditionalFile" value="${materialData["IsDeliveryPackagingAdditionalFile"] || "false"}" />`;

        let tdActions = `
                            <td nowrap>
                                <button type="button" class="btn btn-warning btn-xs edit-row">Edit</button>
                                <button type="button" class="btn btn-danger btn-xs remove-row">Remove</button>
                                ${hiddenInputs}
                            </td nowrap>`;

        let rowHtml = `
                            <tr data-index="${rowIndex}">
                                ${tdActions}
                                ${tdVehicle}
                                ${tdVehicleVersion}
                                ${tdSOP}
                                ${tdEOP}
                                ${tdRealSOP}
                                ${tdRealEOP}
                                ${tdShipTo}
                                ${tdPartName}
                                ${tdPartNumber}
                                ${tdQuality}
                                ${tdProgramSP}
                                ${tdMaxProduction}
                                ${tdAnnualVolume}
                                ${tdVolumePerYear}
                                ${tdIDRoute}
                                ${tdTensileStrenght}
                                ${tdMaterialType}
                                ${tdThickness}
                                ${tdWidth}
                                ${tdPitch}
                                ${tdBlanksPerStroke}
                                ${tdPartsPerVehicle}
                                ${tdTheoricalGrossWeight}
                                ${tdGrossWeight}
                                ${tdShape}
                                ${tdAngleA}
                                ${tdAngleB}
                                ${tdRealLine}
                                ${tdTheoricalStrokes}
                                ${tdRealStrokes}
                                ${tdIdealCycleTimePerTool}
                                ${tdOEE}
                                ${tdStatusDM}
                            </tr>`;

        return rowHtml;
    }

    function IniciaValidacionTiempoReal() {
        // Validación en tiempo real para el input de Vehicle
        $("#Vehicle").on("input", function () {
            validateMaterial("Vehicle");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#vehicleVersion").on('input', function () {
            validateMaterial("vehicleVersion");
        });

        $("#TonsPerShift").on("input", function () {
            validateMaterial("TonsPerShift");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#partName").on('input', function () {
            validateMaterial("partName");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#partNumber").on('input', function () {
            validateMaterial("partNumber");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#quality").on('input', function () {
            validateMaterial("quality");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").on('input changeDate', function () {
            validateMaterial("Real_SOP");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").on('input changeDate', function () {
            validateMaterial("Real_EOP");
        });
        // Validación en tiempo real para el input de Ship_To
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").on('input', function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))");
        });

        // Validación en tiempo real para el input de ID Route Dropdown
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))");
        });


        // Redondea a tres decimales después de perder el foco
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"
            ).on("blur", function () {
                redondearValor(this, 3);
            });


        //packaging standard
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))");
        });

        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
        });

        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        });
        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
        });
        var pitchTimeout;
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").on("input", function () {
            clearTimeout(pitchTimeout);
            pitchTimeout = setTimeout(function () {
                validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");
            }, 600);
        });
        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");
            updateAnnualTonnage();
            updatePackageWeight();

             // Si la forma es Rectangular o Trapecio, copia el valor al peso neto.
            const shapeId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").val();
            if (shapeId === "2" || shapeId === "3") {
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))").val($(this).val());
                // Re-validamos el campo neto después de cambiarlo.
                validateClientNetWeight();
            }
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))");
            updateAnnualTonnage();
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");
            shapeVisibility();
            updateWeightFieldsBasedOnShape();
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))");
        });
        // Validación en tiempo real para el input de SpecialRequirement
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))").on('keyup input', function () {
             validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))");
         });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))").on('keyup input', function () {
             validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))");
        });

        // Validación en tiempo real para el input de Coil Position Dropdown
        $("#ID_Coil_Position").on("change", function () {
            validateMaterial("ID_Coil_Position");
        });

        $("#ID_Arrival_Transport_Type").on("change", function () {
            validateMaterial("ID_Arrival_Transport_Type");
        });

        $("#Arrival_Transport_Type_Other").on("input", function () {
            validateMaterial("Arrival_Transport_Type_Other");
        });

        $("#ID_Arrival_Packaging_Type").on("change", function () {
            validateMaterial("ID_Arrival_Packaging_Type");
        });

        $("#PassesThroughSouthWarehouse").on("change", function () {
            validateMaterial("PassesThroughSouthWarehouse");
        });

        $("#ID_Arrival_Protective_Material").on("change", function () {
            validateMaterial("ID_Arrival_Protective_Material");
        });
        $("#Arrival_Protective_Material_Other").on("input", function () {
            validateMaterial("Arrival_Protective_Material_Other");
        });

        $("#Stackable_Levels").on("input", function () {
            validateMaterial("Stackable_Levels");
        });
        $("#Arrival_Comments").on("input", function () {
            validateMaterial("Arrival_Comments");
        });

        $("#packaging_archivo").on("change", function () {
            validateMaterial("packaging_archivo");
        });

        $("#StrapTypeObservations").on('keyup input', function () {
            validateMaterial("StrapTypeObservations");
        });
        $("#AdditionalsOtherDescription").on('keyup input', function () {
            validateMaterial("AdditionalsOtherDescription");
        });
        $("#LabelOtherDescription").on('keyup input', function () {
            validateMaterial("LabelOtherDescription");
        });

        $("#isRunningChange").on("change", function () {
            toggleRunningChangeWarning();
            validateMaterial("isRunningChange");
        });

        $("#IsCarryOver").on("change", function () {
            validateMaterial("IsCarryOver");
        });

        // --- AGREGA ESTE BLOQUE PARA LOS THICKNESS ---
        // Este evento se "adhiere" al documento y escucha por cualquier
        // 'input' que ocurra en un elemento que TENGA la clase '.welded-thickness-input',
        // sin importar si ese elemento existía al cargar la página.
        $(document).on('input', '.welded-thickness-input', function () {
            validateWeldedThicknesses();
        });

         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))");
            updatePackageWeight(); // Recalcular PackageWeight
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))");
            updatePackageWeight(); // Recalcular PackageWeight
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))").on("input", function () {
            toggleRunningChangeWarning();
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))");
            updatePackageWeight(); // <-- ¡Llamada importante!
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))");
        });

        // Manejador para el cambio en Freight Type
        $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))').on('change', function () {
            updateDeliveryTransportationTypeState(); // Esta función ya existía
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))"); // Validar al cambiar
        });

         // Manejador para el checkbox 'Scrap Reconciliation'
       $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))').on('change', function () {
            handleScrapReconciliationChange();
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))"); // Validar al cambiar
        });

        $("#ScrapReconciliationPercent_Min").on("input", function () { validateMaterial("ScrapReconciliationPercent_Min"); });
        $("#ScrapReconciliationPercent_Max").on("input", function () { validateMaterial("ScrapReconciliationPercent_Max"); });

         // Manejador para el checkbox 'Head/Tail Reconciliation'
         $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))').on('change', function () {
                handleHeadTailReconciliationChange();
                validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))"); // Validar al cambiar
            });

        $("#HeadTailReconciliationPercent_Min").on("input", function () { validateMaterial("HeadTailReconciliationPercent_Min"); });
        $("#HeadTailReconciliationPercent_Max").on("input", function () { validateMaterial("HeadTailReconciliationPercent_Max"); });
        $("#ClientScrapReconciliationPercent").on("input", function () { validateMaterial("ClientScrapReconciliationPercent"); });
        $("#ClientHeadTailReconciliationPercent").on("input", function () { validateMaterial("ClientHeadTailReconciliationPercent"); });

        $("#WeightOfFinalMults_Min").on("input", function () { validateMaterial("WeightOfFinalMults_Min"); });
        $("#WeightOfFinalMults_Max").on("input", function () { validateMaterial("WeightOfFinalMults_Max"); });

        $('#@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width)').on('input', function () {
                validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width)');
                validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos)');
                validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg)');
            });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos)'); });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg)'); });

        $('#@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch)').on('input', function () {
            validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch)');
            validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos)');
            validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg)');
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos)'); });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg)'); });
         $('#@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight)').on('input', function () {
            validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight)');
            validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos)');
            validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg)');
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos)'); });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg)'); });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke)'); });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))").on("input", function () { validateMaterial('@nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car)'); });

  $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))").on("input", function () {
     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))");
 });
 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))").on("input", function () {
     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))");
 });
 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))").on("input", function () {
     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))");
 });
 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))").on("change", function () {
     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))");
 });
 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))").on("change", function () {
     handleDeliveryTransportTypeChange(); // <--- Llama a la nueva función
     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))");
 });
 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))").on("input", function () {
     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))");
 });

     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))");
        });

    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))").on("change", function () { validateMaterial("RequiresRackManufacturing"); });
    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))").on("change", function () { validateMaterial("RequiresDieManufacturing"); });

        // Validación en tiempo real para el input de ID_Real_Blanking_Line Dropdown
      // --- NUEVO MANEJADOR ÚNICO PARA EL CAMBIO DE LÍNEA REAL ---

        // Variable para guardar el valor anterior antes de un cambio
        let previousRealLineValue = null;

        // 1. Antes de que el usuario abra el dropdown, guardamos el valor actual.
        $("#ID_Real_Blanking_Line").on("select2:open", function () {
            previousRealLineValue = $(this).val();
        });

        // 2. Creamos el manejador de evento 'change' que hará todo en orden.
        $("#ID_Real_Blanking_Line").on("change", function () {
            const selectedLineId = $(this).val();
            const selectedMaterialTypeId = $("#ID_Material_type").val();
            // Invocamos la nueva función para calcular el OEE
            fetchAndApplyOee(selectedLineId);

            // Si el usuario no seleccionó una línea (ej. eligió "Select Line"), no hacemos nada.
            if (!selectedLineId || selectedLineId === "0" || selectedLineId === "") {
                // Simplemente disparamos las actualizaciones con la línea teórica.
                debouncedUpdateTheoreticalLine();
                return;
            }

            // Si no hay un tipo de material seleccionado, tampoco podemos validar.
            if (!selectedMaterialTypeId) {
                // En este caso, el cambio de línea es válido, así que procedemos con las demás acciones.
                validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
                debouncedUpdateCapacityGraphs();
                return;
            }

            // 3. Hacemos la llamada AJAX para validar la compatibilidad.
            $.getJSON('@Url.Action("ValidateLineForMaterial", "CTZ_Projects")', { lineId: selectedLineId, materialTypeId: selectedMaterialTypeId })
                .done(function (response) {
                    if (response.isValid) {
                        // CASO A: ¡Es compatible! Procedemos con las acciones originales.
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
                        debouncedUpdateCapacityGraphs();
                    } else {
                        // CASO B: ¡No es compatible! Mostramos alerta y revertimos el cambio.
                        const lineName = $("#ID_Real_Blanking_Line option:selected").text();
                        const materialTypeName = $("#ID_Material_type option:selected").text();

                        Swal.fire({
                            icon: 'error',
                            title: 'Incompatible Line',
                            text: `The selected line "${lineName}" cannot process the material type "${materialTypeName}". The selection will be reverted.`
                        });

                        // Revertimos el dropdown a su valor ANTERIOR.
                        $("#ID_Real_Blanking_Line").val(previousRealLineValue).trigger('change.select2');

                        fetchAndApplyOee(previousRealLineValue);
                    }
                })
                .fail(function() {
                    // Si la llamada AJAX falla, mostramos un error y revertimos por seguridad.
                    toastr.error("Could not validate the production line. Reverting selection.");
                    $("#ID_Real_Blanking_Line").val(previousRealLineValue).trigger('change.select2');
                });
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))").on("change", shapeVisibility);

        //validacion de cadFile
        $("#archivo").on("change", function () {
            validateMaterial("archivo");
            if (this.files.length > 0) {
                const fileName = this.files[0].name;
                $(this).attr("title", fileName); // Aparece como tooltip
            }
        });
        //*** otros metodos y eventos ***

        //Calcula el valor de Theorical gross
        const debouncedUpdateGross = debounce(updateTheoreticalGrossWeight, 300);


        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))")
            .on("change keyup", debouncedUpdateGross);

        //solo se ejecuta cuando hay un cambio en linea teorica
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").on("change", function () {
            var newValue = $(this).val();
            if (newValue !== previousTheoreticalLine) {

                var realProductionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

                //si cambio el valor de la linea teorica y no hay Linea real
                if (realProductionLineId == "") {
                    //actualiza la capacidad
                    debouncedUpdateCapacityGraphs;
                }
                // Actualizamos la variable previousValue
                previousTheoreticalLine = newValue;
            }
        });
        //llama al metododo wrapper de graficas
        // Attach: para los select2 (cambia de valor directamente)
        $("#Vehicle").on("change", debouncedUpdateCapacityGraphs);

        // Para los inputs en los que el usuario debe dejar de teclear (se usa debounce de 1 segundo)
        // Para los inputs normales, mantenemos el evento "input"
        $("#Parts_Per_Vehicle, #Ideal_Cycle_Time_Per_Tool, #Blanks_Per_Stroke, #OEE, #Annual_Volume")
            .on("input", debounce(debouncedUpdateCapacityGraphs, 1000));

        // Para los campos de fecha, escuchamos TANTO "input" (teclear) COMO "changeDate" (seleccionar con el picker)
        $("#Real_SOP, #Real_EOP").on("input changeDate", debounce(debouncedUpdateCapacityGraphs, 1000));

        // Para los campos readonly que se actualizan mediante código, si se dispara manualmente el 'change'
        $("#Real_Strokes, #Theoretical_Strokes").on("change", debouncedUpdateCapacityGraphs);


    }

    function validateMaterial(fieldId) {
        console.log("Validando..." + fieldId)

        // Si no se especifica un campo, valida todos
        if (!fieldId) {
            let validVehicleVersion = validateVehicleVersion();
            let validPartName = validatePartName();
            let validPartNumber = validatePartNumber();
            let validQuality = validateQuality();
            let validVehicle = validateVehicle();
            let validRealSOP = validateRealSOP();
            let validRealEOP = validateRealEOP();
            let validShipTo = validateShipTo();
            let validRoute = validateRoute();
            let validTensile = validateTensileStrength();
            let validMaterialType = validateMaterialType();
            let validThickness = validateThickness();
            let validWidth = validateWidth();
            let validPitch = validatePitch();
            let validGrossWeight = validateGrossWeight();
            let validAnnualVolume = validateAnnualVolume();
            let validVolumePerYear = validateVolumePerYear();
            let validShape = validateShape();
            let validAngleA = validateAngleA();
            let validAngleB = validateAngleB();
            let validBlanksPerStroke = validateBlanksPerStroke();
            let validPartsPerVehicle = validatePartsPerVehicle();
            let validRealLine = validateRealLine();
            let validIdealCycleTimePerTool = validateIdealCycleTimePerTool();
            let validOEE = validateOEE();
            let validTonsPerShift = validateTonsPerShift(); // <-- Añadir
            let validThicknessTolNegative = validateThicknessToleranceNegative();
            let validThicknessTolPositive = validateThicknessTolerancePositive();
            let validWidthTolNegative = validateWidthToleranceNegative();
            let validWidthTolPositive = validateWidthTolerancePositive();
            let validPitchTolNegative = validatePitchToleranceNegative();
            let validPitchTolPositive = validatePitchTolerancePositive();
            let validAngleATolNegative = validateAngleAToleranceNegative();
            let validAngleATolPositive = validateAngleATolerancePositive();
            let validAngleBTolNegative = validateAngleBToleranceNegative();
            let validAngleBTolPositive = validateAngleBTolerancePositive();
            let validMultipliers = validateMultipliers();
            let validMajorBase = validateMajorBase();
            let validMajorBaseToleranceNegative = validateMajorBaseToleranceNegative();
            let validMajorBaseTolerancePositive = validateMajorBaseTolerancePositive();
            let validMinorBase = validateMinorBase();
            let validMinorBaseToleranceNegative = validateMinorBaseToleranceNegative();
            let validMinorBaseTolerancePositive = validateMinorBaseTolerancePositive();
            let validFlatness = validateFlatness();
            let validFlatnessToleranceNegative = validateFlatnessToleranceNegative();
            let validFlatnessTolerancePositive = validateFlatnessTolerancePositive();
            let validMasterCoilWeight = validateMasterCoilWeight();
            let validInnerCoilDiameterArrival = validateInnerCoilDiameterArrival();
            let validOuterCoilDiameterArrival = validateOuterCoilDiameterArrival();
            let validInnerCoilDiameterDelivery = validateInnerCoilDiameterDelivery();
            let validOuterCoilDiameterDelivery = validateOuterCoilDiameterDelivery();
            let validPackagingStandard = validatePackagingStandard();
            let validSpecialRequirement = validateSpecialRequirement();
            let validSpecialPackaging = validateSpecialPackaging();
            let validTurnOverSide = validateTurnOverSide();
            let validCADFile = validateCADFile();
            let validPackagingFile = validatePackagingFile();
            let validStrapObs = validateStrapTypeObservations();
            let validAdditionalObs = validateAdditionalsOtherDescription();
            let validLabelObs = validateLabelOtherDescription();
            let validWidthMults = validateWidth_Mults();
            let validWidthMultsTolNeg = validateWidth_Mults_Tol_Neg();
            let validWidthMultsTolPos = validateWidth_Mults_Tol_Pos();
            let validWidthPlates = validateWidth_Plates();
            let validWidthPlatesTolNeg = validateWidth_Plates_Tol_Neg();
            let validWidthPlatesTolPos = validateWidth_Plates_Tol_Pos();
            let validCoilPosition = validateCoilPosition();
            let validArrivalTransportType = validateArrivalTransportType();
            let validArrivalPackagingType = validateArrivalPackagingType();
            let validArrivalProtectiveMaterial = validateArrivalProtectiveMaterial();
            let validArrivalProtectiveMaterialOther = validateArrivalProtectiveMaterialOther();
            let validStackableLevels = validateStackableLevels();
            let validArrivalComments = validateArrivalComments();
            let validArrivalTransportTypeOther = validateArrivalTransportTypeOther();
            let validPiecesPerPackage = validatePiecesPerPackage();
            let validStacksPerPackage = validateStacksPerPackage();
            let validDeliveryConditions = validateDeliveryConditions();
            let validReturnableUses = validateReturnableUses();
            let validDeliveryCoilPos = validateDeliveryCoilPosition();
            let validDeliveryTransport = validateDeliveryTransportType();
            let validDeliveryTransportOther = validateDeliveryTransportTypeOther();
            let validFreightType = validateFreightType();
            let validArrivalWarehouse = validateArrivalWarehouse();
            let validClientNetWeight = validateClientNetWeight();
            let validIsRunningChange = validateIsRunningChange();
            let validNumberOfPlates = validateNumberOfPlates();
            let validWeldedThicknesses = validateWeldedThicknesses();
            let validScrapRecPerc = validateScrapReconciliationPercent();
            let validScrapRecPercMin = validateScrapReconciliationPercent_Min();
            let validScrapRecPercMax = validateScrapReconciliationPercent_Max();
            let validHeadTailRecPerc = validateHeadTailReconciliationPercent();
            let validHeadTailRecPercMin = validateHeadTailReconciliationPercent_Min();
            let validHeadTailRecPercMax = validateHeadTailReconciliationPercent_Max();
            let validWeightOfFinalMults = validateWeightOfFinalMults();
            let validWeightOfFinalMultsMin = validateWeightOfFinalMults_Min();
            let validWeightOfFinalMultsMax = validateWeightOfFinalMults_Max();
            let validPassesThroughSouthWarehouse = validatePassesThroughSouthWarehouse();
            let validClientScrap = validateClientScrapReconciliationPercent();
            let validClientHeadTail = validateClientHeadTailReconciliationPercent();
            let validIsCarryOver = validateIsCarryOver();
            let validReqRack = validateRequiresRackManufacturing();
            let validReqDie = validateRequiresDieManufacturing();
            let validShearing_Width = validateShearing_Width();
            let validShearing_Width_Tol_Pos = validateShearing_Width_Tol_Pos();
            let validShearing_Width_Tol_Neg = validateShearing_Width_Tol_Neg();
            let validShearing_Pitch = validateShearing_Pitch();
            let validShearing_Pitch_Tol_Pos = validateShearing_Pitch_Tol_Pos();
            let validShearing_Pitch_Tol_Neg = validateShearing_Pitch_Tol_Neg();
            let validShearing_Weight = validateShearing_Weight();
            let validShearing_Weight_Tol_Pos = validateShearing_Weight_Tol_Pos();
            let validShearing_Weight_Tol_Neg = validateShearing_Weight_Tol_Neg();
            let validShearing_Pieces_Per_Stroke = validateShearing_Pieces_Per_Stroke();
            let validShearing_Pieces_Per_Car = validateShearing_Pieces_Per_Car();

            return validVehicleVersion && validPartName && validPartNumber && validQuality && validVehicle
                && validRealSOP && validRealEOP && validShipTo && validRoute && validTensile && validMaterialType
                && validThickness && validWidth && validPitch && validGrossWeight && validAnnualVolume && validVolumePerYear
                && validShape && validAngleA && validAngleB && validBlanksPerStroke && validPartsPerVehicle && validRealLine
                && validIdealCycleTimePerTool && validOEE && validTonsPerShift && validThicknessTolNegative && validThicknessTolPositive
                && validWidthTolNegative && validWidthTolPositive && validPitchTolNegative && validPitchTolPositive
                && validAngleATolNegative && validAngleATolPositive && validAngleBTolNegative && validAngleBTolPositive
                && validMultipliers && validMajorBase && validMajorBaseToleranceNegative
                && validMajorBaseTolerancePositive && validMinorBase && validMinorBaseToleranceNegative && validMinorBaseTolerancePositive
                && validFlatness && validFlatnessToleranceNegative && validFlatnessTolerancePositive
                && validMasterCoilWeight && validInnerCoilDiameterArrival && validOuterCoilDiameterArrival
                && validInnerCoilDiameterDelivery && validOuterCoilDiameterDelivery && validPackagingStandard
                && validSpecialRequirement && validSpecialPackaging && validCADFile && validTurnOverSide && validPackagingFile
                && validSpecialPackaging && validTurnOverSide && validCADFile && validPackagingFile && validStrapObs && validAdditionalObs && validLabelObs
                && validWidthMults && validWidthMultsTolNeg && validWidthMultsTolPos && validWidthPlates && validWidthPlatesTolNeg && validWidthPlatesTolPos
                && validCoilPosition && validArrivalTransportType && validArrivalPackagingType && validArrivalProtectiveMaterial && validArrivalProtectiveMaterialOther
                && validStackableLevels && validArrivalComments && validArrivalTransportTypeOther && validPiecesPerPackage && validStacksPerPackage && validDeliveryConditions
                && validReturnableUses &&  validDeliveryCoilPos && validDeliveryTransport && validDeliveryTransportOther
                && validFreightType && validArrivalWarehouse && validClientNetWeight && validIsRunningChange && validNumberOfPlates && validWeldedThicknesses
                && validScrapRecPerc && validScrapRecPercMin && validScrapRecPercMax && validHeadTailRecPerc && validHeadTailRecPercMin && validHeadTailRecPercMax
                && validWeightOfFinalMults && validWeightOfFinalMultsMin && validWeightOfFinalMultsMax && validPassesThroughSouthWarehouse
                && validClientScrap && validClientHeadTail && validIsCarryOver && validReqRack && validReqDie && validShearing_Width && validShearing_Width_Tol_Pos
                && validShearing_Width_Tol_Neg && validShearing_Pitch && validShearing_Pitch_Tol_Pos && validShearing_Pitch_Tol_Neg
                && validShearing_Weight && validShearing_Weight_Tol_Pos && validShearing_Weight_Tol_Neg && validShearing_Pieces_Per_Stroke
                && validShearing_Pieces_Per_Car
                ;
        }

        // Validar sólo el campo indicado
        switch (fieldId) {
            case "Vehicle":
                return validateVehicle();
            case "vehicleVersion":
                return validateVehicleVersion();
            case "partName":
                return validatePartName();
            case "partNumber":
                return validatePartNumber();
            case "quality":
                return validateQuality();
            case "Real_SOP":
                return validateRealSOP();
            case "Real_EOP":
                return validateRealEOP();
            case "archivo":
                return validateCADFile();
            case "packaging_archivo":
                return validatePackagingFile();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))":
                return validateShipTo();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))":
                return validateRoute();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))":
                return validateTensileStrength();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))":
                return validateMaterialType();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))":
                return validateThickness();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))":
                return validateWidth();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))":
                return validatePitch();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))":
                return validateGrossWeight();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))":
                return validateAnnualVolume();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))":
                return validateVolumePerYear();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))":
                return validateShape();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))":
                return validateAngleA();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))":
                return validateAngleB();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))":
                return validateBlanksPerStroke();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))":
                return validatePartsPerVehicle();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))":
                return validateRealLine();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))":
                return validateIdealCycleTimePerTool();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))":
                return validateOEE();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))":
                return validateThicknessToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))":
                return validateThicknessTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))":
                return validateWidthToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))":
                return validateWidthTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))":
                return validatePitchToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))":
                return validatePitchTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))":
                return validateAngleAToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))":
                return validateAngleATolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))":
                return validateAngleBToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))":
                return validateAngleBTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))":
                return validateMultipliers();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))":
                return validateMajorBase();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))":
                return validateMajorBaseToleranceNegative();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))":
                return validateMajorBaseTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))":
                return validateMinorBase();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))":
                return validateMinorBaseToleranceNegative();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))":
                return validateMinorBaseTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))":
                return validateFlatness();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))":
                return validateFlatnessToleranceNegative();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))":
                return validateFlatnessTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))":
                return validateMasterCoilWeight();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))":
                return validateInnerCoilDiameterArrival();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))":
                return validateOuterCoilDiameterArrival();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))":
                return validateInnerCoilDiameterDelivery();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))":
                return validateOuterCoilDiameterDelivery();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))":
                return validatePackagingStandard();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))":
                return validateSpecialRequirement();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))":
                return validateSpecialPackaging();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))":
                return validateTurnOverSide();
            case "TonsPerShift":
                return validateTonsPerShift();
            case "StrapTypeObservations":
                return validateStrapTypeObservations();
            case "AdditionalsOtherDescription":
                return validateAdditionalsOtherDescription();
            case "LabelOtherDescription":
                return validateLabelOtherDescription();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))":
                return validateWidth_Mults();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))":
                return validateWidth_Mults_Tol_Neg();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))":
                return validateWidth_Mults_Tol_Pos();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))":
                return validateWidth_Plates();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))":
                return validateWidth_Plates_Tol_Neg();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))":
                return validateWidth_Plates_Tol_Pos();
            case "ID_Coil_Position":
                return validateCoilPosition();
            case "ID_Arrival_Transport_Type":
                return validateArrivalTransportType();
            case "Arrival_Transport_Type_Other":
                return validateArrivalTransportTypeOther();
            case "ID_Arrival_Packaging_Type":
                return validateArrivalPackagingType();
            case "ID_Arrival_Protective_Material":
                return validateArrivalProtectiveMaterial();
            case "Arrival_Protective_Material_Other":
                return validateArrivalProtectiveMaterialOther();
            case "Stackable_Levels":
                return validateStackableLevels();
            case "Arrival_Comments":
                return validateArrivalComments();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))":
                return validatePiecesPerPackage();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))":
                return validateStacksPerPackage();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))":
                return validateDeliveryConditions();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))":
                return validateReturnableUses(); // Validar el hijo cuando el padre cambia
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))":
                return validateReturnableUses();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))":
                return validateScrapReconciliationPercent(); // Validar el hijo
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))":
                return validateScrapReconciliationPercent();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))":
                return validateDeliveryCoilPosition();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))":
                return validateDeliveryTransportType();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))":
                return validateDeliveryTransportTypeOther();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))":
                return validateFreightType();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))":
                return validateArrivalWarehouse();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))":
                return validateClientNetWeight();
            case "isRunningChange": return validateIsRunningChange();
            case "IsWeldedBlank": return validateNumberOfPlates() && validateWeldedThicknesses();
            case "numberOfPlates": return validateNumberOfPlates() && validateWeldedThicknesses();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))": return validateScrapReconciliationPercent() && validateScrapReconciliationPercent_Min() && validateScrapReconciliationPercent_Max();
            case "ScrapReconciliationPercent_Min": return validateScrapReconciliationPercent_Min();
            case "ScrapReconciliationPercent_Max": return validateScrapReconciliationPercent_Max();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))": return validateHeadTailReconciliationPercent() && validateHeadTailReconciliationPercent_Min() && validateHeadTailReconciliationPercent_Max();
            case "HeadTailReconciliationPercent_Min": return validateHeadTailReconciliationPercent_Min();
            case "HeadTailReconciliationPercent_Max": return validateHeadTailReconciliationPercent_Max();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))": return validateWeightOfFinalMults() && validateWeightOfFinalMults_Min() && validateWeightOfFinalMults_Max();
            case "WeightOfFinalMults_Min": return validateWeightOfFinalMults_Min();
            case "WeightOfFinalMults_Max": return validateWeightOfFinalMults_Max();
            case "PassesThroughSouthWarehouse": return validatePassesThroughSouthWarehouse();
            case "ClientScrapReconciliationPercent": return validateClientScrapReconciliationPercent();
            case "ClientHeadTailReconciliationPercent": return validateClientHeadTailReconciliationPercent();
            case "IsCarryOver": return validateIsCarryOver();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresRackManufacturing))": return validateRequiresRackManufacturing();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.RequiresDieManufacturing))": return validateRequiresDieManufacturing();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))": return validateShearing_Width();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))": return validateShearing_Width_Tol_Pos();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))": return validateShearing_Width_Tol_Neg();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))": return validateShearing_Pitch();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))": return validateShearing_Pitch_Tol_Pos();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))": return validateShearing_Pitch_Tol_Neg();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))": return validateShearing_Weight();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))": return validateShearing_Weight_Tol_Pos();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))": return validateShearing_Weight_Tol_Neg();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))": return validateShearing_Pieces_Per_Stroke();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))": return validateShearing_Pieces_Per_Car();
            default:
                return true;
        }
        }

        function validatePassesThroughSouthWarehouse() {
            // Un checkbox opcional siempre es válido, ya sea que esté marcado o no.
            // No se necesita lógica de error.
            return true;
        }

        function validateShearing_Width() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))Error");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Width_Tol_Pos() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Pos))Error");
            const mainInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            let mainVal = parseFloat(mainInput.val());
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(mainVal) && val > mainVal) {
                errorEl.text("Tolerance cannot be greater than width.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Width_Tol_Neg() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width_Tol_Neg))Error");
            const mainInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Width))");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            let mainVal = parseFloat(mainInput.val());
            if (isNaN(val) || val > 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be <= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(mainVal) && Math.abs(val) > mainVal) {
                errorEl.text("Tolerance magnitude cannot be greater than width.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Pitch() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))Error");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Pitch_Tol_Pos() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Pos))Error");
            const mainInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            let mainVal = parseFloat(mainInput.val());
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(mainVal) && val > mainVal) {
                errorEl.text("Tolerance cannot be greater than pitch.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Pitch_Tol_Neg() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch_Tol_Neg))Error");
            const mainInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pitch))");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            let mainVal = parseFloat(mainInput.val());
            if (isNaN(val) || val > 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be <= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(mainVal) && Math.abs(val) > mainVal) {
                errorEl.text("Tolerance magnitude cannot be greater than pitch.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Weight() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))Error");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Weight_Tol_Pos() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Pos))Error");
            const mainInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            let mainVal = parseFloat(mainInput.val());
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(mainVal) && val > mainVal) {
                errorEl.text("Tolerance cannot be greater than weight.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Weight_Tol_Neg() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight_Tol_Neg))Error");
            const mainInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Weight))");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            let mainVal = parseFloat(mainInput.val());
            if (isNaN(val) || val > 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be <= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(mainVal) && Math.abs(val) > mainVal) {
                errorEl.text("Tolerance magnitude cannot be greater than weight.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Pieces_Per_Stroke() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Stroke))Error");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateShearing_Pieces_Per_Car() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Shearing_Pieces_Per_Car))Error");
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }


        function validateRequiresRackManufacturing() { return true; } // Checkbox opcional, siempre válido
        function validateRequiresDieManufacturing() { return true; } // Checkbox opcional, siempre válido

        function validateIsCarryOver() {
            // Un checkbox opcional no requiere validación de error, siempre es válido.
            return true;
        }
        function validateClientScrapReconciliationPercent() {
            const input = $("#ClientScrapReconciliationPercent");
            const errorEl = $("#ClientScrapReconciliationPercentError");
            if (!input.closest('.row').parent().is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be a number between 0 and 100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateClientHeadTailReconciliationPercent() {
            const input = $("#ClientHeadTailReconciliationPercent");
            const errorEl = $("#ClientHeadTailReconciliationPercentError");
            if (!input.closest('.row').parent().is(":visible")) return true;
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide(); input.css("border", "");
            if (!raw) return true;
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be a number between 0 and 100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateWeightOfFinalMults_Min() {
            const input = $("#WeightOfFinalMults_Min");
            const errorEl = $("#WeightOfFinalMults_MinError");
            const optimalInput = $("#WeightOfFinalMults");
            const maxInput = $("#WeightOfFinalMults_Max");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true;

            let val = parseFloat(raw);
            let optimalVal = parseFloat(optimalInput.val());
            let maxVal = parseFloat(maxInput.val());

            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(optimalVal) && val > optimalVal) {
                errorEl.text("Min cannot be greater than Optimal.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(maxVal) && val > maxVal) {
                errorEl.text("Min cannot be greater than Max.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateWeightOfFinalMults_Max() {
            const input = $("#WeightOfFinalMults_Max");
            const errorEl = $("#WeightOfFinalMults_MaxError");
            const optimalInput = $("#WeightOfFinalMults");
            const minInput = $("#WeightOfFinalMults_Min");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) return true;

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true;

            let val = parseFloat(raw);
            let optimalVal = parseFloat(optimalInput.val());
            let minVal = parseFloat(minInput.val());

            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(optimalVal) && val < optimalVal) {
                errorEl.text("Max cannot be less than Optimal.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(minVal) && val < minVal) {
                errorEl.text("Max cannot be less than Min.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateScrapReconciliationPercent_Min() {
            const input = $("#ScrapReconciliationPercent_Min");
            const errorEl = $("#ScrapReconciliationPercent_MinError");
            const optimalInput = $("#ScrapReconciliationPercent");
            const maxInput = $("#ScrapReconciliationPercent_Max");

            if (!input.closest('.row').parent().is(":visible")) return true;

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true;

            let val = parseFloat(raw);
            let optimalVal = parseFloat(optimalInput.val());
            let maxVal = parseFloat(maxInput.val());

            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be between 0-100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(optimalVal) && val > optimalVal) {
                errorEl.text("Min cannot be > Optimal.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(maxVal) && val > maxVal) {
                errorEl.text("Min cannot be > Max.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateScrapReconciliationPercent_Max() {
            const input = $("#ScrapReconciliationPercent_Max");
            const errorEl = $("#ScrapReconciliationPercent_MaxError");
            const optimalInput = $("#ScrapReconciliationPercent");
            const minInput = $("#ScrapReconciliationPercent_Min");

            if (!input.closest('.row').parent().is(":visible")) return true;

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true;

            let val = parseFloat(raw);
            let optimalVal = parseFloat(optimalInput.val());
            let minVal = parseFloat(minInput.val());

            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be between 0-100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(optimalVal) && val < optimalVal) {
                errorEl.text("Max cannot be < Optimal.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(minVal) && val < minVal) {
                errorEl.text("Max cannot be < Min.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateHeadTailReconciliationPercent_Min() {
            const input = $("#HeadTailReconciliationPercent_Min");
            const errorEl = $("#HeadTailReconciliationPercent_MinError");
            const optimalInput = $("#HeadTailReconciliationPercent");
            const maxInput = $("#HeadTailReconciliationPercent_Max");

            if (!input.closest('.row').parent().is(":visible")) return true;

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true;

            let val = parseFloat(raw);
            let optimalVal = parseFloat(optimalInput.val());
            let maxVal = parseFloat(maxInput.val());

            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be between 0-100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(optimalVal) && val > optimalVal) {
                errorEl.text("Min cannot be > Optimal.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(maxVal) && val > maxVal) {
                errorEl.text("Min cannot be > Max.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateHeadTailReconciliationPercent_Max() {
            const input = $("#HeadTailReconciliationPercent_Max");
            const errorEl = $("#HeadTailReconciliationPercent_MaxError");
            const optimalInput = $("#HeadTailReconciliationPercent");
            const minInput = $("#HeadTailReconciliationPercent_Min");

            if (!input.closest('.row').parent().is(":visible")) return true;

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true;

            let val = parseFloat(raw);
            let optimalVal = parseFloat(optimalInput.val());
            let minVal = parseFloat(minInput.val());

            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be between 0-100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(optimalVal) && val < optimalVal) {
                errorEl.text("Max cannot be < Optimal.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (!isNaN(minVal) && val < minVal) {
                errorEl.text("Max cannot be < Min.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateIsRunningChange() {
            // Un checkbox siempre es válido (true o false)
            // No se necesita lógica de error.
            return true;
        }
        function validateClientNetWeight() {
            const netInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))Error");
            const grossInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");

            if (netInput.prop("readonly") || netInput.prop("disabled") || !netInput.is(":visible")) {
                errorEl.text("").hide();
                netInput.css("border", "");
                return true;
            }

            let rawNet = netInput.val() ? netInput.val().trim() : "";
            errorEl.text("").hide();
            netInput.css("border", "");

            if (!rawNet) return true; // El campo es opcional, si está vacío no hay error.

            let netVal = parseFloat(rawNet);
            if (isNaN(netVal) || netVal < 0) {
                errorEl.text(isNaN(netVal) ? "Must be a number." : "Must be >= 0.").show();
                netInput.css("border", "1px solid red");
                return false;
            }

            let rawGross = grossInput.val() ? grossInput.val().trim() : "";
            if (rawGross) {
                let grossVal = parseFloat(rawGross);
                if (!isNaN(grossVal) && netVal > grossVal) {
                    errorEl.text("Net weight cannot be greater than Gross weight.").show();
                    netInput.css("border", "1px solid red");
                    return false;
                }
            }

            return true;
        }

         function validateFreightType() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))Error");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                input.next(".select2-container").find(".select2-selection").css("border", "");
                return true;
            }
            // (Validación opcional de obligatoriedad)
            // if (!input.val()) {
            //     errorEl.text("Freight Type is required.").show();
            //     input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
            //     return false;
            // }
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");
            return true;
        }

        function validateArrivalWarehouse() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Arrival_Warehouse))Error");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                input.next(".select2-container").find(".select2-selection").css("border", "");
                return true;
            }
            // (Validación opcional de obligatoriedad)
            // if (!input.val()) {
            //     errorEl.text("Arrival Warehouse is required.").show();
            //     input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
            //     return false;
            // }
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");
            return true;
        }

        function validatePiecesPerPackage() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))Error");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true; // Campo opcional

            let val = parseInt(raw, 10);
            if (isNaN(val) || val < 0 || raw.includes('.')) {
                errorEl.text("Must be a non-negative whole number.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateStacksPerPackage() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))Error");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) return true; // Campo opcional

            let val = parseInt(raw, 10);
            if (isNaN(val) || val < 0 || raw.includes('.')) {
                errorEl.text("Must be a non-negative whole number.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateDeliveryConditions() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.DeliveryConditions))Error");
            const limit = 350;

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            if (val.length > limit) {
                errorEl.text(`Cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateArrivalTransportTypeOther() {
            const input = $("#Arrival_Transport_Type_Other");
            const errorEl = $("#Arrival_Transport_Type_OtherError");
            const container = $("#Arrival_Transport_Type_Other_container");
            const limit = 50;

            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            const value = input.val().trim();
            errorEl.text("").hide();
            input.css("border", "");

            if (!value) {
                errorEl.text("Please specify the 'Other' transport type.").show();
                input.css("border", "1px solid red");
                return false;
            }

            if (value.length > limit) {
                errorEl.text(`Description cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        function validateStackableLevels() {
            const input = $("#Stackable_Levels");
            const errorEl = $("#Stackable_LevelsError");
            const container = $("#Stackable_Levels_container");

            // Si no es visible, no se valida
            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            let val = input.val().trim();
            errorEl.text("").hide();
            input.css("border", "");

            if (!val) {
                errorEl.text("Levels are required when 'Is Stackable' is checked.").show();
                input.css("border", "1px solid red");
                return false;
            }

            let num = parseInt(val, 10);
            if (isNaN(num) || num < 0 || val.includes('.')) {
                errorEl.text("Must be a non-negative whole number.").show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateArrivalComments() {
            const input = $("#Arrival_Comments");
            const errorEl = $("#Arrival_CommentsError");
            const limit = 250;

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            if (val.length > limit) {
                errorEl.text(`Comments cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateArrivalProtectiveMaterial() {
            const input = $("#ID_Arrival_Protective_Material");
            const errorEl = $("#ID_Arrival_Protective_MaterialError");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");

            if (!val || val === "") {
                errorEl.text("Protective Material is required.").show();
                input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
                return false;
            }

            // Disparar la validación del campo "Other" por si acaso
            validateArrivalProtectiveMaterialOther();
            return true;
        }

        function validateArrivalProtectiveMaterialOther() {
            const input = $("#Arrival_Protective_Material_Other");
            const errorEl = $("#Arrival_Protective_Material_OtherError");
            const container = $("#Arrival_Protective_Material_Other_container");

            // Si el contenedor no está visible, la validación no aplica
            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            let val = input.val().trim();
            errorEl.text("").hide();
            input.css("border", "");

            if (!val) {
                errorEl.text("Please specify the 'Other' material.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (val.length > 120) {
                errorEl.text("Cannot exceed 120 characters.").show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }
        function validateArrivalPackagingType() {
            const input = $("#ID_Arrival_Packaging_Type");
            const errorEl = $("#ID_Arrival_Packaging_TypeError");
            const status = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                input.next(".select2-container").find(".select2-selection").css("border", "");
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");

            if (!val || val === "") {
                if (requiredStatus.includes(status)) {
                    errorEl.text("Packaging Type is required.").show();
                    input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
                    return false;
                }
            }
            return true;
        }
        function validateArrivalTransportType() {
            const input = $("#ID_Arrival_Transport_Type");
            const errorEl = $("#ID_Arrival_Transport_TypeError");
            const status = statusId;

            // Estatus que hacen el campo obligatorio (ajusta según tus reglas de negocio)
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si está deshabilitado o no es visible, es válido
            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                errorEl.text("").hide();
                input.next(".select2-container").find(".select2-selection").css("border", "");
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");

            // Validar selección si es un estatus requerido
            if (!val || val === "") {
                if (requiredStatus.includes(status)) {
                    errorEl.text("Transport Type is required.").show();
                    input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
                    return false;
                }
            }

            return true;
        }

        function validateCoilPosition() {
            const input = $("#ID_Coil_Position");
            const errorEl = $("#ID_Coil_PositionError");
            const status = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omitir validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Validar selección
            if (!val || val === "") {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("Coil Position is required.")
                        .show();
                    input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            input.next(".select2-container").find(".select2-selection").css("border", "");
            return true;
        }

                function validateWidth_Mults() {
                    // 1) Elementos del DOM
                    const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))");
                    const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))Error");

            // 2) Si está deshabilitado, es válido
            if (input.prop("readonly") || input.prop("disabled")) return true;

            // 3) Limpiar errores previos
            errorEl.text("").hide();
            input.css("border", "");

            let raw = input.val() ? input.val().trim() : "";

            // 4) Si está vacío, es válido (campo opcional)
            if (!raw) return true;

            // 5) Validar que sea un número y no negativo
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // 6) Después de validarse a sí mismo, re-valida sus tolerancias dependientes
            validateWidth_Mults_Tol_Neg();
            validateWidth_Mults_Tol_Pos();

            return true;
        }

        function validateWidth_Mults_Tol_Neg() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Neg))Error");
            const widthInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))");

            if (input.prop("readonly") || input.prop("disabled")) return true;

            errorEl.text("").hide();
            input.css("border", "");

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) return true;

            let val = parseFloat(raw);
            if (isNaN(val) || val > 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be <= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Validar que la tolerancia no sea mayor que el ancho
            let widthVal = parseFloat(widthInput.val());
            if (!isNaN(widthVal) && Math.abs(val) > widthVal) {
                errorEl.text(`Absolute value cannot exceed Width (${widthVal}).`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateWidth_Mults_Tol_Pos() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults_Tol_Pos))Error");
            const widthInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Mults))");

            if (input.prop("readonly") || input.prop("disabled")) return true;

            errorEl.text("").hide();
            input.css("border", "");

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) return true;

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Validar que la tolerancia no sea mayor que el ancho
            let widthVal = parseFloat(widthInput.val());
            if (!isNaN(widthVal) && val > widthVal) {
                errorEl.text(`Value cannot exceed Width (${widthVal}).`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateWidth_Plates() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))Error");

            if (input.prop("readonly") || input.prop("disabled")) return true;

            errorEl.text("").hide();
            input.css("border", "");

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) return true;

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Re-validar tolerancias dependientes
            validateWidth_Plates_Tol_Neg();
            validateWidth_Plates_Tol_Pos();

            return true;
        }

        function validateWidth_Plates_Tol_Neg() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Neg))Error");
            const widthInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))");

            if (input.prop("readonly") || input.prop("disabled")) return true;

            errorEl.text("").hide();
            input.css("border", "");

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) return true;

            let val = parseFloat(raw);
            if (isNaN(val) || val > 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be <= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            let widthVal = parseFloat(widthInput.val());
            if (!isNaN(widthVal) && Math.abs(val) > widthVal) {
                errorEl.text(`Absolute value cannot exceed Width (${widthVal}).`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateWidth_Plates_Tol_Pos() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates_Tol_Pos))Error");
            const widthInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width_Plates))");

            if (input.prop("readonly") || input.prop("disabled")) return true;

            errorEl.text("").hide();
            input.css("border", "");

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) return true;

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be >= 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            let widthVal = parseFloat(widthInput.val());
            if (!isNaN(widthVal) && val > widthVal) {
                errorEl.text(`Value cannot exceed Width (${widthVal}).`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateTonsPerShift() {
            const input = $("#TonsPerShift");
            const errorEl = $("#TonsPerShiftError");

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                return true; // Es opcional, así que si está vacío, es válido.
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl.text(isNaN(val) ? "The value must be a number." : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateStrapTypeObservations() {
            const input = $("#StrapTypeObservations");
            const errorEl = $("#StrapTypeObservationsError");
            const limit = 120;

            // Si el campo no está visible, no se valida
            if (!input.is(":visible")) {
                errorEl.text("").hide();
                return true;
            }

            const value = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            if (value.length > limit) {
                errorEl.text(`Observations cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateAdditionalsOtherDescription() {
            const input = $("#AdditionalsOtherDescription");
            const errorEl = $("#AdditionalsOtherDescriptionError");
            const container = $("#AdditionalsOtherDescription_container"); // Apuntamos al contenedor
            const limit = 120;

            // Si el contenedor del campo NO es visible, la validación pasa automáticamente.
            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            // Si el contenedor SÍ es visible, entonces validamos.
            const value = input.val().trim();
            errorEl.text("").hide(); // Limpia errores previos
            input.css("border", "");

            // Regla 1: El campo no puede estar vacío
            if (!value) {
                errorEl.text("Please specify the 'Other' Additional description.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Regla 2: No puede exceder los 120 caracteres
            if (value.length > limit) {
                errorEl.text(`Description cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true; // Pasa todas las validaciones
        }

        function validateLabelOtherDescription() {
            const input = $("#LabelOtherDescription");
            const errorEl = $("#LabelOtherDescriptionError");
            const container = $("#LabelOtherDescription_container"); // Apuntamos al contenedor
            const limit = 120;

            // Si el contenedor del campo NO es visible, la validación pasa automáticamente.
            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            // Si el contenedor SÍ es visible, entonces validamos.
            const value = input.val().trim();
            errorEl.text("").hide(); // Limpia errores previos
            input.css("border", "");

            // Regla 1: El campo no puede estar vacío
            if (!value) {
                errorEl.text("Please specify the 'Other' Label description.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Regla 2: No puede exceder los 120 caracteres
            if (value.length > limit) {
                errorEl.text(`Description cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }

            return true; // Pasa todas las validaciones
        }

        function validateTurnOverSide() {
            // 1. Identificar los elementos con los que vamos a trabajar
            const turnOverSideInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))");
            const turnOverCheckbox = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))");
            const errorSpan = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))Error");

            // 2. Si el input está deshabilitado o es de solo lectura, se omite la validación
            if (turnOverSideInput.prop("readonly") || turnOverSideInput.prop("disabled")) {
                return true;
            }

            // 3. Limpiar cualquier mensaje de error y estilo previo
            errorSpan.text("").hide();
            // Para Select2, es mejor aplicar el estilo al contenedor visual
            turnOverSideInput.next(".select2-container").find(".select2-selection").css("border", "");

            // 4. Lógica de validación principal
            // Verificamos si el checkbox 'TurnOver' está seleccionado
            if (turnOverCheckbox.is(":checked")) {

                // Si está seleccionado, TurnOverSide es obligatorio. Obtenemos su valor.
                let turnOverSideValue = (turnOverSideInput.val() || "").trim();

                // Si el valor está vacío, mostramos el error.
                if (!turnOverSideValue) {
                    errorSpan.text("Side is required when 'Turn Over' is checked.").show();
                    turnOverSideInput.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
                    return false;
                }
            }

            // 5. Si el checkbox no está seleccionado, o si está seleccionado y el campo tiene valor, la validación es correcta.
            return true;
        }

       function validateCADFile() {
        const input = $("#archivo");
        const errorSpan = $("#CADFileError");
        const maxSize = 10 * 1024 * 1024; // 10 MB en bytes
        const allowedExtensions = [".dwg", ".dxf", ".dwt", ".pdf", ".zip", ".rar"];

        let requiredStatus = [@((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi), @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)];

        // Resetear mensajes y estilos
        errorSpan.text("").hide();
        input.css("border", "");

        // Si el input está oculto, no se valida nada
        if (!input.is(":visible")) {
            return true;
        }

        // Si el estado del proyecto NO está entre los obligatorios, no se exige tener un archivo (es opcional)
        if (requiredStatus.indexOf(statusId) === -1) {
            // Si no se seleccionó archivo, salimos sin error
            if (!input[0].files[0]) {
                return true;
            }
        } else {
            // Si el estado es de archivo obligatorio, se exige que se seleccione uno
            if (!input[0].files[0]) {
                errorSpan.text("CAD file is required for projects with status of 75% or higher.").show();
                input.css("border", "1px solid red");
                return false;
            }
        }

        // Si se seleccionó un archivo, validar tamaño
        const file = input[0].files[0];
        if (file.size > maxSize) {
            errorSpan.text("File size must be 10MB or less.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // Validar extensión (usa mayúsculas/minúsculas mediante toLowerCase())
        const fileName = file.name.toLowerCase();
        const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
        if (!isValidExtension) {
            errorSpan.text("Only DWG, DXF, DWT, PDF, ZIP and RAR files are allowed.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
        }

        function validatePackagingFile() {
            // 1. Apuntar a los elementos HTML correctos
            const input = $("#packaging_archivo");
            const errorSpan = $("#PackagingFileError");

            // 2. Definir las reglas de validación
            const maxSize = 10 * 1024 * 1024; // 10 MB en bytes
            const allowedExtensions = [".dwg", ".dxf", ".dwt", ".pdf", ".zip", ".rar"];

            // 3. Resetear mensajes y estilos de error
            errorSpan.text("").hide();
            input.css("border", "");

            // 4. Si el campo no está visible, no se valida
            if (!input.is(":visible")) {
                return true;
            }

            // 5. Si no se ha seleccionado ningún archivo, es válido (es opcional)
            if (input[0].files.length === 0) {
                // NOTA: Si en el futuro este archivo se vuelve obligatorio bajo
                // ciertas condiciones, la lógica iría aquí, similar a como funciona
                // la validación de `statusId` en validateCADFile.
                return true;
            }

            // 6. Si se seleccionó un archivo, se procede a validar
            const file = input[0].files[0];

            // Validar el tamaño
            if (file.size > maxSize) {
                errorSpan.text("File size must not exceed 10MB.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Validar la extensión del archivo
            const fileName = file.name.toLowerCase();
            const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
            if (!isValidExtension) {
                errorSpan.text("Only DWG, DXF, DWT, PDF, ZIP and RAR files are allowed.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // Si todas las validaciones pasan
            return true;
        }


        function validateVehicle() {
            const input = $("#Vehicle");

            // Si el input tiene el atributo readonly o disabled, se omite la validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            // DESPUÉS (Solución)
            // Se asegura de que vehicle sea siempre una cadena, incluso si .val() es null.
            let vehicle = ($("#Vehicle").val() || "").trim();

            $("#VehicleError").text("").hide();
            $("#Vehicle").css("border", "");

            if (!vehicle) {
                $("#VehicleError").text("Vehicle is required.").show();
                $("#Vehicle").css("border", "1px solid red");
                return false;
            }

            // Si NO es automotriz, validar longitud máxima
            if (vehicleType != 1 && vehicle.length > 120) {
                $("#VehicleError").text("Vehicle cannot exceed 120 characters.").show();
                $("#Vehicle").css("border", "1px solid red");
                return false;
            }

            return true;
        }

    function validateRoute() {

        const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let route = input.val();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").css("border", "");

        // Se asume que la opción por defecto tiene un valor vacío ("") o "Select a Route"
        if (!route || route === "Select a Route") {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route) is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").css("border", "1px solid red");
            return false;
        } else {
            return true;
        }
    }

        function validateMaterialType() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omito validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Validar selección
            if (!val || val === "Select Material Type") {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ID_Material_type) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            return true;
        }


        function validateShape() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omito validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Validar selección
            if (!val || val === "Select Shape") {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ID_Shape) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            return true;
        }


        function validatePackagingStandard() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omito validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Si no seleccionó nada o quedó en el texto por defecto...
            if (!val || val === "Select an option") {
                if (requiredStatus.includes(status)) {
                    errorEl
                      .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().PackagingStandard) is required.")
                      .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                // opcional en otros estatus
                return true;
            }

            // Todo OK
            return true;
        }


    function validateRealLine() {
        const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
        const err = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error");

        // 0) Actualiza antes el resto de los campos, por si no alcanzan a actualizarse porque no paso la validación
        debouncedUpdateTheoreticalLine();
        updateRealStrokes();

        // 1) Si está readonly o disabled, no validamos
        if (input.prop("readonly") || input.prop("disabled")) {
          return true;
        }

        // 2) Si el usuario PUEDE editar ingeniería, entonces este campo es obligatorio
        if (canEditEngineering) {
          const val = input.val();
          if (!val || val === "0") {
            err.text("Real blanking line is required.").show();
            input.css("border", "1px solid red");
            return false;
          }
        }

        // 3) Si pasó la validación, ocultamos mensaje y borde rojo
        err.text("").hide();
        input.css("border", "");

        // 4) Limpiamos cualquier gráfico previo
        $("#capacityTableContainer").html("");

        return true;
      }


       /**
         * Carga y muestra la gráfica de capacidad del Slitter.
         * Asume que ya se ha decidido que la gráfica debe ser visible.
         */
         // Reemplaza tu función `updateSlitterCapacityChart` con esta nueva versión
    function updateSlitterCapacityChart(OnlyBDMaterials = false, projectId) {
        // Limpiamos la consola para tener una salida limpia en cada ejecución de "what-if"
        if (!OnlyBDMaterials) {
            //console.clear();
            console.log("%c--- What-If Slitter Calculation [START] ---", "color: #009ff5; font-weight: bold;");
        }

        const container = $("#slitterChartContainer");
        container.html("<p style='color:gray;'>Loading Slitter Capacity <i class='fa-solid fa-spinner fa-spin-pulse'></i></p>").slideDown();

        let ajaxData = {
            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(), // AÑADIDO: Token de seguridad
            projectId: projectId, // <-- AÑADIDO
            plantId: @Model.ID_Plant,
            applyDateFilter: true,
            OnlyBDMaterials: OnlyBDMaterials
        };

        // Si es un escenario "what-if", recolectamos y enviamos los datos del formulario
        if (!OnlyBDMaterials) {
            let whatIfMaterials = [];
            const materialIdBeingEdited = parseInt($("#materialId").val(), 10) || 0; // 0 si es nuevo

            console.log(`Modo Simulación: Editando Material ID: ${materialIdBeingEdited === 0 ? 'NUEVO' : materialIdBeingEdited}`);

            // 1. Construimos la lista base con los datos guardados de CADA material en la tabla
            // --- CAMBIO INICIA: Lógica mejorada para construir el JSON ---
            $("#materialsTable tbody tr").each(function () {
                const row = $(this);
                const materialIdInRow = parseInt(row.data("material-id"), 10);

                let material = {
                    ID_Material: materialIdInRow,
                    Vehicle: row.find("input[name$='.Vehicle']").val(),
                    Vehicle_2: row.find("input[name$='.Vehicle_2']").val(),
                    Vehicle_3: row.find("input[name$='.Vehicle_3']").val(),
                    Vehicle_4: row.find("input[name$='.Vehicle_4']").val(),
                    ID_Route: parseInt(row.find("input[name$='.ID_Route']").val()) || null,
                    Initial_Weight: 0,
                    IsEdited: false,
                    Real_SOP: row.find("input[name$='.Real_SOP']").val() || null,
                    Real_EOP: row.find("input[name$='.Real_EOP']").val() || null,
                    SOP_SP: row.find("input[name$='.SOP_SP']").val() || null,
                    EOP_SP: row.find("input[name$='.EOP_SP']").val() || null
                };

                // Calcular Initial_Weight basado en los datos de la fila
                // Calcular Initial_Weight para la fila de la tabla usando la NUEVA fórmula
                const annualVol = parseFloat(row.find("input[name$='.Annual_Volume']").val());
                const volPerYear = parseFloat(row.find("input[name$='.Volume_Per_year']").val());

                if (!isNaN(annualVol) && !isNaN(volPerYear) && annualVol !== 0) {
                    // 1. Calcula el peso base (Weight per Part)
                    const weightPerPart = (volPerYear / annualVol) * 1000;
                    // 2. Calcula el Initial Weight final sumando el 1.5%
                    material.Initial_Weight = weightPerPart * 1.015;
                }

                // Si el ID de esta fila coincide con el que está en el formulario,
                // significa que ESTE es el material que se está editando.
                if (materialIdInRow === materialIdBeingEdited && materialIdBeingEdited !== 0) {
                    material.IsEdited = true;
                    // Aquí, podrías sobreescribir los valores de la fila con los del formulario
                    // si quieres que la simulación sea 100% en tiempo real, pero la lógica actual ya lo hace bien
                    // al reemplazar el objeto completo en el siguiente paso.
                }

                whatIfMaterials.push(material);
            });

            const formData = {
                ID_Material: materialIdBeingEdited,
                Vehicle: $("#Vehicle").val(),
                Vehicle_2: $("#Vehicle_2").val(),
                Vehicle_3: $("#Vehicle_3").val(),
                Vehicle_4: $("#Vehicle_4").val(),
                ID_Route: parseInt($("#ID_Route").val()) || null,
                Initial_Weight: parseFloat($("#Initial_Weight").val()) || 0,
                IsEdited: true,
                Real_SOP: $("#Real_SOP").val() || null,
                Real_EOP: $("#Real_EOP").val() || null,
                SOP_SP: $("#SOP_SP").val() || null,
                EOP_SP: $("#EOP_SP").val() || null
            };

            if (materialIdBeingEdited !== 0) {
                // Modo Edición: Reemplazar el material existente en la lista.
                const index = whatIfMaterials.findIndex(m => m.ID_Material === materialIdBeingEdited);
                if (index > -1) {
                    whatIfMaterials[index] = formData;
                }
            } else {
                // Modo Nuevo: Agregar el material del formulario a la lista.
                whatIfMaterials.push(formData);
            }

            // 4. Mensaje de depuración final con el payload que se enviará
            console.log("Payload de materiales para simulación:", JSON.parse(JSON.stringify(whatIfMaterials)));

            ajaxData.whatIfDataJson = JSON.stringify(whatIfMaterials);
        }

        $.ajax({
            url: '@Url.Action("GetSlitterCapacityData", "CTZ_Projects")',
            type: 'POST',
            data: ajaxData,
            success: function (response) {
                if (!OnlyBDMaterials) console.log("Respuesta del servidor:", response);

                if (response.success && response.data && response.data.length > 0) {
                    generateCharts(response.data, {}, "#slitterChartContainer");
                } else {
                    container.html("<p style='color:red;'>Could not load Slitter capacity data.</p>");
                    if (response.message) toastr.error(response.message);
                }

                if (!OnlyBDMaterials) console.log("%c--- What-If Slitter Calculation [END] ---", "color: #009ff5; font-weight: bold;");
            },
            error: function (xhr, status, error) {
                container.html("<p style='color:red;'>Error fetching Slitter capacity data.</p>");
                if (!OnlyBDMaterials) console.log("%c--- What-If Slitter Calculation [ERROR] ---", "color: red; font-weight: bold;");
            }
        });
    }


     function validateRealSOP() {

          const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))");
          const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error");


        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
         }

         // Limpiar cualquier mensaje de error y estilo previo.
         errorEl.text("").hide();
         input.css("border", "");

         let realSOPStr = input.val().trim();

        // Validación 1: Campo requerido.
            if (!realSOPStr) {
                errorEl.text("Real SOP is required.").show();
                input.css("border", "1px solid red");
                return false;
            }

            let realSOPDate = parseYearMonth(realSOPStr);

            // Validar si el formato de fecha es correcto.
            if (!realSOPDate) {
                errorEl.text("Invalid date format. Use yyyy-mm.").show();
                input.css("border", "1px solid red");
                return false;
         }
             // Validación 2: No puede ser de un año anterior al actual.
         const currentYear = new Date().getFullYear();
         if (realSOPDate.getFullYear() < currentYear) {
             // Se muestra un toast de advertencia en lugar de un error.
             toastr.warning(`Warning: Real SOP is in a year before the current year (${currentYear}).`, "Date Warning");

             // IMPORTANTE: Ya no se retorna 'false', por lo que la validación continúa.
         }
         // --- INICIO DE LA NUEVA LÓGICA ---

            // Validación 3: Debe ser anterior al Real EOP, si este existe.
            let realEOPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val().trim();
            if (realEOPStr) {
                let realEOPDate = parseYearMonth(realEOPStr);
                if (realEOPDate && realSOPDate >= realEOPDate) {
                    errorEl.text("Real SOP must be before Real EOP.").show();
                    input.css("border", "1px solid red");
                    return false;
                }
            }

            // --- FIN DE LA NUEVA LÓGICA ---

            // Validación 4 (Advertencia): Comparar con el SOP planeado si está disponible.
            let sopSPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))").val().trim();
            if (sopSPStr) {
                let sopSPDate = parseYearMonth(sopSPStr);
                if (sopSPDate && realSOPDate < sopSPDate) {
                    toastr.warning("Warning: Real SOP is before the planned SOP.");
                }
            }


        return true;
    }

    function validateRealEOP() {
         const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let realEOPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val().trim();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").css("border", "");

        if (!realEOPStr) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error").text("Real EOP is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").css("border", "1px solid red");
            return false;
        }

        // Obtener el valor de EOP_SP
        let eopSPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))").val().trim();
        let realEOPDate = parseYearMonth(realEOPStr);
        let eopSPDate = parseYearMonth(eopSPStr);

        if (realEOPDate && eopSPDate && realEOPDate > eopSPDate) {
            toastr.warning("Real EOP is later than the planned EOP.");
        }

        return true;
    }

     function validateTensileStrength() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // Si readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // Si está vacío…
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Tensile_Strenght) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        // Advertencia de rango (no bloqueante)
         if (window.engineeringRanges) {
             let criterio = window.engineeringRanges.find(r => r.ID_Criteria === 14);
             if (criterio && !validarContraCriterio(val, criterio)) {
                 input.css("border", "1px solid red");
                 errorEl.text(describirLimites(criterio)).show();
                 return false;
             }
         }
        return true;
    }


    function validateThickness() {
        // 1) IDs y estatus global
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error");
        const status  = statusId;  // tu variable global

        // 2) Estatus en los que Thickness es obligatorio
        let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 3) Si readonly o disabled, salto validación completa
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 4) Lectura y limpieza inicial
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 5) Si está vacío...
        if (!raw) {
            // 5.a) Si el estatus exige que sea obligatorio → error
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Thickness) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            // 5.b) Si es opcional, permitimos vacío (no aplicamos más reglas)
            return true;
        }

        // 6) Intentamos parsear número
        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 7) Validación de no-negativo
        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 8) Aviso de rango mínimo/máximo (no bloqueante)
        if (window.engineeringRanges) {
            let criterio = window.engineeringRanges.find(r => r.ID_Criteria === 7);  //thickness
            if (criterio && !validarContraCriterio(val, criterio)) {
                input.css("border", "1px solid red");
                errorEl.text(describirLimites(criterio)).show();
                return false;
            }
        }
        // 9) Re-validar las tolerancias, ya que dependen de este valor

        validateThicknessToleranceNegative();
        validateThicknessTolerancePositive();
        // 9) Todo OK
        return true;
    }


    function validateThicknessToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))Error");
        const thicknessInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        const status  = statusId;

        // 1) Define los estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 2) Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 3) Lectura y limpieza inicial
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 4) Si no escribieron nada...
        if (!raw) {
            // 4.a) Si el estatus exige que sea obligatorio → error
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ThicknessToleranceNegative) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            // 4.b) Si es opcional, permitimos vacío
            return true;
        }

        // 5) Validar que sea número
        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl.text(isNaN(val) ? "The value must be a number." : "The value must be <= 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 7) Validar que la tolerancia no sea mayor en valor absoluto que el espesor
        let thicknessVal = parseFloat(thicknessInput.val());
        if (!isNaN(thicknessVal) && Math.abs(val) > thicknessVal) {
            errorEl.text(`Absolute value cannot exceed Thickness (${thicknessVal} mm).`).show();
            input.css("border", "1px solid red");
            return false;
        }

        // 8) Todo OK
        return true;
    }

    function validateThicknessTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))Error");
        const thicknessInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        const status  = statusId;

        // 1) Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 2) Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 3) Lectura y limpieza inicial
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 4) Si no escribieron nada...
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ThicknessTolerancePositive) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // 5) Validar que sea número
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl.text(isNaN(val) ? "The value must be a number." : "The value must be >= 0.").show();
            input.css("border", "1px solid red");
            return false;
        }
        // 6) Validar que la tolerancia no sea mayor que el espesor
        let thicknessVal = parseFloat(thicknessInput.val());
        if (!isNaN(thicknessVal) && val > thicknessVal) {
            errorEl.text(`Value cannot exceed Thickness (${thicknessVal} mm).`).show();
            input.css("border", "1px solid red");
            return false;
        }

        // 7) Todo OK
        return true;
    }


   function validateWidthToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().WidthToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


   function validateWidthTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().WidthTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


     function validatePitchToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().PitchToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validatePitchTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().PitchTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }

       function validateAngleAToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleAToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be lower than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleATolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleATolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleBToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleBToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be lower than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleBTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleBTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateWeightOfFinalMults() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))Error");
        const status  = statusId;

        // 1) Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 2) Si readonly/disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 3) Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 4) Vacío → si es obligatorio, error; si no, OK
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().WeightOfFinalMults) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // 5) Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


       function validateMultipliers() {
            // -- INICIO DEL CAMBIO --

            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))Error");
            const status = statusId;

            // 1. Definir la condición especial y los estatus donde el campo es normalmente requerido.
            const isExternalSlitter = (hasExternalProcessor && externalProcessorId === 1);
            const requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // 2. Si está deshabilitado, es válido.
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            // 3. Limpiar errores y leer el valor.
            errorEl.text("").hide();
            input.css("border", "");
            let raw = input.val() ? input.val().trim() : "";

            // 4. Validar si el campo está VACÍO.
            if (!raw) {
                // Si es Slitter Externo, el campo vacío es VÁLIDO.
                if (isExternalSlitter) {
                    return true;
                }
                // Si NO es Slitter Externo, verificamos si es obligatorio por el estatus del proyecto.
                else if (requiredStatus.includes(status)) {
                    errorEl.text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Multipliers) is required.").show();
                    input.css("border", "1px solid red");
                    return false; // Es obligatorio y está vacío.
                }
                // Si no es obligatorio y está vacío, es válido.
                return true;
            }

            // 5. Si el campo TIENE VALOR, SIEMPRE debe ser un número válido y positivo.
            let val = parseFloat(raw);
            if (isNaN(val) || val <= 0) {
                errorEl.text(isNaN(val) ? "Must be a number." : "Must be > 0.").show();
                input.css("border", "1px solid red");
                return false;
            }

            // 6. Si NO es Slitter Externo, se aplican las validaciones de reglas de negocio (max mults).
            if (!isExternalSlitter) {
                if (window.maxMultsAllowed === null || window.maxMultsAllowed === 0) {
                    errorEl.text("A validation rule is missing for the current Thickness and Tensile values.").show();
                    input.css("border", "1px solid red");
                    return false;
                }

                if (val > window.maxMultsAllowed) {
                    errorEl.text(`Value cannot exceed the maximum of ${window.maxMultsAllowed} strips.`).show();
                    input.css("border", "1px solid red");
                    return false;
                }
            }

            // 7. Si pasó todas las validaciones aplicables, es válido.
            return true;
            // -- FIN DEL CAMBIO --
        }



    function validateMajorBase() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MajorBase) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


   function validateMajorBaseToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MajorBaseToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be lower than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMajorBaseTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MajorBaseTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMinorBase() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
         let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
         ];

        // Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // Vacío → si es obligatorio, error; si no, OK
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MinorBase) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
              .text(isNaN(val)
                  ? "The value must be a number."
                  : "The value must be greater than or equal to 0.")
              .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


   function validateMinorBaseToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MinorBaseToleranceNegative) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
              .text(isNaN(val)
                  ? "The value must be a number."
                  : "The value must be lower than or equal to 0.")
              .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMinorBaseTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MinorBaseTolerancePositive) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
              .text(isNaN(val)
                  ? "The value must be a number."
                  : "The value must be greater than or equal to 0.")
              .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateFlatness() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Flatness) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateFlatnessToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().FlatnessToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateFlatnessTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().FlatnessTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }

     function validateMasterCoilWeight() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MasterCoilWeight) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

         // Validación de valor numérico y no negativo (sin cambios)
         let val = parseFloat(raw);
         if (isNaN(val) || val < 0) {
             errorEl
                 .text(isNaN(val)
                     ? "The value must be a number."
                     : "The value must be a positive number.")
                 .show();
             input.css("border", "1px solid red");
             return false;
         }

         // --- INICIO DE LA MODIFICACIÓN ---

         // 1. Verificamos si los rangos de validación ya se cargaron desde el servidor.
            if (window.engineeringRanges) {

                // 2. Buscamos el criterio específico para MasterCoilWeight (ID_Criteria: 17)
                const criterio = window.engineeringRanges.find(r => r.ID_Criteria === 17);

                // 3. Si encontramos el criterio y el valor no es válido...
                if (criterio && !validarContraCriterio(val, criterio)) {

                    // 4. Mostramos el mensaje de error con los límites correctos y marcamos el campo.
                    errorEl.text(describirLimites(criterio)).show();
                    input.css("border", "1px solid red");
                    return false; // La validación falla.
                }
            }

        // --- FIN DE LA MODIFICACIÓN ---

        return true;
    }

        function validateInnerCoilDiameterArrival() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))Error");
            const status = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().InnerCoilDiameterArrival) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be a positive number.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            if (window.engineeringRanges) {
                // Buscamos el criterio para "Inner Coil Diameter" (ID_Criteria: 15)
                const criterio = window.engineeringRanges.find(r => r.ID_Criteria === 15);

                if (criterio) {
                    // --- LÓGICA EXISTENTE CUANDO SE ENCUENTRA UN CRITERIO ---
                    // Caso 1: El criterio define un único valor exacto.
                    if (criterio.NumericValue != null) {
                        if (val !== criterio.NumericValue) {
                            errorEl.text(`Value must be exactly ${criterio.NumericValue}.`).show();
                            input.css("border", "1px solid red");
                            return false;
                        }
                    }
                    // Caso 2: El criterio define un rango, y solo los extremos son válidos.
                    else if (criterio.MinValue != null && criterio.MaxValue != null) {
                        if (val !== criterio.MinValue && val !== criterio.MaxValue) {
                            errorEl.text(`Value must be either ${criterio.MinValue} or ${criterio.MaxValue}.`).show();
                            input.css("border", "1px solid red");
                            return false;
                        }
                    }
                } else {
                    // Se ejecuta cuando SÍ hay engineeringRanges, pero NINGUNO para el Criterio 15.
                    if (val !== 508 && val !== 610) {
                        errorEl.text("Value must be 508 or 610.").show();
                        input.css("border", "1px solid red");
                        return false;
                    }
                }
            } else {
                // Se ejecuta cuando NO existe el objeto engineeringRanges en absoluto.
                if (val !== 508 && val !== 610) {
                    errorEl.text("Value must be 508 or 610.").show();
                    input.css("border", "1px solid red");
                    return false;
                }
            }

            return true;
        }


        function validateOuterCoilDiameterArrival() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().OuterCoilDiameterArrival) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be a positive number.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

           if (window.engineeringRanges) {
                // Buscamos el criterio para "Outer Coil Diameter" (ID_Criteria: 16)
                const criterio = window.engineeringRanges.find(r => r.ID_Criteria === 16);

                if (criterio && !validarContraCriterio(val, criterio)) {
                    errorEl.text(describirLimites(criterio)).show();
                    input.css("border", "1px solid red");
                    return false;
                }
           }

            return true;
        }

      function validateInnerCoilDiameterDelivery() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().InnerCoilDiameterDelivery) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be a positive number.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            if (window.engineeringRanges) {
                // Buscamos el criterio para "Inner Coil Diameter" (ID_Criteria: 15)
                const criterio = window.engineeringRanges.find(r => r.ID_Criteria === 15);

                if (criterio) {
                    // --- LÓGICA EXISTENTE CUANDO SE ENCUENTRA UN CRITERIO ---
                    // Caso 1: El criterio define un único valor exacto.
                    if (criterio.NumericValue != null) {
                        if (val !== criterio.NumericValue) {
                            errorEl.text(`Value must be exactly ${criterio.NumericValue}.`).show();
                            input.css("border", "1px solid red");
                            return false;
                        }
                    }
                    // Caso 2: El criterio define un rango, y solo los extremos son válidos.
                    else if (criterio.MinValue != null && criterio.MaxValue != null) {
                        if (val !== criterio.MinValue && val !== criterio.MaxValue) {
                            errorEl.text(`Value must be either ${criterio.MinValue} or ${criterio.MaxValue}.`).show();
                            input.css("border", "1px solid red");
                            return false;
                        }
                    }
                } else {
                    // Se ejecuta si hay engineeringRanges, pero NINGUNO para el Criterio 15.
                    if (val !== 508 && val !== 610) {
                        errorEl.text("Value must be 508 or 610.").show();
                        input.css("border", "1px solid red");
                        return false;
                    }
                }
            } else {
                // Se ejecuta si NO existe el objeto engineeringRanges.
                if (val !== 508 && val !== 610) {
                    errorEl.text("Value must be 508 or 610.").show();
                    input.css("border", "1px solid red");
                    return false;
                }
            }

            return true;
        }

        function validateOuterCoilDiameterDelivery() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().OuterCoilDiameterDelivery) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be a positive number.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

           if (window.engineeringRanges) {
                // Buscamos el criterio para "Outer Coil Diameter" (ID_Criteria: 16)
                const criterio = window.engineeringRanges.find(r => r.ID_Criteria === 16);

                if (criterio && !validarContraCriterio(val, criterio)) {
                    errorEl.text(describirLimites(criterio)).show();
                    input.css("border", "1px solid red");
                    return false;
                }
            }

            return true;
        }


    function validateWidth() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Width) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (window.engineeringRanges) {
            let criterio = window.engineeringRanges.find(r => r.ID_Criteria === 8); //width
            if (criterio && !validarContraCriterio(val, criterio)) {
                input.css("border", "1px solid red");
                errorEl.text(describirLimites(criterio)).show();
                return false;
            }
        }

        return true;
    }


    function validatePitch() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error");
        const status  = statusId;

         let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
         ];

        // Calcula los golpes teóricos
        updateTheoreticalStrokes();
        updateRealStrokes();

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Pitch) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (window.engineeringRanges) {
            let criterio = window.engineeringRanges.find(r => r.ID_Criteria === 9); //pitch
            if (criterio && !validarContraCriterio(val, criterio)) {
                input.css("border", "1px solid red");
                errorEl.text(describirLimites(criterio)).show();
                return false;
            }
        }

        return true;
    }


     function validateGrossWeight() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
         ];

        // Si readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // Vacío → obligatorio solo en los estatus seleccionados
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Gross_Weight) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

         validateClientNetWeight();


        return true;
    }


     function validateAnnualVolume() {
        // 1) Actualizaciones previas
        updateBlanksPerYear();
        let diffPercentage = updateAnnualVolumeStyle();
        clearTimeout(volumeTimeout);
        volumeTimeout = setTimeout(function () {
            if (typeof diffPercentage !== "undefined") {
                showVolumeDifferenceToast(diffPercentage);
            }
        }, 900);

        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Annual_Volume) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


     function validateVolumePerYear() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Volume_Per_year) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleA() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Angle_A) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleB() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Angle_B) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


        function validateBlanksPerStroke() {
            // 1) Actualiza dependencias
            updateStrokesPerAuto();
            updateMinMaxReales();
            updateStrokesShift();

            // 2) Selección de elementos y estado
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error");
            const status  = statusId;

            // 3) Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // 4) Omitir validación si readonly o disabled
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            // 5) Leer y limpiar
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            // 6) Vacío → obligatorio si el estatus lo exige
            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Blanks_Per_Stroke) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            // 7) Validar número ≥ 0
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            // 8) Todo OK
            return true;
        }


    function validatePartsPerVehicle() {
        // 1) Actualiza Strokes per Auto y Blanks per Year
        updateStrokesPerAuto();
        updateBlanksPerYear();

        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error");
        const status  = statusId;

        // 2) Define los estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 3) Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            // pero igual asignamos el valor a parts_auto
            $("#parts_auto").val(input.val());
            return true;
        }

        // 4) Asigno a parts_auto sin importar si es obligatorio
        let partsValue = input.val();
        $("#parts_auto").val(partsValue);

        // 5) Leer y limpiar
        let raw = partsValue ? partsValue.trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 6) Si quedó vacío…
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Parts_Per_Vehicle) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // 7) Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        // 8) Todo OK
        return true;
    }


    // Funciones de validación individuales
     function validateVehicleVersion() {
          const input = $("#vehicleVersion");

         // Si el input tiene el atributo readonly o disabled, se omite la validación
         if (input.prop("readonly") || input.prop("disabled")) {
             return true;
         }

        let vehicleVersion = $("#vehicleVersion").val().trim();
        $("#vehicleVersionError").text("").hide();
        $("#vehicleVersion").css("border", "");
        if (!vehicleVersion) {
            $("#vehicleVersionError").text("Vehicle Version is required.").show();
            $("#vehicleVersion").css("border", "1px solid red");
            return false;
        } else if (vehicleVersion.length > 50) {
            $("#vehicleVersionError").text("Vehicle Version cannot exceed 50 characters.").show();
            $("#vehicleVersion").css("border", "1px solid red");
            return false;
        }
        return true;
    }

     function validatePartName() {
          const input = $("#partName");

         // Si el input tiene el atributo readonly o disabled, se omite la validación
         if (input.prop("readonly") || input.prop("disabled")) {
             return true;
         }

        let partName = $("#partName").val().trim();
        $("#partNameError").text("").hide();
        $("#partName").css("border", "");
        if (!partName) {
            $("#partNameError").text("Part Name is required.").show();
            $("#partName").css("border", "1px solid red");
            return false;
        } else if (partName.length > 50) {
            $("#partNameError").text("Part Name cannot exceed 50 characters.").show();
            $("#partName").css("border", "1px solid red");
            return false;
        }
        return true;
    }

    function validateShipTo() {
        const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let shipTo = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").val().trim();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "");
        if (!shipTo) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To) is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "1px solid red");
            return false;
        } else if (shipTo.length > 150) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To) cannot exceed 150 characters.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "1px solid red");
            return false;
        }
        return true;
    }

        function validateSpecialPackaging() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
               // @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
              //  @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si está readonly o disabled, no validar
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            const limit = 350;
            const value = input.val().trim();

            // Limpiar mensajes anteriores
            errorEl.text("").hide();
            input.css("border", "");

            // Si es obligatorio y quedó vacío → error
            if (!value) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                // opcional en otros estatus
                return true;
            }

            // ⚠️ Validar longitud si hay contenido
            if (value.length > limit) {
                errorEl
                    .text(
                        "@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging) cannot exceed " +
                        limit +
                        " characters."
                    )
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }



        function validateSpecialRequirement() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
               // @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
               // @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si está readonly o disabled, no validar
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            const limit = 350;
            const value = input.val().trim();

            // Limpiar mensajes anteriores
            errorEl.text("").hide();
            input.css("border", "");

            // Si es obligatorio y quedó vacío → error
            if (!value) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                // opcional en otros estatus
                return true;
            }

            // ⚠️ Validar longitud si hay contenido
            if (value.length > limit) {
                errorEl
                    .text(
                        "@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement) cannot exceed " +
                        limit +
                        " characters."
                    )
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }



    function validatePartNumber() {
        const input = $("#partNumber");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let partNumber = $("#partNumber").val().trim();
        $("#partNumberError").text("").hide();
        $("#partNumber").css("border", "");
        if (!partNumber) {
            $("#partNumberError").text("Part Number is required.").show();
            $("#partNumber").css("border", "1px solid red");
            return false;
        } else if (partNumber.length > 50) {
            $("#partNumberError").text("Part Number cannot exceed 50 characters.").show();
            $("#partNumber").css("border", "1px solid red");
            return false;
        }
        return true;
    }

    function validateQuality() {
        const input = $("#quality");
        const status = statusId;  // tu variable global

        // 1) Si readonly o disabled, omito todo
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 2) Defino qué estatus obligan a requerir el campo
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        let val = input.val() ? input.val().trim() : "";

        // 3) Siempre valido el largo máximo si escribieron algo
        if (val.length > 50) {
            $("#qualityError").text("Quality cannot exceed 50 characters.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 4) Si el estatus exige que sea obligatorio, entonces validamos que NO esté vacío
        if (requiredStatus.includes(status) && !val) {
            $("#qualityError").text("Quality is required.").show();
            input.css("border", "1px solid red");
            return false;
        }
        // 5) Si llegamos aquí, todo está OK
        $("#qualityError").text("").hide();
        input.css("border", "");
        return true;
    }

    function validateIdealCycleTimePerTool() {
        // 1) Actualizar min/max reales antes de validar
        updateMinMaxReales();

        // 2) Seleccionamos input y span de error
        const input     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))");
        const errorSpan = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error");

        // 3) Si está readonly o disabled, omitimos validación
        if (input.prop("readonly") || input.prop("disabled")) {
          return true;
        }

        // 4) Obligatorio si puede editar ingeniería
        let valueStr = input.val().trim();
        if (canEditEngineering && valueStr === "") {
          errorSpan.text("Ideal Cycle Time is required.").show();
          input.css("border", "1px solid red");
          return false;
        }

        // 5) Reiniciar mensajes y estilos
        errorSpan.text("").hide();
        input.css("border", "");

        // 6) Si vino vacío y no es obligatorio, es válido
        if (valueStr === "") {
          return true;
        }

        // 7) Convertir y validar que sea número >= 0
        let floatVal = parseFloat(valueStr);
        if (isNaN(floatVal) || floatVal < 0) {
          errorSpan.text("The value must be a number and greater than or equal to 0.").show();
          input.css("border", "1px solid red");
          return false;
        }

        return true;
      }

    function validateOEE() {
        // 1) Seleccionamos input y span de error
        const input     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))");
        const errorSpan = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error");

        // 2) Si está readonly o disabled, omitimos validación
        if (input.prop("readonly") || input.prop("disabled")) {
          return true;
        }

        // 3) Obligatorio si puede editar ingeniería
        let value = input.val().trim();
        if (canEditEngineering && value === "") {
          errorSpan.text("OEE is required.").show();
          input.css("border", "1px solid red");
          return false;
        }

        // 4) Si está vacío y no es obligatorio, es válido
        if (value === "") {
          return true;
        }

        // 5) Convertir a número y validar rango 0–100
        let num = parseFloat(value);
        if (isNaN(num)) {
          errorSpan.text("Please enter a valid number.").show();
          input.css("border", "1px solid red");
          return false;
        }
        if (num < 0 || num > 100) {
          errorSpan.text("Please enter a value between 0 and 100.").show();
          input.css("border", "1px solid red");
          return false;
        }

        // 6) Limpiar mensajes y estilos
        errorSpan.text("").hide();
        input.css("border", "");

        return true;
  }



    // Limpia el formulario
    function clearMaterialForm(columns) {
        $("#materialIndex").val("");
        $("#materialId").val("");

        for (let col of columns) {
            if (col.type && col.type === "dropdown") {
                $(col.selector).val("").trigger("change");
            } else {
                $(col.selector).val("");
                $(col.selector).css("background-color", "");
            }
            $(col.selector).css("border", "");
            $(col.selector + "Error").text("").hide();
        }
        //datos fuera del columns
         // --- LÓGICA DE LIMPIEZA MEJORADA ---

        updateWeightCalculations();
        // 1. Limpiar los campos que no están en columnDefs
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val("");
        $("#parts_auto").val("");
        updateStrokesPerAuto();
        updateBlanksPerYear();
        updateMinMaxReales();
        $("#ID_File_Packaging").val("");
        $("#ID_File_CAD_Drawing").val("");
        $("#PackagingFileName").val("");
        $("#CADFileName").val("");
        $("#ID_File_Additional").val("");
        $("#AdditionalFileName").val("");
        $("#ID_File_ArrivalAdditional").val("");
        $("#ArrivalAdditionalFileName").val("");
        $("#ID_File_CoilDataAdditional").val(""); $("#CoilDataAdditionalFileName").val("");
        $("#ID_File_SlitterDataAdditional").val(""); $("#SlitterDataAdditionalFileName").val("");
        $("#ID_File_VolumeAdditional").val(""); $("#VolumeAdditionalFileName").val("");
        $("#ID_File_OutboundFreightAdditional").val(""); $("#OutboundFreightAdditionalFileName").val("");
        $("#ID_File_DeliveryPackagingAdditional").val(""); $("#DeliveryPackagingAdditionalFileName").val("");

        updatePackagingFileUI();
        updateFileUIGeneric('ID_File_TechnicalSheet', 'TechnicalSheetFileName', 'file_container_technicalSheetFile', 'fileActions_containerTechnicalSheetFile', 'downloadFileTechnicalSheetFile');
        updateFileUIGeneric('ID_File_Additional', 'AdditionalFileName', 'file_container_AdditionalFile', 'fileActions_containerAdditionalFile', 'downloadFileAdditional');
        updateFileUIGeneric('ID_File_ArrivalAdditional', 'ArrivalAdditionalFileName', 'file_container_arrivalAdditionalFile', 'fileActions_containerArrivalAdditionalFile', 'downloadArrivalAdditionalFile');
        updateFileUIGeneric('ID_File_CoilDataAdditional', 'CoilDataAdditionalFileName', 'file_container_coilDataAdditionalFile', 'fileActions_containerCoilDataAdditionalFile', 'downloadCoilDataAdditionalFile');
        updateFileUIGeneric('ID_File_SlitterDataAdditional', 'SlitterDataAdditionalFileName', 'file_container_slitterDataAdditionalFile', 'fileActions_containerSlitterDataAdditionalFile', 'downloadSlitterDataAdditionalFile');
        updateFileUIGeneric('ID_File_VolumeAdditional', 'VolumeAdditionalFileName', 'file_container_volumeAdditionalFile', 'fileActions_containerVolumeAdditionalFile', 'downloadVolumeAdditionalFile');
        updateFileUIGeneric('ID_File_OutboundFreightAdditional', 'OutboundFreightAdditionalFileName', 'file_container_outboundFreightAdditionalFile', 'fileActions_containerOutboundFreightAdditionalFile', 'downloadOutboundFreightAdditionalFile');
        updateFileUIGeneric('ID_File_DeliveryPackagingAdditional', 'DeliveryPackagingAdditionalFileName', 'file_container_deliveryPackagingAdditionalFile', 'fileActions_containerDeliveryPackagingAdditionalFile', 'downloadDeliveryPackagingAdditionalFile');

        toggleRunningChangeWarning();

        $('#IsWeldedBlank').prop('checked', false).trigger('change'); // Esto oculta y limpia los campos de platinas
        $('#numberOfPlates').val('');
        $('#weldedPlatesThickness_container').empty().hide();
        $('#weldedPlatesJson').val('');

        $("#ID_Slitting_Line").val("");
        $("#slitting_line_name").val("");

        // 2. Limpiar TODOS los checkboxes con un solo selector
        $('.rack-type-checkbox, .additional-checkbox, .label-checkbox, .strap-checkbox').prop('checked', false);

        // 3. Ocultar y limpiar los campos de "Other"
        $('#AdditionalsOtherDescription_container, #LabelOtherDescription_container').hide();
        $('#AdditionalsOtherDescription, #LabelOtherDescription').val('');

        // 4. Resetear el botón principal
        $('.btn-add-material').html('<i class="fa-solid fa-plus"></i> Add Material');

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))").val("");
        // Campos de transporte de llegada
        $("#Arrival_Transport_Type_Other_container").hide();
        $("#Arrival_Transport_Type_Other").val('');


    }


        function updateTheoreticalLine() {
            console.log("--- updateTheoreticalLine ---");
            const selectedRouteId = parseInt($("#ID_Route").val(), 10);

            // Guard: If the route is not a blanking route, do nothing here.
            if (!blankingRouteIds.includes(selectedRouteId)) {
                $("#theoretical_blk_line").val("N/A for this route");
                $("#ID_Theoretical_Blanking_Line, #Theoretical_Strokes").val("");
                debouncedFetchAndApplyValidationRanges();
                return;
            }

            const previousTheoreticalLineId = $("#ID_Theoretical_Blanking_Line").val();
            let materialTypeId = $("#ID_Material_type").val();

            if (!materialTypeId) {
                $("#theoretical_blk_line, #ID_Theoretical_Blanking_Line, #Theoretical_Strokes").val("");
                debouncedFetchAndApplyValidationRanges();
                return;
            }

            $("#theoretical_blk_line").val("Calculating...");

            let dataToSend = {
                plantId: @Model.ID_Plant,
                materialTypeId: materialTypeId,
                thickness: parseFloat($("#Thickness").val()) || null,
                width: parseFloat($("#Width").val()) || null,
                pitch: parseFloat($("#Pitch").val()) || null,
                tensile: parseFloat($("#Tensile_Strenght").val()) || null
            };

            const $realLineSelect = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
            const realLineId = $realLineSelect.val();

            $.getJSON('@Url.Action("GetTheoreticalLine", "CTZ_Projects")', dataToSend)
                .done(function (response) {
                    let newLineId = "";
                    const realLineName = (realLineId && realLineId !== "0" && realLineId !== "") ? $realLineSelect.find('option:selected').text() : null;

                    if (response.success) {
                        // We found a theoretical line
                        $("#theoretical_blk_line").val(response.lineName);
                        $("#ID_Theoretical_Blanking_Line").val(response.lineId);
                        newLineId = response.lineId.toString();

                        // Si NO hay una línea real seleccionada, la línea teórica es la que manda.
                        // Calculamos el OEE basado en ella.
                        if (!realLineId || realLineId === "0" || realLineId === "") {
                            fetchAndApplyOee(response.lineId);
                        }

                        if (newLineId !== previousTheoreticalLineId) {
                            if (realLineName) {
                                // Case 1: Success + Real Line exists. The Real Line has priority.
                                toastr.info(`Theoretical line is ${response.lineName}, but validations will use the selected Real Line: ${realLineName}.`);
                            } else {
                                // Case 2: Success + NO Real Line. The new Theoretical Line is in charge.
                                toastr.success(`Theoretical line updated to: ${response.lineName}`);
                            }
                        }
                    } else {
                        // No theoretical line was found
                        $("#theoretical_blk_line").val("No Match");
                        $("#ID_Theoretical_Blanking_Line").val("");
                        newLineId = "";

                        // Si no hay línea teórica Y TAMPOCO hay línea real, limpiamos el campo OEE.
                        if (!realLineId || realLineId === "0" || realLineId === "") {
                            fetchAndApplyOee(null); // Llamar con null limpiará el campo.
                        }

                        if (previousTheoreticalLineId !== "") { // Only show a message if a value was cleared
                            if (realLineName) {
                                // Case 3: No Match + Real Line exists. The Real Line has priority.
                                toastr.warning(`No match for theoretical line. Validations will use the selected Real Line: ${realLineName}.`);
                            } else {
                                // Case 4: No Match + NO Real Line. Inform the user.
                                toastr.warning("No match found for any theoretical line. Selection has been cleared.");
                            }
                        }
                    }
                })
                .fail(function() {
                    $("#theoretical_blk_line").val("Error");
                    $("#ID_Theoretical_Blanking_Line").val("");
                })
                .always(function() {
                    // CRUCIAL: After calculation, ALWAYS call the function to get the final validation ranges.
                    debouncedFetchAndApplyValidationRanges();
                });
        }

        // 2. Nueva función para calcular y mostrar el "Initial Weight".
       function updateWeightCalculations() {
            const annualVolume = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val());
            const volumePerYear = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").val());

            const weightPerPartInput = $("#WeightPerPart");
            const initialWeightInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Initial_Weight))");

            let weightPerPart = 0;

            // 1. Calcular "Weight per Part" (la fórmula original de Initial Weight)
            if (!isNaN(annualVolume) && !isNaN(volumePerYear) && annualVolume !== 0) {
                weightPerPart = (volumePerYear / annualVolume) * 1000;
                weightPerPartInput.val(weightPerPart.toFixed(3));
            } else {
                weightPerPartInput.val("");
            }

            // 2. Calcular "Initial Weight" como "Weight per Part" + 1.5%
            if (weightPerPart > 0) {
                const initialWeight = weightPerPart * 1.015; // Suma del 1.5%
                initialWeightInput.val(initialWeight.toFixed(3));
            } else {
                initialWeightInput.val("");
            }

            // 3. Disparar actualización de la gráfica (ya estaba)
            debouncedUpdateSlitterChart();
        }

        // Función debounce
        function debounce(func, wait) {
            var timeout;
            return function () {
                var context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    func.apply(context, args);
                }, wait);
            };
        }

    // Re-numerar filas tras eliminación
    function renumberRows() {
        $("#materialsTable tbody tr").each(function (i, row) {
            $(row).attr("data-index", i);
            let hiddenInputs = $(row).find("input[name^='materials']");
            hiddenInputs.each(function () {
                let nameAttr = $(this).attr("name"); // p.ej. materials[3].Part_Number
                let fieldName = nameAttr.substring(nameAttr.indexOf('.') + 1);
                // fieldName => Part_Number
                $(this).attr("name", `materials[${i}].${fieldName}`);
            });
        });
        }

        function validarContraCriterio(valor, criterio) {
            // Destructuramos la nueva propiedad 'Tolerance' que ahora viene del objeto
            const { NumericValue, MinValue, MaxValue, Tolerance } = criterio;

            if (NumericValue != null) {
                return valor === NumericValue;
            }

            // La holgura es el valor que viene de la BD. Si es nulo o inválido, será 0.
            const toleranceAmount = (typeof Tolerance === 'number') ? Tolerance : 0;

            if (MinValue != null) {
                const lowerLimit = MinValue - toleranceAmount;
                if (valor < lowerLimit) {
                    return false;
                }
            }

            if (MaxValue != null) {
                const upperLimit = MaxValue + toleranceAmount;
                if (valor > upperLimit) {
                    return false;
                }
            }

            return true; // El valor es válido
        }

        function describirLimites(criterio) {
            const { NumericValue, MinValue, MaxValue, Tolerance } = criterio;
            const toleranceAmount = (typeof Tolerance === 'number') ? Tolerance : 0;

            console.log('critero: ')
            console.log(criterio)

            let text = "No limits defined";

            if (NumericValue != null) {
                text = `Must be exactly ${NumericValue}`;
            }
            else if (MinValue != null && MaxValue != null) {
                text = `Allowed range: ${MinValue} - ${MaxValue}`;
                if (toleranceAmount > 0) {
                    text += ` (+/- ${toleranceAmount})`;
                }
            }
            else if (MinValue != null) {
                text = `Minimum allowed: ${MinValue}`;
                if (toleranceAmount > 0) {
                    text += ` (tolerance: -${toleranceAmount})`;
                }
            }
            else if (MaxValue != null) {
                text = `Maximum allowed: ${MaxValue}`;
                if (toleranceAmount > 0) {
                    text += ` (tolerance: +${toleranceAmount})`;
                }
            }

            return text;
        }

        function parseYearMonth(dateStr) {
            if (!dateStr) return null;
            var parts = dateStr.split("-");
            if (parts.length < 2) return null;
            return new Date(parts[0], parts[1] - 1, 1);
        }

    // Inicializar select2 y evento solo si es automotriz
    if (vehicleType == 1) {
        $("#Vehicle, #Vehicle_2, #Vehicle_3, #Vehicle_4").select2({ width: '100%' });

        $("#Vehicle, #Vehicle_2, #Vehicle_3, #Vehicle_4").on("change", function () {
            recalculateVehicleData();
        });
    }

    function recalculateVehicleData() {
        // Supongamos que tienes una función similar a getVehicleData que, para cada combo,
        // obtiene un objeto incluyendo la propiedad productionData, la cual se extrae del atributo data-productionjson.
        function getVehicleData(selector) {
            var selectedOption = $(selector).find("option:selected");
            return {
                sop: selectedOption.data("sop"),
                eop: selectedOption.data("eop"),
                program: selectedOption.data("program"),
                maxProduction: selectedOption.data("maxproduction"),
                productionJson: selectedOption.data("productionjson")
            };
        }

        var data1 = getVehicleData("#Vehicle");
        var data2 = getVehicleData("#Vehicle_2");
        var data3 = getVehicleData("#Vehicle_3");
        var data4 = getVehicleData("#Vehicle_4");

        // Solo considerar aquellos vehículos que tienen un valor seleccionado y producción definida
        var selectedVehicles = [];
        [data1, data2, data3, data4].forEach(function (d) {
            if (d && d.sop && d.productionJson) {
                try {
                    d.productionData = JSON.parse(d.productionJson);
                } catch (e) {
                    d.productionData = [];
                }
                selectedVehicles.push(d);
            }
        });

        // Calcular el SOP (mínimo) y EOP (máximo) usando data de los vehículos seleccionados (si es necesario)
        var minSOP = null, maxEOP = null;
        selectedVehicles.forEach(function (d) {
            var sopDate = new Date(d.sop);
            var eopDate = new Date(d.eop);
            console.log("SOP: " + sopDate + " EOP: " + eopDate)
            if (!minSOP || sopDate < minSOP) minSOP = sopDate;
            if (!maxEOP || eopDate > maxEOP) maxEOP = eopDate;
        });
        if (minSOP) $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))").val(moment.utc(minSOP).format("YYYY-MM"));
        if (maxEOP) $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))").val(moment.utc(maxEOP).format("YYYY-MM"));


        // Para Program_SP: Concatenar los posibles "program" de los vehículos (data1, data2, data3, data4)
        // separando por " / " (con espacio antes y después) y evitando duplicados
        var programs = [];
        [data1, data2, data3, data4].forEach(function (d) {
            if (d && d.program && programs.indexOf(d.program) === -1) {
                programs.push(d.program);
            }
        });
        var concatenatedProgram = programs.join(" / ");
        $("#programSP").val(concatenatedProgram);

        // Calcular la suma de producción por año
        var productionByYear = {};
        selectedVehicles.forEach(function (d) {
            console.log("Vehículo:", d);
            if (d.productionJson && Array.isArray(d.productionJson)) {
                d.productionJson.forEach(function (item) {
                    console.log("Item de producción:", item);
                    var year = item.Production_Year;
                    var sum = parseFloat(item.Production_Amount) || 0;
                    if (year) {
                        if (!productionByYear[year]) {
                            productionByYear[year] = 0;
                        }
                        productionByYear[year] += sum;
                    }
                });
            }
        });
        console.log("Suma de producción por año:", productionByYear);

        // Determinar el año con mayor producción acumulada
        var maxProduction = 0, maxProductionYear = null;
        for (var year in productionByYear) {
            if (productionByYear[year] > maxProduction) {
                maxProduction = productionByYear[year];
                maxProductionYear = year;
            }
        }
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val(maxProduction);
        if (maxProductionYear) {
            $("#maxProductionYearDisplay").text("Year: " + maxProductionYear);
        }

        //llamamos a grafica de slitter
        debouncedUpdateSlitterChart();
    }

     function shapeVisibility() {
        let shapeInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");
        let fileName = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))").val();
        let idFile   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))").val();
        let shapeVal = shapeInput.val();

        // Contenedores y control de TurnOver
        let turnoverContainer = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))_container");
        let turnoverInput     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))");
        let turnoversideContainer = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))_container");
        let turnoversideInput     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOverSide))");

        // Campos relacionados con los ángulos
        let camposAngulos = [
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))"
        ];

        // 1) Si Shape no está visible, ocultamos todo y deshabilitamos TurnOver
        if (!shapeInput.is(":visible")) {
            camposAngulos.forEach(campo => {
                $("#" + campo).prop("disabled", true).val("");
                $("#" + campo + "_container").hide();
            });
            $("#archivo").prop("disabled", true).val("");
            $("#cat_file_container, #fileActions_container").hide();

            // TurnOver también se oculta y deshabilita
            turnoverInput.prop("disabled", true).prop("checked", false);
            turnoverContainer.hide();
            turnoversideInput.prop("disabled", true);
            turnoversideInput.val(null).trigger('change.select2');
            turnoversideContainer.hide();

            return;
        }

        // 2) Ángulos sólo si Shape = "3"
        camposAngulos.forEach(campo => {
            let input     = $("#" + campo);
            let container = $("#" + campo + "_container");

            if (shapeVal === "3") {
                input.prop("disabled", false);
                container.show();
            } else {
                input.prop("disabled", true).val("");
                container.hide();
            }
        });

        // 3) Lógica de archivo sólo si Shape = "18"


        if (shapeVal === "18") {
            updateFileUI();
        } else {
            $("#cat_file_container").hide();
            $("#fileActions_container").hide();
            $("#archivo").prop("disabled", true).val("");
        }

         // 4) Lógica para TurnOver y TurnOverSide, dependiente de Shape = "18"
         if (shapeVal === "18") {
             // El checkbox "TurnOver" siempre es visible y se puede editar si el shape es 18
             turnoverContainer.show();
             if (canEditSales) {
                 turnoverInput.prop("disabled", false);
             }

             // AHORA, la visibilidad de "TurnOverSide" depende del checkbox "TurnOver"
             if (turnoverInput.is(":checked")) {
                 turnoversideContainer.show();
                 if (canEditSales) {
                     turnoversideInput.prop("disabled", false);
                 }
             } else {
                 // Si "TurnOver" NO está chequeado, ocultamos, deshabilitamos y reseteamos "TurnOverSide"
                 turnoversideContainer.hide();
                 turnoversideInput.prop("disabled", true);
                 turnoversideInput.val(null).trigger('change.select2');
             }

         } else {
             // Si el Shape no es "18", ocultamos y reseteamos ambos campos
             turnoverContainer.hide();
             turnoverInput.prop("disabled", true).prop("checked", false);

             turnoversideContainer.hide();
             turnoversideInput.prop("disabled", true);
             turnoversideInput.val(null).trigger('change.select2');
         }
    }

    /**
     * Actualiza el dropdown de "Material Type" basado en la ruta seleccionada.
     * Si la ruta incluye Slitting, filtra los materiales; si no, muestra todos los de la planta.
     */
    function updateMaterialTypeDropdown() {
        const selectedRouteId = parseInt($("#ID_Route").val(), 10);
        const slitterLineId = $("#ID_Slitting_Line").val();
        const materialTypeSelect = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))");
        const plantId = @Model.ID_Plant;

        // --- INICIO DE LA MODIFICACIÓN ---
        // PASO 1: Guardar la selección actual ANTES de hacer cualquier cambio.
        const previouslySelectedMaterialType = materialTypeSelect.val();
        // --- FIN DE LA MODIFICACIÓN ---

        if (slittingRouteIds.includes(selectedRouteId) && slitterLineId) {

            materialTypeSelect.html('<option>Loading compatible materials...</option>').prop('disabled', true).trigger('change.select2');

            $.getJSON('@Url.Action("GetAvailableMaterialTypesForSlitter", "CTZ_Projects")', { plantId: plantId, slitterLineId: slitterLineId })
                .done(function (response) {
                    if (response.success) {
                        materialTypeSelect.empty().append('<option value="">Select Material Type</option>');
                        response.data.forEach(function (item) {
                            materialTypeSelect.append(new Option(item.Text, item.Value));
                        });

                        // --- INICIO DE LA MODIFICACIÓN ---
                        // PASO 2: Después de repoblar, intentar restaurar la selección previa.
                        if (previouslySelectedMaterialType && materialTypeSelect.find(`option[value="${previouslySelectedMaterialType}"]`).length > 0) {
                            materialTypeSelect.val(previouslySelectedMaterialType);
                        }
                        // --- FIN DE LA MODIFICACIÓN ---

                        toastr.info("Material Type list has been filtered for the selected Slitting Line.");
                    } else {
                         toastr.error(response.message || "Could not load compatible materials.");
                         loadAllMaterialTypesForPlant(); // Llama a la versión actualizada de esta función
                    }
                })
                .fail(function() {
                    toastr.error("Error fetching compatible materials.");
                    loadAllMaterialTypesForPlant(); // Llama a la versión actualizada de esta función
                })
                .always(function() {
                    materialTypeSelect.prop('disabled', !canEditSales).trigger('change.select2');
                });

        } else {
            // Si la ruta NO incluye Slitting, carga todos los materiales para la planta.
            loadAllMaterialTypesForPlant();
        }
    }

    /**
     * Función auxiliar para cargar TODOS los tipos de material para la planta actual,
     * preservando la selección si es posible.
     */
    function loadAllMaterialTypesForPlant() {
        const materialTypeSelect = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))");

        // --- INICIO DE LA MODIFICACIÓN ---
        // PASO 1: Guardar la selección actual.
        const previouslySelectedMaterialType = materialTypeSelect.val();
        // --- FIN DE LA MODIFICACIÓN ---

        materialTypeSelect.empty().append('<option value="">Select Material Type</option>');

        @foreach (var item in (SelectList)ViewBag.MaterialTypeList)
        {
            <text>
                materialTypeSelect.append(new Option("@item.Text", "@item.Value"));
            </text>
        }

        // --- INICIO DE LA MODIFICACIÓN ---
        // PASO 2: Intentar restaurar la selección previa.
        if (previouslySelectedMaterialType && materialTypeSelect.find(`option[value="${previouslySelectedMaterialType}"]`).length > 0) {
            materialTypeSelect.val(previouslySelectedMaterialType);
        }
        // --- FIN DE LA MODIFICACIÓN ---

        materialTypeSelect.trigger('change.select2');
    }

    function updateFileUI() {
        // 1. Lee los datos del archivo CAD desde los inputs ocultos del formulario.
        let fileId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))").val();
        let fileName = $("#CADFileName").val();

        // 2. Comprueba si existe un archivo asociado a este material.
        if (fileId && fileName && fileId.trim() !== "" && fileName.trim() !== "") {
            // --- CASO A: SÍ hay un archivo ---

            $("#cat_file_container").hide();
            $("#fileActions_container").show();

            // Configura el enlace de descarga
            $("#downloadFile")
                .attr("href", "/CTZ_Projects/DownloadFile?fileId=" + fileId)
                .attr("title", fileName)
                .html('<i class="fa-solid fa-download"></i> ' + fileName);

            $("#archivo").prop("disabled", true);

        } else {

            $("#cat_file_container").show();
            $("#fileActions_container").hide();

            if (canEditSales) {
                $("#archivo").prop("disabled", false);
            } else {
                $("#archivo").prop("disabled", true);
            }
        }
    }

        function updatePackagingFileUI() {
            let fileId = $("#ID_File_Packaging").val();
            let fileName = $("#PackagingFileName").val();


            if (fileId && fileName) {
                $("#packaging_file_container").hide();
                $("#packagingFileActions_container").show();
                $("#downloadPackagingFile")
                    .attr("href", "/CTZ_Projects/DownloadFile?fileId=" + fileId)
                    .attr("title", fileName) // <-- AÑADE ESTA LÍNEA
                    .html('<i class="fa-solid fa-download"></i> ' + fileName);
            } else {
                $("#packaging_file_container").show();
                $("#packagingFileActions_container").hide();
            }
        }

        function updateFileUIGeneric(fileIdText, fileNameText, fileContainerText, fileActionContainer, downloadContainer) {
            let fileId = $("#" + fileIdText).val();
            let fileName = $("#" + fileNameText).val();

            if (fileId && fileName) {
                $("#" + fileContainerText).hide();
                $("#" + fileActionContainer).show();
                $("#" + downloadContainer)
                    .attr("href", "/CTZ_Projects/DownloadFile?fileId=" + fileId)
                    .attr("title", fileName) // <-- AÑADE ESTA LÍNEA
                    .html('<i class="fa-solid fa-download"></i> ' + fileName);
            } else {
                $("#" + fileContainerText).show();
                $("#" + fileActionContainer).hide();
            }
        }

    function updateRealStrokes() {

        var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

        // Suponiendo que tienes los valores en los campos:
        var pitch = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val());
        var rotation = 0; // 0 de momento


        if (isNaN(pitch) || isNaN(rotation) || productionLineId == "") {
            // Manejar error: se requieren ambos valores.
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").trigger("change");

            return;
        }

       $.ajax({
            url: '@Url.Action("GetTheoreticalStrokes", "CTZ_Projects")',
            type: 'GET',
            data: {
                productionLineId: productionLineId,
                pitch: pitch,
                rotation: rotation
            },
            success: function (response) {
                if (response.success) {
                    var strokes = parseFloat(response.theoreticalStrokes);
                    var formattedStrokes = (strokes % 1 === 0) ? strokes : strokes.toFixed(2);
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val(formattedStrokes);
                } else {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
                    toastr.error("Error: " + response);
                }
            },
            error: function (xhr, status, error) {
                toastr.error("Error en Ajax: " + error);
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
            },
            async: false
        }).always(function () {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").trigger("change");
        });


    }

    function updateStrokesPerAuto() {
        var partsVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val());
        var blanksVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());

        // Si alguno es inválido o la división no es posible, limpia el campo
        if (isNaN(partsVal) || isNaN(blanksVal) || blanksVal === 0) {
            $("#strokes_auto").val("");
        } else {
            var result = partsVal / blanksVal;
            $("#strokes_auto").val(result.toFixed(2));
        }
    }

    function updateMinMaxReales() {
        var blanksPerYear = parseFloat($("#blanks_per_year").val());
        var idealCycleTime = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val());
        var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());

        // Validamos que todos los valores sean números y que idealCycleTime y blanksPerStroke no sean 0
        if (isNaN(blanksPerYear) || isNaN(idealCycleTime) || isNaN(blanksPerStroke) || idealCycleTime === 0 || blanksPerStroke === 0) {
            $("#min_max_reales").val("");
        } else {
            var result = blanksPerYear / idealCycleTime / blanksPerStroke;
            $("#min_max_reales").val(result.toFixed(2));
        }

        //tambien actualiza la version de OEE
        updateMinMaxRealesOEE();
    }


    function updateBlanksPerYear() {
        var partsVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val());
        var annualVolume = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val());

        // Verificar si alguno es inválido o nulo
        if (isNaN(partsVal) || isNaN(annualVolume)) {
            $("#blanks_per_year").val("");
        } else {
            var result = partsVal * annualVolume;
            $("#blanks_per_year").val(result.toFixed(2));
        }

        //valida los campos que pudieran depender de este input
        updateMinMaxReales();
        updateStrokesShift();
    }

    function updateMinMaxRealesOEE() {
        var minMaxReales = parseFloat($("#min_max_reales").val());
        var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val());

        if (isNaN(minMaxReales) || isNaN(oee) || oee === 0) {
            $("#min_max_reales_oee").val("");
        } else {
            // Normalizamos el OEE de porcentaje a valor decimal
            var oeeDecimal = oee / 100;
            var result = minMaxReales / oeeDecimal;
            $("#min_max_reales_oee").val(result.toFixed(2));
        }

        // Actualiza los turnos reales
        updateActualShifts();
    }


    function updateActualShifts() {
        var minMaxRealesOEE = parseFloat($("#min_max_reales_oee").val());

        // Verifica si el valor es válido (7.5 y 60 son constantes, por lo que no se espera división por 0)
        if (isNaN(minMaxRealesOEE)) {
            $("#actual_shifts").val("");
        } else {
            var result = minMaxRealesOEE / 7.5 / 60;
            $("#actual_shifts").val(result.toFixed(2));
        }

        updateStrokesShift();
    }

    function updateStrokesShift() {
        var blanksPerYear = parseFloat($("#blanks_per_year").val());
        var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());
        var actualShifts = parseFloat($("#actual_shifts").val());

        if (isNaN(blanksPerYear) || isNaN(blanksPerStroke) || isNaN(actualShifts) || blanksPerStroke === 0 || actualShifts === 0) {
            $("#strokes_shift").val("");
        } else {
            var result = blanksPerYear / blanksPerStroke / actualShifts;
            $("#strokes_shift").val(result.toFixed(0));
        }
    }


        function updateTheoreticalStrokes() {

        var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val();

        // Suponiendo que tienes los valores en los campos:
        var pitch = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val());
        ////var rotation = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val()); // valor de giro
        var rotation = 0; // 0 de momento


        if (isNaN(pitch) || isNaN(rotation) || productionLineId == "") {
            // Manejar error: se requieren ambos valores.
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
            return;
        }

        $.ajax({
            url: '@Url.Action("GetTheoreticalStrokes", "CTZ_Projects")',
            type: 'GET',
            data: { productionLineId: productionLineId, pitch: pitch, rotation: rotation },
            success: function (response) {
                if (response.success) {
                    // Actualiza el campo de Theoretical_Strokes con el valor obtenido
                    var strokes = parseFloat(response.theoreticalStrokes);
                    var formattedStrokes = (strokes % 1 === 0) ? strokes : strokes.toFixed(2);
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val(formattedStrokes);
                } else {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
                    toastr.warning("Warning: " + response.message);
                }
            },
            error: function (xhr, status, error) {
                toastr.error("Error en Ajax: " + response.message);
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
            },
            async: false
        });
    }

    function updateTheoreticalGrossWeight() {

        // 1. Obtener los valores de los inputs
        let thicknessStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").val().trim();
        let widthStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").val().trim();
        let pitchStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val().trim();
        let blanksStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val().trim();
        let materialTypeStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)) option:selected").text().trim().toUpperCase();

        // Obtener el ID de la ruta seleccionada
        const selectedRouteId = parseInt($("#ID_Route").val(), 10);

        // Si la ruta contiene Blanking (usa el array que ya tienes en tu vista)
        if (blankingRouteIds.includes(selectedRouteId)) {

            // Validar que los campos para el cálculo de BLK no estén vacíos
            if (!thicknessStr || !widthStr || !pitchStr || !blanksStr || !materialTypeStr || materialTypeStr === "SELECT MATERIAL TYPE") {
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val("");
                return;
            }

            let thickness = parseFloat(thicknessStr);
            let width = parseFloat(widthStr);
            let pitch = parseFloat(pitchStr);
            let blanksPerStroke = parseFloat(blanksStr);

            // 2. Determinar la densidad según el tipo de material
            let density = 0;
            if (materialTypeStr.includes("STEEL")) {
                density = 7.85;
            } else if (materialTypeStr.includes("ALU")) {
                density = 2.7;
            } else {
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val("");
                return; // Salir si el tipo de material no es válido
            }

            // 3. Realizar el cálculo original para Blanking
            // Asegurarse de que blanksPerStroke no sea cero para evitar división por cero
            if (blanksPerStroke > 0) {
                let weight = (thickness * width * pitch * density) / 1000000 / blanksPerStroke;
                // 4. Actualizar el campo
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val(weight.toFixed(3));
            } else {
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val("");
            }

        } else {
            // Para cualquier otra ruta que no sea ni SLT puro ni contenga BLK
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val("");
        }
    }


        // Función para actualizar los tooltips de los campos de ingeniería
        // --- PEGA ESTE NUEVO BLOQUE EN LUGAR DE TU ANTIGUA FUNCIÓN updateLimitsDisplay ---

        // --- REEMPLAZA TU ANTIGUA FUNCIÓN updateEngineeringLimitsDisplay CON ESTA ---

        /**
         * Actualiza el texto de ayuda (<small>) debajo de los inputs de ingeniería.
         * Esta función ahora lee de una única fuente de verdad: window.engineeringRanges.
         */
        /**
 * Actualiza el texto de ayuda (<small>) debajo de los inputs de ingeniería
 * y el límite de mults, usando las variables globales.
 */
        function updateLimitsDisplay() {
            console.log("--- updateLimitsDisplay ---");

            const rangesToUse = window.engineeringRanges;

            // Mapeo de los campos que queremos actualizar en la UI.
            const limits = [
                { displayId: "#tensil-limit-display", criterioId: 14 },     // Tensile Strength
                { displayId: "#thickness-limit-display", criterioId: 7 },    // Thickness
                { displayId: "#width-limit-display", criterioId: 8 },        // Width
                { displayId: "#pitch-limit-display", criterioId: 9 }         // Pitch
            ];

            // 1. Limpiamos todos los displays antes de empezar.
            limits.forEach(({ displayId }) => {
                $(displayId).text("");
            });
            // Limpiamos también el display de mults
            $("#mults-limit-display").text("");

            // 2. Si tenemos un array de rangos para mostrar, los procesamos.
            if (rangesToUse && Array.isArray(rangesToUse)) {
                limits.forEach(({ displayId, criterioId }) => {
                    const range = rangesToUse.find(r => r.ID_Criteria === criterioId);
                    const limitText = range ? describirLimites(range) : "No limits defined for this selection.";
                    $(displayId).text(limitText);
                });
            } else {
                console.log("No hay rangos de dimensiones para mostrar.");
            }

            // 3. Actualizamos el display para el máximo de mults permitido
            if (typeof window.maxMultsAllowed === 'number') {
                $("#mults-limit-display").text(`Max. allowed: ${window.maxMultsAllowed} strips`);
            }
        }


        function updateVehicleVisibility() {
            // CAMBIO: Mensaje de depuración inicial
            console.log("--- Ejecutando updateVehicleVisibility ---");

            // Si Vehicle 1 no tiene valor, ocultar las filas de los demás vehículos.
            if (!$("#Vehicle").val()) {
                // CAMBIO: Se usan los IDs de las filas (.row) y se incluye la fila 4.
                $(".vehicle-row-2, .vehicle-row-3").hide();
                console.log("Valor de Vehículo 1: VACÍO. Ocultando filas 2, 3 y 4.");
            } else {
                // Si Vehicle 1 tiene valor, mostrar la fila de Vehicle 2.
                $(".vehicle-row-2").show();
                console.log("Valor de Vehículo 1: PRESENTE. Mostrando Fila 2.");

                if (!$("#Vehicle_2").val()) {
                    // Si Vehicle 2 no tiene valor, ocultar las filas 3 y 4.
                    $(".vehicle-row-3").hide();
                    console.log(" -> Valor de Vehículo 2: VACÍO. Ocultando filas 3 y 4.");
                } else {
                    // Si Vehicle 2 tiene valor, mostrar la fila de Vehicle 3.
                    $(".vehicle-row-3").show();
                    console.log(" -> Valor de Vehículo 2: PRESENTE. Mostrando Fila 3.");

                }
            }
            console.log("--- Fin de updateVehicleVisibility ---");
        }

    // Función que actualiza el fondo del input Annual_Volume según el porcentaje de diferencia
    function updateAnnualVolumeStyle() {
        // Obtenemos los valores
        let annualVolumeStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val().trim();
        let maxProductionStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val().trim();

        // Si alguno no tiene valor, salimos
        if (!annualVolumeStr || !maxProductionStr) {
            // Podrías resetear el fondo a blanco
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", "");
            return;
        }

        // Convertir a número
        let annualVolume = parseFloat(annualVolumeStr);
        let maxProduction = parseFloat(maxProductionStr);

        // Evitar división por cero
        if (maxProduction === 0) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", "");
            return;
        }

        // Calcular el ratio
        let ratio = annualVolume / maxProduction;
        // Calcular diferencia porcentual respecto a maxProduction
        let diffPercentage = ((annualVolume - maxProduction) / maxProduction) * 100;

        // Actualizar el fondo según el rango:
        // Verde: ratio entre 0.85 y 1.15
        // Amarillo: ratio entre 0.70 y 0.85 o entre 1.15 y 1.30
        // Rojo: cualquier otro caso
        let newBgColor = "";
        if (ratio >= 0.85 && ratio <= 1.15) {
            newBgColor = "lightgreen";
        } else if ((ratio >= 0.70 && ratio < 0.85) || (ratio > 1.15 && ratio <= 1.30)) {
            newBgColor = "lightyellow";
        } else {
            newBgColor = "lightcoral";
        }

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", newBgColor);

        // Devuelve la diferencia porcentual para usar en el toast
        return diffPercentage;
    }

    // Función para mostrar el toast con la diferencia porcentual
    function showVolumeDifferenceToast(diffPercentage) {
        // Redondear a dos decimales
        let diffRounded = diffPercentage.toFixed(2);
        // Generar el mensaje: puede ser "x% above" o "x% below"
        let message = "";
        if (diffPercentage > 0) {
            message = `${diffRounded}% above Max Production`;
        } else if (diffPercentage < 0) {
            message = `${Math.abs(diffRounded)}% below Max Production`;
        } else {
            message = "No difference with Max Production";
        }

        // Mostrar el toast
        toastr.info(message);
    }

        function redondearValor(elemento, decimales) {
            let value = parseFloat($(elemento).val());
            if (!isNaN(value)) {
                let factor = Math.pow(10, decimales);
                let rounded = Math.round(value * factor) / factor;
                $(elemento).val(rounded);
            }
        }

        // Dispara el evento 'change' en el combo box
        $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))').trigger('change');

        // Llamar a la gráfica al cargar la página con el parámetro en true
        updateSlitterCapacityChart(true, @Model.ID_Project);

        // Función para mostrar/ocultar el campo "Other"
        function handleArrivalProtectiveMaterialChange() {
            console.log('entra handleArrivalProtectiveMaterialChange')
            const otherContainer = $("#Arrival_Protective_Material_Other_container");
            const otherInput = $("#Arrival_Protective_Material_Other");

            // El ID para "Other" en la tabla CTZ_Packaging_Additionals es 6
            if ($("#ID_Arrival_Protective_Material").val() == "6") {
                otherContainer.slideDown();
            } else {
                otherContainer.slideUp();
                otherInput.val(''); // Limpiar el valor al ocultar
            }
        }

        // Función para mostrar/ocultar "Stackable Levels"
        function handleStackableChange() {
            const levelsContainer = $("#Stackable_Levels_container");
            const levelsInput = $("#Stackable_Levels");

            if ($("#Is_Stackable").is(":checked")) {
                levelsContainer.slideDown();
            } else {
                levelsContainer.slideUp();
                levelsInput.val(''); // Limpiar el valor al ocultar
                validateMaterial("Stackable_Levels"); // Revalidar para quitar el error si lo había
            }
        }
        // Función para mostrar/ocultar el campo "Other" para Arrival Transport Type
        function handleArrivalTransportTypeChange() {
            const otherContainer = $("#Arrival_Transport_Type_Other_container");
            const otherInput = $("#Arrival_Transport_Type_Other");

            // 5 es el ID para "Other" en la tabla CTZ_Transport_Types
            if ($("#ID_Arrival_Transport_Type").val() == "5") {
                otherContainer.slideDown();
            } else {
                otherContainer.slideUp();
                otherInput.val(''); // Limpiar el valor al ocultar
            }
        }

          /**
         * Calcula el Tonelaje Anual (Annual Tonnage) basado en el Volumen Anual y el Peso Bruto.
         * Formula: (Annual_Volume * Gross_Weight) / 1000
         */
        function updateAnnualTonnage() {
            const targetInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AnnualTonnage))");

            targetInput.val("Pending");
            @*const annualVolume = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val());
            const grossWeight = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").val());

            if (!isNaN(annualVolume) && !isNaN(grossWeight)) {
                // (Units/Year * KG/Unit) / (1000 KG/Ton) = Tons/Year
                const tonnage = (annualVolume * grossWeight) / 1000.0;
                targetInput.val(tonnage.toFixed(3));
            } else {
                targetInput.val("");
            }*@
        }

        /**
         * Calcula el Peso del Paquete (Package Weight) basado en Piezas, Pilas y Peso Bruto.
         * Formula: (PiecesPerPackage * StacksPerPackage * Gross_Weight)
         */
         function updatePackageWeight() {
            const pieces = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PiecesPerPackage))").val());
            const stacks = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.StacksPerPackage))").val());

            // --- INICIO LÓGICA DE FALLBACK ---
            const clientNetWeight = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))").val());
            const grossWeight = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").val());

            // Usar ClientNetWeight si es un número válido y mayor que 0, si no, usar Gross_Weight
            const weightToUse = (!isNaN(clientNetWeight) && clientNetWeight > 0) ? clientNetWeight : grossWeight;
            // --- FIN LÓGICA DE FALLBACK ---

            const targetInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackageWeight))");

            if (!isNaN(pieces) && !isNaN(stacks) && !isNaN(weightToUse) && pieces > 0 && stacks > 0 && weightToUse > 0) {
                // (Pieces/Stack * Stacks/Package * KG/Piece) = KG/Package
                const weight = (pieces * stacks * weightToUse); // <-- Usa la variable weightToUse
                targetInput.val(weight.toFixed(3));
            } else {
                targetInput.val("");
            }
        }

        /**
         * Muestra/oculta el campo 'Other' para Delivery Transport Type
         */
        function handleDeliveryTransportTypeChange() {
            const otherContainer = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))_container");
            const otherInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))");
            const selectedValue = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))").val();

            // ID 5 es "Other" en la tabla CTZ_Transport_Types
            if (selectedValue == "5") {
                otherContainer.slideDown();
            } else {
                otherContainer.slideUp();
                otherInput.val(''); // Limpiar el valor al ocultar
                validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))"); // Quitar error si lo había
            }
        }

        function validateReturnableUses() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))Error");
            const container = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))_container");

            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) {
                errorEl.text("Number of uses is required when 'Returnable Rack' is checked.").show();
                input.css("border", "1px solid red");
                return false;
            }
            let val = parseInt(raw, 10);
            if (isNaN(val) || val <= 0 || raw.includes('.')) {
                errorEl.text("Must be a positive whole number.").show();
                input.css("border", "1px solid red");
                return false;
            }
            errorEl.text("").hide();
            input.css("border", "");
            return true;
        }

        function validateNumberOfPlates() {
            const input = $("#numberOfPlates");
            const errorEl = $("#numberOfPlatesError"); // Apuntamos al nuevo span
            const isChecked = $('#IsWeldedBlank').is(':checked');

            if (!isChecked || !input.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                errorEl.text("Required when 'Is Welded Blank' is checked.").show();
                input.css("border", "1px solid red");
                return false;
            }

            let val = parseInt(raw, 10);
            // Validamos que sea un número entero (sin decimales) entre 2 y 5
            if (isNaN(val) || val < 2 || val > 5 || raw.includes('.')) {
                errorEl.text("Must be a whole number between 2 and 5.").show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateWeldedThicknesses() {
            let isValid = true;
            if (!$('#IsWeldedBlank').is(':checked')) {
                return true;
            }

            $('.welded-thickness-input').each(function () {
                const input = $(this);
                const errorEl = input.next('.error-message');
                errorEl.text("").hide();
                input.css("border", "");

                let raw = input.val() ? input.val().trim() : "";
                if (!raw) {
                    errorEl.text("Required").show();
                    input.css("border", "1px solid red");
                    isValid = false;
                } else {
                    let val = parseFloat(raw);
                    // Se cambia la condición para ser más explícito sobre números negativos
                    if (isNaN(val) || val < 0) {
                        errorEl.text("Value cannot be negative.").show(); // Mensaje más claro
                        input.css("border", "1px solid red");
                        isValid = false;
                    }
                }
            });
            return isValid;
        }

        function validateScrapReconciliationPercent() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))Error");
            const container = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))_container");

            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            if (!raw) {
                errorEl.text("Percentage is required when 'Scrap reconciliation' is checked.").show();
                input.css("border", "1px solid red");
                return false;
            }
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be a number between 0 and 100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            errorEl.text("").hide();
            input.css("border", "");
            return true;
        }

        function validateHeadTailReconciliationPercent() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))Error");
            const container = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))_container");

            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }
            let raw = input.val() ? input.val().trim() : "";
            if (!raw) {
                errorEl.text("Percentage is required when 'Head/Tail reconciliation' is checked.").show();
                input.css("border", "1px solid red");
                return false;
            }
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0 || val > 100) {
                errorEl.text("Must be a number between 0 and 100.").show();
                input.css("border", "1px solid red");
                return false;
            }
            errorEl.text("").hide();
            input.css("border", "");
            return true;
        }

        // (La validación de FreightType se omite como solicitaste)

        function validateDeliveryCoilPosition() {
            // Esta validación es opcional, puedes hacerla requerida si lo necesitas.
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Coil_Position))Error");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                 errorEl.text("").hide();
                 input.next(".select2-container").find(".select2-selection").css("border", "");
                 return true;
            }
            // Ejemplo de validación (opcional):
            // if (!input.val()) {
            //     errorEl.text("Delivery Coil Position is required.").show();
            //     input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
            //     return false;
            // }
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");
            return true;
        }

        function validateDeliveryTransportType() {
            // Esta validación es opcional
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))Error");

            if (input.prop("readonly") || input.prop("disabled") || !input.is(":visible")) {
                 errorEl.text("").hide();
                 input.next(".select2-container").find(".select2-selection").css("border", "");
                 return true;
            }
            // Ejemplo de validación (opcional):
            // if (!input.val()) {
            //     errorEl.text("Delivery Transport Type is required.").show();
            //     input.next(".select2-container").find(".select2-selection").css("border", "1px solid red");
            //     return false;
            // }
            errorEl.text("").hide();
            input.next(".select2-container").find(".select2-selection").css("border", "");
            // Disparar la validación del campo "Other" por si acaso
            validateDeliveryTransportTypeOther();
            return true;
        }

        /**
         * Busca y aplica el OEE para una línea de producción específica,
         * solo si el campo OEE está vacío.
         * param {any} lineId El ID de la línea de producción.
         */
        function fetchAndApplyOee(lineId) {
            const oeeInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))");
            const oeeNoteSpan = $("#oeeCalculationNote");

            // Ya no comprobamos si el input tiene valor aquí. La llamada AJAX se hará siempre que haya una línea.

            if (!lineId || lineId === "0" || lineId === "") {
                oeeNoteSpan.hide().text('');
                // No limpiamos el input aquí para no borrar la entrada del usuario si cambia de línea y no hay cálculo.
                return;
            }

            $.getJSON('@Url.Action("GetOeeForLine", "CTZ_Projects")', { lineId: lineId })
                .done(function (response) {

                    if (response.success && response.isCalculated) {

                        if (response.foundRecords) {
                            // CASO 1: Se encontraron registros.
                            // Siempre mostramos la nota con el valor calculado para informar al usuario.
                            oeeNoteSpan.text(`* Calculated average is ${response.oeeValue.toFixed(2)}% from the last 6 months.`);
                            oeeNoteSpan.show();

                            // SOLO si el campo de texto está vacío, lo rellenamos y lo resaltamos.
                            if (!oeeInput.val() || oeeInput.val().trim() === "") {
                                oeeInput.val(response.oeeValue.toFixed(2));
                                oeeInput.css('background-color', '#e9f5ff');
                            }
                        } else {
                            // CASO 2: No se encontraron registros.
                            // Siempre mostramos la nota de aviso.
                            oeeNoteSpan.text('* No OEE records found for the last 6 months.');
                            oeeNoteSpan.show();
                            // Nos aseguramos de que no esté resaltado si no se pudo calcular un valor.
                            oeeInput.css('background-color', '');
                        }
                    } else {
                         // Si la respuesta no fue exitosa o no fue un cálculo, limpiamos la nota.
                         oeeNoteSpan.hide().text('');
                         oeeInput.css('background-color', '');
                    }
                })
                .fail(function() {
                    toastr.error("Could not retrieve OEE value for the selected line.");
                });
        }

        function validateDeliveryTransportTypeOther() {
            const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))Error");
            const container = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Delivery_Transport_Type_Other))_container");
            const limit = 50;

            if (!container.is(":visible")) {
                errorEl.text("").hide();
                input.css("border", "");
                return true;
            }

            const value = input.val().trim();
            if (!value) {
                errorEl.text("Please specify the 'Other' transport type.").show();
                input.css("border", "1px solid red");
                return false;
            }
            if (value.length > limit) {
                errorEl.text(`Cannot exceed ${limit} characters.`).show();
                input.css("border", "1px solid red");
                return false;
            }
            errorEl.text("").hide();
            input.css("border", "");
            return true;
        }

       /**
         * Esta función controla la visibilidad del combo "Delivery Transport Type".
         * Solo se debe mostrar si el campo "Freight Type" está configurado como 'DDP'.
         */
        function updateDeliveryTransportationTypeState() {

            // 1. Obtener el valor del combo "Freight Type"
            const freightTypeSelect = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_FreightType))');
            const freightType = freightTypeSelect.val();

            // 2. Obtener los elementos de "Delivery Transport Type"
            const deliveryTransportContainer = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))_container');
            const deliveryTransportSelect = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))');

            // 3. ID de "DDP" (Según el script SQL, DDP es el ID 2)
            const ddpFreightTypeId = "2";


            // Verifica que los selectores de JQuery hayan encontrado los elementos
            if (deliveryTransportContainer.length === 0) {
                console.error("ERROR: No se encontró el CONTENEDOR '#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))_container'");
            } else {
                console.log("Contenedor a mostrar/ocultar:", deliveryTransportContainer.attr('id'));
            }
            if (deliveryTransportSelect.length === 0) {
                 console.error("ERROR: No se encontró el SELECT '#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Delivery_Transport_Type))'");
            }
            // --- FIN DEBUG ---

            // 4. Lógica de visibilidad
            if (freightType === ddpFreightTypeId) {

                deliveryTransportContainer.slideDown(); // O .show()

                if (@(canEditSales.ToString().ToLower())) {
                    deliveryTransportSelect.prop('disabled', false);
                }
            } else {
                deliveryTransportContainer.slideUp();
                deliveryTransportSelect.val('').trigger('change');
                deliveryTransportSelect.prop('disabled', true);
            }
        }

        // 1. CREAMOS FUNCIONES NOMBRADAS PARA MANEJAR LA VISIBILIDAD
        function handleScrapReconciliationChange() {
            const percentContainer = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliationPercent))_container');
            if ($('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ScrapReconciliation))').is(':checked')) {
                percentContainer.slideDown();
            } else {
                percentContainer.slideUp();
                // No es necesario limpiar los valores aquí, el usuario podría querer re-activarlo
            }
        }

        function handleReturnableRackChange() {
            const usesContainer = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ReturnableUses))_container');
            if ($('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsReturnableRack))').is(':checked')) {
                usesContainer.slideDown();
            } else {
                usesContainer.slideUp();
            }
        }

        function handleHeadTailReconciliationChange() {
            const percentContainer = $('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliationPercent))_container');
            if ($('#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.HeadTailReconciliation))').is(':checked')) {
                percentContainer.slideDown();
            } else {
                percentContainer.slideUp();
                // No es necesario limpiar los valores aquí
            }
        }

        function handleWeldedBlankChange() {
            const isChecked = $('#IsWeldedBlank').is(':checked');
            const numberOfPlatesContainer = $('#numberOfPlates_container');
            const thicknessContainer = $('#weldedPlatesThickness_container');

            if (isChecked) {
                // Si se activa, simplemente mostramos los contenedores.
                // Los valores que ya estaban ahí, se conservarán.
                numberOfPlatesContainer.slideDown();
                thicknessContainer.slideDown();
            } else {
                // Si se desactiva, solo ocultamos. NO borramos los valores de los inputs.
                // El usuario podría haber cometido un error y querer reactivarlo.
                numberOfPlatesContainer.slideUp();
                thicknessContainer.slideUp();
            }
        }


        // REEMPLAZA TU FUNCIÓN generateThicknessInputs COMPLETA CON ESTA VERSIÓN
        function generateThicknessInputs() {
            const container = $('#weldedPlatesThickness_container');
            const numberOfPlatesInput = $('#numberOfPlates');
            const numberOfPlates = parseInt(numberOfPlatesInput.val(), 10);

            // PASO 1: Guardar los valores existentes ANTES de borrar nada.
            let existingValues = {};
            container.find('.welded-thickness-input').each(function() {
                // Guardamos el valor usando el ID del input como llave (ej: "thicknessPlate1")
                existingValues[$(this).attr('id')] = $(this).val();
            });

            // PASO 2: Ahora sí, limpiar el contenedor.
            container.empty().hide();

            if (isNaN(numberOfPlates) || numberOfPlates < 2 || numberOfPlates > 5) {
                if (numberOfPlatesInput.val()) { // Solo mostrar error si hay algo escrito
                     toastr.warning('Number of plates must be between 2 and 5.', 'Invalid Input');
                }
                return;
            }

            let inputsHtml = '<div class="row">';
            const colWidth = Math.max(Math.floor(12 / numberOfPlates), 2);

            for (let i = 1; i <= numberOfPlates; i++) {
                const inputId = `thicknessPlate${i}`;
                // PASO 3: Al crear el input, buscar si tenía un valor guardado
                const previousValue = existingValues[inputId] || ''; // Si no hay valor, queda vacío

                inputsHtml += `
                    <div class="col-md-${colWidth} form-group">
                        <label for="${inputId}">Thickness Plate ${i}</label>
                        <input type="number" id="${inputId}" class="form-control welded-thickness-input"
                               placeholder="mm" min="0" step="any"
                               value="${previousValue}" @(canEditSales ? "" : "readonly") />
                        <span id="${inputId}Error" class="error-message" style="color: red; display: none;"></span>
                    </div>
                `;
            }
            inputsHtml += '</div>';

            container.html(inputsHtml).slideDown();
        }



        function toggleRunningChangeWarning() {
            const isChecked = $("#isRunningChange").is(":checked");
            const warningSpan = $("#runningChangeWarning");

            // Nuevo: Leemos el valor del campo Client Net Weight
            const netWeightValue = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))").val();

            // La advertencia ahora solo se muestra si el checkbox está marcado Y el campo de peso está vacío.
            if (isChecked && (!netWeightValue || netWeightValue.trim() === "")) {
                warningSpan.slideDown();
            } else {
                warningSpan.slideUp();
            }
        }

        function updateWeightFieldsBasedOnShape() {
            const shapeId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").val();
            const grossWeightInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");
            const netWeightInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ClientNetWeight))");

            // IDs para Rectangular (2) y Trapecio (3)
            if (shapeId === "2" || shapeId === "3") {
                // Para Rectangular y Trapecio, el Neto es igual al Bruto.
                netWeightInput.prop('readonly', true); // Hacemos el campo de solo lectura
                netWeightInput.val(grossWeightInput.val()); // Copiamos el valor inmediatamente
            } else {
                // Para cualquier otra forma (incluyendo "Configurado"), ambos son editables.
                // Solo quitamos 'readonly' si el usuario tiene permiso para editar.
                if (canEditSales) {
                    netWeightInput.prop('readonly', false);
                }
            }

            // Re-validamos ambos campos para asegurar consistencia
            validateGrossWeight();
            validateClientNetWeight();
        }
    });

    </script>
}

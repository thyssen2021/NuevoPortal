@model Portal_2_0.Models.CTZ_Projects

@{
    ViewBag.Title = "Edit Client & Part Information";
    ViewBag.PrimerNivel = "quote";
    ViewBag.SegundoNivel = "edit_client_part";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    bool canEditSales = ViewBag.CanEditSales as bool? ?? false;
    bool canEditDataManagement = ViewBag.CanEditDataManagement as bool? ?? false;
    bool canEditEngineering = ViewBag.CanEditEngineering as bool? ?? false;


}

@section estilos {
    <!-- SweetAlert2 -->
    <link href="@Url.Content("~/Content/vendors/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css")" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet" />
    <!-- DatePicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
    <!--Handsontable -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">

    <style>
        .toast {
            opacity: 0.95 !important; /* Ajusta el valor según lo que necesites */
        }

        /* Contenedor que separa claramente la sección de inputs */
        .material-form {
            border: 2px solid #009ff5; /* Borde con color corporativo */
            border-radius: 6px;
            padding: 15px;
            background-color: #f9fcff; /* Color de fondo claro para distinguir */
            margin-bottom: 30px; /* Separación de la tabla */
        }

        .material-form-title {
            color: #009ff5;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .material-form label {
            font-weight: bold;
            color: #009ff5; /* Resaltamos el texto del label con color corporativo */
        }

        .material-form .form-control {
            margin-bottom: 10px;
        }

        /* Ajustes generales de la tabla */
        .ht-like {
            border-collapse: collapse;
            width: 100%;
            border: 1px solid #ccc; /* Borde exterior */
            font-family: Arial, sans-serif; /* fuente similar a Handsontable */
        }

            /* Cabecera de la tabla */
            .ht-like thead th {
                background-color: #009ff5; /* color de fondo similar a Handsontable */
                color: #fff; /* texto en blanco */
                padding: 8px; /* algo de espaciado */
                border: 1px solid #ccc; /* bordes */
                text-align: center; /* alineación */
            }

            /* Filas del cuerpo */
            .ht-like tbody tr td {
                border: 1px solid #ccc;
                padding: 6px;
            }

            /* Alternar color de fondo en filas (opcional) */
            .ht-like tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            /* Hover en filas (opcional) */
            .ht-like tbody tr:hover {
                background-color: #e6ffe6;
            }

        /* Botón pequeño */
        .btn-xs {
            padding: 5px 10px;
            font-size: 12px;
        }

        input::placeholder {
            color: #bebbbb !important;
        }

        .btn-default {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            color: #555;
            border-radius: 3px;
            padding: 8px 15px;
        }

        /* Estilos personalizados para el tooltip */
        .tooltip-inner {
            background-color: #009ff5;
            color: #ffffff;
            font-weight: 500;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .tooltip.bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #009ff5;
        }

        .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #009ff5;
        }

        .arrow::before {
            border-left-color: #009ff5 !important;
            border-right-color: #009ff5 !important;
        }

        bs-tooltip-right .arrow::before {
        }

        /* Estilos para agrupar secciones */
        fieldset {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
        }

        legend {
            font-size: 1.2em;
            font-weight: bold;
            width: auto;
            padding: 0 10px;
            color: #009ff5;
            margin-bottom: 10px;
        }

        /* Título general del formulario */
        .material-form-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #009ff5;
        }

        /* Ejemplo de estilos para inputs */
        input.form-control, select.form-control, textarea.form-control {
            border-radius: 3px;
            border: 1px solid #ddd;
            padding: 8px;
            background-color: #fff;
            transition: border-color 0.3s ease;
        }

            input.form-control:focus, select.form-control:focus, textarea.form-control:focus {
                border-color: #009ff5;
                outline: none;
            }

        /* Opcional: estilos para mensajes de error */
        .error-message {
            font-size: 0.9em;
        }

        /* Espaciado entre filas */
        .row + .row {
            margin-top: 15px;
        }

        #archivo {
            display: block;
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            color: #555;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

            #archivo:hover {
                background-color: #eaeaea;
            }

        #downloadFile {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 5px 12px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }

            #downloadFile:hover {
                background-color: #218838;
            }

        /* Texto en gris oscuro cuando está disabled */
        .select2-container--default.select2-container--disabled .select2-selection__rendered {
            color: #7d848a !important;
        }

        /* Opcional: flecha también en gris oscuro */
        .select2-container--default.select2-container--disabled .select2-selection__arrow b {
            border-color: #7d848a transparent transparent transparent !important;
        }

        #shiftLegend {
            border: solid 1px gray;
            padding-top: 8px;
            padding-bottom: 8px;
            display: none;
        }

        #shiftLegend .legend-item {
            display: inline-block;
            margin: 0 20px;
            font-size: 0.9em;
            color: #333;
        }

        #shiftLegend .legend-line {
            display: inline-block;
            width: 30px;
            height: 0;
            border-top: 2px dashed;
            margin-right: 6px;
            vertical-align: middle;
        }
    </style>
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <!-- Cuadro informativo con los datos del proyecto -->
                        @{
                            // Si quieres ocultar el botón "Edit General Data":
                            ViewBag.ShowEditButton = false;
                        }
                        @Html.Partial("_CTZ_ProjectInfo", Model)

                        <!-- Form principal -->
                        @using (Html.BeginForm("EditClientPartInformation", "CTZ_Projects", FormMethod.Post, new { enctype = "multipart/form-data", id = "materialForm" }))
                        {
                            @Html.AntiForgeryToken()

                            if (!Html.ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger" role="alert">
                                    @Html.ValidationSummary("", "Advertencia:")
                                </div>
                            }

                            <!-- Hidden para el ID del proyecto -->
                            @Html.HiddenFor(model => model.ID_Project)

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Part Number Information</div>

                                <input type="hidden" id="materialIndex" value="" />
                                <input type="hidden" id="materialId" value="" />
                                <input type="hidden" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))" value="" />
                                <input type="hidden" id="CADFileName" value="" />


                                <!-- VEHICLE INFORMATION -->
                                <fieldset class="mb-3">
                                    <legend>Vehicle Information</legend>
                                    <div class="row">
                                        @if (Model.ID_VehicleType.HasValue && Model.ID_VehicleType.Value == 1)
                                        {
                                            <div class="col-md-6">
                                                <label>
                                                    Vehicle
                                                    <i class="fa fa-question-circle"
                                                       data-toggle="tooltip"
                                                       data-placement="right"
                                                       data-html="true"
                                                       title="Select the vehicle from the list."></i>
                                                </label>
                                                <select id="Vehicle" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value"
                                                                data-sop="@item.SOP"
                                                                data-eop="@item.EOP"
                                                                data-program="@item.Program"
                                                                data-maxproduction="@item.MaxProduction"
                                                                data-productionjson="@item.ProductionDataJson">
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                                <span id="VehicleError" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label>Vehicle 2</label>
                                                <select id="Vehicle_2" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value"
                                                                data-sop="@item.SOP"
                                                                data-eop="@item.EOP"
                                                                data-program="@item.Program"
                                                                data-maxproduction="@item.MaxProduction"
                                                                data-productionjson="@item.ProductionDataJson">
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                                <span id="Vehicle_2Error" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label>Vehicle 3</label>
                                                <select id="Vehicle_3" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value"
                                                                data-sop="@item.SOP"
                                                                data-eop="@item.EOP"
                                                                data-program="@item.Program"
                                                                data-maxproduction="@item.MaxProduction"
                                                                data-productionjson="@item.ProductionDataJson">
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                                <span id="Vehicle_3Error" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label>Vehicle 4</label>
                                                <select id="Vehicle_4" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                    <option value="">Select a Vehicle</option>
                                                    @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                    {
                                                        <option value="@item.Value"
                                                                data-sop="@item.SOP"
                                                                data-eop="@item.EOP"
                                                                data-program="@item.Program"
                                                                data-maxproduction="@item.MaxProduction"
                                                                data-productionjson="@item.ProductionDataJson">
                                                            @item.Text
                                                        </option>
                                                    }
                                                </select>
                                                <span id="Vehicle_4Error" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="col-md-8">
                                                <label>
                                                    Vehicle
                                                    <i class="fa fa-question-circle"
                                                       data-toggle="tooltip"
                                                       data-placement="right"
                                                       data-html="true"
                                                       title="Enter the vehicle name."></i>
                                                </label>
                                                <input type="text" id="Vehicle" name="Vehicle" class="form-control" placeholder="Enter Vehicle" maxlength="120" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                                <span id="VehicleError" class="error-message" style="color: red; display: none;"></span>
                                            </div>
                                        }

                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label>Vehicle Version</label>
                                            <input type="text" id="vehicleVersion" class="form-control" placeholder="Vehicle Version" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="vehicleVersionError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-2">
                                            <label>Program SP</label>
                                            <input type="text" id="programSP" class="form-control" placeholder="Program SP" readonly />
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- PRODUCTION & SHIPPING DATES -->
                                <fieldset class="mb-3">
                                    <legend>Production & Route</legend>
                                    <div class="row">
                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SOP_SP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Planned Start Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))" class="form-control" placeholder="yyyy-MM" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().EOP_SP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Planned End Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))" class="form-control" placeholder="yyyy-MM" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Real_SOP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Actual Start Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text"
                                                   id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"
                                                   name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"
                                                   class="form-control"
                                                   placeholder="yyyy‑MM"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-1">
                                            <label>
                                                @Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Real_EOP)
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Actual End Of Production (yyyy-MM)."></i>
                                            </label>
                                            <input type="text"
                                                   id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"
                                                   name="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"
                                                   class="form-control"
                                                   placeholder="yyyy‑MM"
                                                   @(canEditSales ? "" : "readonly") autocomplete="off" />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To)</label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))" class="form-control" placeholder="Ship To" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-4">
                                            <label>Part Name</label>
                                            <input type="text" id="partName" class="form-control" placeholder="Part Name" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="partNameError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Part Number</label>
                                            <input type="text" id="partNumber" class="form-control" placeholder="Part Number" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="partNumberError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))_container" class="col-md-3">
                                            <label>Quality</label>
                                            <select id="quality" name="quality" class="form-control select2-quality" @(!canEditSales ? "disabled" : String.Empty)></select>
                                            <span id="qualityError" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <div class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)</label>
                                            <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-3">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route)</label>
                                            @if (canEditSales) //enabled
                                            {
                                                @Html.DropDownList("ID_Route", new SelectList(ViewBag.ID_RouteList, "Value", "Text"), "Select a Route", new { @class = "form-control select2", id = "ID_Route" })
                                            }
                                            else //disabled
                                            {
                                                @Html.DropDownList("ID_Route", new SelectList(ViewBag.ID_RouteList, "Value", "Text"), "Select a Route", new { @class = "form-control select2", id = "ID_Route", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>



                                <!-- MECHANICAL PROPERTIES -->
                                <fieldset class="mb-3">
                                    <legend>Mechanical Properties</legend>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Tensile_Strenght)
                                                <i id="tensil-limit-id"
                                                   class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Limits not available"></i>
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))" class="form-control" placeholder="Tensile Strength" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Material_type)</label>
                                            @if (canEditSales) //enabled
                                            {
                                                @Html.DropDownList("ID_Material_type", (SelectList)ViewBag.MaterialTypeList, "Select Material Type", new { @class = "form-control select2" })
                                            }
                                            else //disabled
                                            {
                                                @Html.DropDownList("ID_Material_type", (SelectList)ViewBag.MaterialTypeList, "Select Material Type", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Thickness)
                                                <i id="thickness-limit-id"
                                                   class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Limits not available"></i>
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))" class="form-control" placeholder="Thickness" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ThicknessTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width)
                                                <i id="width-limit-id"
                                                   class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Limits not available"></i>
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))" class="form-control" placeholder="Width" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WidthTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Pitch)
                                                <i id="pitch-limit-id"
                                                   class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Limits not available"></i>
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" class="form-control" placeholder="Pitch" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PitchTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Flatness)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Flatness)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessToleranceNegative)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessTolerancePositive)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().FlatnessTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- WEIGHT & VOLUME -->
                                <fieldset class="mb-3">
                                    <legend>Weight & Volume</legend>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WeightOfFinalMults)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().WeightOfFinalMults)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Multipliers)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Multipliers)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))" class="form-control" placeholder="Blanks Per Stroke" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))" class="form-control" placeholder="Parts Per Vehicle" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Gross_Weight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))" class="form-control" placeholder="Theoretical Gross Weight" min="0" readonly />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))" class="form-control" placeholder="Gross Weight" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)</label>
                                            <input type="number" step="1" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- SHAPE & ANGLES -->
                                <fieldset id="shapeAndAngles" class="mb-3">
                                    <legend>Shape & Angles</legend>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape)</label>
                                            @if (canEditSales) //enabled
                                            {
                                                @Html.DropDownList("ID_Shape", (SelectList)ViewBag.ShapeList, "Select Shape", new { @class = "form-control select2" })
                                            }
                                            else //disabled
                                            {
                                                @Html.DropDownList("ID_Shape", (SelectList)ViewBag.ShapeList, "Select Shape", new { @class = "form-control select2", disabled = "disabled" })
                                            }
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))" class="form-control" placeholder="Angle A" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleAToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleAToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleATolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleATolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))" class="form-control" placeholder="Angle B" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBToleranceNegative)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBTolerancePositive)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().AngleBTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBase)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBase)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseToleranceNegative)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseTolerancePositive)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MajorBaseTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBase)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBase)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseToleranceNegative)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseToleranceNegative)" max="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))_container" class="col-md-2">
                                            <label>
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseTolerancePositive)
                                            </label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MinorBaseTolerancePositive)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))_container" class="col-md-1">
                                            <label class="form-check-label"
                                                   for="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))">
                                                @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().TurnOver)
                                            </label>
                                        
                                                @* El label dentro de form-check para que al hacer clic active el checkbox *@
                                                @if (canEditSales)
                                                {
                                                    <input class="form-check-input form-control"
                                                           type="checkbox"
                                                           id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))" />
                                                }
                                                else
                                                {
                                                    <input class="form-check-input form-control"
                                                           type="checkbox"
                                                           id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))"
                                                           disabled="disabled" />
                                                }
                                       
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))Error"
                                                  class="error-message"
                                                  style="color: red; display: none;">
                                            </span>
                                        </div>

                                        <div id="cat_file_container" class="col-md-6">
                                            <label>CAD Drawings</label>
                                            <div class="col-md-12">
                                                <input type="file" id="archivo" name="archivo" accept=".dwg,.dxf,.dwt,.pdf,.rar,.zip" @(!canEditSales? "disabled":string.Empty)>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-danger btn-sm" id="cancelFileButton" style="display: none;"  @(!canEditSales? "disabled":string.Empty)>Cancel</button>
                                            </div>
                                            <span id="CADFileError" class="error-message col-md-12" style="color: red; display: none;"></span>
                                        </div>
                                        <!-- Contenedor para las acciones sobre el archivo existente -->
                                        <div id="fileActions_container" class="col-md-6" style="display: none;">
                                            <label>CAD Drawings</label>
                                            <div class="col-md-12">
                                                <!-- Enlace para descargar; el href se asignará dinámicamente (o se puede generar en el servidor) -->
                                                <a id="downloadFile" href="#">Descargar Archivo</a>
                                                <!-- Botón para cambiar archivo -->
                                                <button type="button" class="btn btn-success btn-sm" id="changeFileButton" @(!canEditSales? "disabled":string.Empty)>Change</button>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>

                                <!-- COIL & PACKAGING -->
                                <fieldset class="mb-3">
                                    <legend>Coil & Packaging</legend>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MasterCoilWeight)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().MasterCoilWeight)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterArrival)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterArrival)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterArrival)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterArrival)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterDelivery)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().InnerCoilDiameterDelivery)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterDelivery)</label>
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OuterCoilDiameterDelivery)" min="0" autocomplete="off" @(canEditSales ? "" : "readonly") />
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))_container" class="col-md-2">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().PackagingStandard)</label>
                                            <select id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))" class="form-control select2" @(!canEditSales ? "disabled" : string.Empty)>
                                                <option value="">Select an option</option>
                                                <option value="OWN">tkMM</option>
                                                <option value="CM">Customer</option>
                                            </select>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))_container" class="col-md-4">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement)</label>
                                            <textarea id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement)" rows="3" autocomplete="off" @(canEditSales ? "" : "readonly")></textarea>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                        <div id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))_container" class="col-md-4">
                                            <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging)</label>
                                            <textarea id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging)" rows="3" autocomplete="off" @(canEditSales ? "" : "readonly")></textarea>
                                            <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    </div>
                                </fieldset>

                                <br />
                                <button type="button" class="btn btn-success btn-xs btn-add-material" style="display:@(!canEditSales?"none":string.Empty)"><i class="fa-solid fa-plus"></i> Add Material</button>
                                <button type="button" class="btn btn-danger btn-xs btn-clear-form" style="display:@(!canEditSales?"none":string.Empty)"><i class="fa-solid fa-eraser"></i> Clear Form</button>
                            </div>

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Technical Feasibility</div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="hidden" id="ID_Theoretical_Blanking_Line" name="ID_Theoretical_Blanking_Line" />
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Theoretical_Blanking_Line)</label>
                                        <input type="text" id="theoretical_blk_line" class="form-control" placeholder="Theoretical Blanking Line" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Strokes)</label>
                                        <input type="text" id="Theoretical_Strokes" class="form-control" placeholder="Theoretical Strokes" readonly />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line)</label>
                                        @if (canEditEngineering)
                                        {
                                            @Html.DropDownList("ID_Real_Blanking_Line", (SelectList)ViewBag.LinesList, "Select Line", new { @class = "form-control select2" })
                                        }
                                        else
                                        {
                                            @Html.DropDownList("ID_Real_Blanking_Line", (SelectList)ViewBag.LinesList, "Select Line", new { @class = "form-control select2", disabled = "disabled" })
                                        }
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_Strokes)</label>
                                        <input type="text" id="Real_Strokes" class="form-control" placeholder="Real Strokes" readonly />
                                    </div>

                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)" min="0" autocomplete="off" @(canEditEngineering ? "" : "readonly") />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)</label>
                                        <div style="position: relative; display: inline-block; width: 100%;">
                                            <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)" min="0" max="100" style="padding-right: 25px;text-align:right" autocomplete="off" @(canEditEngineering ? "" : "readonly") />
                                            <span style="position: absolute; right: 10px; top: 44%; transform: translateY(-50%); pointer-events: none; color: #555; font-weight: bold;">%</span>

                                        </div>
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                </div>
                                <br />
                                <button type="button" class="btn btn-success btn-xs btn-add-material" id="id-btn-save-engineering" style="display:none"><i class="fa-solid fa-save"></i> Save Changes</button>
                            </div>

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Efficiency and Capacity</div>
                                <div class="row">
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Parts/Auto</label>
                                        <input type="text" id="parts_auto" class="form-control" placeholder="Parts/Auto" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Stroke/Auto</label>
                                        <input type="text" id="strokes_auto" class="form-control" placeholder="Stroke/Auto" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Blanks/Year</label>
                                        <input type="text" id="blanks_per_year" class="form-control" placeholder="Blanks/Year" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Min Max Reales</label>
                                        <input type="text" id="min_max_reales" class="form-control" placeholder="Min Max Reales" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Min Max Reales / OEE</label>
                                        <input type="text" id="min_max_reales_oee" class="form-control" placeholder="Min Max Reales / OEE" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Actual Shifts</label>
                                        <input type="text" id="actual_shifts" class="form-control" placeholder="Actual Shifts" readonly />
                                    </div>
                                    <div class="col-md-3" style="display:@(!canEditDataManagement?"none":string.Empty)">
                                        <label>Stroke / shift</label>
                                        <input type="text" id="strokes_shift" class="form-control" placeholder="Stroke / shift" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Status DM</label>
                                        <input type="text" id="status_dm" class="form-control" placeholder="Status DM" readonly />
                                    </div>
                                </div>
                                <label style="display:@(!canEditDataManagement?"none":string.Empty)">Capacity (Selected Line)</label>
                                <!-- Contenedor para el Handsontable de "What‑If Capacity" para el material seleccionado -->
                                <div id="capacityTableContainer" style="display:@(!canEditDataManagement?"none":string.Empty)"></div>
                                <div style="margin-bottom: 10px;display:@(!canEditDataManagement?"none":string.Empty);">
                                    <strong>Color Legend:</strong>
                                    <div style="display: flex; gap: 20px; margin-top: 5px;">
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 20px; height: 20px; background-color: #c1fcac; border: 1px solid #ccc; margin-right: 5px;"></div>
                                            <span> < 95% (ACCEPTED)</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 20px; height: 20px; background-color: #ffd53b; border: 1px solid #ccc; margin-right: 5px; "></div>
                                            <span>95% to 98% (ON REVIEWED)</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div style="width: 20px; height: 20px; background-color: #ff7c4f; border: 1px solid #ccc; margin-right: 5px;"></div>
                                            <span>> 98% (REJECTED)</span>
                                        </div>
                                    </div>
                                </div>
                                <label>Summary Capacity</label>
                                <div id="chartsContainer"></div>
                                <!-- LEGEND: leyenda de turnos fuera del canvas -->
                                <div id="shiftLegend" class="mt-3 text-center"></div>
                            </div>

                            <!-- TITLE FOR THE MATERIAL FORM -->
                            <div class="material-form-title">Summary Parts Number</div>
                            <!-- TABLA DE MATERIALES -->
                            <table class="table-responsive ht-like" id="materialsTable">
                                <thead>
                                    <tr>
                                        <th nowrap>Actions</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Vehicle)</th>
                                        <th nowrap>Vehicle Version</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SOP_SP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().EOP_SP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_SOP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_EOP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To)</th>
                                        <th nowrap>Part Name</th>
                                        <th nowrap>Part Number</th>
                                        <th nowrap>Quality</th>
                                        <th nowrap>Program SP</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Tensile_Strenght)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Material_type)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Thickness)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Pitch)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Gross_Weight)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Theoretical_Blanking_Line)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Strokes)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_Strokes)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)</th>
                                        <th nowrap>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)</th>
                                        <th nowrap>Status DM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.CTZ_Project_Materials != null && Model.CTZ_Project_Materials.Any())
                                    {
                                        var matList = Model.CTZ_Project_Materials.OrderByDescending(x => x.ID_Material).ToList();
                                        for (int i = 0; i < matList.Count; i++)
                                        {
                                            var material = matList[i];
                                            <tr data-index="@i" data-material-id="@material.ID_Material">
                                                <td nowrap>
                                                    <button type="button" class="btn btn-warning btn-xs edit-row">Edit</button>
                                                    <button type="button" class="btn btn-danger btn-xs remove-row">Remove</button>

                                                    <!-- Hidden inputs para el POST -->
                                                    <input type="hidden" name="materials[@i].ID_Material" value="@material.ID_Material" />
                                                    <input type="hidden" name="materials[@i].Vehicle" value="@material.Vehicle" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))" value="@material.Vehicle_2" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))" value="@material.Vehicle_3" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))" value="@material.Vehicle_4" />
                                                    <input type="hidden" name="materials[@i].Vehicle_version" value="@material.Vehicle_version" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))" value="@(material.SOP_SP.HasValue? material.SOP_SP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))" value="@(material.EOP_SP.HasValue? material.EOP_SP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))" value="@(material.Real_SOP.HasValue? material.Real_SOP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))" value="@(material.Real_EOP.HasValue? material.Real_EOP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))" value="@(material.Ship_To)" />
                                                    <input type="hidden" name="materials[@i].Part_Number" value="@material.Part_Number" />
                                                    <input type="hidden" name="materials[@i].Part_Name" value="@material.Part_Name" />
                                                    <input type="hidden" name="materials[@i].Quality" value="@material.Quality" />
                                                    <input type="hidden" name="materials[@i].Program_SP" value="@material.Program_SP" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))" value="@material.Max_Production_SP" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))" value="@material.Annual_Volume" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))" value="@material.Volume_Per_year" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))" value="@material.ID_Route" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))" value="@material.Tensile_Strenght" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))" value="@material.ID_Material_type" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))" value="@material.Thickness" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))" value="@material.Width" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" value="@material.Pitch" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))" value="@material.Blanks_Per_Stroke" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))" value="@material.Parts_Per_Vehicle" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))" value="@material.Theoretical_Gross_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))" value="@material.Gross_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))" value="@material.ID_Shape" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))" value="@material.Angle_A" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))" value="@material.Angle_B" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))" value="@material.ID_Real_Blanking_Line" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))" value="@material.ID_Theoretical_Blanking_Line" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))" value="@material.Theoretical_Strokes" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))" value="@material.Real_Strokes" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))" value="@material.Ideal_Cycle_Time_Per_Tool" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))" value="@material.OEE" />
                                                    <input type="hidden" name="materials[@i].status_dm" value="--" />
                                                    <!--Nuevos Campos -->
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))" value="@material.ThicknessToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))" value="@material.ThicknessTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))" value="@material.WidthToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))" value="@material.WidthTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))" value="@material.PitchToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))" value="@material.PitchTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))" value="@material.AngleAToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))" value="@material.AngleATolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))" value="@material.AngleBToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))" value="@material.AngleBTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))" value="@material.WeightOfFinalMults" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))" value="@material.Multipliers" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))" value="@material.MajorBase" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))" value="@material.MajorBaseToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))" value="@material.MajorBaseTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))" value="@material.MinorBase" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))" value="@material.MinorBaseToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))" value="@material.MinorBaseTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))" value="@material.Flatness" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))" value="@material.FlatnessToleranceNegative" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))" value="@material.FlatnessTolerancePositive" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))" value="@material.MasterCoilWeight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))" value="@material.InnerCoilDiameterArrival" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))" value="@material.OuterCoilDiameterArrival" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))" value="@material.InnerCoilDiameterDelivery" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))" value="@material.OuterCoilDiameterDelivery" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))" value="@material.PackagingStandard" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))" value="@material.SpecialRequirement" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))" value="@material.SpecialPackaging" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))" value="@material.ID_File_CAD_Drawing" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.IsFile))" value="@material.IsFile" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))" value="@(material.CTZ_Files != null? material.CTZ_Files.Name : string.Empty)" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))" value="@(material.TurnOver.HasValue && material.TurnOver.Value == true ? "true" :"false")" />
                                                </td>
                                                <td nowrap>@Html.DisplayFor(model => material.Vehicle)</td>
                                                <td nowrap>@material.Vehicle_version</td>
                                                <td nowrap>@(material.SOP_SP.HasValue? material.SOP_SP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@(material.EOP_SP.HasValue? material.EOP_SP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@(material.Real_SOP.HasValue? material.Real_SOP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@(material.Real_EOP.HasValue? material.Real_EOP.Value.ToString("yyyy-MM"):"")</td>
                                                <td nowrap>@material.Ship_To</td>
                                                <td nowrap>@material.Part_Name</td>
                                                <td nowrap>@material.Part_Number</td>
                                                <td nowrap>@material.Quality</td>
                                                <td nowrap>@material.Program_SP</td>
                                                <td nowrap>@material.Max_Production_SP</td>
                                                <td nowrap>@material.Annual_Volume</td>
                                                <td nowrap>@material.Volume_Per_year</td>
                                                <td nowrap>@(material.CTZ_Route != null ? material.CTZ_Route.Route_Name : "")</td>
                                                <td nowrap>@material.Tensile_Strenght</td>
                                                <td nowrap>@(material.CTZ_Material_Type != null ? material.CTZ_Material_Type.Material_Name : "")</td>
                                                <td nowrap>@material.Thickness</td>
                                                <td nowrap>@material.Width</td>
                                                <td nowrap>@material.Pitch</td>
                                                <td nowrap>@material.Blanks_Per_Stroke</td>
                                                <td nowrap>@material.Parts_Per_Vehicle</td>
                                                <td nowrap>@material.Theoretical_Gross_Weight</td>
                                                <td nowrap>@material.Gross_Weight</td>
                                                <td nowrap>@(material.SCDM_cat_forma_material != null ? material.SCDM_cat_forma_material.ConcatKey : "")</td>
                                                <td nowrap>@material.Angle_A</td>
                                                <td nowrap>@material.Angle_B</td>
                                                <td nowrap>@(material.CTZ_Production_Lines != null ? material.CTZ_Production_Lines.Description : "")</td>
                                                <td nowrap>@(material.CTZ_Production_Lines1 != null ? material.CTZ_Production_Lines1.Description : "")</td>
                                                <td nowrap>@material.Theoretical_Strokes</td>
                                                <td nowrap>@material.Real_Strokes</td>
                                                <td nowrap>@material.Ideal_Cycle_Time_Per_Tool</td>
                                                <td nowrap>@material.OEE</td>
                                                <td nowrap>--</td> @*Peniente de mandar el estatus Real*@
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>

                            <br />
                            <!-- Botón final para guardar todo en la base de datos -->
                            <button type="submit" class="btn btn-success"><i class="fa-regular fa-floppy-disk"></i> Save All Materials</button>
                        }
                    </div>
                    <div class="text-right mt-3">
                        <button type="button" class="btn btn-default" onclick="window.history.back();">
                            <i class="fa-regular fa-circle-left"></i> Back
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 10000;
">
    <div style="
        position: absolute;
        top: 20px;
        left:30px;
        color: #b0a9a9;
        font-size: 1.8em;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px 20px;
        border-radius: 6px;
    ">
        <i class="fa-solid fa-spinner fa-spin"></i> Guardando Cambios...
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <!-- SweetAlert2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/sweetalert2/sweetalert2.min.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- Select2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <!-- DatePicker -->
    @Scripts.Render(Url.Content("~/Content/vendors/moment/moment.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <!-- Hansontable -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>

    <script>

//variables para activar/desactivar campos
// Objeto que mapea el ID de la ruta (o su valor) a la lista de campos que deben estar activos.
const routeFieldMap = {
    //Route con ID = 1 = "BLK"
    "1": ["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",
    ],
    //Route con ID = 2 = "BLK + RP"
    "2": ["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",

    ],
     //Route con ID = 4 = "BLK + SH"
    "4": ["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",


    ],
    //Route con ID = 5 = "BLK + WLD"
    "5": [
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",


    ],
    //Route con ID = 6 = "COIL TO COIL"
    "6": [
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))"

    ],
     //Route con ID = 7 = "REWINDED" //pendiente
    "7": [
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
    ],
      //Route con ID = 8 = "SLT"
    "8": [
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))"
    ],
    //Route con ID = 9 = "SLT + BLK"
    "9": [
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",


    ],
     //Route con ID = 10 = "SLT + BLK + WLD"
    "10": [
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",


    ],
    //Route con ID = 11 = "WAREHOUSING"
    "11": [
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))"
    ],
    //Route con ID = 12 = "WAREHOUSING / REPALLETIZING"
    "12": [
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
         "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))"
    ],
    //Route con ID = 13 = "WEIGHT DIVISION"
    "13": [
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
        "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))"
     ],
};

// Lista de TODOS los campos que podrían activarse/desactivarse
const allFields = [
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Quality))", //Steel grade
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))",

];

// Lista de nombres de campos que están dentro del fieldset "Shape & Angles"
var shapeFields = [
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
    "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))"
];


// Si no tiene valor, asumimos 0 (no automotriz)
var vehicleType = @(Model.ID_VehicleType.HasValue ? Model.ID_VehicleType.Value : 0);

let volumeTimeout; //variable global para timeout de annual volume

var previousTheoreticalLine = $("#ID_Theoretical_Blanking_Line").val();


// Configuración de Toastr
toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "timeOut": "3000",
    "extendedTimeOut": "1000"
};

var lineMap = {
    "PUEBLA-BLK1": 1,
    "PUEBLA-BLK2": 2,
    "PUEBLA-BLK3": 3,
    "SILAO-BLK1": 4,
    "SILAO-BLK2": 5,
    "SILAO-BLK3": 6,
    "SLP-BLK1": 7
};

        // Mapeo de ID_Status => color
        var statusColors = {
            "POH": "#0098f7",   // POH
            "Casi Casi": "#ffd400",   // Casi Casi
            "Carry Over": "#aaaaaa",   // Carry Over
            "Quotes": "#01c401"    // Quotes
        };

        // Mapeo de ID_Status => etiqueta legible
        var statusLabels = {
            "POH": "POH",
            "Casi Casi": "Casi Casi",
            "Carry Over": "Carry Over",
            "Quotes": "Quotes"
        };

        const totalLabelPlugin = {
            id: 'totalLabelPlugin',
            // Se ejecuta después de dibujar los datasets
            afterDatasetsDraw(chart, args, options) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;

                ctx.save();
                ctx.font = options.font || 'bold 12px sans-serif';
                ctx.fillStyle = options.textColor || '#000';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';

                //las etiquetas se reparten uniformemente a lo largo del eje X
                const numLabels = chart.data.labels.length;
                const colWidth = (chartArea.right - chartArea.left) / numLabels;

                chart.data.labels.forEach((label, index) => {
                    // Calcular la suma de los valores en esa posición (acumulado)
                    let total = 0;
                    chart.data.datasets.forEach(dataset => {
                        total += dataset.data[index] || 0;
                    });

                    // Obtener la posición en Y para el valor total
                    let yPos = yScale.getPixelForValue(total);
                    // Obtener la posición en X como el centro de la "columna"
                    let xPos = chartArea.left + colWidth * index + colWidth / 2;

                    // Dibujar el texto (con dos decimales y "%")
                    ctx.fillText(total.toFixed(2) + "%", xPos, yPos - 2);
                });

                ctx.restore();
            }
        };

        // Plugin personalizado para dibujar una línea vertical al mover el mouse
        const verticalLinePlugin = {
            id: 'verticalLinePlugin',
            afterDatasetsDraw(chart, args, options) {

                // Verificar si hay un punto activo (tooltip visible)
                if (chart.tooltip && chart.tooltip._active && chart.tooltip._active.length) {
                    // Tomamos el primer punto activo (index)
                    let activePoint = chart.tooltip._active[0];
                    let ctx = chart.ctx;
                    let x = activePoint.element.x;
                    let topY = chart.chartArea.top;
                    let bottomY = chart.chartArea.bottom;

                    // Dibujamos la línea
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, topY);
                    ctx.lineTo(x, bottomY);
                    ctx.lineWidth = options.lineWidth || 2;       // grosor
                    ctx.strokeStyle = options.lineColor || 'pink'; // color
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };

        // Inyectamos el C# bool como literal JS
        var canEditSales = @canEditSales.ToString().ToLower();
        var canEditDataManagement = @canEditDataManagement.ToString().ToLower();
        var canEditEngineering = @canEditEngineering.ToString().ToLower();

        var statusId = @Model.ID_Status;


    $(document).ready(function () {

        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                toastr.success("@TempData["SuccessMessage"]");
            </text>
        }

    // Inicializar Select2 en los selects
    $(".select2").select2({ width: '100%' });

    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });

    //previene enter en formulario
    $(window).keydown(function (event) {
        if (event.keyCode == 13) {
            event.preventDefault();
            return false;
        }
    });


        //Función que envuelve la llamada a UpdateCapacityGraphs con debounce
        const debouncedUpdateCapacityGraphs = debounce(function () {
            UpdateCapacityGraphs();
            //llama al metodo para actualizar el ht de capacidad.
            UpdateCapacityHansontable();
        }, 300); // 300 ms de espera

    //agrega el evento para el cambio de archivo
     $("#changeFileButton").on("click", function () {
         let fileUploadContainer = $("#cat_file_container");
         let fileActionsContainer = $("#fileActions_container");
         let archivoInput = $("#archivo");
         let cancelButton = $("#cancelFileButton");

         fileUploadContainer.show();
         fileActionsContainer.hide();
         cancelButton.show();

         archivoInput.prop("disabled", false);
     });

     $("#cancelFileButton").on("click", function () {
         let fileUploadContainer = $("#cat_file_container");
         let fileActionsContainer = $("#fileActions_container");
         let archivoInput = $("#archivo");
         let cancelButton = $("#cancelFileButton");

         fileUploadContainer.hide();
         fileActionsContainer.show();
         cancelButton.hide();

         archivoInput.prop("disabled", true);
    });

    // Ocultar inicialmente los selects de Vehicle 2, 3 y 4
    $("#Vehicle_2").closest(".col-md-6").hide();
    $("#Vehicle_3").closest(".col-md-6").hide();
    $("#Vehicle_4").closest(".col-md-6").hide();

    // Llamar a la función al cargar la página
    updateVehicleVisibility();

    // Asociar el evento change a cada select para actualizar la visibilidad
    $("#Vehicle").on("change", updateVehicleVisibility);
    $("#Vehicle_2").on("change", updateVehicleVisibility);
    $("#Vehicle_3").on("change", updateVehicleVisibility);

    // Inicializa el select2 para Quality con tags y sugerencias
    var qualityData = @Html.Raw(Json.Encode(ViewBag.QualityList));

    //llama al evento de update shape
    shapeVisibility();

        //llama al metodo para mostrar las graficas, OnlyBDMaterials = true
        UpdateCapacityGraphs(true)
        UpdateCapacityHansontable(true)

    $(".select2-quality").select2({
        tags: true,
        data: qualityData,
        width: '100%',
        placeholder: "Select or enter quality"
    }).val(null).trigger("change");  //vacio por defecto


        //solo inicializa datepicker si puede editar
        if (canEditSales) {

            // Inicializa datepicker para Real_SOP
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").datepicker({
                format: "yyyy-mm",       // Formato año-mes (en minúsculas, ya que bootstrap-datepicker usa "mm" para mes)
                startView: "months",     // Inicia mostrando meses
                minViewMode: "months",   // Permite seleccionar solo meses
                autoclose: true
            });

            // Inicializa datepicker para Real_EOP
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").datepicker({
                format: "yyyy-mm",
                startView: "months",
                minViewMode: "months",
                autoclose: true
            });

        }
    var columnDefs = [
        { key: "Vehicle", selector: "#Vehicle", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))", type: "dropdown" },
        { key: "Vehicle_version", selector: "#vehicleVersion", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))", type: "text" },
        { key: "Part_Name", selector: "#partName", type: "text" },
        { key: "Part_Number", selector: "#partNumber", type: "text" },
        { key: "Quality", selector: "#quality", type: "dropdown" },
        { key: "Program_SP", selector: "#programSP", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))", type: "number" },
        { key: "status_dm", selector: "#status_dm", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))", type: "number" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))", type: "dropdown" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))", type: "text" },
        { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))", type: "check" },
    ];

    // Declaramos una variable para el timeout
        let updateTimeout;


    // Asociamos el evento change y keyup a los campos indicados
    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght)), " +
        "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), " +
        "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), " +
        "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch)), " +
        "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))")
        .on("change keyup", function () {
            // Cada vez que se dispara el evento, se cancela el timeout anterior
            clearTimeout(updateTimeout);
            // Se establece un nuevo timeout para ejecutar la función updateTheoreticalLine después de 1500 milisegundos
            updateTimeout = setTimeout(updateTheoreticalLine, 800);
        });

    //inicia eventos para validacion en tiempo real
    IniciaValidacionTiempoReal();

    // Botón para agregar/actualizar material
    $(document).on("click", ".btn-add-material", function () {

        // Realizar la validación antes de continuar
        if (!validateMaterial()) {

            toastr.warning("Please check the material data. Some fields are missing or contain invalid information.");

            return; // Detener si la validación falla
        }

        let index = $("#materialIndex").val().trim();
        let materialData = {};

        // Recoge valores de los inputs
        for (let col of columnDefs) {
            let $input = $(col.selector);
            let val;

            // Checkbox
            if (col.type === "check") {
                // .is(':checked') devuelve true/false
                val = $input.is(":checked").toString();
            }
            // Hidden siempre lo tomamos
            else if ($input.attr("type") === "hidden") {
                val = $input.val();
            }
            // Visible normal
            else if ($input.is(":visible")) {
                val = $input.val();
            }
            // Oculto → vacío
            else {
                val = "";
            }

            materialData[col.key] = val;
        }

        console.log(materialData)

        // Aquí: si el input de archivo (#archivo) tiene algún valor, marcamos este material.
        // Consideramos que solo el material que se agregue cuando se tenga un archivo tendrá la bandera.
        materialData["IsFile"] = $("#archivo").val() ? "true" : "false";

        if (index === "") {
            // AGREGAR NUEVO
            let rowCount = $("#materialsTable tbody tr").length;
            let rowHtml = buildRowHtml(materialData, rowCount);
            $("#materialsTable tbody").append(rowHtml);
        //    toastr.success("Material added successfully.");
        } else {
            // EDITAR MATERIAL EXISTENTE
            let row = $("#materialsTable tbody").find(`tr[data-index='${index}']`);
            let indice = 1; // El incice empieza en 1 porque se moite 0 de la columna de acciones
            let colCells = row.find("td");

            // Actualizar hidden inputs
            let hiddenInputs = row.find("input[name^='materials']");

            hiddenInputs.each(function () {
                let nameAttr = $(this).attr("name");
                for (let col of columnDefs) {
                    if (nameAttr.endsWith(`.${col.key}`)) {
                        let newVal;
                        if (col.type === "check") {
                            newVal = materialData[col.key];
                        }
                        else if ($(this).attr("type") === "hidden") {
                            newVal = materialData[col.key];
                        }
                        else {
                            newVal = $(col.selector).is(":visible") ? materialData[col.key] : "";
                        }
                        $(this).val(newVal);
                    }
                }
                if (nameAttr.indexOf("IsFile") !== -1) {
                    $(this).val(materialData["IsFile"]);
                }
            });
        }

        //envia el formulario
        $("#materialForm").submit();

        //clearMaterialForm(columnDefs);
    });

    //Al enviar el formularrio muestra un mensaje
    $("#materialForm").on("submit", function () {
        $("#loadingOverlay").show();
    });

    $("#eraseInputs").click(function () {
        clearMaterialForm(columnDefs);
    });

    //oculta/muestra campos segun Ruta
    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").on("change", function () {

        let selectedValue = $(this).val();

        // 1) Oculta y deshabilita todos los campos de la lista 'allFields' con efecto de desvanecimiento
        allFields.forEach(field => {
            $(`#${field}`).prop("disabled", true);
            $(`#${field}_container`).fadeOut(0);
        });

        // 2) Muestra y habilita los campos correspondientes a la ruta seleccionada con efecto de desvanecimiento
        if (routeFieldMap[selectedValue]) {
            routeFieldMap[selectedValue].forEach(field => {
                $(`#${field}_container`).fadeIn(0);
                $(`#${field}`).prop("disabled", !canEditSales);
            });
        }

        //// Se buscan inputs y selects que estén visibles dentro del fieldset
        var visibleElements = $("#shapeAndAngles").find("input:visible, select:visible");

        if (routeFieldMap[selectedValue] && routeFieldMap[selectedValue].some(field => shapeFields.includes(field))) {
            $("#shapeAndAngles").fadeIn(0);
        } else {
            $("#shapeAndAngles").fadeOut(0);
        }

        shapeVisibility();

    });

    // Botón Remove
    $(document).on("click", ".remove-row", function () {
        var row = $(this).closest("tr");
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to remove this material?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#009ff5',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                row.remove();
                renumberRows();
                //envia el formulario
                $("#materialForm").submit();
            }
        });
    });

    // Botón Edit
    $(document).off("click", ".edit-row").on("click", ".edit-row", function () {

        let row = $(this).closest("tr");
        let index = row.data("index");
        let materialId = row.data("material-id"); // Asegúrate de que la fila tenga data-material-id
        //asigna el valor al input oculto
        $("#materialId").val(materialId)
        $("#materialIndex").val(index);

        //hace visible el boton para ingenieria.
        if (canEditEngineering) {
            $("#id-btn-save-engineering").show();
        }

        let hiddenInputs = row.find("input[name^='materials']");
        hiddenInputs.each(function () {
            let nameAttr = $(this).attr("name");
            let val = $(this).val();
            for (let col of columnDefs) {
                if (nameAttr.endsWith(`.${col.key}`)) {
                    // 1) Checkbox: en lugar de .val(), usamos .prop('checked')
                    if (col.type === "check") {
                        $(col.selector).prop("checked", val === "true");
                        continue;
                    }

                    // 2) Quality (añadir opción si hace falta)
                    if (col.key === "Quality") {
                        if (!$(col.selector).find(`option[value="${val}"]`).length) {
                            let newOption = new Option(val, val, true, true);
                            $(col.selector).append(newOption);
                        }
                    }

                    // 3) El resto de controles
                    $(col.selector).val(val);

                    // 4) Si es un select2, refrescamos el texto sin disparar change
                    if (col.type === "dropdown") {
                        let $select = $(col.selector);
                        let selectedText = $select.find('option:selected').text();
                        if ($select.data('select2')) {
                            $select.data('select2')
                                .$container
                                .find('.select2-selection__rendered')
                                .text(selectedText);
                        }
                    }
                }
            }
        });


        $('.btn-add-material').html('<i class="fa-solid fa-pen-to-square"></i> Save Changes');

        //llama al evento onchange del input de route para mostrar ocultar campos
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").trigger("change");
        updateVehicleVisibility();
        shapeVisibility();

        validateMaterial();
    });

        function UpdateCapacityGraphs(OnlyBDMaterials = false) {
            console.log('entra UpdateCapacityGraphs');

            // Obtiene el valor de la línea teórica
            let theoricalBLKID = $("#ID_Theoretical_Blanking_Line").val();

            let materialId = $("#materialId").val();

            // Obtiene el ID de la línea real (del select correspondiente)
            var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

            // Si la línea real es vacía o 0, se utiliza la línea teórica
            if (productionLineId === "" || productionLineId === "0") {
                productionLineId = theoricalBLKID;
                console.log('Usando linea teorica para calculos');
            }

            // Obtener los valores de los campos necesarios
            var vehicle = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle))").val();
            var partsPerVehicle = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val()) || null;
            var idealCycleTimePerTool = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val()) || null;
            var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val()) || null;
            var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val()) || null;
            var realSOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").val();
            var realEOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val();
            var annualVol = parseInt($("#Annual_Volume").val()) || null;

            // Campos de fallback para idealCycleTimePerTool
            var realStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val()) || null;
            var theoreticalStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val()) || null;

            // Limpiar el contenedor de gráficos
            $("#chartsContainer").html("<p style='color:gray;'>Loading <i class='fa-solid fa-spinner fa-spin-pulse'></i></p>");

            // Validar que existan los campos obligatorios
            var missingFields = [];
            if (!vehicle || vehicle.trim() === "") {
                missingFields.push("Vehicle");
            }
            if (partsPerVehicle === null) {
                missingFields.push("Parts per Vehicle");
            }
            if (blanksPerStroke === null) {
                missingFields.push("Blanks per Stroke");
            }
            if (!realSOP || realSOP.trim() === "") {
                missingFields.push("Real SOP");
            }
            if (!realEOP || realEOP.trim() === "") {
                missingFields.push("Real EOP");
            }
            if (annualVol === null) {
                missingFields.push("Annual Volume");
            }

            // Fallback para idealCycleTimePerTool
            if (idealCycleTimePerTool === null) {
                if (realStrokes !== null) {
                    idealCycleTimePerTool = realStrokes;
                } else if (theoreticalStrokes !== null) {
                    idealCycleTimePerTool = theoreticalStrokes;
                } else {
                    missingFields.push("Ideal Cycle Time (or Real/Theoretical Strokes)");
                }
            }

            // Si faltan campos, no se ejecuta la llamada AJAX; se limpia el contenedor y se muestra un mensaje
            if (missingFields.length > 0 && !OnlyBDMaterials) {
                $("#chartsContainer").html(
                    "<p style='color:red;'>Missing required fields: " + missingFields.join(", ") + "</p>"
                );
                return;
            }

            // Realizar la llamada AJAX
            $.ajax({
                url: '@Url.Action("GetMaterialCapacityScenariosGraphs", "CTZ_Projects")',
                type: 'GET',
                data: {
                    projectId: @Model.ID_Project,
                    materialId: materialId,  // Puede ser null
                    blkID: productionLineId,
                    vehicle: vehicle,
                    partsPerVehicle: partsPerVehicle,
                    idealCycleTimePerTool: idealCycleTimePerTool,
                    blanksPerStroke: blanksPerStroke,
                    oee: oee,
                    realSOP: realSOP,
                    realEOP: realEOP,
                    annualVol: annualVol,
                    OnlyBDMaterials: OnlyBDMaterials
                },
                success: function (response) {
                    var container = document.getElementById("chartsContainer");
                    container.innerHTML = ""; // Limpiar contenedor
                    if (response.success) {
                        generateCharts(response.data);
                    } else {
                        $("#chartsContainer").html(
                            "<p style='color:red;'>Warning: " + response.message + "</p>"
                        );
                        //toastr.error("Error: " + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    $("#chartsContainer").html(
                        "<p style='color:red;'>Error: " + error + "</p>"
                    );
                   // toastr.error("An error occurred: " + error);
                },
                async: true
            });
        }


        function generateCharts(data) {
            // Limpiar el contenedor principal de gráficos
            $("#chartsContainer").empty();
            var currentRow = null;
            var charts = [];      // <-- aquí acumularemos las instancias

            // Iterar sobre cada línea de producción (cada gráfica)
            data.forEach(function (lineData, index) {
                // Comenzar una nueva fila cada 2 gráficos
                if (index % 2 === 0) {
                    currentRow = $('<div class="row" style="margin-bottom:20px;"></div>');
                    $("#chartsContainer").append(currentRow);
                }

                // Crear un contenedor de columna (col-md-6)
                var colDiv = $('<div class="col-md-6"></div>');

                // --- Paso 1: Filtrar los años fiscales que tienen datos ---
                var fyData = lineData.DataByFY;
                var startIdx = 0, endIdx = fyData.length - 1;
                for (let i = 0; i < fyData.length; i++) {
                    if (fyData[i].Breakdown && fyData[i].Breakdown.some(b => b.Percentage > 0)) {
                        startIdx = i;
                        break;
                    }
                }
                for (let i = fyData.length - 1; i >= 0; i--) {
                    if (fyData[i].Breakdown && fyData[i].Breakdown.some(b => b.Percentage > 0)) {
                        endIdx = i;
                        break;
                    }
                }
                var filteredFYData = (startIdx <= endIdx) ? fyData.slice(startIdx, endIdx + 1) : fyData;
                var labels = filteredFYData.map(fy => fy.FiscalYear);

                // --- Paso 2: Armar datasets agrupados por estatus ---
                var statusMap = {};  // Key: StatusId, Value: { label, data: [], backgroundColor }
                filteredFYData.forEach(function (fyItem) {
                    if (fyItem.Breakdown) {
                        fyItem.Breakdown.forEach(function (b) {
                            if (!statusMap[b.StatusId]) {
                                statusMap[b.StatusId] = {
                                    statusId: b.StatusId,
                                    label: statusLabels[b.StatusId] || ("Status " + b.StatusId),
                                    data: [],
                                    backgroundColor: statusColors[b.StatusId] || "#999999"
                                };
                            }
                        });
                    }
                });
                Object.keys(statusMap).forEach(function (statusId) {
                    filteredFYData.forEach(function (fyItem) {
                        var entry = (fyItem.Breakdown || []).find(b => b.StatusId == statusId);
                        statusMap[statusId].data.push(entry ? entry.Percentage : 0);
                    });
                });
                // Ordenar los datasets según el orden deseado
                var desiredOrder = ["POH", "Casi Casi", "Carry Over", "Quotes"];
                var datasets = Object.values(statusMap).sort(function (a, b) {
                    var indexA = desiredOrder.indexOf(a.label);
                    var indexB = desiredOrder.indexOf(b.label);
                    indexA = indexA === -1 ? desiredOrder.length : indexA;
                    indexB = indexB === -1 ? desiredOrder.length : indexB;
                    return indexA - indexB;
                });

                // --- Paso 3: Calcular el máximo acumulado para configurar el eje Y ---
                var maxAcc = 0;
                for (let i = 0; i < filteredFYData.length; i++) {
                    let sum = 0;
                    datasets.forEach(ds => {
                        sum += ds.data[i] || 0;
                    });
                    if (sum > maxAcc) {
                        maxAcc = sum;
                    }
                }
                var maxPercentage = Math.ceil(Math.max(100, maxAcc) * 1.1);

                // --- Paso 4: Crear el canvas para la gráfica y agregarlo a la columna ---
                colDiv.append('<h4>' + lineData.LineName + '</h4>');
                var canvasId = "chartLine_" + lineData.LineId;
                colDiv.append('<canvas id="' + canvasId + '"></canvas>');
                currentRow.append(colDiv);

                // --- Paso 5: Generar la gráfica con Chart.js ---
                var ctx = document.getElementById(canvasId).getContext("2d");
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets.map(function (ds) {
                            return {
                                label: ds.label,
                                data: ds.data,
                                backgroundColor: ds.backgroundColor,
                                borderColor: ds.backgroundColor,
                                fill: true,
                                stack: 'CapacityStack',
                                tension: 0,  // Líneas rectas
                                pointRadius: 0
                            };
                        })
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: "Fiscal Year"
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: maxPercentage,
                                title: {
                                    display: true,
                                    text: "Capacity (%)"
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var label = context.dataset.label || "";
                                        var value = context.parsed.y;
                                        return label + ": " + value + "%";
                                    },
                                    footer: function (tooltipItems) {
                                        var total = tooltipItems.reduce((acc, item) => acc + item.parsed.y, 0);
                                        return "Total: " + total.toFixed(2) + "%";
                                    },
                                    title: function (tooltipItems) {
                                        return "Fiscal Year: " + tooltipItems[0].label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line100: {
                                        type: 'line',
                                        yMin: 100,
                                        yMax: 100,
                                        borderColor: 'red',
                                        borderWidth: 3,
                                        label: {
                                            enabled: false,
                                            content: '100% capacity',
                                            position: 'end',
                                            backgroundColor: 'rgba(255,0,0,0.7)',
                                            color: '#fff'
                                        }
                                    },
                                    line85: {
                                        type: 'line',
                                        yMin: 85,
                                        yMax: 85,
                                        borderColor: 'orange',
                                        borderWidth: 3,
                                        label: {
                                            enabled: false,
                                            content: '85% capacity',
                                            position: 'end',
                                            backgroundColor: 'rgba(255,165,0,0.7)',
                                            color: '#fff'
                                        }
                                    },
                                    line25: {
                                        type: 'line',
                                        yMin: 25,
                                        yMax: 25,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [8, 3, 3, 3],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '1st shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line53: {
                                        type: 'line',
                                        yMin: 53,
                                        yMax: 53,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [3, 3],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '2nd shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line80: {
                                        type: 'line',
                                        yMin: 80,
                                        yMax: 80,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [8, 4],        // guion-espacio
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '3rd shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line100_2: {
                                        type: 'line',
                                        yMin: 100,
                                        yMax: 100,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [5, 10],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: true,
                                            content: '4th shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                }
                            },
                            // Opcional: configuración para verticalLinePlugin
                            verticalLinePlugin: {
                                lineWidth: 1,
                                lineColor: '#e91e63'
                            },
                            totalLabelPlugin: {
                                font: "bold 14px sans-serif",
                                textColor: "#555555"
                            }
                        }
                    },
                    plugins: [totalLabelPlugin, verticalLinePlugin]
                });

                charts.push(chart);   // <-- lo guardamos

            });

            if (charts.length > 0) {
                // Usamos la primera gráfica para extraer las anotaciones
                buildShiftLegend(charts[0].options.plugins.annotation.annotations);
            }

            // Mostrar el mensaje solo si hay alguna gráfica generada
            if ($("#chartsContainer").children().length > 0) {
                $("#chartsNote").show();
                $("#shiftLegend").show();
            } else {
                $("#chartsNote").hide();
                $("#shiftLegend").hide();

            }
        }

        function buildShiftLegend(annotations) {
            var legend = document.getElementById('shiftLegend');
            legend.innerHTML = '';

            // Contador de turnos
            Object.values(annotations).forEach(function (a) {
                // Solo procesamos las anotaciones con borderDash definido
                if (Array.isArray(a.borderDash)) {
                    // Construimos el atributo dash-array si existe
                    var dashArray = a.borderDash.length
                        ? ' stroke-dasharray="' + a.borderDash.join(',') + '"'
                        : '';

                    // Creamos un SVG con una línea horizontal
                    var svg =
                        '<svg width="30" height="6" ' +
                        'style="vertical-align:middle;">' +
                        '<line x1="0" y1="3" x2="30" y2="3" ' +
                        'stroke="' + a.borderColor + '" ' +
                        'stroke-width="2"' +
                        dashArray +
                        '/>' +
                        '</svg>';

                    // Obtenemos el texto de la etiqueta (si lo tenías guardado en label.content)
                    var text = (a.label && a.label.content)
                        ? a.label.content
                        : '';

                    // Añadimos al contenedor
                    var item = document.createElement('span');
                    item.className = 'legend-item';
                    item.innerHTML = svg + ' ' + text;
                    legend.appendChild(item);
                }
            });
        }

        function UpdateCapacityHansontable(OnlyBDMaterials = false) {
            //si no tiene el permiso se sale
            if (!canEditDataManagement) {
                console.warn("UpdateCapacityHansontable: Acceso denegado, no puede editar DM. Faltan permisos.");
                return;
            }

            console.log('entra UpdateCapacityHansontable');

            let materialId = $("#materialId").val();

             // obtiene el valor de la linea teorica
            let theoricalBLKID = $("#ID_Theoretical_Blanking_Line").val();

            // Obtiene los ids que se enviaran
            var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

            //si la linea real es igual a vacio 0, se utiliza la linea teorica
            if (productionLineId == "" || productionLineId == 0) {
                productionLineId = theoricalBLKID;
                console.log('Usando linea teorica para calculos')
            }

            var vehicle = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle))").val();
            var partsPerVehicle = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val()) || null;
            var idealCycleTimePerTool = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val()) || null;
            var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val()) || null;
            var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val()) || null;
            var realSOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").val();
            var realEOP = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val();
            var annualVol = parseInt($("#Annual_Volume").val()) || null;

            // Campos de fallback para idealCycleTimePerTool
            var realStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val()) || null;
            var theoreticalStrokes = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val()) || null;

            // Limpiar el contenedor de gráficos
            $("#capacityTableContainer").html("<p style='color:gray;'>Loading <i class='fa-solid fa-spinner fa-spin-pulse'></i></p>");

            // Validar que existan los campos obligatorios
            var missingFields = [];
            if (!vehicle || vehicle.trim() === "") {
                missingFields.push("Vehicle");
            }
            if (partsPerVehicle === null) {
                missingFields.push("Parts per Vehicle");
            }
            if (blanksPerStroke === null) {
                missingFields.push("Blanks per Stroke");
            }
            if (!realSOP || realSOP.trim() === "") {
                missingFields.push("Real SOP");
            }
            if (!realEOP || realEOP.trim() === "") {
                missingFields.push("Real EOP");
            }
            if (annualVol === null) {
                missingFields.push("Annual Volume");
            }

            // Fallback para idealCycleTimePerTool
            if (idealCycleTimePerTool === null) {
                if (realStrokes !== null) {
                    idealCycleTimePerTool = realStrokes;
                } else if (theoreticalStrokes !== null) {
                    idealCycleTimePerTool = theoreticalStrokes;
                } else {
                    missingFields.push("Ideal Cycle Time (or Real/Theoretical Strokes)");
                }
            }

            // Si faltan campos, no se ejecuta la llamada AJAX; se limpia el contenedor y se muestra un mensaje
            if (missingFields.length > 0 && !OnlyBDMaterials) {
                $("#capacityTableContainer").html(
                    "<p style='color:red;'>Missing required fields: " + missingFields.join(", ") + "</p>"
                );
                return;
            }

            // Llamada AJAX para obtener el "what‑if" de capacidad para el material seleccionado.
            // Se envían además projectId, materialId y blkID (que es la línea real consultada)
            $.ajax({
                url: '@Url.Action("GetMaterialCapacityScenarios", "CTZ_Projects")',
                type: 'GET',
                data: {
                    projectId: @Model.ID_Project,
                    materialId: materialId, // Puede ser null
                    blkID: productionLineId,
                    vehicle: vehicle,
                    partsPerVehicle: partsPerVehicle,
                    idealCycleTimePerTool: idealCycleTimePerTool,
                    blanksPerStroke: blanksPerStroke,
                    oee: oee,
                    realSOP: realSOP,
                    realEOP: realEOP,
                    annualVol: annualVol,
                    OnlyBDMaterials: OnlyBDMaterials
                },
                success: function (response) {
                    var container = document.getElementById("capacityTableContainer");
                    container.innerHTML = ""; // Limpiar contenedor
                    if (response.success) {
                        // 1. Actualizamos el input status_dm con el valor calculado en el servidor
                        if (OnlyBDMaterials == false) {
                            $("#status_dm").val(response.status_dm);
                        }
                        // 2. Convertir la data (array de objetos) a una matriz para Handsontable
                        var arrayData = convertToHandsontableMatrix(response.data);
                        // arrayData.rows es una matriz donde:
                        //   columna 0: LineId (oculta)
                        //   columna 1: Line (nombre)
                        //   columnas siguientes: valores de los FY

                        // 3. Inicializar Handsontable
                        new Handsontable(container, {
                            data: arrayData.rows,
                            readOnly: true,
                            colHeaders: arrayData.headers,
                            rowHeaders: true,
                            // Ocultamos la primera columna (LineId)
                            hiddenColumns: {
                                columns: [0],
                            },
                            // Hook para modificar los encabezados de columna.
                            // Si el encabezado (por ejemplo, "FY 22/23") se encuentra en response.highlightedFY, se le aplica fondo dorado.
                            afterGetColHeader: function (col, TH) {
                                // Las columnas FY comienzan en el índice 2 (0: LineId, 1: Line)
                                if (col >= 2) {
                                    var headerText = this.getColHeader(col);
                                    if (response.highlightedFY.indexOf(headerText) !== -1) {
                                        TH.style.backgroundColor = "#FFD700"; // Dorado
                                    } else {
                                        TH.style.backgroundColor = "#009ff5"; // Valor por defecto
                                        TH.style.color = "#ffffff";           // Texto en blanco
                                    }
                                } else {
                                    TH.style.backgroundColor = "#009ff5"; // Valor por defecto
                                    TH.style.color = "#ffffff";           // Texto en blanco
                                }
                            },
                            // Configuración de las celdas
                            cells: function (row, col, prop) {
                                var cellProperties = {};
                                cellProperties.readOnly = true;

                                cellProperties.renderer = function (instance, td, row, col, prop, value, cellProperties) {
                                    // Render base de texto
                                    Handsontable.renderers.TextRenderer.apply(this, arguments);

                                    // Obtenemos los datos de la fila (en formato array)
                                    var rowData = instance.getSourceDataAtRow(row);
                                    // La primera columna (índice 0) es el LineId (oculto)
                                    var isSelectedLine = (rowData[0] == productionLineId);

                                    // Para la columna 1 (nombre de la línea), si es la línea consultada se resalta
                                    if (col === 1) {
                                        if (isSelectedLine) {
                                            td.style.backgroundColor = "#c1fcac"; // Verde claro para la fila seleccionada
                                        }
                                    } else {
                                        // Para las demás columnas, se asume que contienen valores numéricos (decimales)
                                        if (typeof value === "number") {
                                            var percentage = value * 100;
                                            td.innerHTML = percentage.toFixed(2) + "%";

                                            // Aplicar colores según el valor (sin importar la fila seleccionada)
                                            if (percentage < 95) {
                                                if (isSelectedLine)
                                                    td.style.backgroundColor = "#c1fcac";  // Menor a 95%
                                            } else if (percentage < 98) {
                                                td.style.backgroundColor = "#ffd53b"; // Entre 95% y 98%
                                            } else {
                                                td.style.backgroundColor = "#ff7c4f";    // 98% o mayor
                                            }
                                            // Si además es la fila consultada, se puede optar por fusionar el estilo;
                                            // por ejemplo, si quieres que tenga un tinte extra, podrías modificar el color.
                                            // Aquí se deja el color calculado.
                                        } else {
                                            td.innerHTML = value;
                                        }
                                    }
                                    return td;
                                };

                                return cellProperties;
                            },
                            licenseKey: 'non-commercial-and-evaluation'
                        });
                    } else {
                        $(container).html("<p style='color:red;'>" + response.message + "</p>");
                    }
                },
                error: function () {
                    $("#capacityTableContainer").html("<p style='color:red;'>Error al cargar datos de capacidad.</p>");
                }
            });
         }

    // Función para convertir la respuesta en un formato tabular para Handsontable.
    function convertToHandsontableMatrix(dataArray) {
        // 1) Recopilar todas las claves únicas de todos los objetos
        let allKeys = new Set();
        dataArray.forEach(obj => {
            Object.keys(obj).forEach(k => allKeys.add(k));
        });
        let keysArray = Array.from(allKeys);

        // 2) Definir el orden deseado:
        //    a) "LineId" en primer lugar, si existe.
        //    b) "Line" en segundo lugar, si existe.
        //    c) Las claves que comiencen con "FY" (ordenadas alfabéticamente).
        //    d) Cualquier otra clave (opcional, en orden ascendente).
        const lineIdKey = keysArray.includes("LineId") ? ["LineId"] : [];
        const lineKey = keysArray.includes("Line") ? ["Line"] : [];
        const fyKeys = keysArray.filter(k => k.startsWith("FY"));
        fyKeys.sort(); // Ordena las claves de FY alfabéticamente.
        const remainingKeys = keysArray.filter(k => k !== "LineId" && k !== "Line" && !k.startsWith("FY"));
        remainingKeys.sort(); // Opcional.

        // 3) Construir el arreglo final de claves en el orden deseado.
        let sortedKeys = [].concat(lineIdKey, lineKey, fyKeys, remainingKeys);

        // 4) Construir la cabecera (headers) y las filas (rows)
        let headers = sortedKeys;
        let rows = dataArray.map(obj => {
            return sortedKeys.map(k => obj[k] !== undefined ? obj[k] : "");
        });

        return { headers, rows };
    }

    // Construye fila para la tabla
    function buildRowHtml(materialData, rowIndex) {
        let tdVehicle = `<td nowrap>${materialData["Vehicle"]}</td>`;
        let tdVehicleVersion = `<td nowrap>${materialData["Vehicle_version"]}</td>`;
        let tdSOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))"]}</td>`;
        let tdEOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))"]}</td>`;
        let tdRealSOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"]}</td>`;
        let tdRealEOP = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"]}</td>`;
        let tdShipTo = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))"]}</td>`;
        let tdPartName = `<td nowrap>${materialData["Part_Name"]}</td>`;
        let tdPartNumber = `<td nowrap>${materialData["Part_Number"]}</td>`;
        let tdQuality = `<td nowrap>${materialData["Quality"]}</td>`;
        let tdProgramSP = `<td nowrap>${materialData["Program_SP"]}</td>`;
        let tdMaxProduction = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))"]}</td>`;
        let tdAnnualVolume = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))"]}</td>`;
        let tdVolumePerYear = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))"]}</td>`;

        // Para ID_Route, buscamos el texto en el combo:
        let routeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))"];
        let routeText = $("#ID_Route option[value='" + routeId + "']").text() || routeId;  // Si no se encuentra, muestra el id
        let tdIDRoute = `<td nowrap>${routeText}</td>`;

        //tensile
        let tdTensileStrenght = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))"]}</td>`;

        // Para ID_Material_type
        let materialTypeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))"];
        let materialTypeText = $("#ID_Material_type option[value='" + materialTypeId + "']").text() || materialTypeId;  // Si no se encuentra, muestra el id
        let tdMaterialType = `<td nowrap>${materialTypeText}</td>`;

        //thickness, width, pitch
        let tdThickness = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))"]}</td>`;
        let tdWidth = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))"]}</td>`;
        let tdPitch = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))"]}</td>`;
        let tdTheoricalGrossWeight = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))"]}</td>`;
        let tdGrossWeight = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"]}</td>`;

        // Para ID_Shape
        let shapeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))"];
        let shapeText = $("#ID_Shape option[value='" + shapeId + "']").text() || shapeId;  // Si no se encuentra, muestra el id
        let tdShape = `<td nowrap>${shapeText}</td>`;

        let tdAngleA = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]}</td>`;
        let tdAngleB = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]}</td>`;
        let tdBlanksPerStroke = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))"]}</td>`;
        let tdPartsPerVehicle = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))"]}</td>`;

        // Para ID_Real_Blanking_Line
        let realLineId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))"];
        let realLineText = $("#ID_Real_Blanking_Line option[value='" + realLineId + "']").text() || realLineId;  // Si no se encuentra, muestra el id
        let tdRealLine = `<td nowrap>${realLineText}</td>`;

        let tdTheoricalStrokes = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))"]}</td>`;
        let tdRealStrokes = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))"]}</td>`;
        let tdIdealCycleTimePerTool = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))"]}</td>`;
        let tdOEE = `<td nowrap>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))"]}</td>`;
        let tdStatusDM = `<td nowrap>${materialData["status_dm"]}</td>`;


        let hiddenInputs = "";
        for (let col of columnDefs) {
            let inputValue;

            if (col.type === "check") {
                // Para checkbox siempre usamos el verdadero "true" o "false"
                inputValue = materialData[col.key] === "true" ? "true" : "false";
            }
            else {
                let $input = $(col.selector);
                if ($input.attr("type") === "hidden") {
                    // Hidden: tomamos siempre materialData
                    inputValue = materialData[col.key];
                } else {
                    // Visible → su valor, Oculto → vacío
                    inputValue = $input.is(":visible") ? materialData[col.key] : "";
                }
            }

            hiddenInputs +=
                `<input type="hidden" name="materials[${rowIndex}].${col.key}" value="${inputValue}" />`;
        }


        // Agregar bandera para identificar que este material es el que tendrá el archivo.
        // Si materialData["IsFile"] está definido, úsalo; en caso contrario, asigna "false".
        hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].IsFile" value="${materialData["IsFile"] || "false"}" />`;

        console.log(hiddenInputs)


        let tdActions = `
                            <td nowrap>
                                <button type="button" class="btn btn-warning btn-xs edit-row">Edit</button>
                                <button type="button" class="btn btn-danger btn-xs remove-row">Remove</button>
                                ${hiddenInputs}
                            </td nowrap>`;

        let rowHtml = `
                            <tr data-index="${rowIndex}">
                                ${tdActions}
                                ${tdVehicle}
                                ${tdVehicleVersion}
                                ${tdSOP}
                                ${tdEOP}
                                ${tdRealSOP}
                                ${tdRealEOP}
                                ${tdShipTo}
                                ${tdPartName}
                                ${tdPartNumber}
                                ${tdQuality}
                                ${tdProgramSP}
                                ${tdMaxProduction}
                                ${tdAnnualVolume}
                                ${tdVolumePerYear}
                                ${tdIDRoute}
                                ${tdTensileStrenght}
                                ${tdMaterialType}
                                ${tdThickness}
                                ${tdWidth}
                                ${tdPitch}
                                ${tdBlanksPerStroke}
                                ${tdPartsPerVehicle}
                                ${tdTheoricalGrossWeight}
                                ${tdGrossWeight}
                                ${tdShape}
                                ${tdAngleA}
                                ${tdAngleB}
                                ${tdRealLine}
                                ${tdTheoricalStrokes}
                                ${tdRealStrokes}
                                ${tdIdealCycleTimePerTool}
                                ${tdOEE}
                                ${tdStatusDM}
                            </tr>`;

        return rowHtml;
    }

    function IniciaValidacionTiempoReal() {
        // Validación en tiempo real para el input de Vehicle
        $("#Vehicle").on("input", function () {
            validateMaterial("Vehicle");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#vehicleVersion").on('input', function () {
            validateMaterial("vehicleVersion");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#partName").on('input', function () {
            validateMaterial("partName");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#partNumber").on('input', function () {
            validateMaterial("partNumber");
        });

        // Validación en tiempo real para el input de Vehicle_version
        $("#quality").on('input', function () {
            validateMaterial("quality");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").on('input', function () {
            validateMaterial("Real_SOP");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").on('input', function () {
            validateMaterial("Real_EOP");
        });
        // Validación en tiempo real para el input de Ship_To
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").on('input', function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))");
        });

        // Validación en tiempo real para el input de ID Route Dropdown
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))");
        });


        // Redondea a tres decimales después de perder el foco
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))," +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"
            ).on("blur", function () {
                redondearValor(this, 3);
            });


        // Validación en tiempo real para el input de ID_Material_type Dropdown
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))");
        });

        //packaging standard
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))");
        });

        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
        });

        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        });
        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
        });
        var pitchTimeout;
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").on("input", function () {
            clearTimeout(pitchTimeout);
            pitchTimeout = setTimeout(function () {
                validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");
            }, 600);
        });
        //validacion en tiempo real
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");
            shapeVisibility();
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))");
        });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))");
        });

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))");
        });
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))").on("input", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))");
        });
        // Validación en tiempo real para el input de SpecialRequirement
         $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))").on('keyup input', function () {
             validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))");
         });
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))").on('keyup input', function () {
             validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))");
         });

        // Validación en tiempo real para el input de ID_Real_Blanking_Line Dropdown
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").on("change", function () {
            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
        });
        //validacion de cadFile
        $("#archivo").on("change", function () {
            validateMaterial("archivo");
            if (this.files.length > 0) {
                const fileName = this.files[0].name;
                $(this).attr("title", fileName); // Aparece como tooltip
            }
        });
        //*** otros metodos y eventos ***

        //Calcula el valor de Theorical gross
        const debouncedUpdateGross = debounce(updateTheoreticalGrossWeight, 300);

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))")
            .on("change keyup", debouncedUpdateGross);

        //solo se ejecuta cuando hay un cambio en linea teorica
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").on("change", function () {
            var newValue = $(this).val();
            if (newValue !== previousTheoreticalLine) {

                var realProductionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

                //si cambio el valor de la linea teorica y no hay Linea real
                if (realProductionLineId == "") {
                    //actualiza la capacidad
                    debouncedUpdateCapacityGraphs;
                }
                // Actualizamos la variable previousValue
                previousTheoreticalLine = newValue;
            }
        });
        //llama al metododo wrapper de graficas
        // Attach: para los select2 (cambia de valor directamente)
        $("#ID_Real_Blanking_Line").on("change", debouncedUpdateCapacityGraphs);
        $("#Vehicle").on("change", debouncedUpdateCapacityGraphs);

        // Para los inputs en los que el usuario debe dejar de teclear (se usa debounce de 1 segundo)
        $("#Parts_Per_Vehicle, #Ideal_Cycle_Time_Per_Tool, #Blanks_Per_Stroke, #OEE, #Real_SOP, #Real_EOP, #Annual_Volume")
            .on("input", debounce(debouncedUpdateCapacityGraphs, 1000));

        // Para los campos readonly que se actualizan mediante código, si se dispara manualmente el 'change'
        $("#Real_Strokes, #Theoretical_Strokes").on("change", debouncedUpdateCapacityGraphs);
    }

    function validateMaterial(fieldId) {
        console.log("Validando..." + fieldId)

        // Si no se especifica un campo, valida todos
        if (!fieldId) {
            let validVehicleVersion = validateVehicleVersion();
            let validPartName = validatePartName();
            let validPartNumber = validatePartNumber();
            let validQuality = validateQuality();
            let validVehicle = validateVehicle();
            let validRealSOP = validateRealSOP();
            let validRealEOP = validateRealEOP();
            let validShipTo = validateShipTo();
            let validRoute = validateRoute();
            let validTensile = validateTensileStrength();
            let validMaterialType = validateMaterialType();
            let validThickness = validateThickness();
            let validWidth = validateWidth();
            let validPitch = validatePitch();
            let validGrossWeight = validateGrossWeight();
            let validAnnualVolume = validateAnnualVolume();
            let validVolumePerYear = validateVolumePerYear();
            let validShape = validateShape();
            let validAngleA = validateAngleA();
            let validAngleB = validateAngleB();
            let validBlanksPerStroke = validateBlanksPerStroke();
            let validPartsPerVehicle = validatePartsPerVehicle();
            let validRealLine = validateRealLine();
            let validIdealCycleTimePerTool = validateIdealCycleTimePerTool();
            let validOEE = validateOEE();
            let validThicknessTolNegative = validateThicknessToleranceNegative();
            let validThicknessTolPositive = validateThicknessTolerancePositive();
            let validWidthTolNegative = validateWidthToleranceNegative();
            let validWidthTolPositive = validateWidthTolerancePositive();
            let validPitchTolNegative = validatePitchToleranceNegative();
            let validPitchTolPositive = validatePitchTolerancePositive();
            let validAngleATolNegative = validateAngleAToleranceNegative();
            let validAngleATolPositive = validateAngleATolerancePositive();
            let validAngleBTolNegative = validateAngleBToleranceNegative();
            let validAngleBTolPositive = validateAngleBTolerancePositive();
            let validWeightOfFinalMults = validateWeightOfFinalMults();
            let validMultipliers = validateMultipliers();
            let validMajorBase = validateMajorBase();
            let validMajorBaseToleranceNegative = validateMajorBaseToleranceNegative();
            let validMajorBaseTolerancePositive = validateMajorBaseTolerancePositive();
            let validMinorBase = validateMinorBase();
            let validMinorBaseToleranceNegative = validateMinorBaseToleranceNegative();
            let validMinorBaseTolerancePositive = validateMinorBaseTolerancePositive();
            let validFlatness = validateFlatness();
            let validFlatnessToleranceNegative = validateFlatnessToleranceNegative();
            let validFlatnessTolerancePositive = validateFlatnessTolerancePositive();
            let validMasterCoilWeight = validateMasterCoilWeight();
            let validInnerCoilDiameterArrival = validateInnerCoilDiameterArrival();
            let validOuterCoilDiameterArrival = validateOuterCoilDiameterArrival();
            let validInnerCoilDiameterDelivery = validateInnerCoilDiameterDelivery();
            let validOuterCoilDiameterDelivery = validateOuterCoilDiameterDelivery();
            let validPackagingStandard = validatePackagingStandard();
            let validSpecialRequirement = validateSpecialRequirement();
            let validSpecialPackaging = validateSpecialPackaging();
            let validCADFile = validateCADFile();

            return validVehicleVersion && validPartName && validPartNumber && validQuality && validVehicle
                && validRealSOP && validRealEOP && validShipTo && validRoute && validTensile && validMaterialType
                && validThickness && validWidth && validPitch && validGrossWeight && validAnnualVolume && validVolumePerYear
                && validShape && validAngleA && validAngleB && validBlanksPerStroke && validPartsPerVehicle && validRealLine
                && validIdealCycleTimePerTool && validOEE && validThicknessTolNegative && validThicknessTolPositive
                && validWidthTolNegative && validWidthTolPositive && validPitchTolNegative && validPitchTolPositive
                && validAngleATolNegative && validAngleATolPositive && validAngleBTolNegative && validAngleBTolPositive
                && validWeightOfFinalMults && validMultipliers && validMajorBase && validMajorBaseToleranceNegative
                && validMajorBaseTolerancePositive && validMinorBase && validMinorBaseToleranceNegative && validMinorBaseTolerancePositive
                && validFlatness && validFlatnessToleranceNegative && validFlatnessTolerancePositive
                && validMasterCoilWeight && validInnerCoilDiameterArrival && validOuterCoilDiameterArrival
                && validInnerCoilDiameterDelivery && validOuterCoilDiameterDelivery && validPackagingStandard
                && validSpecialRequirement && validSpecialPackaging && validCADFile
                ;
        }

        // Validar sólo el campo indicado
        switch (fieldId) {
            case "Vehicle":
                return validateVehicle();
            case "vehicleVersion":
                return validateVehicleVersion();
            case "partName":
                return validatePartName();
            case "partNumber":
                return validatePartNumber();
            case "quality":
                return validateQuality();
            case "Real_SOP":
                return validateRealSOP();
            case "Real_EOP":
                return validateRealEOP();
            case "archivo":
                return validateCADFile();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))":
                return validateShipTo();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))":
                return validateRoute();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))":
                return validateTensileStrength();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))":
                return validateMaterialType();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))":
                return validateThickness();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))":
                return validateWidth();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))":
                return validatePitch();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))":
                return validateGrossWeight();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))":
                return validateAnnualVolume();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))":
                return validateVolumePerYear();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))":
                return validateShape();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))":
                return validateAngleA();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))":
                return validateAngleB();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))":
                return validateBlanksPerStroke();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))":
                return validatePartsPerVehicle();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))":
                return validateRealLine();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))":
                return validateIdealCycleTimePerTool();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))":
                return validateOEE();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))":
                return validateThicknessToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))":
                return validateThicknessTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))":
                return validateWidthToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))":
                return validateWidthTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))":
                return validatePitchToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))":
                return validatePitchTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))":
                return validateAngleAToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))":
                return validateAngleATolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))":
                return validateAngleBToleranceNegative();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))":
                return validateAngleBTolerancePositive();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))":
                return validateWeightOfFinalMults();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))":
                return validateMultipliers();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))":
                return validateMajorBase();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))":
                return validateMajorBaseToleranceNegative();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))":
                return validateMajorBaseTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))":
                return validateMinorBase();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))":
                return validateMinorBaseToleranceNegative();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))":
                return validateMinorBaseTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))":
                return validateFlatness();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))":
                return validateFlatnessToleranceNegative();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))":
                return validateFlatnessTolerancePositive();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))":
                return validateMasterCoilWeight();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))":
                return validateInnerCoilDiameterArrival();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))":
                return validateOuterCoilDiameterArrival();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))":
                return validateInnerCoilDiameterDelivery();
             case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))":
                return validateOuterCoilDiameterDelivery();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))":
                return validatePackagingStandard();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))":
                return validateSpecialRequirement();
            case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))":
                return validateSpecialPackaging();
            default:
                return true;
        }
    }

       function validateCADFile() {
        const input = $("#archivo");
        const errorSpan = $("#CADFileError");
        const maxSize = 10 * 1024 * 1024; // 10 MB en bytes
        const allowedExtensions = [".dwg", ".dxf", ".dwt", ".pdf", ".zip", ".rar"];

        let requiredStatus = [@((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi), @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)];

        // Resetear mensajes y estilos
        errorSpan.text("").hide();
        input.css("border", "");

        // Si el input está oculto, no se valida nada
        if (!input.is(":visible")) {
            return true;
        }

        // Si el estado del proyecto NO está entre los obligatorios, no se exige tener un archivo (es opcional)
        if (requiredStatus.indexOf(statusId) === -1) {
            // Si no se seleccionó archivo, salimos sin error
            if (!input[0].files[0]) {
                return true;
            }
        } else {
            // Si el estado es de archivo obligatorio, se exige que se seleccione uno
            if (!input[0].files[0]) {
                errorSpan.text("CAD file is required for projects with status of 75% or higher.").show();
                input.css("border", "1px solid red");
                return false;
            }
        }

        // Si se seleccionó un archivo, validar tamaño
        const file = input[0].files[0];
        if (file.size > maxSize) {
            errorSpan.text("File size must be 10MB or less.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // Validar extensión (usa mayúsculas/minúsculas mediante toLowerCase())
        const fileName = file.name.toLowerCase();
        const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
        if (!isValidExtension) {
            errorSpan.text("Only DWG, DXF, DWT, PDF, ZIP and RAR files are allowed.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateVehicle() {

        const input = $("#Vehicle");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let vehicle = $("#Vehicle").val().trim();
        $("#VehicleError").text("").hide();
        $("#Vehicle").css("border", "");

        if (!vehicle) {
            $("#VehicleError").text("Vehicle is required.").show();
            $("#Vehicle").css("border", "1px solid red");
            return false;
        }

        // Si NO es automotriz, validar longitud máxima
        if (vehicleType != 1 && vehicle.length > 120) {
            $("#VehicleError").text("Vehicle cannot exceed 120 characters.").show();
            $("#Vehicle").css("border", "1px solid red");
            return false;
        }

        return true;
    }

    function validateRoute() {

        const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let route = input.val();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").css("border", "");

        // Se asume que la opción por defecto tiene un valor vacío ("") o "Select a Route"
        if (!route || route === "Select a Route") {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route) is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").css("border", "1px solid red");
            return false;
        } else {
            return true;
        }
    }

        function validateMaterialType() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omito validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Validar selección
            if (!val || val === "Select Material Type") {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ID_Material_type) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            return true;
        }


        function validateShape() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omito validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Validar selección
            if (!val || val === "Select Shape") {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ID_Shape) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            return true;
        }


        function validatePackagingStandard() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PackagingStandard))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si readonly o disabled, omito validación
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let val = input.val();
            errorEl.text("").hide();
            input.css("border", "");

            // Si no seleccionó nada o quedó en el texto por defecto...
            if (!val || val === "Select an option") {
                if (requiredStatus.includes(status)) {
                    errorEl
                      .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().PackagingStandard) is required.")
                      .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                // opcional en otros estatus
                return true;
            }

            // Todo OK
            return true;
        }


    function validateRealLine() {
        const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
        const err = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error");

        // 0) Actualiza antes el resto de los campos, por si no alcanzan a actualizarse porque no paso la validación
        updateTheoreticalLine();
        updateRealStrokes();

        // 1) Si está readonly o disabled, no validamos
        if (input.prop("readonly") || input.prop("disabled")) {
          return true;
        }

        // 2) Si el usuario PUEDE editar ingeniería, entonces este campo es obligatorio
        if (canEditEngineering) {
          const val = input.val();
          if (!val || val === "0") {
            err.text("Real blanking line is required.").show();
            input.css("border", "1px solid red");
            return false;
          }
        }

        // 3) Si pasó la validación, ocultamos mensaje y borde rojo
        err.text("").hide();
        input.css("border", "");

        // 4) Limpiamos cualquier gráfico previo
        $("#capacityTableContainer").html("");

        return true;
      }

     function validateRealSOP() {

         const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let realSOPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").val().trim();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").css("border", "");

        if (!realSOPStr) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error").text("Real SOP is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").css("border", "1px solid red");
            return false;
        }

        // Obtener el valor de SOP_SP
        let sopSPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))").val().trim();
        let realSOPDate = parseYearMonth(realSOPStr);
        let sopSPDate = parseYearMonth(sopSPStr);

        if (realSOPDate && sopSPDate && realSOPDate < sopSPDate) {
            toastr.warning("Real SOP is before the planned SOP.");
        }

        return true;
    }

    function validateRealEOP() {
         const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let realEOPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val().trim();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").css("border", "");

        if (!realEOPStr) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error").text("Real EOP is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").css("border", "1px solid red");
            return false;
        }

        // Obtener el valor de EOP_SP
        let eopSPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))").val().trim();
        let realEOPDate = parseYearMonth(realEOPStr);
        let eopSPDate = parseYearMonth(eopSPStr);

        if (realEOPDate && eopSPDate && realEOPDate > eopSPDate) {
            toastr.warning("Real EOP is later than the planned EOP.");
        }

        return true;
    }

     function validateTensileStrength() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // Si readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // Si está vacío…
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Tensile_Strenght) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        // Advertencia de rango (no bloqueante)
        if (window.engineeringRanges) {
            let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 4);
            if (gaugeRange && (val < gaugeRange.Min_Value || val > gaugeRange.Max_Value)) {
                input.css("border", "1px solid orange");
                errorEl
                    .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                    .show();
            }
        }

        return true;
    }


    function validateThickness() {
        // 1) IDs y estatus global
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error");
        const status  = statusId;  // tu variable global

        // 2) Estatus en los que Thickness es obligatorio
        let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 3) Si readonly o disabled, salto validación completa
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 4) Lectura y limpieza inicial
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 5) Si está vacío...
        if (!raw) {
            // 5.a) Si el estatus exige que sea obligatorio → error
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Thickness) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            // 5.b) Si es opcional, permitimos vacío (no aplicamos más reglas)
            return true;
        }

        // 6) Intentamos parsear número
        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 7) Validación de no-negativo
        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 8) Aviso de rango mínimo/máximo (no bloqueante)
        if (window.engineeringRanges) {
            let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 1);
            if (gaugeRange &&
                (val < gaugeRange.Min_Value || val > gaugeRange.Max_Value)) {
                input.css("border", "1px solid orange");
                errorEl
                  .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                  .show();
            }
        }

        // 9) Todo OK
        return true;
    }


    function validateThicknessToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessToleranceNegative))Error");
        const status  = statusId;

        // 1) Define los estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 2) Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 3) Lectura y limpieza inicial
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 4) Si no escribieron nada...
        if (!raw) {
            // 4.a) Si el estatus exige que sea obligatorio → error
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ThicknessToleranceNegative) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            // 4.b) Si es opcional, permitimos vacío
            return true;
        }

        // 5) Validar que sea número
        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 6) Validar tolerancia negativa (≤ 0)
        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 7) Todo OK
        return true;
    }

    function validateThicknessTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ThicknessTolerancePositive))Error");
        const status  = statusId;

        // 1) Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 2) Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 3) Lectura y limpieza inicial
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 4) Si no escribieron nada...
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().ThicknessTolerancePositive) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // 5) Validar que sea número
        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 6) Validar tolerancia positiva (≥ 0)
        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 7) Todo OK
        return true;
    }


   function validateWidthToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().WidthToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


   function validateWidthTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WidthTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().WidthTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


     function validatePitchToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().PitchToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validatePitchTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.PitchTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";  
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().PitchTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }

       function validateAngleAToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleAToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be lower than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleATolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleATolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleBToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleBToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be lower than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleBTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().AngleBTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateWeightOfFinalMults() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.WeightOfFinalMults))Error");
        const status  = statusId;

        // 1) Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 2) Si readonly/disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 3) Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 4) Vacío → si es obligatorio, error; si no, OK
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().WeightOfFinalMults) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // 5) Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMultipliers() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Multipliers))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Multipliers) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMajorBase() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MajorBase) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


   function validateMajorBaseToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MajorBaseToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be lower than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMajorBaseTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MajorBaseTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMinorBase() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
         let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
         ];

        // Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // Vacío → si es obligatorio, error; si no, OK
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MinorBase) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
              .text(isNaN(val)
                  ? "The value must be a number."
                  : "The value must be greater than or equal to 0.")
              .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


   function validateMinorBaseToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MinorBaseToleranceNegative) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val > 0) {
            errorEl
              .text(isNaN(val)
                  ? "The value must be a number."
                  : "The value must be lower than or equal to 0.")
              .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateMinorBaseTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                  .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MinorBaseTolerancePositive) is required.")
                  .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
              .text(isNaN(val)
                  ? "The value must be a number."
                  : "The value must be greater than or equal to 0.")
              .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateFlatness() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Flatness))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Flatness) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateFlatnessToleranceNegative() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessToleranceNegative))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().FlatnessToleranceNegative) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val > 0) {
            errorEl.text("The value must be lower than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateFlatnessTolerancePositive() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.FlatnessTolerancePositive))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().FlatnessTolerancePositive) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }

     function validateMasterCoilWeight() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MasterCoilWeight))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().MasterCoilWeight) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }

        function validateInnerCoilDiameterArrival() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterArrival))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().InnerCoilDiameterArrival) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }


        function validateOuterCoilDiameterArrival() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterArrival))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().OuterCoilDiameterArrival) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateInnerCoilDiameterDelivery() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.InnerCoilDiameterDelivery))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().InnerCoilDiameterDelivery) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }

        function validateOuterCoilDiameterDelivery() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OuterCoilDiameterDelivery))Error");
            const status  = statusId;

            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().OuterCoilDiameterDelivery) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }


    function validateWidth() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Width) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (window.engineeringRanges) {
            let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 2);
            if (gaugeRange && (val < gaugeRange.Min_Value || val > gaugeRange.Max_Value)) {
                input.css("border", "1px solid orange");
                errorEl
                    .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                    .show();
            }
        }

        return true;
    }


    function validatePitch() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error");
        const status  = statusId;

         let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
         ];

        // Calcula los golpes teóricos
        updateTheoreticalStrokes();
        updateRealStrokes();

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Pitch) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val)) {
            errorEl.text("The value must be a number.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (val < 0) {
            errorEl.text("The value must be greater than or equal to 0.").show();
            input.css("border", "1px solid red");
            return false;
        }

        if (window.engineeringRanges) {
            let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 3);
            if (gaugeRange && (val < gaugeRange.Min_Value || val > gaugeRange.Max_Value)) {
                input.css("border", "1px solid orange");
                errorEl
                    .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                    .show();
            }
        }

        return true;
    }


     function validateGrossWeight() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
             @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
         ];

        // Si readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // Leer y limpiar
        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // Vacío → obligatorio solo en los estatus seleccionados
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Gross_Weight) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


     function validateAnnualVolume() {
        // 1) Actualizaciones previas
        updateBlanksPerYear();
        let diffPercentage = updateAnnualVolumeStyle();
        clearTimeout(volumeTimeout);
        volumeTimeout = setTimeout(function () {
            if (typeof diffPercentage !== "undefined") {
                showVolumeDifferenceToast(diffPercentage);
            }
        }, 900);

        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Annual_Volume) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


     function validateVolumePerYear() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error");
        const status  = statusId;

        // Estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Volume_Per_year) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleA() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Angle_A) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


    function validateAngleB() {
        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error");
        const status  = statusId;

        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let raw = input.val() ? input.val().trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Angle_B) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        return true;
    }


        function validateBlanksPerStroke() {
            // 1) Actualiza dependencias
            updateStrokesPerAuto();
            updateMinMaxReales();
            updateStrokesShift();

            // 2) Selección de elementos y estado
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error");
            const status  = statusId;

            // 3) Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // 4) Omitir validación si readonly o disabled
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            // 5) Leer y limpiar
            let raw = input.val() ? input.val().trim() : "";
            errorEl.text("").hide();
            input.css("border", "");

            // 6) Vacío → obligatorio si el estatus lo exige
            if (!raw) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Blanks_Per_Stroke) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            // 7) Validar número ≥ 0
            let val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
                errorEl
                    .text(isNaN(val)
                        ? "The value must be a number."
                        : "The value must be greater than or equal to 0.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            // 8) Todo OK
            return true;
        }


    function validatePartsPerVehicle() {
        // 1) Actualiza Strokes per Auto y Blanks per Year
        updateStrokesPerAuto();
        updateBlanksPerYear();

        const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))");
        const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error");
        const status  = statusId;

        // 2) Define los estatus que hacen el campo obligatorio
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        // 3) Si está readonly o disabled, omito validación
        if (input.prop("readonly") || input.prop("disabled")) {
            // pero igual asignamos el valor a parts_auto
            $("#parts_auto").val(input.val());
            return true;
        }

        // 4) Asigno a parts_auto sin importar si es obligatorio
        let partsValue = input.val();
        $("#parts_auto").val(partsValue);

        // 5) Leer y limpiar
        let raw = partsValue ? partsValue.trim() : "";
        errorEl.text("").hide();
        input.css("border", "");

        // 6) Si quedó vacío…
        if (!raw) {
            if (requiredStatus.includes(status)) {
                errorEl
                    .text("@Html.DisplayNameFor(m => m.CTZ_Project_Materials.First().Parts_Per_Vehicle) is required.")
                    .show();
                input.css("border", "1px solid red");
                return false;
            }
            return true;
        }

        // 7) Validar número ≥ 0
        let val = parseFloat(raw);
        if (isNaN(val) || val < 0) {
            errorEl
                .text(isNaN(val)
                    ? "The value must be a number."
                    : "The value must be greater than or equal to 0.")
                .show();
            input.css("border", "1px solid red");
            return false;
        }

        // 8) Todo OK
        return true;
    }


    // Funciones de validación individuales
     function validateVehicleVersion() {
          const input = $("#vehicleVersion");

         // Si el input tiene el atributo readonly o disabled, se omite la validación
         if (input.prop("readonly") || input.prop("disabled")) {
             return true;
         }

        let vehicleVersion = $("#vehicleVersion").val().trim();
        $("#vehicleVersionError").text("").hide();
        $("#vehicleVersion").css("border", "");
        if (!vehicleVersion) {
            $("#vehicleVersionError").text("Vehicle Version is required.").show();
            $("#vehicleVersion").css("border", "1px solid red");
            return false;
        } else if (vehicleVersion.length > 50) {
            $("#vehicleVersionError").text("Vehicle Version cannot exceed 50 characters.").show();
            $("#vehicleVersion").css("border", "1px solid red");
            return false;
        }
        return true;
    }

     function validatePartName() {
          const input = $("#partName");

         // Si el input tiene el atributo readonly o disabled, se omite la validación
         if (input.prop("readonly") || input.prop("disabled")) {
             return true;
         }

        let partName = $("#partName").val().trim();
        $("#partNameError").text("").hide();
        $("#partName").css("border", "");
        if (!partName) {
            $("#partNameError").text("Part Name is required.").show();
            $("#partName").css("border", "1px solid red");
            return false;
        } else if (partName.length > 50) {
            $("#partNameError").text("Part Name cannot exceed 50 characters.").show();
            $("#partName").css("border", "1px solid red");
            return false;
        }
        return true;
    }

    function validateShipTo() {
        const input = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let shipTo = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").val().trim();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("").hide();
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "");
        if (!shipTo) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To) is required.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "1px solid red");
            return false;
        } else if (shipTo.length > 150) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To) cannot exceed 150 characters.").show();
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "1px solid red");
            return false;
        }
        return true;
    }

        function validateSpecialPackaging() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialPackaging))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si está readonly o disabled, no validar
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            const limit = 350;
            const value = input.val().trim();

            // Limpiar mensajes anteriores
            errorEl.text("").hide();
            input.css("border", "");

            // Si es obligatorio y quedó vacío → error
            if (!value) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                // opcional en otros estatus
                return true;
            }

            // ⚠️ Validar longitud si hay contenido
            if (value.length > limit) {
                errorEl
                    .text(
                        "@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialPackaging) cannot exceed " +
                        limit +
                        " characters."
                    )
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }



        function validateSpecialRequirement() {
            const input   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))");
            const errorEl = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SpecialRequirement))Error");
            const status  = statusId;

            // Estatus que hacen el campo obligatorio
            let requiredStatus = [
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
                @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
            ];

            // Si está readonly o disabled, no validar
            if (input.prop("readonly") || input.prop("disabled")) {
                return true;
            }

            const limit = 350;
            const value = input.val().trim();

            // Limpiar mensajes anteriores
            errorEl.text("").hide();
            input.css("border", "");

            // Si es obligatorio y quedó vacío → error
            if (!value) {
                if (requiredStatus.includes(status)) {
                    errorEl
                        .text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement) is required.")
                        .show();
                    input.css("border", "1px solid red");
                    return false;
                }
                // opcional en otros estatus
                return true;
            }

            // ⚠️ Validar longitud si hay contenido
            if (value.length > limit) {
                errorEl
                    .text(
                        "@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SpecialRequirement) cannot exceed " +
                        limit +
                        " characters."
                    )
                    .show();
                input.css("border", "1px solid red");
                return false;
            }

            return true;
        }



    function validatePartNumber() {
        const input = $("#partNumber");

        // Si el input tiene el atributo readonly o disabled, se omite la validación
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        let partNumber = $("#partNumber").val().trim();
        $("#partNumberError").text("").hide();
        $("#partNumber").css("border", "");
        if (!partNumber) {
            $("#partNumberError").text("Part Number is required.").show();
            $("#partNumber").css("border", "1px solid red");
            return false;
        } else if (partNumber.length > 50) {
            $("#partNumberError").text("Part Number cannot exceed 50 characters.").show();
            $("#partNumber").css("border", "1px solid red");
            return false;
        }
        return true;
    }

    function validateQuality() {
        const input = $("#quality");
        const status = statusId;  // tu variable global

        // 1) Si readonly o disabled, omito todo
        if (input.prop("readonly") || input.prop("disabled")) {
            return true;
        }

        // 2) Defino qué estatus obligan a requerir el campo
        let requiredStatus = [
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.Quotes),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CarryOver),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.CasiCasi),
            @((int)Bitacoras.Util.CTZ_Project_Estatus_Enum.POH)
        ];

        let val = input.val() ? input.val().trim() : "";

        // 3) Siempre valido el largo máximo si escribieron algo
        if (val.length > 50) {
            $("#qualityError").text("Quality cannot exceed 50 characters.").show();
            input.css("border", "1px solid red");
            return false;
        }

        // 4) Si el estatus exige que sea obligatorio, entonces validamos que NO esté vacío
        if (requiredStatus.includes(status) && !val) {
            $("#qualityError").text("Quality is required.").show();
            input.css("border", "1px solid red");
            return false;
        }
        // 5) Si llegamos aquí, todo está OK
        $("#qualityError").text("").hide();
        input.css("border", "");
        return true;
    }

    function validateIdealCycleTimePerTool() {
        // 1) Actualizar min/max reales antes de validar
        updateMinMaxReales();

        // 2) Seleccionamos input y span de error
        const input     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))");
        const errorSpan = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error");

        // 3) Si está readonly o disabled, omitimos validación
        if (input.prop("readonly") || input.prop("disabled")) {
          return true;
        }

        // 4) Obligatorio si puede editar ingeniería
        let valueStr = input.val().trim();
        if (canEditEngineering && valueStr === "") {
          errorSpan.text("Ideal Cycle Time is required.").show();
          input.css("border", "1px solid red");
          return false;
        }

        // 5) Reiniciar mensajes y estilos
        errorSpan.text("").hide();
        input.css("border", "");

        // 6) Si vino vacío y no es obligatorio, es válido
        if (valueStr === "") {
          return true;
        }

        // 7) Convertir y validar que sea número >= 0
        let floatVal = parseFloat(valueStr);
        if (isNaN(floatVal) || floatVal < 0) {
          errorSpan.text("The value must be a number and greater than or equal to 0.").show();
          input.css("border", "1px solid red");
          return false;
        }

        return true;
      }

    function validateOEE() {
        // 1) Seleccionamos input y span de error
        const input     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))");
        const errorSpan = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error");

        // 2) Si está readonly o disabled, omitimos validación
        if (input.prop("readonly") || input.prop("disabled")) {
          return true;
        }

        // 3) Obligatorio si puede editar ingeniería
        let value = input.val().trim();
        if (canEditEngineering && value === "") {
          errorSpan.text("OEE is required.").show();
          input.css("border", "1px solid red");
          return false;
        }

        // 4) Si está vacío y no es obligatorio, es válido
        if (value === "") {
          return true;
        }

        // 5) Convertir a número y validar rango 0–100
        let num = parseFloat(value);
        if (isNaN(num)) {
          errorSpan.text("Please enter a valid number.").show();
          input.css("border", "1px solid red");
          return false;
        }
        if (num < 0 || num > 100) {
          errorSpan.text("Please enter a value between 0 and 100.").show();
          input.css("border", "1px solid red");
          return false;
        }

        // 6) Limpiar mensajes y estilos
        errorSpan.text("").hide();
        input.css("border", "");

        return true;
  }



    // Limpia el formulario
    function clearMaterialForm(columns) {
        $("#materialIndex").val("");
        $("#materialIdmaterialId").val("");
        for (let col of columns) {
            if (col.type && col.type === "dropdown") {
                $(col.selector).val("").trigger("change");
            } else {
                $(col.selector).val("");
                $(col.selector).css("background-color", "");
            }
            $(col.selector).css("border", "");
            $(col.selector + "Error").text("").hide();
        }
        //datos fuera del columns
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val("");
        $("#parts_auto").val("");

        //limpia valores
        updateStrokesPerAuto()
        updateBlanksPerYear()
        updateMinMaxReales()


        $('.btn-add-material').html('<i class="fa-solid fa-plus"></i> Add Material');

    }

        function updateTheoreticalLine() {


        // 1. Lee los valores de tus inputs
        let tensilStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").val();
        let thicknessStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").val();
        let widthStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").val();
        let pitchStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val();
        let plant = @Model.ID_Plant;
        let typ = $("#ID_Material_type option:selected").val().toUpperCase();

        // 2. Si alguno está vacío, borramos la línea teórica y salimos
        if (!tensilStr || !thicknessStr || !widthStr || !pitchStr || !typ) {
            $("#theoretical_blk_line").val("");
            //borra los limites
            window.engineeringRanges = null;
            //valida los campon involucrados
            validateTensileStrength("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
            validateThickness("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
            validateWidth("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
            validatePitch("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");

            //borra tooltips
            // Si no existen rangos, limpiar todos los tooltips
            $("#tensil-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#thickness-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#width-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#pitch-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            return;
        }

        let tensil = parseFloat(tensilStr);
        let thickness = parseFloat(thicknessStr);
        let width = parseFloat(widthStr);
        let pitch = parseFloat(pitchStr);

        // 4. Aplica la lógica condicional
        // Lógica condicional
        let lineaTeorica = ""; // p.ej. "PUEBLA-BLK1"
        if (plant === 1) {
            // PUEBLA
            if (typ == 3) { // E STEEL
                lineaTeorica = "PUEBLA-BLK3";
            } else if (typ == 4) { // UE STEEL
                if (tensil <= 600 || width <= 1680) {
                    lineaTeorica = "PUEBLA-BLK1";
                } else {
                    lineaTeorica = "PUEBLA-BLK2";
                }
            } else if (typ == 5) { // HS STEEL
                lineaTeorica = "PUEBLA-BLK2";
            }
        } else if (plant === 2) {
            // SILAO
            if (typ == 1 || typ == 2 || typ == 5) {
                // E ALU, UE ALU, HS STEEL
                lineaTeorica = "SILAO-BLK3";
            } else if (typ == 3) {
                lineaTeorica = "SILAO-BLK1";
            } else if (typ == 4) {
                lineaTeorica = "SILAO-BLK2";
            }
        } else if (plant === 4) {
            // SLP
            lineaTeorica = "SLP-BLK1";
        }

        // Asignar en el input visible
        $("#theoretical_blk_line").val(lineaTeorica);

        // Buscar el ID en lineMap
        let lineId = lineMap[lineaTeorica] || "";

        // Asignar en el input hidden
        $("#ID_Theoretical_Blanking_Line").val(lineId);
        //Dispara el evento de cambio de Linea teorica
        $("#ID_Theoretical_Blanking_Line").val(lineId).trigger("change");

        //obtiene el valor de la linea real
        var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

        //si la linea real es diferente de 0 es el valor que toma para los limites.
        if (productionLineId != "")
            lineId = productionLineId;

        // Si lineId es válido, hacemos la llamada AJAX para obtener min y max
        if (lineId) {
            $.ajax({
                url: '@Url.Action("GetEngineeringDimensions", "CTZ_Projects")',
                data: { lineId: lineId },
                type: 'GET',
                success: function (data) {
                    // data es un array con { ID_Criteria, Min_Value, Max_Value }
                    // Guardamos estos rangos en variables globales o un objeto local
                    window.engineeringRanges = data;
                    updateEngineeringTooltips(); // Actualizamos los tooltips con los límites reales

                },
                error: function (err) {
                    console.error("Error getting engineering dimensions", err);
                },
                async: false
            });
        } else {
            // si no hay lineId, limpiar
            window.engineeringRanges = null;

            $("#tensil-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#thickness-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#width-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#pitch-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
        }


        //valida los campon involucrados
        validateTensileStrength("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
        validateThickness("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
        validateWidth("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
        validatePitch("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");


    }

        // Función debounce
        function debounce(func, wait) {
            var timeout;
            return function () {
                var context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    func.apply(context, args);
                }, wait);
            };
        }

    // Re-numerar filas tras eliminación
    function renumberRows() {
        $("#materialsTable tbody tr").each(function (i, row) {
            $(row).attr("data-index", i);
            let hiddenInputs = $(row).find("input[name^='materials']");
            hiddenInputs.each(function () {
                let nameAttr = $(this).attr("name"); // p.ej. materials[3].Part_Number
                let fieldName = nameAttr.substring(nameAttr.indexOf('.') + 1);
                // fieldName => Part_Number
                $(this).attr("name", `materials[${i}].${fieldName}`);
            });
        });
    }

    function parseYearMonth(dateStr) {
        if (!dateStr) return null;
        var parts = dateStr.split("-");
        if (parts.length < 2) return null;
        return new Date(parts[0], parts[1] - 1, 1);
    }

    // Inicializar select2 y evento solo si es automotriz
    if (vehicleType == 1) {
        $("#Vehicle, #Vehicle_2, #Vehicle_3, #Vehicle_4").select2({ width: '100%' });

        $("#Vehicle, #Vehicle_2, #Vehicle_3, #Vehicle_4").on("change", function () {
            recalculateVehicleData();
        });
    }

    function recalculateVehicleData() {
        // Supongamos que tienes una función similar a getVehicleData que, para cada combo,
        // obtiene un objeto incluyendo la propiedad productionData, la cual se extrae del atributo data-productionjson.
        function getVehicleData(selector) {
            var selectedOption = $(selector).find("option:selected");
            return {
                sop: selectedOption.data("sop"),
                eop: selectedOption.data("eop"),
                program: selectedOption.data("program"),
                maxProduction: selectedOption.data("maxproduction"),
                productionJson: selectedOption.data("productionjson")
            };
        }

        var data1 = getVehicleData("#Vehicle");
        var data2 = getVehicleData("#Vehicle_2");
        var data3 = getVehicleData("#Vehicle_3");
        var data4 = getVehicleData("#Vehicle_4");

        // Solo considerar aquellos vehículos que tienen un valor seleccionado y producción definida
        var selectedVehicles = [];
        [data1, data2, data3, data4].forEach(function (d) {
            if (d && d.sop && d.productionJson) {
                try {
                    d.productionData = JSON.parse(d.productionJson);
                } catch (e) {
                    d.productionData = [];
                }
                selectedVehicles.push(d);
            }
        });

        // Calcular el SOP (mínimo) y EOP (máximo) usando data de los vehículos seleccionados (si es necesario)
        var minSOP = null, maxEOP = null;
        selectedVehicles.forEach(function (d) {
            var sopDate = new Date(d.sop);
            var eopDate = new Date(d.eop);
            console.log("SOP: " + sopDate + " EOP: " + eopDate)
            if (!minSOP || sopDate < minSOP) minSOP = sopDate;
            if (!maxEOP || eopDate > maxEOP) maxEOP = eopDate;
        });
        if (minSOP) $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))").val(moment.utc(minSOP).format("YYYY-MM"));
        if (maxEOP) $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))").val(moment.utc(maxEOP).format("YYYY-MM"));


        // Para Program_SP: Concatenar los posibles "program" de los vehículos (data1, data2, data3, data4)
        // separando por " / " (con espacio antes y después) y evitando duplicados
        var programs = [];
        [data1, data2, data3, data4].forEach(function (d) {
            if (d && d.program && programs.indexOf(d.program) === -1) {
                programs.push(d.program);
            }
        });
        var concatenatedProgram = programs.join(" / ");
        $("#programSP").val(concatenatedProgram);

        // Calcular la suma de producción por año
        var productionByYear = {};
        selectedVehicles.forEach(function (d) {
            console.log("Vehículo:", d);
            if (d.productionJson && Array.isArray(d.productionJson)) {
                d.productionJson.forEach(function (item) {
                    console.log("Item de producción:", item);
                    var year = item.Production_Year;
                    var sum = parseFloat(item.Production_Amount) || 0;
                    if (year) {
                        if (!productionByYear[year]) {
                            productionByYear[year] = 0;
                        }
                        productionByYear[year] += sum;
                    }
                });
            }
        });
        console.log("Suma de producción por año:", productionByYear);

        // Determinar el año con mayor producción acumulada
        var maxProduction = 0, maxProductionYear = null;
        for (var year in productionByYear) {
            if (productionByYear[year] > maxProduction) {
                maxProduction = productionByYear[year];
                maxProductionYear = year;
            }
        }
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val(maxProduction);
        if (maxProductionYear) {
            $("#maxProductionYearDisplay").text("Year: " + maxProductionYear);
        }
    }

     function shapeVisibility() {
        let shapeInput = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");
        let fileName = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.CADFileName))").val();
        let idFile   = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_File_CAD_Drawing))").val();
        let shapeVal = shapeInput.val();

        // Contenedores y control de TurnOver
        let turnoverContainer = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))_container");
        let turnoverInput     = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.TurnOver))");

        // Campos relacionados con los ángulos
        let camposAngulos = [
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleAToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleATolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.AngleBTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MinorBaseTolerancePositive))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBase))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseToleranceNegative))",
            "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.MajorBaseTolerancePositive))"
        ];

        // 1) Si Shape no está visible, ocultamos todo y deshabilitamos TurnOver
        if (!shapeInput.is(":visible")) {
            camposAngulos.forEach(campo => {
                $("#" + campo).prop("disabled", true).val("");
                $("#" + campo + "_container").hide();
            });
            $("#archivo").prop("disabled", true).val("");
            $("#cat_file_container, #fileActions_container").hide();

            // TurnOver también se oculta y deshabilita
            turnoverInput.prop("disabled", true).prop("checked", false);
            turnoverContainer.hide();

            return;
        }

        // 2) Ángulos sólo si Shape = "3"
        camposAngulos.forEach(campo => {
            let input     = $("#" + campo);
            let container = $("#" + campo + "_container");

            if (shapeVal === "3") {
                input.prop("disabled", false);
                container.show();
            } else {
                input.prop("disabled", true).val("");
                container.hide();
            }
        });

        // 3) Lógica de archivo sólo si Shape = "18"
        let fileUploadContainer  = $("#cat_file_container");
        let fileActionsContainer = $("#fileActions_container");

        if (shapeVal === "18") {
            if (idFile && idFile.trim()) {
                fileUploadContainer.hide();
                fileActionsContainer.show();
                $("#downloadFile")
                    .attr("href", "/CTZ_Projects/DownloadFile?fileId=" + idFile)
                    .html('<i class="fa-solid fa-download"></i> ' + fileName);
                $("#archivo").prop("disabled", true);
            } else {
                fileUploadContainer.show();
                fileActionsContainer.hide();
                if (canEditSales) { //solo quita el atributo disabled, si canEditSales
                    $("#archivo").prop("disabled", false);
                }
            }
        } else {
            fileUploadContainer.hide();
            fileActionsContainer.hide();
            $("#archivo").prop("disabled", true).val("");
        }

        // 4) TurnOver: sólo visible y habilitado cuando Shape = "18"
        if (shapeVal === "18") {
            turnoverContainer.show();
            if (canEditSales) { //solo quita el atributo disabled, si canEditSales
                turnoverInput.prop("disabled", false);
            }
        } else {
            turnoverContainer.hide();
            turnoverInput.prop("disabled", true).prop("checked", false);
        }
    }



    function updateRealStrokes() {

        var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

        // Suponiendo que tienes los valores en los campos:
        var pitch = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val());
        var rotation = 0; // 0 de momento


        if (isNaN(pitch) || isNaN(rotation) || productionLineId == "") {
            // Manejar error: se requieren ambos valores.
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").trigger("change");

            return;
        }

       $.ajax({
            url: '@Url.Action("GetTheoreticalStrokes", "CTZ_Projects")',
            type: 'GET',
            data: {
                productionLineId: productionLineId,
                pitch: pitch,
                rotation: rotation
            },
            success: function (response) {
                if (response.success) {
                    var strokes = parseFloat(response.theoreticalStrokes);
                    var formattedStrokes = (strokes % 1 === 0) ? strokes : strokes.toFixed(2);
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val(formattedStrokes);
                } else {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
                    toastr.error("Error: " + response);
                }
            },
            error: function (xhr, status, error) {
                toastr.error("Error en Ajax: " + error);
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
            },
            async: false
        }).always(function () {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").trigger("change");
        });


    }

    function updateStrokesPerAuto() {
        var partsVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val());
        var blanksVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());

        // Si alguno es inválido o la división no es posible, limpia el campo
        if (isNaN(partsVal) || isNaN(blanksVal) || blanksVal === 0) {
            $("#strokes_auto").val("");
        } else {
            var result = partsVal / blanksVal;
            $("#strokes_auto").val(result.toFixed(2));
        }
    }

    function updateMinMaxReales() {
        var blanksPerYear = parseFloat($("#blanks_per_year").val());
        var idealCycleTime = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val());
        var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());

        // Validamos que todos los valores sean números y que idealCycleTime y blanksPerStroke no sean 0
        if (isNaN(blanksPerYear) || isNaN(idealCycleTime) || isNaN(blanksPerStroke) || idealCycleTime === 0 || blanksPerStroke === 0) {
            $("#min_max_reales").val("");
        } else {
            var result = blanksPerYear / idealCycleTime / blanksPerStroke;
            $("#min_max_reales").val(result.toFixed(2));
        }

        //tambien actualiza la version de OEE
        updateMinMaxRealesOEE();
    }


    function updateBlanksPerYear() {
        var partsVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val());
        var annualVolume = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val());

        // Verificar si alguno es inválido o nulo
        if (isNaN(partsVal) || isNaN(annualVolume)) {
            $("#blanks_per_year").val("");
        } else {
            var result = partsVal * annualVolume;
            $("#blanks_per_year").val(result.toFixed(2));
        }

        //valida los campos que pudieran depender de este input
        updateMinMaxReales();
        updateStrokesShift();
    }

    function updateMinMaxRealesOEE() {
        var minMaxReales = parseFloat($("#min_max_reales").val());
        var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val());

        if (isNaN(minMaxReales) || isNaN(oee) || oee === 0) {
            $("#min_max_reales_oee").val("");
        } else {
            // Normalizamos el OEE de porcentaje a valor decimal
            var oeeDecimal = oee / 100;
            var result = minMaxReales / oeeDecimal;
            $("#min_max_reales_oee").val(result.toFixed(2));
        }

        // Actualiza los turnos reales
        updateActualShifts();
    }


    function updateActualShifts() {
        var minMaxRealesOEE = parseFloat($("#min_max_reales_oee").val());

        // Verifica si el valor es válido (7.5 y 60 son constantes, por lo que no se espera división por 0)
        if (isNaN(minMaxRealesOEE)) {
            $("#actual_shifts").val("");
        } else {
            var result = minMaxRealesOEE / 7.5 / 60;
            $("#actual_shifts").val(result.toFixed(2));
        }

        updateStrokesShift();
    }

    function updateStrokesShift() {
        var blanksPerYear = parseFloat($("#blanks_per_year").val());
        var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());
        var actualShifts = parseFloat($("#actual_shifts").val());

        if (isNaN(blanksPerYear) || isNaN(blanksPerStroke) || isNaN(actualShifts) || blanksPerStroke === 0 || actualShifts === 0) {
            $("#strokes_shift").val("");
        } else {
            var result = blanksPerYear / blanksPerStroke / actualShifts;
            $("#strokes_shift").val(result.toFixed(0));
        }
    }


        function updateTheoreticalStrokes() {

        var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val();

        // Suponiendo que tienes los valores en los campos:
        var pitch = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val());
        ////var rotation = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val()); // valor de giro
        var rotation = 0; // 0 de momento


        if (isNaN(pitch) || isNaN(rotation) || productionLineId == "") {
            // Manejar error: se requieren ambos valores.
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
            return;
        }

        $.ajax({
            url: '@Url.Action("GetTheoreticalStrokes", "CTZ_Projects")',
            type: 'GET',
            data: { productionLineId: productionLineId, pitch: pitch, rotation: rotation },
            success: function (response) {
                if (response.success) {
                    // Actualiza el campo de Theoretical_Strokes con el valor obtenido
                    var strokes = parseFloat(response.theoreticalStrokes);
                    var formattedStrokes = (strokes % 1 === 0) ? strokes : strokes.toFixed(2);
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val(formattedStrokes);
                } else {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
                    toastr.error("Error: " + response);
                }
            },
            error: function (xhr, status, error) {
                toastr.error("Error en Ajax: " + response.message);
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
            },
            async: false
        });
    }

    function updateTheoreticalGrossWeight() {

        // 1. Obtener los valores de los inputs
        let thicknessStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").val().trim();
        let widthStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").val().trim();
        let pitchStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val().trim();
        let blanksStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val().trim();
        let materialTypeStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)) option:selected").text().trim().toUpperCase();


        // Validar que los campos numéricos contengan valores válidos
        if (!thicknessStr || !widthStr || !pitchStr || !blanksStr || $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)) option:selected").val() == "") {
            // Si falta alguno, se puede limpiar o dejar el campo sin actualizar
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val("");

            return;
        }

        let thickness = parseFloat(thicknessStr);
        let width = parseFloat(widthStr);
        let pitch = parseFloat(pitchStr);
        let blanksPerStroke = parseFloat(blanksStr);

        // 2. Determinar la densidad según el tipo de material
        let density = 0;
        if (materialTypeStr.indexOf("STEEL") > -1) {
            density = 7.85;
        } else if (materialTypeStr.indexOf("ALU") > -1) {
            density = 2.7;
        } else {
            // Si no se detecta ninguno de los casos, no se puede calcular
            //  $("#TheoreticalGrossWeight").val("Type not valid");
            return;
        }

        // 3. Realizar el cálculo
        let weight = (thickness * width * pitch * density) / 1000000 / blanksPerStroke;

        // 4. Actualizar el campo de Theoretical Gross Weight (formatear si se desea)
        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val(weight.toFixed(3));
    }


    // Función para actualizar los tooltips de los campos de ingeniería
    function updateEngineeringTooltips() {
        if (window.engineeringRanges) {
            // Actualizar tooltip para Tensile Strength (ID_Criteria = 4)
            let tensileRange = window.engineeringRanges.find(r => r.ID_Criteria === 4);
            if (tensileRange) {
                $("#tensil-limit-id").attr("title", `Allowed range: ${tensileRange.Min_Value} - ${tensileRange.Max_Value}`).tooltip('dispose').tooltip();
            }
            // Actualizar tooltip para Thickness (ID_Criteria = 1)
            let thicknessRange = window.engineeringRanges.find(r => r.ID_Criteria === 1);
            if (thicknessRange) {
                $("#thickness-limit-id").attr("title", `Allowed range: ${thicknessRange.Min_Value} - ${thicknessRange.Max_Value}`).tooltip('dispose').tooltip();
            }
            // Actualizar tooltip para Width (ID_Criteria = 2)
            let widthRange = window.engineeringRanges.find(r => r.ID_Criteria === 2);
            if (widthRange) {
                $("#width-limit-id").attr("title", `Allowed range: ${widthRange.Min_Value} - ${widthRange.Max_Value}`).tooltip('dispose').tooltip();
            }
            // Actualizar tooltip para Pitch (ID_Criteria = 3)
            let pitchRange = window.engineeringRanges.find(r => r.ID_Criteria === 3);
            if (pitchRange) {
                $("#pitch-limit-id").attr("title", `Allowed range: ${pitchRange.Min_Value} - ${pitchRange.Max_Value}`).tooltip('dispose').tooltip();
            }
        } else {
            // Si no existen rangos, limpiar todos los tooltips
            //borra tooltips
            // Si no existen rangos, limpiar todos los tooltips
            $("#tensil-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#thickness-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#width-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
            $("#pitch-limit-id")
                .attr("title", "Limits not available").tooltip('dispose').tooltip();
        }
    }

    function updateVehicleVisibility() {
        // Si Vehicle1 no tiene valor, ocultar Vehicle2, 3 y 4 y limpiar sus valores.
        if (!$("#Vehicle").val()) {
            $("#Vehicle_2").closest(".col-md-6").hide();
            $("#Vehicle_2").val(null).trigger("change.select2");
            $("#Vehicle_3").closest(".col-md-6").hide();
            $("#Vehicle_3").val(null).trigger("change.select2");
            $("#Vehicle_4").closest(".col-md-6").hide();
            $("#Vehicle_4").val(null).trigger("change.select2");
        } else {
            // Si Vehicle1 tiene valor, mostrar Vehicle2.
            $("#Vehicle_2").closest(".col-md-6").show();
            // Si Vehicle2 no tiene valor, ocultar Vehicle3 y Vehicle4 y limpiar sus valores.
            if (!$("#Vehicle_2").val()) {
                $("#Vehicle_3").closest(".col-md-6").hide();
                $("#Vehicle_3").val(null).trigger("change.select2");;
                $("#Vehicle_4").closest(".col-md-6").hide();
                $("#Vehicle_4").val(null).trigger("change.select2");;
            } else {
                // Si Vehicle2 tiene valor, mostrar Vehicle3.
                $("#Vehicle_3").closest(".col-md-6").show();
                // Si Vehicle3 no tiene valor, ocultar Vehicle4 y limpiar su valor.
                if (!$("#Vehicle_3").val()) {
                    $("#Vehicle_4").closest(".col-md-6").hide();
                    $("#Vehicle_4").val(null).trigger("change.select2");;
                } else {
                    // Si Vehicle3 tiene valor, mostrar Vehicle4.
                    $("#Vehicle_4").closest(".col-md-6").show();
                }
            }
        }
    }

    // Función que actualiza el fondo del input Annual_Volume según el porcentaje de diferencia
    function updateAnnualVolumeStyle() {
        // Obtenemos los valores
        let annualVolumeStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val().trim();
        let maxProductionStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val().trim();

        // Si alguno no tiene valor, salimos
        if (!annualVolumeStr || !maxProductionStr) {
            // Podrías resetear el fondo a blanco
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", "");
            return;
        }

        // Convertir a número
        let annualVolume = parseFloat(annualVolumeStr);
        let maxProduction = parseFloat(maxProductionStr);

        // Evitar división por cero
        if (maxProduction === 0) {
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", "");
            return;
        }

        // Calcular el ratio
        let ratio = annualVolume / maxProduction;
        // Calcular diferencia porcentual respecto a maxProduction
        let diffPercentage = ((annualVolume - maxProduction) / maxProduction) * 100;

        // Actualizar el fondo según el rango:
        // Verde: ratio entre 0.85 y 1.15
        // Amarillo: ratio entre 0.70 y 0.85 o entre 1.15 y 1.30
        // Rojo: cualquier otro caso
        let newBgColor = "";
        if (ratio >= 0.85 && ratio <= 1.15) {
            newBgColor = "lightgreen";
        } else if ((ratio >= 0.70 && ratio < 0.85) || (ratio > 1.15 && ratio <= 1.30)) {
            newBgColor = "lightyellow";
        } else {
            newBgColor = "lightcoral";
        }

        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", newBgColor);

        // Devuelve la diferencia porcentual para usar en el toast
        return diffPercentage;
    }

    // Función para mostrar el toast con la diferencia porcentual
    function showVolumeDifferenceToast(diffPercentage) {
        // Redondear a dos decimales
        let diffRounded = diffPercentage.toFixed(2);
        // Generar el mensaje: puede ser "x% above" o "x% below"
        let message = "";
        if (diffPercentage > 0) {
            message = `${diffRounded}% above Max Production`;
        } else if (diffPercentage < 0) {
            message = `${Math.abs(diffRounded)}% below Max Production`;
        } else {
            message = "No difference with Max Production";
        }

        // Mostrar el toast
        toastr.info(message);
    }

    function redondearValor(elemento, decimales) {
        let value = parseFloat($(elemento).val());
        if (!isNaN(value)) {
            let factor = Math.pow(10, decimales);
            let rounded = Math.round(value * factor) / factor;
            $(elemento).val(rounded);
        }
    }

});

    </script>
}

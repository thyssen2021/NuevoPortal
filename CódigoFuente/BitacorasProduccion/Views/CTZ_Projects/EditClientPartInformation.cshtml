@model Portal_2_0.Models.CTZ_Projects

@{
    ViewBag.Title = "Edit Client & Part Information";
    ViewBag.PrimerNivel = "quote";
    ViewBag.SegundoNivel = "edit_client_part";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    //llama al metodo para pruebas
    Dictionary<int, Dictionary<int, double>> capacityDictionary = Model.GetCapacityPlusQuote();

}

@section estilos {
    <!-- SweetAlert2 -->
    <link href="@Url.Content("~/Content/vendors/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css")" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet" />
    <!-- DatePicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
    <style>
        .toast {
            opacity: 0.95 !important; /* Ajusta el valor según lo que necesites */
        }

        /* Contenedor que separa claramente la sección de inputs */
        .material-form {
            border: 2px solid #009ff5; /* Borde con color corporativo */
            border-radius: 6px;
            padding: 15px;
            background-color: #f9fcff; /* Color de fondo claro para distinguir */
            margin-bottom: 30px; /* Separación de la tabla */
        }

        .material-form-title {
            color: #009ff5;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .material-form label {
            font-weight: bold;
            color: #009ff5; /* Resaltamos el texto del label con color corporativo */
        }

        .material-form .form-control {
            margin-bottom: 10px;
        }

        /* Tabla con color corporativo */
        #materialsTable {
            border: 1px solid #009ff5;
            width: 100%;
            border-collapse: collapse;
        }

            #materialsTable thead {
                background-color: #009ff5;
                color: #ffffff; /* Texto blanco en cabecera */
            }

            #materialsTable th,
            #materialsTable td {
                text-align: center;
                vertical-align: middle;
                border: 1px solid #009ff5;
                padding: 8px;
            }

        /* Botón pequeño */
        .btn-xs {
            padding: 5px 10px;
            font-size: 12px;
        }

        input::placeholder {
            color: #bebbbb !important;
        }

        .btn-default {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            color: #555;
            border-radius: 3px;
            padding: 8px 15px;
        }

        /* Estilos personalizados para el tooltip */
        .tooltip-inner {
            background-color: #009ff5;
            color: #ffffff;
            font-weight: 500;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .tooltip.bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #009ff5;
        }

        .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #009ff5;
        }

        .arrow::before {
            border-left-color: #009ff5 !important;
            border-right-color: #009ff5 !important;
        }

        bs-tooltip-right .arrow::before {
        }
    </style>
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <!-- Cuadro informativo con los datos del proyecto -->
                        @{
                            // Si quieres ocultar el botón "Edit General Data":
                            ViewBag.ShowEditButton = false;
                        }
                        @Html.Partial("_CTZ_ProjectInfo", Model)

                        <!-- Form principal -->
                        @using (Html.BeginForm("EditClientPartInformation", "CTZ_Projects", FormMethod.Post))
                        {
                            @Html.AntiForgeryToken()

                            <!-- Hidden para el ID del proyecto -->
                            @Html.HiddenFor(model => model.ID_Project)

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Part Number Information</div>

                                <input type="hidden" id="materialIndex" value="" />

                                <div class="row">

                                    @if (Model.ID_VehicleType.HasValue && Model.ID_VehicleType.Value == 1)
                                    {
                                        <!-- Campo para Vehicle principal -->
                                        <div class="col-md-6">
                                            <label>
                                                Vehicle
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Select the vehicle from the list."></i>
                                            </label>
                                            <select id="Vehicle" class="form-control select2">
                                                <option value="">Select a Vehicle</option>
                                                @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                {
                                                    <option value="@item.Value"
                                                            data-sop="@item.SOP"
                                                            data-eop="@item.EOP"
                                                            data-program="@item.Program"
                                                            data-maxproduction="@item.MaxProduction"
                                                            data-productionjson="@item.ProductionDataJson">
                                                        @item.Text
                                                    </option>
                                                }
                                            </select>
                                            <span id="VehicleError" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <!-- Campo para Vehicle_2 -->
                                        <div class="col-md-6">
                                            <label>Vehicle 2</label>
                                            <select id="Vehicle_2" class="form-control select2">
                                                <option value="">Select a Vehicle</option>
                                                @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                {
                                                    <option value="@item.Value"
                                                            data-sop="@item.SOP"
                                                            data-eop="@item.EOP"
                                                            data-program="@item.Program"
                                                            data-maxproduction="@item.MaxProduction"
                                                            data-productionjson="@item.ProductionDataJson">
                                                        @item.Text
                                                    </option>
                                                }
                                            </select>
                                            <span id="Vehicle_2Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <!-- Campo para Vehicle_3 -->
                                        <div class="col-md-6">
                                            <label>Vehicle 3</label>
                                            <select id="Vehicle_3" class="form-control select2">
                                                <option value="">Select a Vehicle</option>
                                                @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                {
                                                    <option value="@item.Value"
                                                            data-sop="@item.SOP"
                                                            data-eop="@item.EOP"
                                                            data-program="@item.Program"
                                                            data-maxproduction="@item.MaxProduction"
                                                            data-productionjson="@item.ProductionDataJson">
                                                        @item.Text
                                                    </option>
                                                }
                                            </select>
                                            <span id="Vehicle_3Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>

                                        <!-- Campo para Vehicle_4 -->
                                        <div class="col-md-6">
                                            <label>Vehicle 4</label>
                                            <select id="Vehicle_4" class="form-control select2">
                                                <option value="">Select a Vehicle</option>
                                                @foreach (var item in (IEnumerable<Portal_2_0.Controllers.VehicleItem>)ViewBag.VehicleList)
                                                {
                                                    <option value="@item.Value"
                                                            data-sop="@item.SOP"
                                                            data-eop="@item.EOP"
                                                            data-program="@item.Program"
                                                            data-maxproduction="@item.MaxProduction"
                                                            data-productionjson="@item.ProductionDataJson">
                                                        @item.Text
                                                    </option>
                                                }
                                            </select>
                                            <span id="Vehicle_4Error" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    }
                                    else
                                    { <div class="col-md-8">
                                            <label>
                                                Vehicle
                                                <i class="fa fa-question-circle"
                                                   data-toggle="tooltip"
                                                   data-placement="right"
                                                   data-html="true"
                                                   title="Enter the vehicle name."></i>
                                            </label>
                                            <!-- Si no es automotriz, el campo "Vehicle" puede ser un input de texto -->
                                            <input type="text" id="Vehicle" name="Vehicle" class="form-control" placeholder="Enter Vehicle" maxlength="120" />
                                            <span id="VehicleError" class="error-message" style="color: red; display: none;"></span>
                                        </div>
                                    }

                                </div>
                                <div class="row"><br /></div>
                                <div class="row">
                                    <div class="col-md-1">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SOP_SP)
                                            <i class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="This field shows the planned Start Of Production (SOP) in yyyy-MM format."></i>
                                        </label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))" class="form-control" placeholder="yyyy-MM" readonly />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-1">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().EOP_SP)
                                            <i class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="This field shows the planned End Of Production (EOP) in yyyy-MM format."></i>
                                        </label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))" class="form-control" placeholder="yyyy-MM" readonly />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-1">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_SOP)
                                            <i class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="Enter the actual Start Of Production date in yyyy-MM format."></i>
                                        </label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))" class="form-control" placeholder="yyyy-MM" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-1">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_EOP)
                                            <i class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="Enter the actual End Of Production date in yyyy-MM format."></i>
                                        </label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))" class="form-control" placeholder="yyyy-MM" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To)</label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))" class="form-control" placeholder="Ship To" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Vehicle Version</label>
                                        <input type="text" id="vehicleVersion" class="form-control" placeholder="Vehicle Version" />
                                        <span id="vehicleVersionError" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Part Name</label>
                                        <input type="text" id="partName" class="form-control" placeholder="Part Name" />
                                        <span id="partNameError" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Part Number</label>
                                        <input type="text" id="partNumber" class="form-control" placeholder="Part Number" />
                                        <span id="partNumberError" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Quality</label>
                                        @* Usamos DropDownListFor, asignando una lista vacía (ya que los datos se cargarán via JS) o generamos el select manualmente *@
                                        <select id="quality" name="quality" class="form-control select2-quality"></select>
                                        <span id="qualityError" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Program SP</label>
                                        <input type="text" id="programSP" class="form-control" placeholder="Program SP" readonly />
                                    </div>
                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)</label>
                                        <input type="text" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))" class="form-control" placeholder="" readonly />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route)</label>
                                        @Html.DropDownList("ID_Route", new SelectList(ViewBag.ID_RouteList, "Value", "Text"), "Select a Route", new { @class = "form-control select2", id = "ID_Route" })
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Tensile_Strenght)
                                            <i id="tensil-limit-id"
                                               class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="Limits not available"></i>
                                        </label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))" class="form-control" placeholder="Tensile Strength" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Material_type)</label>
                                        @Html.DropDownList("ID_Material_type", (SelectList)ViewBag.MaterialTypeList, "Select Material Type", new { @class = "form-control select2" })
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Thickness)
                                            <i id="thickness-limit-id"
                                               class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="Limits not available"></i>
                                        </label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))" class="form-control" placeholder="Thickness" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width)
                                            <i id="width-limit-id"
                                               class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="Limits not available"></i>
                                        </label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))" class="form-control" placeholder="Width" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>
                                            @Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Pitch)
                                            <i id="pitch-limit-id"
                                               class="fa fa-question-circle"
                                               data-toggle="tooltip"
                                               data-placement="right"
                                               data-html="true"
                                               title="Limits not available"></i>
                                        </label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" class="form-control" placeholder="Pitch" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))" class="form-control" placeholder="Blanks Per Stroke" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))" class="form-control" placeholder="Parts Per Vehicle" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Gross_Weight)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))" class="form-control" placeholder="Theoretical Gross Weight" min="0" readonly />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))" class="form-control" placeholder="Gross Weight" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>


                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)</label>
                                        <input type="number" step="1" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape)</label>
                                        @Html.DropDownList("ID_Shape", (SelectList)ViewBag.ShapeList, "Select Shape", new { @class = "form-control select2" })
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))" class="form-control" placeholder="Angle A" min="0" readonly />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>

                                    <div class="col-md-2">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))" class="form-control" placeholder="Angle B" min="0" readonly />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                </div>

                                <br />
                                <button type="button" class="btn btn-success btn-xs" id="addOrUpdateMaterial"><i class="fa-solid fa-plus"></i> Add Material</button>
                                <button type="button" class="btn btn-danger btn-xs" id="eraseInputs"><i class="fa-solid fa-eraser"></i> Clear Form</button>
                            </div>

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Technical Feasibility</div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="hidden" id="ID_Theoretical_Blanking_Line" name="ID_Theoretical_Blanking_Line" />
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Theoretical_Blanking_Line)</label>
                                        <input type="text" id="theoretical_blk_line" class="form-control" placeholder="Theoretical Blanking Line" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Strokes)</label>
                                        <input type="text" id="Theoretical_Strokes" class="form-control" placeholder="Theoretical Strokes" readonly />
                                    </div>
                                </div>                               
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line)</label>
                                        @Html.DropDownList("ID_Real_Blanking_Line", (SelectList)ViewBag.LinesList, "Select Line", new { @class = "form-control select2" })
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_Strokes)</label>
                                        <input type="text" id="Real_Strokes" class="form-control" placeholder="Real Strokes" readonly />
                                    </div>
                                   
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)</label>
                                        <input type="number" step="any" id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))" class="form-control" placeholder="@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)" min="0" />
                                        <span id="@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error" class="error-message" style="color: red; display: none;"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- SECCIÓN DE INPUTS: material-form -->
                            <div class="material-form">
                                <!-- TITLE FOR THE MATERIAL FORM -->
                                <div class="material-form-title">Efficiency and Capacity</div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>Parts/Auto</label>
                                        <input type="text" id="parts_auto" class="form-control" placeholder="Parts/Auto" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Stroke/Auto</label>
                                        <input type="text" id="strokes_auto" class="form-control" placeholder="Stroke/Auto" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Blanks/Year</label>
                                        <input type="text" id="blanks_per_year" class="form-control" placeholder="Blanks/Year" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Min Max Reales</label>
                                        <input type="text" id="min_max_reales" class="form-control" placeholder="Min Max Reales" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Min Max Reales / OEE</label>
                                        <input type="text" id="min_max_reales_oee" class="form-control" placeholder="Min Max Reales / OEE" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Actual Shifts</label>
                                        <input type="text" id="actual_shifts" class="form-control" placeholder="Actual Shifts" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Stroke / shift</label>
                                        <input type="text" id="strokes_shift" class="form-control" placeholder="Stroke / shift" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>% Capacity</label>
                                        <input type="text" id="capacity" class="form-control" placeholder="0%" readonly />
                                    </div>
                                    <div class="col-md-3">
                                        <label>Status DM</label>
                                        <input type="text" id="status_dm" class="form-control" placeholder="Status DM" readonly />
                                    </div>
                                </div>
                            </div>

                            <!-- TABLA DE MATERIALES -->
                            <table class="table table-bordered table-responsive" id="materialsTable">
                                <thead>
                                    <tr>
                                        <th>Actions</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Vehicle)</th>
                                        <th>Vehicle Version</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().SOP_SP)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().EOP_SP)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_SOP)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_EOP)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To)</th>
                                        <th>Part Name</th>
                                        <th>Part Number</th>
                                        <th>Quality</th>
                                        <th>Program SP</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Max_Production_SP)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Tensile_Strenght)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Material_type)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Thickness)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Pitch)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Gross_Weight)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Theoretical_Strokes)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Real_Strokes)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool)</th>
                                        <th>@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().OEE)</th>
                                        <th>% Capacity</th>
                                        <th>Status DM</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.CTZ_Project_Materials != null && Model.CTZ_Project_Materials.Any())
                                    {
                                        var matList = Model.CTZ_Project_Materials.OrderByDescending(x => x.ID_Material).ToList();
                                        for (int i = 0; i < matList.Count; i++)
                                        {
                                            var material = matList[i];
                                            var capacityPercent = material.GetAverageCapacityFromQuote(capacityDictionary);
                                            var status_dm = (capacityPercent < 0.95 ? "APPROVED" : capacityPercent < 0.98 ? "ON REVIEW" : "REJECTED");
                                            <tr data-index="@i">
                                                <td>
                                                    <button type="button" class="btn btn-warning btn-xs edit-row">Edit</button>
                                                    <button type="button" class="btn btn-danger btn-xs remove-row">Remove</button>

                                                    <!-- Hidden inputs para el POST -->
                                                    <input type="hidden" name="materials[@i].ID_Material" value="@material.ID_Material" />
                                                    <input type="hidden" name="materials[@i].Vehicle" value="@material.Vehicle" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))" value="@material.Vehicle_2" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))" value="@material.Vehicle_3" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))" value="@material.Vehicle_4" />
                                                    <input type="hidden" name="materials[@i].Vehicle_version" value="@material.Vehicle_version" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))" value="@(material.SOP_SP.HasValue? material.SOP_SP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))" value="@(material.EOP_SP.HasValue? material.EOP_SP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))" value="@(material.Real_SOP.HasValue? material.Real_SOP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))" value="@(material.Real_EOP.HasValue? material.Real_EOP.Value.ToString("yyyy-MM"):"")" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))" value="@(material.Ship_To)" />
                                                    <input type="hidden" name="materials[@i].Part_Number" value="@material.Part_Number" />
                                                    <input type="hidden" name="materials[@i].Part_Name" value="@material.Part_Name" />
                                                    <input type="hidden" name="materials[@i].Quality" value="@material.Quality" />
                                                    <input type="hidden" name="materials[@i].Program_SP" value="@material.Program_SP" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))" value="@material.Max_Production_SP" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))" value="@material.Annual_Volume" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))" value="@material.Volume_Per_year" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))" value="@material.ID_Route" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))" value="@material.Tensile_Strenght" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))" value="@material.ID_Material_type" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))" value="@material.Thickness" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))" value="@material.Width" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" value="@material.Pitch" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))" value="@material.Blanks_Per_Stroke" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))" value="@material.Parts_Per_Vehicle" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))" value="@material.Theoretical_Gross_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))" value="@material.Gross_Weight" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))" value="@material.ID_Shape" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))" value="@material.Angle_A" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))" value="@material.Angle_B" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))" value="@material.ID_Real_Blanking_Line" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))" value="@material.Theoretical_Strokes" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))" value="@material.Real_Strokes" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))" value="@material.Ideal_Cycle_Time_Per_Tool" />
                                                    <input type="hidden" name="materials[@i].@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))" value="@material.OEE" />
                                                    <input type="hidden" name="materials[@i].capacity" value="@capacityPercent.ToString("P2")" />
                                                    <input type="hidden" name="materials[@i].status_dm" value="@status_dm" />
                                                </td>
                                                <td>@Html.DisplayFor(model => material.Vehicle)</td>
                                                <td>@material.Vehicle_version</td>
                                                <td>@(material.SOP_SP.HasValue? material.SOP_SP.Value.ToString("yyyy-MM"):"")</td>
                                                <td>@(material.EOP_SP.HasValue? material.EOP_SP.Value.ToString("yyyy-MM"):"")</td>
                                                <td>@(material.Real_SOP.HasValue? material.Real_SOP.Value.ToString("yyyy-MM"):"")</td>
                                                <td>@(material.Real_EOP.HasValue? material.Real_EOP.Value.ToString("yyyy-MM"):"")</td>
                                                <td>@material.Ship_To</td>
                                                <td>@material.Part_Name</td>
                                                <td>@material.Part_Number</td>
                                                <td>@material.Quality</td>
                                                <td>@material.Program_SP</td>
                                                <td>@material.Max_Production_SP</td>
                                                <td>@material.Annual_Volume</td>
                                                <td>@material.Volume_Per_year</td>
                                                <td>@(material.CTZ_Route != null ? material.CTZ_Route.Route_Name : "")</td>
                                                <td>@material.Tensile_Strenght</td>
                                                <td>@(material.CTZ_Material_Type != null ? material.CTZ_Material_Type.Material_Name : "")</td>
                                                <td>@material.Thickness</td>
                                                <td>@material.Width</td>
                                                <td>@material.Pitch</td>
                                                <td>@material.Blanks_Per_Stroke</td>
                                                <td>@material.Parts_Per_Vehicle</td>
                                                <td>@material.Theoretical_Gross_Weight</td>
                                                <td>@material.Gross_Weight</td>
                                                <td>@(material.SCDM_cat_forma_material != null ? material.SCDM_cat_forma_material.ConcatKey : "")</td>
                                                <td>@material.Angle_A</td>
                                                <td>@material.Angle_B</td>
                                                <td>@(material.CTZ_Production_Lines1 != null ? material.CTZ_Production_Lines1.Description : "")</td>
                                                <td>@material.Theoretical_Strokes</td>
                                                <td>@material.Real_Strokes</td>
                                                <td>@material.Ideal_Cycle_Time_Per_Tool</td>
                                                <td>@material.OEE</td>
                                                <td>@capacityPercent.ToString("P2")</td>
                                                <td>@status_dm</td>

                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>

                            <br />
                            <!-- Botón final para guardar todo en la base de datos -->
                            <button type="submit" class="btn btn-success"><i class="fa-regular fa-floppy-disk"></i> Save All Materials</button>
                        }
                    </div>
                    <div class="text-right mt-3">
                        <button type="button" class="btn btn-default" onclick="window.history.back();">
                            <i class="fa-regular fa-circle-left"></i> Back
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <!-- SweetAlert2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/sweetalert2/sweetalert2.min.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- Select2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <!-- DatePicker -->
    @Scripts.Render(Url.Content("~/Content/vendors/moment/moment.js"))
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        //variables para activar/desactivar campos
        // Objeto que mapea el ID de la ruta (o su valor) a la lista de campos que deben estar activos.
        const routeFieldMap = {
            "1": ["Thickness", "Width", "Pitch"],      // Ejemplo: para Route con ID = 1
            "2": ["Tensile_Strenght", "OEE"],          // Route 2 activa Tensile y OEE
            "3": ["Blanks_Per_Stroke", "Parts_Per_Vehicle", "Angle_A", "Angle_B"]
        };

        // Lista de TODOS los campos que podrían activarse/desactivarse
        const allFields = [
            "Thickness",
            "Width",
            "Pitch",
            "Tensile_Strenght",
            "OEE",
            "Blanks_Per_Stroke",
            "Parts_Per_Vehicle",
            "Angle_A",
            "Angle_B"
        ];

         // Si no tiene valor, asumimos 0 (no automotriz)
        var vehicleType = @(Model.ID_VehicleType.HasValue ? Model.ID_VehicleType.Value : 0);

        let volumeTimeout; //variable global para timeout de annual volume

        // Configuración de Toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000",
            "extendedTimeOut": "1000"
        };

        var lineMap = {
            "PUEBLA-BLK1": 1,
            "PUEBLA-BLK2": 2,
            "PUEBLA-BLK3": 3,
            "SILAO-BLK1": 4,
            "SILAO-BLK2": 5,
            "SILAO-BLK3": 6,
            "SLP-BLK1": 7
        };

        $(document).ready(function () {
            // Inicializar Select2 en los selects
            $(".select2").select2({ width: '100%' });

            $(function () {
                $('[data-toggle="tooltip"]').tooltip();
            });

            //previene enter en formulario
            $(window).keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    return false;
                }
            });


            // Ocultar inicialmente los selects de Vehicle 2, 3 y 4
            $("#Vehicle_2").closest(".col-md-6").hide();
            $("#Vehicle_3").closest(".col-md-6").hide();
            $("#Vehicle_4").closest(".col-md-6").hide();

            // Llamar a la función al cargar la página
            updateVehicleVisibility();

            // Asociar el evento change a cada select para actualizar la visibilidad
            $("#Vehicle").on("change", updateVehicleVisibility);
            $("#Vehicle_2").on("change", updateVehicleVisibility);
            $("#Vehicle_3").on("change", updateVehicleVisibility);

            // Inicializa el select2 para Quality con tags y sugerencias
            var qualityData = @Html.Raw(Json.Encode(ViewBag.QualityList));


            $(".select2-quality").select2({
                tags: true,
                data: qualityData,
                width: '100%',
                placeholder: "Select or enter quality"
            }).val(null).trigger("change");  //vacio por defecto

             // Inicializa datepicker para Real_SOP
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").datepicker({
                format: "yyyy-mm",       // Formato año-mes (en minúsculas, ya que bootstrap-datepicker usa "mm" para mes)
                startView: "months",     // Inicia mostrando meses
                minViewMode: "months",   // Permite seleccionar solo meses
                autoclose: true
            });

            // Inicializa datepicker para Real_EOP
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").datepicker({
                format: "yyyy-mm",
                startView: "months",
                minViewMode: "months",
                autoclose: true
            });

            var columnDefs = [
                { key: "Vehicle", selector: "#Vehicle", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))", type: "dropdown" },
                { key: "Vehicle_version", selector: "#vehicleVersion", type: "text" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))", type: "text" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))", type: "text" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))", type: "text" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))", type: "text" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))", type: "text" },
                { key: "Part_Name", selector: "#partName", type: "text" },
                { key: "Part_Number", selector: "#partNumber", type: "text" },
                { key: "Quality", selector: "#quality", type: "dropdown" },
                { key: "Program_SP", selector: "#programSP", type: "text" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))", type: "dropdown" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))", type: "number" },
                { key: "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))", selector: "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))", type: "number" },
                { key: "capacity", selector: "#capacity", type: "number" },
                { key: "status_dm", selector: "#status_dm", type: "text" },


            ];

            // Declaramos una variable para el timeout
            let updateTimeout;

            // Asociamos el evento change y keyup a los campos indicados
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght)), " +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), " +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), " +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch)), " +
              "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))")
            .on("change keyup", function () {
                // Cada vez que se dispara el evento, se cancela el timeout anterior
                clearTimeout(updateTimeout);
                // Se establece un nuevo timeout para ejecutar la función updateTheoreticalLine después de 1500 milisegundos
                updateTimeout = setTimeout(updateTheoreticalLine, 800);
            });

            //inicia eventos para validacion en tiempo real
            IniciaValidacionTiempoReal();

            // Botón para agregar/actualizar material
            $("#addOrUpdateMaterial").click(function () {

                // Realizar la validación antes de continuar
                if (!validateMaterial()) {

                    toastr.warning("Please check the material data. Some fields are missing or contain invalid information.");

                    return; // Detener si la validación falla
                }

                let index = $("#materialIndex").val().trim();
                let materialData = {};

                // Recogemos valores de los inputs
                for (let col of columnDefs) {
                    materialData[col.key] = $(col.selector).val();
                }

                if (index === "") {
                    // AGREGAR NUEVO
                    let rowCount = $("#materialsTable tbody tr").length;
                    let rowHtml = buildRowHtml(materialData, rowCount);
                    $("#materialsTable tbody").append(rowHtml);
                    toastr.success("Material added successfully.");
                } else {
                    // EDITAR MATERIAL EXISTENTE
                    let row = $("#materialsTable tbody").find(`tr[data-index='${index}']`);
                    let indice = 1; // El incice empieza en 1 porque se moite 0 de la columna de acciones
                    let colCells = row.find("td");

                    colCells.eq(indice++).text(materialData["Vehicle"]);
                    //colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_2))"]);
                    //colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_3))"]);
                    //colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Vehicle_4))"]);
                    colCells.eq(indice++).text(materialData["Vehicle_version"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))"]);
                    colCells.eq(indice++).text(materialData["Part_Name"]);
                    colCells.eq(indice++).text(materialData["Part_Number"]);
                    colCells.eq(indice++).text(materialData["Quality"]);
                    colCells.eq(indice++).text(materialData["Program_SP"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))"]);
                    //route
                    let routeVal = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))"];
                    let routeText = $("#ID_Route option[value='" + routeVal + "']").text() || routeVal;
                    colCells.eq(indice++).text(routeText);
                    //tensile
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))"]);
                    //Material Type
                    let materialTypeVal = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))"];
                    let materialTypeText = $("#ID_Material_type option[value='" + materialTypeVal + "']").text() || materialTypeVal;
                    colCells.eq(indice++).text(materialTypeText);
                    //thickness , width, pitch
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"]);
                    //Shape
                    let shapeVal = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))"];
                    let shapeText = $("#ID_Shape option[value='" + shapeVal + "']").text() || shapeVal;
                    colCells.eq(indice++).text(shapeText);

                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))"]);

                    //Real BLK
                    let realLineVal = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))"];
                    let realLineText = $("#ID_Real_Blanking_Line option[value='" + realLineVal + "']").text() || realLineVal;
                    colCells.eq(indice++).text(realLineText);

                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))"]);
                    colCells.eq(indice++).text(materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))"]);
                    colCells.eq(indice++).text(materialData["capacity"]);
                    colCells.eq(indice++).text(materialData["status_dm"]);


                    // Actualizar hidden inputs
                    let hiddenInputs = row.find("input[name^='materials']");
                    hiddenInputs.each(function () {
                        let nameAttr = $(this).attr("name"); // e.g. materials[3].Part_Number
                        for (let col of columnDefs) {
                            if (nameAttr.endsWith(`.${col.key}`)) {
                                $(this).val(materialData[col.key]);
                            }
                        }
                    });
                    toastr.info("Material updated successfully.");
                }

                clearMaterialForm(columnDefs);
            });

            $("#eraseInputs").click(function () {
                clearMaterialForm(columnDefs);
            });

            //oculta/muestra campos segun Ruta
            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").on("change", function () {
                let selectedValue = $(this).val();

                // 1) Desactivar/ocultar todos los campos de la lista 'allFields'
                allFields.forEach(field => {
                    // Por ejemplo, ocultar el contenedor
                    $(`#${field}_container`).hide();
                    // O deshabilitar el input
                    $(`#${field}`).prop("disabled", true);
                });

                // 2) Buscar en el diccionario los campos que deben activarse
                if (routeFieldMap[selectedValue]) {
                    routeFieldMap[selectedValue].forEach(field => {
                        $(`#${field}_container`).show();
                        $(`#${field}`).prop("disabled", false);
                    });
                }
            });

            // Botón Remove
            $(document).on("click", ".remove-row", function () {
                var row = $(this).closest("tr");
                Swal.fire({
                    title: 'Are you sure?',
                    text: "Do you really want to remove this material?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#009ff5',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, remove it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        row.remove();
                        renumberRows();
                        toastr.error("Material removed.");
                    }
                });
            });

            // Botón Edit
            $(document).on("click", ".edit-row", function () {
                let row = $(this).closest("tr");
                let index = row.data("index");

                $("#materialIndex").val(index);

                let hiddenInputs = row.find("input[name^='materials']");
                hiddenInputs.each(function () {
                    let nameAttr = $(this).attr("name");
                    let val = $(this).val();
                    for (let col of columnDefs) {
                        if (nameAttr.endsWith(`.${col.key}`)) {
                            // Si es el campo Quality y no existe la opción, la agregamos
                            if (col.key === "Quality") {
                                if (!$(col.selector).find(`option[value="${val}"]`).length) {
                                    let newOption = new Option(val, val, true, true);
                                    $(col.selector).append(newOption);
                                }
                            }

                            $(col.selector).val(val);
                            // Si es un dropdown, dispara el cambio para actualizar Select2
                            if (col.type && col.type === "dropdown") {
                                $(col.selector).trigger("change");
                            }
                        }
                    }
                });

                $("#addOrUpdateMaterial").html('<i class="fa-solid fa-pen-to-square"></i> Update Material');
                validateMaterial();
            });



            // Construye fila para la tabla
            function buildRowHtml(materialData, rowIndex) {
                let tdVehicle = `<td>${materialData["Vehicle"]}</td>`;
                let tdVehicleVersion = `<td>${materialData["Vehicle_version"]}</td>`;
                let tdSOP = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))"]}</td>`;
                let tdEOP = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))"]}</td>`;
                let tdRealSOP = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))"]}</td>`;
                let tdRealEOP = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))"]}</td>`;
                let tdShipTo = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))"]}</td>`;
                let tdPartName = `<td>${materialData["Part_Name"]}</td>`;
                let tdPartNumber = `<td>${materialData["Part_Number"]}</td>`;
                let tdQuality = `<td>${materialData["Quality"]}</td>`;
                let tdProgramSP = `<td>${materialData["Program_SP"]}</td>`;
                let tdMaxProduction = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))"]}</td>`;
                let tdAnnualVolume = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))"]}</td>`;
                let tdVolumePerYear = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))"]}</td>`;

                 // Para ID_Route, buscamos el texto en el combo:
                let routeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))"];
                let routeText = $("#ID_Route option[value='" + routeId + "']").text() || routeId;  // Si no se encuentra, muestra el id
                let tdIDRoute = `<td>${routeText}</td>`;

                //tensile
                let tdTensileStrenght = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))"]}</td>`;

                // Para ID_Material_type
                let materialTypeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))"];
                let materialTypeText = $("#ID_Material_type option[value='" + materialTypeId + "']").text() || materialTypeId;  // Si no se encuentra, muestra el id
                let tdMaterialType = `<td>${materialTypeText}</td>`;

                //thickness, width, pitch
                let tdThickness = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))"]}</td>`;
                let tdWidth = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))"]}</td>`;
                let tdPitch = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))"]}</td>`;
                let tdTheoricalGrossWeight = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))"]}</td>`;
                let tdGrossWeight = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"]}</td>`;

                // Para ID_Shape
                let shapeId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))"];
                let shapeText = $("#ID_Shape option[value='" + shapeId + "']").text() || shapeId;  // Si no se encuentra, muestra el id
                let tdShape = `<td>${shapeText}</td>`;

                let tdAngleA = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]}</td>`;
                let tdAngleB = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))"]}</td>`;
                let tdBlanksPerStroke = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))"]}</td>`;
                let tdPartsPerVehicle = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))"]}</td>`;

                // Para ID_Real_Blanking_Line
                let realLineId = materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))"];
                let realLineText = $("#ID_Real_Blanking_Line option[value='" + realLineId + "']").text() || realLineId;  // Si no se encuentra, muestra el id
                let tdRealLine = `<td>${realLineText}</td>`;

                let tdTheoricalStrokes = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))"]}</td>`;
                let tdRealStrokes = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))"]}</td>`;
                let tdIdealCycleTimePerTool = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))"]}</td>`;
                let tdOEE = `<td>${materialData["@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))"]}</td>`;
                let tdCapacity = `<td>${materialData["capacity"]}</td>`;
                let tdStatusDM = `<td>${materialData["status_dm"]}</td>`;


                let hiddenInputs = "";
                for (let col of columnDefs) {
                    hiddenInputs += `<input type="hidden" name="materials[${rowIndex}].${col.key}" value="${materialData[col.key] || ""}" />`;
                }

                let tdActions = `
                                <td>
                                    <button type="button" class="btn btn-warning btn-xs edit-row">Edit</button>
                                    <button type="button" class="btn btn-danger btn-xs remove-row">Remove</button>
                                    ${hiddenInputs}
                                </td>`;

                let rowHtml = `
                                <tr data-index="${rowIndex}">
                                    ${tdActions}
                                    ${tdVehicle}
                                    ${tdVehicleVersion}
                                    ${tdSOP}
                                    ${tdEOP}
                                    ${tdRealSOP}
                                    ${tdRealEOP}
                                    ${tdShipTo}
                                    ${tdPartName}
                                    ${tdPartNumber}
                                    ${tdQuality}
                                    ${tdProgramSP}
                                    ${tdMaxProduction}
                                    ${tdAnnualVolume}
                                    ${tdVolumePerYear}
                                    ${tdIDRoute}
                                    ${tdTensileStrenght}
                                    ${tdMaterialType}
                                    ${tdThickness}
                                    ${tdWidth}
                                    ${tdPitch}
                                    ${tdBlanksPerStroke}
                                    ${tdPartsPerVehicle}
                                    ${tdTheoricalGrossWeight}
                                    ${tdGrossWeight}
                                    ${tdShape}
                                    ${tdAngleA}
                                    ${tdAngleB}
                                    ${tdRealLine}
                                    ${tdTheoricalStrokes}
                                    ${tdRealStrokes}
                                    ${tdIdealCycleTimePerTool}
                                    ${tdOEE}
                                    ${tdCapacity}
                                    ${tdStatusDM}
                                </tr>`;

                return rowHtml;
            }

            function IniciaValidacionTiempoReal() {
                // Validación en tiempo real para el input de Vehicle
                $("#Vehicle").on("change keyup input", function () {
                    validateMaterial("Vehicle");
                });

                // Validación en tiempo real para el input de Vehicle_version
                $("#vehicleVersion").on('keyup input', function () {
                    validateMaterial("vehicleVersion");
                });

                // Validación en tiempo real para el input de Vehicle_version
                $("#partName").on('keyup input', function () {
                    validateMaterial("partName");
                });

                // Validación en tiempo real para el input de Vehicle_version
                $("#partNumber").on('keyup input', function () {
                    validateMaterial("partNumber");
                });

                // Validación en tiempo real para el input de Vehicle_version
                $("#quality").on('keyup input', function () {
                    validateMaterial("quality");
                });

                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").on('change', function () {
                    validateMaterial("Real_SOP");
                });
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").on('change', function () {
                    validateMaterial("Real_EOP");
                });
                // Validación en tiempo real para el input de Ship_To
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").on('keyup input', function () {
                    validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))");
                });

                // Validación en tiempo real para el input de ID Route Dropdown
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").on("change", function () {
                    validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))");
                });


                  //Redondea a tres decimales después de perder el foco
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght)), " +
                    "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), " +
                    "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), " +
                    "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))" +
                    "#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))"
                    ).on("blur", function () {
                    redondearValor(this, 3);
                 });

                 // Validación en tiempo real para el input de ID_Material_type Dropdown
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))").on("change", function () {
                     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))");
                 });

                  //validacion en tiempo real
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").on("keyup change input", function () {
                     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
                 });

                   //validacion en tiempo real
                   $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").on("keyup change input", function () {
                       validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
                   });
                   //validacion en tiempo real
                   $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").on("keyup change input", function () {
                       validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
                   });
                   var pitchTimeout;
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").on("keyup change input", function () {
                        clearTimeout(pitchTimeout);
                        pitchTimeout = setTimeout(function() {
                            validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");
                        }, 600);
                    });
                   //validacion en tiempo real
                   $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").on("keyup change input", function () {
                       validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))");
                   });

                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").on("keyup change input", function () {
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))");
                   });
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").on("keyup change input", function () {
                       validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))");
                   });

                 // Validación en tiempo real para el input de ID_Shape Dropdown
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").on("change", function () {
                     validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))");

                      // Obtenemos el valor seleccionado
                    let shapeVal = $(this).val();

                    // Si el valor es "3", habilitamos los inputs de ángulos
                    if (shapeVal === "3") {
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").removeAttr("readonly")
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").removeAttr("readonly")
                    } else {
                        // Si es diferente, deshabilitamos (readonly) y opcionalmente limpiamos o marcamos con un fondo gris
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").attr("readonly", true)
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").attr("readonly", true)
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").val("")
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").val("")
                    }
                 });

                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").on("keyup change input", function () {
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))");
                    });
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").on("keyup change input", function () {
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))");
                    });
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").on("keyup change input", function () {
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))");
                    });
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").on("keyup change input", function () {
                         validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))");
                    });
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").on("keyup change input", function () {
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))");
                    });
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").on("keyup change input", function () {
                        validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))");
                    });

                     // Validación en tiempo real para el input de ID_Real_Blanking_Line Dropdown
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").on("change", function () {
                         validateMaterial("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))");
                     });
                //*** otros metodos y eventos ***

                   //Calcula el valor de Theorical gross
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)), #@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").on("change keyup", function () {
                    // Puedes agregar un debounce si lo deseas para evitar múltiples ejecuciones rápidas.
                    updateTheoreticalGrossWeight();
                });

            }

            function validateMaterial(fieldId) {
                // Si no se especifica un campo, valida todos
                if (!fieldId) {
                    let validVehicleVersion = validateVehicleVersion();
                    let validPartName = validatePartName();
                    let validPartNumber = validatePartNumber();
                    let validQuality = validateQuality();
                    let validVehicle = validateVehicle();
                    let validRealSOP = validateRealSOP();
                    let validRealEOP = validateRealEOP();
                    let validShipTo = validateShipTo();
                    let validRoute = validateRoute();
                    let validTensile = validateTensileStrength();
                    let validMaterialType = validateMaterialType();
                    let validThickness = validateThickness();
                    let validWidth = validateWidth();
                    let validPitch = validatePitch();
                    let validGrossWeight = validateGrossWeight();
                    let validAnnualVolume = validateAnnualVolume();
                    let validVolumePerYear = validateVolumePerYear();
                    let validShape = validateShape();
                    let validAngleA = validateAngleA();
                    let validAngleB = validateAngleB();
                    let validBlanksPerStroke = validateBlanksPerStroke();
                    let validPartsPerVehicle = validatePartsPerVehicle();
                    let validRealLine = validateRealLine();
                    let validIdealCycleTimePerTool = validateIdealCycleTimePerTool();
                    let validOEE = validateOEE();

                    return validVehicleVersion && validPartName && validPartNumber && validQuality && validVehicle
                        && validRealSOP && validRealEOP && validShipTo && validRoute && validTensile && validMaterialType
                        && validThickness && validWidth && validPitch && validGrossWeight && validAnnualVolume && validVolumePerYear
                        && validShape && validAngleA && validAngleB && validBlanksPerStroke && validPartsPerVehicle && validRealLine
                        && validIdealCycleTimePerTool && validOEE
                        ;
                }

                // Validar sólo el campo indicado
                switch (fieldId) {
                    case "Vehicle":
                        return validateVehicle();
                    case "vehicleVersion":
                        return validateVehicleVersion();
                    case "partName":
                        return validatePartName();
                    case "partNumber":
                        return validatePartNumber();
                    case "quality":
                        return validateQuality();
                    case "Real_SOP":
                        return validateRealSOP();
                    case "Real_EOP":
                        return validateRealEOP();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))":
                        return validateShipTo();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))":
                        return validateRoute();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))":
                        return validateTensileStrength();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))":
                        return validateMaterialType();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))":
                        return validateThickness();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))":
                        return validateWidth();
                    case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))":
                        return validatePitch();
                   case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))":
                        return validateGrossWeight();
                  case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))":
                        return validateAnnualVolume();
                  case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))":
                        return validateVolumePerYear();
                   case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))":
                        return validateShape();
                   case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))":
                        return validateAngleA();
                   case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))":
                        return validateAngleB();
                   case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))":
                        return validateBlanksPerStroke();
                   case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))":
                        return validatePartsPerVehicle();
                  case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))":
                        return validateRealLine();
                 case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))":
                        return validateIdealCycleTimePerTool();
                 case "@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))":
                        return validateOEE();
                    default:
                        return true;
                }
            }

            function validateVehicle() {
                let vehicle = $("#Vehicle").val().trim();
                $("#VehicleError").text("").hide();
                $("#Vehicle").css("border", "");

                if (!vehicle) {
                    $("#VehicleError").text("Vehicle is required.").show();
                    $("#Vehicle").css("border", "1px solid red");
                    return false;
                }

                // Si NO es automotriz, validar longitud máxima
                if (vehicleType != 1 && vehicle.length > 120) {
                    $("#VehicleError").text("Vehicle cannot exceed 120 characters.").show();
                    $("#Vehicle").css("border", "1px solid red");
                    return false;
                }

                return true;
            }
             function validateRoute() {
                // Validación para Vehicle (dropdown)
                let route = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").val();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").css("border", "");

                 // Se asume que la opción por defecto tiene un valor vacío ("") o "Select a Route"
                 if (!route || route === "Select a Route") {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Route))").css("border", "1px solid red");
                    return false;
                } else {
                    return true;
                }
            }

            function validateMaterialType() {
                let materialType = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))").val();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))").css("border", "");

                if (!materialType || materialType === "Select Material Type") {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Route) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type))").css("border", "1px solid red");
                    return false;
                }

                return true;
            }

              function validateShape() {
                let inputValue = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").val();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").css("border", "");

                  if (!inputValue || inputValue === "Select Shape") {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Shape) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Shape))").css("border", "1px solid red");
                    return false;
                }

                return true;
            }

            function validateRealLine() {
                let inputValue = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").val();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").css("border", "");

                updateRealStrokes();


                @*if (!inputValue || inputValue === "Select Line") {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().ID_Real_Blanking_Line) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line))").css("border", "1px solid red");
                    return false;
                }*@

                return true;
            }

            function validateRealSOP() {
                let realSOPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").css("border", "");

                if (!realSOPStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))Error").text("Real SOP is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_SOP))").css("border", "1px solid red");
                    return false;
                }

                // Obtener el valor de SOP_SP
                let sopSPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))").val().trim();
                let realSOPDate = parseYearMonth(realSOPStr);
                let sopSPDate = parseYearMonth(sopSPStr);

                if (realSOPDate && sopSPDate && realSOPDate < sopSPDate) {
                    toastr.warning("Real SOP is before the planned SOP.");
                }

                return true;
            }

            function validateRealEOP() {
                let realEOPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").css("border", "");

                if (!realEOPStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))Error").text("Real EOP is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_EOP))").css("border", "1px solid red");
                    return false;
                }

                // Obtener el valor de EOP_SP
                let eopSPStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))").val().trim();
                let realEOPDate = parseYearMonth(realEOPStr);
                let eopSPDate = parseYearMonth(eopSPStr);

                if (realEOPDate && eopSPDate && realEOPDate > eopSPDate) {
                    toastr.warning("Real EOP is later than the planned EOP.");
                }

                return true;
            }

            function validateTensileStrength() {
                let tensileStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").css("border", "");

                if (!tensileStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error").text("Tensile Strenght is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").css("border", "1px solid red");
                    return false;
                }

                let tensileVal = parseFloat(tensileStr);

                if (tensileVal < 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").css("border", "1px solid red");
                    return false;
                }



                if (window.engineeringRanges) {
                    let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 4);
                    if (gaugeRange) {
                        if (tensileVal < gaugeRange.Min_Value || tensileVal > gaugeRange.Max_Value) {
                            // Establecer el borde naranja
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").css("border", "1px solid orange");
                            // Mostrar mensaje de advertencia con los límites en el mismo elemento de error
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))Error")
                                .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                                .show();
                        }
                    }
                }

                return true;
            }

            function validateThickness() {
                let thicknessStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").css("border", "");

                if (!thicknessStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Thickness) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").css("border", "1px solid red");
                    return false;
                }
                let thicknessVal = parseFloat(thicknessStr);
                if (thicknessVal < 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").css("border", "1px solid red");
                    return false;
                }

                // --- Aquí agregas la comparación con Min/Max de BD ---
                // Solo mostramos un toastr.warning, sin bloquear

               if (window.engineeringRanges) {
                    // Buscar el rango para GaugeMetric (ID_Criteria = 1)
                    let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 1);
                    if (gaugeRange) {
                        if (thicknessVal < gaugeRange.Min_Value || thicknessVal > gaugeRange.Max_Value) {
                            // Establecer el borde naranja
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").css("border", "1px solid orange");
                            // Mostrar mensaje de advertencia con los límites en el mismo elemento de error
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))Error")
                                .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                                .show();
                        }
                    }
                }

                return true;
            }

             function validateWidth() {
                let widthStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").css("border", "");

                 if (!widthStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Width) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").css("border", "1px solid red");
                    return false;
                }

                 let widthVal = parseFloat(widthStr);
                 if (widthVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").css("border", "1px solid red");
                    return false;
                }

                if (window.engineeringRanges) {
                    let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 2);
                    if (gaugeRange) {
                        if (widthVal < gaugeRange.Min_Value || widthVal > gaugeRange.Max_Value) {
                            // Establecer el borde naranja
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").css("border", "1px solid orange");
                            // Mostrar mensaje de advertencia con los límites en el mismo elemento de error
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))Error")
                                .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                                .show();
                        }
                    }
                }

                return true;
            }

            function validatePitch() {
                let pitchStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").css("border", "");

                //Calcula los golpes teoricos
                updateTheoreticalStrokes();
                updateRealStrokes();

                if (!pitchStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Pitch) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").css("border", "1px solid red");
                    return false;
                }

                let pitchVal = parseFloat(pitchStr);
                if (pitchVal < 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").css("border", "1px solid red");
                    return false;
                }


              if (window.engineeringRanges) {
                    let gaugeRange = window.engineeringRanges.find(r => r.ID_Criteria === 3);
                  if (gaugeRange) {

                        if (pitchVal < gaugeRange.Min_Value || pitchVal > gaugeRange.Max_Value) {
                            // Establecer el borde naranja
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").css("border", "1px solid orange");
                            // Mostrar mensaje de advertencia con los límites en el mismo elemento de error
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))Error")
                                .text(`Allowed range: ${gaugeRange.Min_Value} - ${gaugeRange.Max_Value}`)
                                .show();
                        }
                    }
                }

                return true;
            }

            function validateGrossWeight() {
                let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").css("border", "");

                if (!valueStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Gross_Weight) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").css("border", "1px solid red");
                    return false;
                }

                let floatVal = parseFloat(valueStr);
                if (floatVal < 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Gross_Weight))").css("border", "1px solid red");
                    return false;
                }

                return true;
            }

            function validateAnnualVolume() {
                //actualiza los blanks por año
                updateBlanksPerYear();

                // Actualiza el color de fondo inmediatamente
                let diffPercentage = updateAnnualVolumeStyle();

                // Cada vez que el usuario escribe, cancelamos el timeout anterior
                clearTimeout(volumeTimeout);
                // Establecemos un nuevo timeout de 0.8 segundos (800 ms) para mostrar el toast
                volumeTimeout = setTimeout(function () {
                    // Si diffPercentage se calculó (no es undefined)
                    if (typeof diffPercentage !== "undefined") {
                        showVolumeDifferenceToast(diffPercentage);
                    }
                }, 900);

                 let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val().trim();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error").text("").hide();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("border", "");

                 if (!valueStr) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Annual_Volume) is required.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("border", "1px solid red");
                     return false;
                 }

                 let floatVal = parseFloat(valueStr);
                 if (floatVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))Error").text("The value must be greater than or equal to 0.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("border", "1px solid red");
                     return false;
                 }

                 return true;
            }

            function validateVolumePerYear() {
                 let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").val().trim();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error").text("").hide();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").css("border", "");

                 if (!valueStr) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Volume_Per_year) is required.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").css("border", "1px solid red");
                     return false;
                 }

                 let floatVal = parseFloat(valueStr);
                 if (floatVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))Error").text("The value must be greater than or equal to 0.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Volume_Per_year))").css("border", "1px solid red");
                     return false;
                 }

                 return true;
            }

            function validateAngleA() {
                 // Si el input tiene el atributo readonly, no se valida y se retorna true
                if ($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").prop("readonly")) {
                    return true;
                }

                 let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").val().trim();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error").text("").hide();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").css("border", "");

                 if (!valueStr) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_A) is required.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").css("border", "1px solid red");
                     return false;
                 }

                 let floatVal = parseFloat(valueStr);
                 if (floatVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))Error").text("The value must be greater than or equal to 0.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_A))").css("border", "1px solid red");
                     return false;
                 }

                 return true;
            }

             function validateAngleB() {
                 // Si el input tiene el atributo readonly, no se valida y se retorna true
                if ($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").prop("readonly")) {
                    return true;
                }

                 let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").val().trim();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error").text("").hide();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").css("border", "");

                 if (!valueStr) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Angle_B) is required.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").css("border", "1px solid red");
                     return false;
                 }

                 let floatVal = parseFloat(valueStr);
                 if (floatVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))Error").text("The value must be greater than or equal to 0.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Angle_B))").css("border", "1px solid red");
                     return false;
                 }

                 return true;
            }

             function validateBlanksPerStroke() {
                 //actualiza Strokes per Auto
                 updateStrokesPerAuto();
                 updateMinMaxReales();
                 updateStrokesShift();

                 let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val().trim();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error").text("").hide();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").css("border", "");

                 if (!valueStr) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Blanks_Per_Stroke) is required.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").css("border", "1px solid red");
                     return false;
                 }

                 let floatVal = parseFloat(valueStr);
                 if (floatVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))Error").text("The value must be greater than or equal to 0.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").css("border", "1px solid red");
                     return false;
                 }

                 return true;
            }

            function validatePartsPerVehicle() {
                //actualiza Strokes per Auto
                updateStrokesPerAuto()
                updateBlanksPerYear()

                 var partsValue = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val();
                 $("#parts_auto").val(partsValue);

                 let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val().trim();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error").text("").hide();
                 $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").css("border", "");

                 if (!valueStr) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Parts_Per_Vehicle) is required.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").css("border", "1px solid red");
                     return false;
                 }

                 let floatVal = parseFloat(valueStr);
                 if (floatVal < 0) {
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))Error").text("The value must be greater than or equal to 0.").show();
                     $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").css("border", "1px solid red");
                     return false;
                 }

                 return true;
            }

            // Funciones de validación individuales
            function validateVehicleVersion() {
                let vehicleVersion = $("#vehicleVersion").val().trim();
                $("#vehicleVersionError").text("").hide();
                $("#vehicleVersion").css("border", "");
                if (!vehicleVersion) {
                    $("#vehicleVersionError").text("Vehicle Version is required.").show();
                    $("#vehicleVersion").css("border", "1px solid red");
                    return false;
                } else if (vehicleVersion.length > 50) {
                    $("#vehicleVersionError").text("Vehicle Version cannot exceed 50 characters.").show();
                    $("#vehicleVersion").css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            function validatePartName() {
                let partName = $("#partName").val().trim();
                $("#partNameError").text("").hide();
                $("#partName").css("border", "");
                if (!partName) {
                    $("#partNameError").text("Part Name is required.").show();
                    $("#partName").css("border", "1px solid red");
                    return false;
                } else if (partName.length > 50) {
                    $("#partNameError").text("Part Name cannot exceed 50 characters.").show();
                    $("#partName").css("border", "1px solid red");
                    return false;
                }
                return true;
            }

             function validateShipTo() {
                let partName = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "");
                if (!partName) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "1px solid red");
                    return false;
                } else if (partName.length > 150) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ship_To) cannot exceed 150 characters.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ship_To))").css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            function validatePartNumber() {
                let partNumber = $("#partNumber").val().trim();
                $("#partNumberError").text("").hide();
                $("#partNumber").css("border", "");
                if (!partNumber) {
                    $("#partNumberError").text("Part Number is required.").show();
                    $("#partNumber").css("border", "1px solid red");
                    return false;
                } else if (partNumber.length > 50) {
                    $("#partNumberError").text("Part Number cannot exceed 50 characters.").show();
                    $("#partNumber").css("border", "1px solid red");
                    return false;
                }
                return true;
            }

            function validateQuality() {
                let qualityVal = $("#quality").val();
                let quality = qualityVal ? qualityVal.trim() : "";
                $("#qualityError").text("").hide();
                $("#quality").css("border", "");
                if (!quality) {
                    $("#qualityError").text("Quality is required.").show();
                    $("#quality").css("border", "1px solid red");
                    return false;
                } else if (quality.length > 50) {
                    $("#qualityError").text("Quality cannot exceed 50 characters.").show();
                    $("#quality").css("border", "1px solid red");
                    return false;
                }
                return true;
            }


            function validateIdealCycleTimePerTool() {

                updateMinMaxReales();

                let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").css("border", "");

                @*if (!valueStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").css("border", "1px solid red");
                    return false;
                }*@

                let floatVal = parseFloat(valueStr);
                if (floatVal < 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").css("border", "1px solid red");
                    return false;
                }

                return true;
            }

            function validateOEE() {

                let valueStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val().trim();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error").text("").hide();
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").css("border", "");

                @*if (!valueStr) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))Error").text("@Html.DisplayNameFor(model => model.CTZ_Project_Materials.First().Ideal_Cycle_Time_Per_Tool) is required.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").css("border", "1px solid red");
                    return false;
                }*@

                let floatVal = parseFloat(valueStr);
                if (floatVal < 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))Error").text("The value must be greater than or equal to 0.").show();
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").css("border", "1px solid red");
                    return false;
                }

                return true;
            }

            // Limpia el formulario
            function clearMaterialForm(columns) {
                $("#materialIndex").val("");
                for (let col of columns) {
                    if (col.type && col.type === "dropdown") {
                        $(col.selector).val("").trigger("change");
                    } else {
                        $(col.selector).val("");
                        $(col.selector).css("background-color", "");
                    }
                    $(col.selector).css("border", "");
                    $(col.selector + "Error").text("").hide();
                }
                //datos fuera del columns
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val("");
                $("#parts_auto").val("");

                //limpia valores
                updateStrokesPerAuto()
                updateBlanksPerYear()
                updateMinMaxReales()


                $("#addOrUpdateMaterial").html('<i class="fa-solid fa-plus"></i> Add Material');

            }

               function updateTheoreticalLine() {
                   // 1. Lee los valores de tus inputs
                   let tensilStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))").val();
                   let thicknessStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").val();
                   let widthStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").val();
                   let pitchStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val();
                   let plant = @Model.ID_Plant;
                   let typ = $("#ID_Material_type option:selected").val().toUpperCase();


                   // 2. Si alguno está vacío, borramos la línea teórica y salimos
                   if (!tensilStr || !thicknessStr || !widthStr || !pitchStr || !typ) {
                       $("#theoretical_blk_line").val("");
                       //borra los limites
                       window.engineeringRanges = null;
                        //valida los campon involucrados
                        validateTensileStrength("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
                        validateThickness("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
                        validateWidth("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
                       validatePitch("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");

                       //borra tooltips
                          // Si no existen rangos, limpiar todos los tooltips
                       $("#tensil-limit-id")
                          .attr("title", "Limits not available").tooltip('dispose').tooltip();
                      $("#thickness-limit-id")
                          .attr("title", "Limits not available").tooltip('dispose').tooltip();
                      $("#width-limit-id")
                          .attr("title", "Limits not available").tooltip('dispose').tooltip();
                      $("#pitch-limit-id")
                          .attr("title", "Limits not available").tooltip('dispose').tooltip();
                       return;
                   }

                   let tensil = parseFloat(tensilStr);
                   let thickness = parseFloat(thicknessStr);
                   let width = parseFloat(widthStr);
                   let pitch = parseFloat(pitchStr);

                   // 4. Aplica la lógica condicional
                   // Lógica condicional
                   let lineaTeorica = ""; // p.ej. "PUEBLA-BLK1"
                   if (plant === 1) {
                       // PUEBLA
                       if (typ == 3) { // E STEEL
                           lineaTeorica = "PUEBLA-BLK3";
                       } else if (typ == 4) { // UE STEEL
                           if (tensil <= 600 || width <= 1680) {
                               lineaTeorica = "PUEBLA-BLK1";
                           } else {
                               lineaTeorica = "PUEBLA-BLK2";
                           }
                       } else if (typ == 5) { // HS STEEL
                           lineaTeorica = "PUEBLA-BLK2";
                       }
                   } else if (plant === 2) {
                       // SILAO
                       if (typ == 1 || typ == 2 || typ == 5) {
                           // E ALU, UE ALU, HS STEEL
                           lineaTeorica = "SILAO-BLK3";
                       } else if (typ == 3) {
                           lineaTeorica = "SILAO-BLK1";
                       } else if (typ == 4) {
                           lineaTeorica = "SILAO-BLK2";
                       }
                   } else if (plant === 4) {
                       // SLP
                       lineaTeorica = "SLP-BLK1";
                   }

                   // Asignar en el input visible
                   $("#theoretical_blk_line").val(lineaTeorica);

                   // Buscar el ID en lineMap
                   let lineId = lineMap[lineaTeorica] || "";

                   // Asignar en el input hidden
                   $("#ID_Theoretical_Blanking_Line").val(lineId);

                    // Si lineId es válido, hacemos la llamada AJAX para obtener min y max
                   if (lineId) {
                       $.ajax({
                           url: '@Url.Action("GetEngineeringDimensions", "CTZ_Projects")',
                           data: { lineId: lineId },
                           type: 'GET',
                           success: function (data) {
                               // data es un array con { ID_Criteria, Min_Value, Max_Value }
                               // Guardamos estos rangos en variables globales o un objeto local
                               window.engineeringRanges = data;
                               updateEngineeringTooltips(); // Actualizamos los tooltips con los límites reales

                           },
                           error: function (err) {
                               console.error("Error getting engineering dimensions", err);
                           },
                           async: false
                       });
                   } else {
                       // si no hay lineId, limpiar
                       window.engineeringRanges = null;

                       $("#tensil-limit-id")
                           .attr("title", "Limits not available").tooltip('dispose').tooltip();
                       $("#thickness-limit-id")
                           .attr("title", "Limits not available").tooltip('dispose').tooltip();
                       $("#width-limit-id")
                           .attr("title", "Limits not available").tooltip('dispose').tooltip();
                       $("#pitch-limit-id")
                           .attr("title", "Limits not available").tooltip('dispose').tooltip();
                   }


                   //valida los campon involucrados
                   validateTensileStrength("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Tensile_Strenght))");
                   validateThickness("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))");
                   validateWidth("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))");
                   validatePitch("@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))");
               }


            // Re-numerar filas tras eliminación
            function renumberRows() {
                $("#materialsTable tbody tr").each(function (i, row) {
                    $(row).attr("data-index", i);
                    let hiddenInputs = $(row).find("input[name^='materials']");
                    hiddenInputs.each(function () {
                        let nameAttr = $(this).attr("name"); // p.ej. materials[3].Part_Number
                        let fieldName = nameAttr.substring(nameAttr.indexOf('.') + 1);
                        // fieldName => Part_Number
                        $(this).attr("name", `materials[${i}].${fieldName}`);
                    });
                });
            }

            function parseYearMonth(dateStr) {
                if (!dateStr) return null;
                var parts = dateStr.split("-");
                if (parts.length < 2) return null;
                return new Date(parts[0], parts[1] - 1, 1);
            }

             // Inicializar select2 y evento solo si es automotriz
           if (vehicleType == 1) {
                $("#Vehicle, #Vehicle_2, #Vehicle_3, #Vehicle_4").select2({ width: '100%' });

                $("#Vehicle, #Vehicle_2, #Vehicle_3, #Vehicle_4").on("change", function () {
                    recalculateVehicleData();
                });
            }

            function recalculateVehicleData() {
                // Supongamos que tienes una función similar a getVehicleData que, para cada combo,
                // obtiene un objeto incluyendo la propiedad productionData, la cual se extrae del atributo data-productionjson.
                function getVehicleData(selector) {
                    var selectedOption = $(selector).find("option:selected");
                    return {
                        sop: selectedOption.data("sop"),
                        eop: selectedOption.data("eop"),
                        program: selectedOption.data("program"),
                        maxProduction: selectedOption.data("maxproduction"),
                        productionJson: selectedOption.data("productionjson")
                    };
                }

                var data1 = getVehicleData("#Vehicle");
                var data2 = getVehicleData("#Vehicle_2");
                var data3 = getVehicleData("#Vehicle_3");
                var data4 = getVehicleData("#Vehicle_4");

                // Solo considerar aquellos vehículos que tienen un valor seleccionado y producción definida
                var selectedVehicles = [];
                [data1, data2, data3, data4].forEach(function(d) {
                    if (d && d.sop && d.productionJson) {
                        try {
                            d.productionData = JSON.parse(d.productionJson);
                        } catch (e) {
                            d.productionData = [];
                        }
                        selectedVehicles.push(d);
                    }
                });

                // Calcular el SOP (mínimo) y EOP (máximo) usando data de los vehículos seleccionados (si es necesario)
                var minSOP = null, maxEOP = null;
                selectedVehicles.forEach(function(d) {
                    var sopDate = new Date(d.sop);
                    var eopDate = new Date(d.eop);
                    console.log("SOP: " + sopDate + " EOP: " + eopDate)
                    if (!minSOP || sopDate < minSOP) minSOP = sopDate;
                    if (!maxEOP || eopDate > maxEOP) maxEOP = eopDate;
                });
                if (minSOP) $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.SOP_SP))").val(moment.utc(minSOP).format("YYYY-MM"));
                if (maxEOP) $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.EOP_SP))").val(moment.utc(maxEOP).format("YYYY-MM"));


                // Para Program_SP, tomar el del primer vehículo seleccionado
                if (data1 && data1.program) {
                    $("#programSP").val(data1.program);
                }

                // Calcular la suma de producción por año
                var productionByYear = {};
                selectedVehicles.forEach(function (d) {
                    console.log("Vehículo:", d);
                    if (d.productionJson && Array.isArray(d.productionJson)) {
                        d.productionJson.forEach(function (item) {
                            console.log("Item de producción:", item);
                            var year = item.Production_Year;
                            var sum = parseFloat(item.Production_Amount) || 0;
                            if (year) {
                                if (!productionByYear[year]) {
                                    productionByYear[year] = 0;
                                }
                                productionByYear[year] += sum;
                            }
                        });
                    }
                });
                console.log("Suma de producción por año:", productionByYear);

                // Determinar el año con mayor producción acumulada
                var maxProduction = 0, maxProductionYear = null;
                for (var year in productionByYear) {
                    if (productionByYear[year] > maxProduction) {
                        maxProduction = productionByYear[year];
                        maxProductionYear = year;
                    }
                }
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val(maxProduction);
                if (maxProductionYear) {
                    $("#maxProductionYearDisplay").text("Year: " + maxProductionYear);
                }
            }

            function updateRealStrokes() {

                var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Real_Blanking_Line)) option:selected").val();

                // Suponiendo que tienes los valores en los campos:
                var pitch = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val());
                var rotation = 0; // 0 de momento


                if (isNaN(pitch) || isNaN(rotation) || productionLineId == "") {
                    // Manejar error: se requieren ambos valores.
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GetTheoreticalStrokes", "CTZ_Projects")',
                    type: 'GET',
                    data: { productionLineId: productionLineId, pitch: pitch, rotation: rotation },
                    success: function(response) {
                        if (response.success) {
                            // Actualiza el campo de Theoretical_Strokes con el valor obtenido
                            var strokes = parseFloat(response.theoreticalStrokes);
                            var formattedStrokes = (strokes % 1 === 0) ? strokes : strokes.toFixed(2);
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val(formattedStrokes);
                        } else {
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
                            toastr.error("Error: "+ response);
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error("Error en Ajax: " + response.message);
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Real_Strokes))").val("");
                    },
                    async: false
                });
            }

            function updateStrokesPerAuto() {
                var partsVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val());
                var blanksVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());

                // Si alguno es inválido o la división no es posible, limpia el campo
                if (isNaN(partsVal) || isNaN(blanksVal) || blanksVal === 0) {
                    $("#strokes_auto").val("");
                } else {
                    var result = partsVal / blanksVal;
                    $("#strokes_auto").val(result.toFixed(2));
                }
            }

            function updateMinMaxReales() {
                var blanksPerYear = parseFloat($("#blanks_per_year").val());
                var idealCycleTime = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Ideal_Cycle_Time_Per_Tool))").val());
                var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());

                // Validamos que todos los valores sean números y que idealCycleTime y blanksPerStroke no sean 0
                if (isNaN(blanksPerYear) || isNaN(idealCycleTime) || isNaN(blanksPerStroke) || idealCycleTime === 0 || blanksPerStroke === 0) {
                    $("#min_max_reales").val("");
                } else {
                    var result = blanksPerYear / idealCycleTime / blanksPerStroke;
                    $("#min_max_reales").val(result.toFixed(2));
                }

                //tambien actualiza la version de OEE
                updateMinMaxRealesOEE();
            }


            function updateBlanksPerYear() {
                var partsVal = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Parts_Per_Vehicle))").val());
                var annualVolume = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val());

                // Verificar si alguno es inválido o nulo
                if (isNaN(partsVal) || isNaN(annualVolume)) {
                    $("#blanks_per_year").val("");
                } else {
                    var result = partsVal * annualVolume;
                    $("#blanks_per_year").val(result.toFixed(2));
                }

                //valida los campos que pudieran depender de este input
                updateMinMaxReales();
                updateStrokesShift();
            }

          function updateMinMaxRealesOEE() {
            var minMaxReales = parseFloat($("#min_max_reales").val());
            var oee = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.OEE))").val());

            if (isNaN(minMaxReales) || isNaN(oee) || oee === 0) {
                $("#min_max_reales_oee").val("");
            } else {
                // Normalizamos el OEE de porcentaje a valor decimal
                var oeeDecimal = oee / 100;
                var result = minMaxReales / oeeDecimal;
                $("#min_max_reales_oee").val(result.toFixed(2));
            }

            // Actualiza los turnos reales
            updateActualShifts();
        }


            function updateActualShifts() {
                var minMaxRealesOEE = parseFloat($("#min_max_reales_oee").val());

                // Verifica si el valor es válido (7.5 y 60 son constantes, por lo que no se espera división por 0)
                if (isNaN(minMaxRealesOEE)) {
                    $("#actual_shifts").val("");
                } else {
                    var result = minMaxRealesOEE / 7.5 / 60;
                    $("#actual_shifts").val(result.toFixed(2));
                }

                updateStrokesShift();
            }

            function updateStrokesShift() {
                var blanksPerYear = parseFloat($("#blanks_per_year").val());
                var blanksPerStroke = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val());
                var actualShifts = parseFloat($("#actual_shifts").val());

                if (isNaN(blanksPerYear) || isNaN(blanksPerStroke) || isNaN(actualShifts) || blanksPerStroke === 0 || actualShifts === 0) {
                    $("#strokes_shift").val("");
                } else {
                    var result = blanksPerYear / blanksPerStroke / actualShifts;
                    $("#strokes_shift").val(result.toFixed(0));
                }
            }


            function updateTheoreticalStrokes() {
                var productionLineId = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Theoretical_Blanking_Line))").val();

                // Suponiendo que tienes los valores en los campos:
                var pitch = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val());
                ////var rotation = parseFloat($("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val()); // valor de giro
                var rotation = 0; // 0 de momento


                if (isNaN(pitch) || isNaN(rotation) || productionLineId == "") {
                    // Manejar error: se requieren ambos valores.
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GetTheoreticalStrokes", "CTZ_Projects")',
                    type: 'GET',
                    data: { productionLineId: productionLineId, pitch: pitch, rotation: rotation },
                    success: function(response) {
                        if (response.success) {
                            // Actualiza el campo de Theoretical_Strokes con el valor obtenido
                            var strokes = parseFloat(response.theoreticalStrokes);
                            var formattedStrokes = (strokes % 1 === 0) ? strokes : strokes.toFixed(2);
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val(formattedStrokes);
                        } else {
                            $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
                            toastr.error("Error: "+ response);
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error("Error en Ajax: " + response.message);
                        $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Strokes))").val("");
                    },
                    async: false
                });
            }

            function updateTheoreticalGrossWeight() {

                // 1. Obtener los valores de los inputs
                let thicknessStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Thickness))").val().trim();
                let widthStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Width))").val().trim();
                let pitchStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Pitch))").val().trim();
                let blanksStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Blanks_Per_Stroke))").val().trim();
                let materialTypeStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)) option:selected").text().trim().toUpperCase();


                // Validar que los campos numéricos contengan valores válidos
                if (!thicknessStr || !widthStr || !pitchStr || !blanksStr || $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.ID_Material_type)) option:selected").val() =="") {
                    // Si falta alguno, se puede limpiar o dejar el campo sin actualizar
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val("");

                    return;
                }

                let thickness = parseFloat(thicknessStr);
                let width = parseFloat(widthStr);
                let pitch = parseFloat(pitchStr);
                let blanksPerStroke = parseFloat(blanksStr);

                // 2. Determinar la densidad según el tipo de material
                let density = 0;
                if (materialTypeStr.indexOf("STEEL") > -1) {
                    density = 7.85;
                } else if (materialTypeStr.indexOf("ALU") > -1) {
                    density = 2.7;
                } else {
                    // Si no se detecta ninguno de los casos, no se puede calcular
                  //  $("#TheoreticalGrossWeight").val("Type not valid");
                    return;
                }

                console.log("Densidad = " + density)
                // 3. Realizar el cálculo
                let weight = (thickness * width * pitch * density) / 1000000 / blanksPerStroke;

                // 4. Actualizar el campo de Theoretical Gross Weight (formatear si se desea)
                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Theoretical_Gross_Weight))").val(weight.toFixed(3));
            }


            // Función para actualizar los tooltips de los campos de ingeniería
            function updateEngineeringTooltips() {
                if (window.engineeringRanges) {
                    // Actualizar tooltip para Tensile Strength (ID_Criteria = 4)
                    let tensileRange = window.engineeringRanges.find(r => r.ID_Criteria === 4);
                    if (tensileRange) {
                        $("#tensil-limit-id").attr("title", `Allowed range: ${tensileRange.Min_Value} - ${tensileRange.Max_Value}`).tooltip('dispose').tooltip();
                    }
                    // Actualizar tooltip para Thickness (ID_Criteria = 1)
                    let thicknessRange = window.engineeringRanges.find(r => r.ID_Criteria === 1);
                    if (thicknessRange) {
                        $("#thickness-limit-id").attr("title", `Allowed range: ${thicknessRange.Min_Value} - ${thicknessRange.Max_Value}`).tooltip('dispose').tooltip();
                    }
                    // Actualizar tooltip para Width (ID_Criteria = 2)
                    let widthRange = window.engineeringRanges.find(r => r.ID_Criteria === 2);
                    if (widthRange) {
                        $("#width-limit-id").attr("title", `Allowed range: ${widthRange.Min_Value} - ${widthRange.Max_Value}`).tooltip('dispose').tooltip();
                    }
                    // Actualizar tooltip para Pitch (ID_Criteria = 3)
                    let pitchRange = window.engineeringRanges.find(r => r.ID_Criteria === 3);
                    if (pitchRange) {
                        $("#pitch-limit-id").attr("title", `Allowed range: ${pitchRange.Min_Value} - ${pitchRange.Max_Value}`).tooltip('dispose').tooltip();
                    }
                } else {
                    // Si no existen rangos, limpiar todos los tooltips
                    //borra tooltips
                    // Si no existen rangos, limpiar todos los tooltips
                     $("#tensil-limit-id")
                        .attr("title", "Limits not available").tooltip('dispose').tooltip();
                    $("#thickness-limit-id")
                        .attr("title", "Limits not available").tooltip('dispose').tooltip();
                    $("#width-limit-id")
                        .attr("title", "Limits not available").tooltip('dispose').tooltip();
                    $("#pitch-limit-id")
                        .attr("title", "Limits not available").tooltip('dispose').tooltip();
                }
            }

            function updateVehicleVisibility() {
                // Si Vehicle1 no tiene valor, ocultar Vehicle2, 3 y 4 y limpiar sus valores.
                if (!$("#Vehicle").val()) {
                    $("#Vehicle_2").closest(".col-md-6").hide();
                    $("#Vehicle_2").val(null).trigger("change.select2");
                    $("#Vehicle_3").closest(".col-md-6").hide();
                    $("#Vehicle_3").val(null).trigger("change.select2");
                    $("#Vehicle_4").closest(".col-md-6").hide();
                    $("#Vehicle_4").val(null).trigger("change.select2");
                } else {
                    // Si Vehicle1 tiene valor, mostrar Vehicle2.
                    $("#Vehicle_2").closest(".col-md-6").show();
                    // Si Vehicle2 no tiene valor, ocultar Vehicle3 y Vehicle4 y limpiar sus valores.
                    if (!$("#Vehicle_2").val()) {
                        $("#Vehicle_3").closest(".col-md-6").hide();
                        $("#Vehicle_3").val(null).trigger("change.select2");;
                        $("#Vehicle_4").closest(".col-md-6").hide();
                        $("#Vehicle_4").val(null).trigger("change.select2");;
                    } else {
                        // Si Vehicle2 tiene valor, mostrar Vehicle3.
                        $("#Vehicle_3").closest(".col-md-6").show();
                        // Si Vehicle3 no tiene valor, ocultar Vehicle4 y limpiar su valor.
                        if (!$("#Vehicle_3").val()) {
                            $("#Vehicle_4").closest(".col-md-6").hide();
                            $("#Vehicle_4").val(null).trigger("change.select2");;
                        } else {
                            // Si Vehicle3 tiene valor, mostrar Vehicle4.
                            $("#Vehicle_4").closest(".col-md-6").show();
                        }
                    }
                }
            }

            // Función que actualiza el fondo del input Annual_Volume según el porcentaje de diferencia
            function updateAnnualVolumeStyle() {
                // Obtenemos los valores
                let annualVolumeStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").val().trim();
                let maxProductionStr = $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Max_Production_SP))").val().trim();

                // Si alguno no tiene valor, salimos
                if (!annualVolumeStr || !maxProductionStr) {
                    // Podrías resetear el fondo a blanco
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", "");
                    return;
                }

                // Convertir a número
                let annualVolume = parseFloat(annualVolumeStr);
                let maxProduction = parseFloat(maxProductionStr);

                // Evitar división por cero
                if (maxProduction === 0) {
                    $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", "");
                    return;
                }

                // Calcular el ratio
                let ratio = annualVolume / maxProduction;
                // Calcular diferencia porcentual respecto a maxProduction
                let diffPercentage = ((annualVolume - maxProduction) / maxProduction) * 100;

                // Actualizar el fondo según el rango:
                // Verde: ratio entre 0.85 y 1.15
                // Amarillo: ratio entre 0.70 y 0.85 o entre 1.15 y 1.30
                // Rojo: cualquier otro caso
                let newBgColor = "";
                if (ratio >= 0.85 && ratio <= 1.15) {
                    newBgColor = "lightgreen";
                } else if ((ratio >= 0.70 && ratio < 0.85) || (ratio > 1.15 && ratio <= 1.30)) {
                    newBgColor = "lightyellow";
                } else {
                    newBgColor = "lightcoral";
                }

                $("#@(nameof(Portal_2_0.Models.CTZ_Project_Materials.Annual_Volume))").css("background-color", newBgColor);

                // Devuelve la diferencia porcentual para usar en el toast
                return diffPercentage;
            }

            // Función para mostrar el toast con la diferencia porcentual
            function showVolumeDifferenceToast(diffPercentage) {
                // Redondear a dos decimales
                let diffRounded = diffPercentage.toFixed(2);
                // Generar el mensaje: puede ser "x% above" o "x% below"
                let message = "";
                if (diffPercentage > 0) {
                    message = `${diffRounded}% above Max Production`;
                } else if (diffPercentage < 0) {
                    message = `${Math.abs(diffRounded)}% below Max Production`;
                } else {
                    message = "No difference with Max Production";
                }

                // Mostrar el toast
                toastr.info(message);
            }

            function redondearValor(elemento, decimales) {
                let value = parseFloat($(elemento).val());
                if (!isNaN(value)) {
                    let factor = Math.pow(10, decimales);
                    let rounded = Math.round(value * factor) / factor;
                    $(elemento).val(rounded);
                }
            }

        });
    </script>
}

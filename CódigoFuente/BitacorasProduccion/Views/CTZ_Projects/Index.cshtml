@model IEnumerable<Portal_2_0.Models.CTZ_Projects>
@{
    ViewBag.Title = "Projects List";
    ViewBag.FirstLevel = "quote";
    ViewBag.SecondLevel = "index_quotes";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";

    Clases.Util.MensajesSweetAlert mensajeAlerta = (Clases.Util.MensajesSweetAlert)ViewBag.MensajeAlert;

}

@section estilos {

    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet" />
    <!-- DataTables -->
    @Styles.Render("~/Content/dataTables_css")

    <style>
        /* DataTables header style */
        table.dataTable thead {
            background-color: #009ff5;
            color: white;
        }
        /* Override button style */
        .btn-primary {
            background-color: #009ff5;
            border-color: #009ff5;
        }
        /* Professional search panel */
        .search-panel {
            background: #f7f7f7;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

            .search-panel label {
                font-weight: bold;
            }
        /* Loading indicator overlay */
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
        }

            #loadingIndicator .spinner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 2em;
            }
    </style>
}

@*Para SweetAlert*@
@if (mensajeAlerta != null)
{
    <input type="hidden" value="@mensajeAlerta.Mensaje" id="mensajeAlert" />
    <input type="hidden" value="@mensajeAlerta.getTipoMensaje()" id="mensajeAlertTipo" />
}


<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>

        <!-- Header -->
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="nav navbar-right panel_toolbox">
                            <a href="@Url.Action("Create", "CTZ_Projects")" class="btn btn-primary">New Quote</a>
                        </div>
                        <div class="clearfix"></div>
                    </div>

                    <!-- Search Section -->
                    <div class="x_content">
                        @using (Html.BeginForm("Index", "CTZ_Projects", FormMethod.Post, new { id = "searchForm", @class = "form-horizontal" }))
                        {
                            @Html.AntiForgeryToken()
                            <div class="search-panel">
                                <div class="row">
                                    <!-- Campo de texto para Project -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchProject">Project</label>
                                            <input type="text" name="searchProject" id="searchProject" class="form-control" placeholder="Project" value="@Request["searchProject"]" />
                                        </div>
                                    </div>
                                    <!-- Combo para Client -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchClient">Client</label>
                                            <select name="searchClient" id="searchClient" class="form-control select2" style="width:100%;">
                                                @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ClientList)
                                                {
                                                    <option value="@item.Value" @(Request["searchClient"] == item.Value ? "selected" : "")>@item.Text</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Combo para Facility -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchFacility">Facility</label>
                                            <select name="searchFacility" id="searchFacility" class="form-control select2" style="width:100%;">
                                                @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.FacilityList)
                                                {
                                                    <option value="@item.Value" @(Request["searchFacility"] == item.Value ? "selected" : "")>@item.Text</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Combo para Status -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchStatus">Status</label>
                                            <select name="searchStatus" id="searchStatus" class="form-control select2" style="width:100%;">
                                                @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.StatusList)
                                                {
                                                    <option value="@item.Value" @(Request["searchStatus"] == item.Value ? "selected" : "")>@item.Text</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Combo para Created By -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchCreatedBy">Created By</label>
                                            <select name="searchCreatedBy" id="searchCreatedBy" class="form-control select2" style="width:100%;">
                                                @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.CreatedByList)
                                                {
                                                    <option value="@item.Value" @(Request["searchCreatedBy"] == item.Value ? "selected" : "")>@item.Text</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Fecha inicio -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchDateStart">Created Date Start</label>
                                            <input type="date" name="searchDateStart" id="searchDateStart" class="form-control" value="@Request["searchDateStart"]" />
                                        </div>
                                    </div>
                                    <!-- Fecha fin -->
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label for="searchDateEnd">Created Date End</label>
                                            <input type="date" name="searchDateEnd" id="searchDateEnd" class="form-control" value="@Request["searchDateEnd"]" />
                                        </div>
                                    </div>
                                    <!-- Botón Search  -->
                                    <div class="col-md-2">
                                        <div class="form-group" style="margin-top:25px;">
                                            <button type="submit" id="btnSearch" class="btn btn-warning btn-block"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
                                        </div>
                                    </div>
                                    <!-- Botón Clear Filters -->
                                    <div class="col-md-2">
                                        <div class="form-group" style="margin-top:25px;">
                                            <button type="button" id="btnClear" class="btn btn-info btn-block"><i class="fa-solid fa-filter-circle-xmark"></i> Clear Filters</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <!-- Fin del formulario de búsqueda -->
                        <!-- Projects Table -->
                        <div class="table-responsive">
                            <table id="projectsTable" class="table table-striped table-bordered" style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Project ID</th>
                                        <th>Status</th>
                                        <th>Client</th>
                                        <th>OEM</th>
                                        <th>Facility</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Lasted Version</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var project in Model)
                                    {
                                        <tr>
                                            <td>@project.ConcatQuoteID</td>
                                            <td>@Html.DisplayFor(model => project.CTZ_Project_Status.ConcatStatus)</td>
                                            <td>@(project.CTZ_Clients != null ? project.CTZ_Clients.Client_Name : project.Cliente_Otro)</td>
                                            <td>@(project.CTZ_OEMClients != null ? project.CTZ_OEMClients.Client_Name : project.OEM_Otro)</td>
                                            <td>@Html.DisplayFor(model => project.CTZ_plants.Description)</td>
                                            <td>@(project.empleados != null ? project.empleados.nombre : "Unknown")</td>
                                            <td>@project.Creted_Date.ToString("MM/dd/yyyy")</td>
                                            <td>@project.LastedVersionNumber</td>
                                            <td>
                                                <a href="@Url.Action("EditProject", "CTZ_Projects", new { id = project.ID_Project })" class="btn btn-warning btn-xs" style="color:#2a2a2a;">Edit</a>                             
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <!-- Fin de la tabla -->
                    </div><!-- x_content -->
                </div><!-- x_panel -->
            </div><!-- col -->
        </div><!-- row -->
    </div><!-- container -->
</div>

<!-- Loading indicator -->
<div id="loadingIndicator">
    <div class="spinner">
        Loading...
    </div>
</div>

@section Scripts {
    <!-- SweetAlert2 -->
    @Scripts.Render(Url.Content("~/Content/vendors/sweetalert2/sweetalert2.min.js"))
    <!-- Lee la variable temporal de mensaje y muestra Toast -->
    @Scripts.Render(Url.Content("~/Scripts/AlertasSweetAlert.js"))
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <!-- DataTables -->
    @Scripts.Render("~/bundles/dataTables_js")
    <script>
        $(document).ready(function () {
            // Inicializar Select2 en los selects de búsqueda
            $(".select2").select2({ width: '100%' });

            // Inicializar DataTable
            $("#projectsTable").DataTable({
                responsive: false,
                autoWidth: false,
                order: [] // No define una columna de ordenamiento inicial, pero permite el ordemiento manual
            });

            // Función de debounce para retrasar el envío del formulario
            var debounce = function (func, delay) {
                var inDebounce;
                return function () {
                    var context = this;
                    var args = arguments;
                    clearTimeout(inDebounce);
                    inDebounce = setTimeout(function () {
                        func.apply(context, args);
                    }, delay);
                };
            };

            // Auto-submit en combos: enviar el formulario al cambiar el valor
            $("#searchClient, #searchFacility, #searchStatus, #searchCreatedBy").change(function () {
                $("#searchForm").submit();
            });

            // Auto-submit en el input de Project cuando deja de escribir (2 segundos)
            $("#searchProject").on("keyup", debounce(function () {
                $("#searchForm").submit();
            }, 1500));

            // Auto-submit en los inputs de fecha (2 segundos después de cambiar)
            $("#searchDateStart, #searchDateEnd").on("change", debounce(function () {
                $("#searchForm").submit();
            }, 1500));

            // Botón "Clear Filters": reinicia todos los campos y envía el formulario
            $("#btnClear").click(function () {
                $("#searchProject").val("");
                $("#searchDateStart").val("");
                $("#searchDateEnd").val("");
                $("#searchClient").val("0").trigger("change");
                $("#searchFacility").val("0").trigger("change");
                $("#searchStatus").val("0").trigger("change");
                $("#searchCreatedBy").val("0").trigger("change");
                $("#searchForm").submit();
            });

            // Mostrar indicador de carga al enviar el formulario
            $("#searchForm").submit(function () {
                $("#loadingIndicator").fadeIn();
            });
        });
    </script>
}

@model Portal_2_0.Models.CTZ_Projects

@using Portal_2_0.Models
@using Portal_2_0.Controllers



@{

    ViewBag.nav_style = "nav-sm"; // Requerido por el JS de la vista padre
    ViewBag.FirstLevel = "quote";
    ViewBag.SecondLevel = "create_quote";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var countries = ViewBag.CountriesWithWarning as List<CountryWithWarningVm>
                  ?? new List<CountryWithWarningVm>();

    var isNew = Model.ID_Project == 0;
    ViewBag.Title = isNew ? "Create Project" : "Edit Project";
}

@section estilos {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet" />
    <style>
        /* Fuentes generales */
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #009ff5;
        }

        /* Contenedor principal */
        .x_panel {
            background: #fff;
            border: 1px solid #e6e9ed;
            border-radius: 6px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            padding: 20px 25px;
            margin-bottom: 30px;
        }

        .x_title {
            border-bottom: 2px solid #009ff5;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

            .x_title h2 {
                color: #009ff5;
                font-weight: 600;
                font-size: 22px;
                margin: 0;
            }

        /* Estilos de las "cards" de secciones del formulario */
        .form-card {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

            .form-card h3 {
                font-size: 16px;
                font-weight: 600;
                color: #009ff5;
                margin-bottom: 15px;
                border-bottom: 1px solid #009ff5;
                padding-bottom: 5px;
            }

        /* Formularios compactos */
        .form-horizontal .form-group {
            margin-bottom: 12px;
        }

        .control-label {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .form-control {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 8px 10px;
            height: 38px;
        }

            .form-control:focus {
                border-color: #009ff5;
                box-shadow: 0 0 4px rgba(0,159,245,0.3);
            }

        /* Distribución compacta con columnas fijas */
        .compact-row {
            display: flex;
            flex-wrap: wrap;
            margin: -5px;
        }

            .compact-row .compact-col {
                padding: 5px;
                flex: 1 1 250px; /* Mínimo 250px, se expanden en pantallas grandes */
            }

        /* Botones */
        .btn-success {
            background-color: #009ff5;
            border-color: #009ff5;
            border-radius: 3px;
            padding: 8px 15px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

            .btn-success:hover {
                background-color: #007dbb;
                border-color: #007dbb;
            }

        .btn-default {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            color: #555;
            border-radius: 3px;
            padding: 8px 15px;
        }

        hr {
            border-top: 1px solid #e6e9ed;
            margin: 20px 0;
        }

        .additional-section {
            background: #f9f9f9;
            border: 1px dashed #ccc;
            padding: 15px;
            margin-bottom: 20px;
            display: none; /* Se oculta inicialmente */
        }

            .additional-section h4 {
                color: #009ff5;
                margin-bottom: 10px;
            }

        .toast {
            opacity: 0.92 !important; /* o el valor que desees */
        }

        #shiftLegend {
            border: solid 1px gray;
            padding-top: 8px;
            padding-bottom: 8px;
            display: none;
        }

            #shiftLegend .legend-item {
                display: inline-block;
                margin: 0 20px;
                font-size: 0.9em;
                color: #333;
            }

            #shiftLegend .legend-line {
                display: inline-block;
                width: 30px;
                height: 0;
                border-top: 2px dashed;
                margin-right: 6px;
                vertical-align: middle;
            }

        .highlight-label {
            background-color: #ffe75d; /* Un color amarillo tipo marcatextos */
            padding: 2px 6px; /* Un poco de espacio para que no se vea apretado */
            border-radius: 3px; /* Esquinas ligeramente redondeadas para un look más suave */
            display: inline-block; /* Asegura que el fondo se aplique correctamente */
        }
    </style>
}


<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        @using (Html.BeginForm())
                        {
                            @Html.AntiForgeryToken()
                            @Html.HiddenFor(model => model.ID_Project)

                            <div class="form-horizontal">
                                @if (!Html.ViewData.ModelState.IsValid)
                                {
                                    <div class="alert alert-danger" role="alert">
                                        @Html.ValidationSummary("", new { @class = "text-white" })
                                    </div>
                                }
                                <!-- Sección de Material Owner, Facility y Status -->
                                <div class="form-card">
                                    <h3>Project Details</h3>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.ID_Material_Owner, new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Material_Owner, null, "-- Select Material Owner --", new { @class = "form-control select2", id = "ID_Material_Owner", required = "required" })
                                            @Html.ValidationMessageFor(model => model.ID_Material_Owner, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.ID_Plant, new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Plant, null, "-- Select Facility --", new { @class = "form-control select2", required = "required" })
                                            @Html.ValidationMessageFor(model => model.ID_Plant, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.ID_Status, new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Status, null, "-- Select Status --", new { @class = "form-control select2", required = "required" })
                                            @Html.ValidationMessageFor(model => model.ID_Status, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.ID_VehicleType, new { @class = "control-label highlight-label" })
                                            @Html.DropDownListFor(model => model.ID_VehicleType, null, "-- Select Vehicle Type --", new { @class = "form-control select2", required = "required" })
                                            @Html.ValidationMessageFor(model => model.ID_VehicleType, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.ImportRequired, new { @class = "control-label" })
                                            <div class="checkbox">
                                                @Html.CheckBoxFor(model => model.ImportRequired, new { id = "ImportRequired" })
                                                <label for="ImportRequired">Import Required</label>
                                            </div>
                                            @Html.ValidationMessageFor(model => model.ImportRequired, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                </div>


                                <!-- Sección adicional para Material Owner (cuando se selecciona OWN o id=1) -->
                                <div id="materialOwnerAdditionalSection" class="additional-section">
                                    <h4>Additional Data for Material Owner</h4>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.LabelFor(m => m.ID_Incoterm, "Incoterm", new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Incoterm, null,
                                                "-- Select Incoterm --",
                                                new { @class = "form-control select2", id = "incoterm1" })
                                            @Html.ValidationMessageFor(m => m.ID_Incoterm, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="compact-col">
                                            @Html.LabelFor(m => m.ID_Country_Origin, "Material Origin", new { @class = "control-label" })
                                            <select id="country1"
                                                    name="ID_Country_Origin"
                                                    class="form-control select2">
                                                <option value="">-- Select Country --</option>
                                                @foreach (var c in countries)
                                                {
                                                    <option value="@c.ID_Country"
                                                            data-warning="@c.Warning.ToString().ToLower()"
                                                            @(Model.ID_Country_Origin == c.ID_Country ? "selected" : "")>
                                                        @c.ConcatKey
                                                    </option>
                                                }
                                            </select>
                                            @Html.ValidationMessageFor(m => m.ID_Country_Origin, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="compact-col" style="display:none">
                                            @Html.LabelFor(model => model.Mults, new { @class = "control-label" })
                                            @Html.TextBoxFor(model => model.Mults, new { @class = "form-control", placeholder = "Mults" })
                                            @Html.ValidationMessageFor(model => model.Mults, "", new { @class = "text-danger" })
                                        </div>

                                    </div>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.Comments_Material_Owner, new { @class = "control-label" })
                                            @Html.TextAreaFor(model => model.Comments_Material_Owner, new { @class = "form-control", placeholder = "Enter your comments...", rows = "4" })
                                            @Html.ValidationMessageFor(model => model.Comments_Material_Owner, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                </div>

                                <!-- Sección adicional para Import Required -->
                                <div id="importAdditionalSection" class="additional-section">
                                    <h4>Import Additional Data</h4>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.LabelFor(m => m.ID_Import_Business_Model, "Business Model", new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Import_Business_Model, null,
                                                "-- Select a Business Model --",
                                                new { @class = "form-control select2", id = "modelo_negocio" })
                                            @Html.ValidationMessageFor(m => m.ID_Import_Business_Model, "", new { @class = "text-danger" })
                                        </div>
                                        <div class="compact-col">
                                            @Html.Label("incoterm2", "Incoterm", new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Incoterm, null,
                                                "-- Select Incoterm --",
                                                new { @class = "form-control select2", id = "incoterm2" })
                                            @Html.ValidationMessageFor(m => m.ID_Incoterm, "", new { @class = "text-danger" })

                                        </div>
                                        <div class="compact-col">
                                            @Html.Label("country2", "Material Origin", new { @class = "control-label" })
                                            <select id="country2"
                                                    name="ID_Country_Origin"
                                                    class="form-control select2">
                                                <option value="">-- Select Country --</option>
                                                @foreach (var c in countries)
                                                {
                                                    <option value="@c.ID_Country"
                                                            data-warning="@c.Warning.ToString().ToLower()"
                                                            @(Model.ID_Country_Origin == c.ID_Country ? "selected" : "")>
                                                        @c.ConcatKey
                                                    </option>
                                                }
                                            </select>
                                            @Html.ValidationMessageFor(m => m.ID_Country_Origin, "", new { @class = "text-danger" })

                                        </div>
                                    </div>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.LabelFor(model => model.Comments_Import, new { @class = "control-label" })
                                            @Html.TextAreaFor(model => model.Comments_Import, new { @class = "form-control", placeholder = "Enter your comments...", rows = "4" })
                                            @Html.ValidationMessageFor(model => model.Comments_Import, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                </div>

                                <!-- Sección de Client y OEM -->
                                <div class="form-card">
                                    <h3>Client / OEM Information</h3>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            @Html.Label("Client", new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_Client, null, "-- Select Client --", new { @class = "form-control select2", id = "ID_Client" })
                                            @Html.ValidationMessageFor(model => model.ID_Client, "", new { @class = "text-danger" })
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" id="chkOtherClient" name="chkOtherClient" @( (ViewBag.OtherClient != null && (bool)ViewBag.OtherClient) || !string.IsNullOrEmpty(Model.Cliente_Otro) ? "checked" : "") /> Other Client
                                                </label>
                                            </div>
                                            <div id="divOtherClient" style="margin-top: 15px;">
                                                <div class="form-group">
                                                    @Html.LabelFor(m => m.Cliente_Otro, "Client Name", new { @class = "control-label" })
                                                    @Html.TextBoxFor(m => m.Cliente_Otro, new { @class = "form-control", placeholder = "Enter client name" })
                                                    @Html.ValidationMessageFor(m => m.Cliente_Otro, "", new { @class = "text-danger" })
                                                </div>
                                                <div class="form-group">
                                                    @Html.LabelFor(m => m.OtherClient_Address, "Address", new { @class = "control-label" })
                                                    @Html.TextAreaFor(m => m.OtherClient_Address, new { @class = "form-control", placeholder = "Enter client address", @rows = 2 })
                                                    @Html.ValidationMessageFor(m => m.OtherClient_Address, "", new { @class = "text-danger" })
                                                </div>
                                                <div class="form-group">
                                                    @Html.LabelFor(m => m.OtherClient_Telephone, "Telephone", new { @class = "control-label" })
                                                    @Html.TextBoxFor(m => m.OtherClient_Telephone, new { @class = "form-control", placeholder = "Enter telephone" })
                                                    @Html.ValidationMessageFor(m => m.OtherClient_Telephone, "", new { @class = "text-danger" })
                                                </div>
                                            </div>
                                        </div>
                                        <div class="compact-col">
                                            @Html.Label("OEM / Final Client", new { @class = "control-label" })
                                            @Html.DropDownListFor(model => model.ID_OEM, null, "-- Select OEM --", new { @class = "form-control select2", id = "ID_OEM" })
                                            @Html.ValidationMessageFor(model => model.ID_OEM, "", new { @class = "text-danger" })
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" id="chkOtherOEM" name="chkOtherOEM" @( (ViewBag.OtherOEM != null && (bool)ViewBag.OtherOEM) || !string.IsNullOrEmpty(Model.OEM_Otro) ? "checked" : "") /> Other OEM / Final Client
                                                </label>
                                            </div>
                                            <div id="divOtherOEM" style="margin-top: 15px;">
                                                <div class="form-group">
                                                    @Html.LabelFor(m => m.OEM_Otro, "OEM Name", new { @class = "control-label" })
                                                    @Html.TextBoxFor(m => m.OEM_Otro, new { @class = "form-control", placeholder = "Enter OEM name" })
                                                    @Html.ValidationMessageFor(m => m.OEM_Otro, "", new { @class = "text-danger" })
                                                </div>
                                                <div class="form-group">
                                                    @Html.LabelFor(m => m.OtherOEM_Address, "Address", new { @class = "control-label" })
                                                    @Html.TextAreaFor(m => m.OtherOEM_Address, new { @class = "form-control", placeholder = "Enter OEM address", @rows = 2 })
                                                    @Html.ValidationMessageFor(m => m.OtherOEM_Address, "", new { @class = "text-danger" })
                                                </div>
                                                <div class="form-group">
                                                    @Html.LabelFor(m => m.OtherOEM_Telephone, "Telephone", new { @class = "control-label" })
                                                    @Html.TextBoxFor(m => m.OtherOEM_Telephone, new { @class = "form-control", placeholder = "Enter telephone" })
                                                    @Html.ValidationMessageFor(m => m.OtherOEM_Telephone, "", new { @class = "text-danger" })
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>



                                <!-- Sección de fechas y Quote ID -->
                                <div class="form-card">
                                    <h3>Project Metadata</h3>
                                    <div class="compact-row">
                                        <div class="compact-col">
                                            <label class="control-label">Created By</label>
                                            <input type="text" class="form-control" value="@(((empleados)ViewBag.EmpleadoLogeado).ConcatNombre)" disabled="disabled" readonly="readonly" />
                                        </div>
                                        <div class="compact-col">
                                            <label class="control-label">Creation Date</label>
                                            <input type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" disabled="disabled" readonly="readonly" />
                                        </div>
                                        <div class="compact-col">
                                            <label class="control-label">@Html.DisplayNameFor(model => model.ConcatQuoteID)</label>
                                            <input type="text" class="form-control" value="TBD" disabled="disabled" readonly="readonly" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Sección de Comments -->
                                <div class="form-card">
                                    <h3>Comments</h3>
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.Comments, new { @class = "control-label" })
                                        @Html.TextAreaFor(model => model.Comments, new { @class = "form-control", placeholder = "Enter your comments...", rows = "4" })
                                        @Html.ValidationMessageFor(model => model.Comments, "", new { @class = "text-danger" })
                                    </div>
                                </div>


                                <!-- chartsContainer -->
                                <div class="form-card">
                                    <!-- Texto de aclaración en inglés -->
                                    <div id="chartsNote" style="margin-bottom: 20px; background-color:#fff3cb; padding:15px; border:1px solid #ddd; border-radius:4px; display:none;">
                                        <p style="margin:0; font-size:14px; color:#333;">
                                            <b>Note</b>: The capacity shown in the graphs represents the current operating capacity and does not include the capacity allocated for the current project.
                                        </p>
                                    </div>
                                    <div id="chartsContainer"></div>
                                    <!-- LEGEND: leyenda de turnos fuera del canvas -->
                                    <div id="shiftLegend" class="mt-3 text-center"></div>
                                </div>

                                <!-- Botón Submit -->
                                <div class="text-right">
                                    <button type="submit" class="btn btn-success">@(isNew ? "Create" : "Save Changes")</button>
                                </div>
                            </div>
                        }
                        <div class="mt-3">
                            @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-default" })
                        </div>
                    </div><!-- x_content -->
                </div><!-- x_panel -->
            </div><!-- col -->
        </div><!-- row -->
    </div><!-- container-fluid -->
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>



    <script>
        // Mapeo de ID_Status => color
        var statusColors = {
            "POH": "#0098f7",   // POH
            "Casi Casi": "#ffd400",   // Casi Casi
            "Carry Over": "#aaaaaa",   // Carry Over
            "Quotes": "#01c401"    // Quotes
        };

        // Mapeo de ID_Status => etiqueta legible
        var statusLabels = {
            "POH": "POH",
            "Casi Casi": "Casi Casi",
            "Carry Over": "Carry Over",
            "Quotes": "Quotes"
        };

        $(document).ready(function () {
            // sincronizar Incoterms espejo
            $("#incoterm1, #incoterm2").on("change", function () {
                var v = $(this).val();
                $("#incoterm1, #incoterm2").val(v);
                $('#incoterm1, #incoterm2').select2('destroy').select2({ width: '100%' });
            });
            // sincronizar País espejo
            $("#country1, #country2").on("change", function () {
                var $this = $(this),
                    val = $this.val();

                // 1) Sincroniza el valor en ambos selects
                $("#country1, #country2").val(val);

                // 2) Re-inicializa Select2 para refrescar el texto
                $("#country1, #country2")
                    .select2('destroy')
                    .select2({ width: '100%' });

                // 3) Comprueba el data-warning del <option> seleccionado
                var warning = $this.find('option:selected').data('warning');

                console.log(warning)
                if (warning === true || warning === 'true') {
                    toastr.warning(
                        "Warning: choosing this country may incur additional costs due to export tariffs, customs fees, etc.",
                        "Export Warning"
                    );
                }
            });

            // Inicializar Select2 en los selects
            $(".select2").select2({ width: '100%' });

            // Inicializar el estado de las secciones adicionales
            toggleImportAdditional();
            toggleMaterialOwnerAdditional();

            // Evento para el combo de tipo de vehículo
            $('#ID_VehicleType').on('change', updateOemSectionState);

            // Funcionalidad para Client: al marcar "Other Client"
            $("#chkOtherClient").change(function () {
                handleClientFields();
            });

              // Evento para el DROPDOWN de Cliente
            $('#ID_Client').on('change', function() {
                if ($('#chkOtherClient').is(':checked')) return; // Si "Other" está marcado, no hacemos nada

                const clientId = $(this).val();

                const clientName = $(this).find('option:selected').text();

                if (clientId) {
                    $('#Cliente_Otro').val(clientName);

                    // Llamada AJAX para obtener los datos del cliente
                    $.getJSON('@Url.Action("GetClientDetails")', { id: clientId }, function(data) {
                        if (data) {
                            //$('#Cliente_Otro').val(''); // El nombre "Otro" no aplica aquí
                            $('#OtherClient_Address').val(data.Address);
                            $('#OtherClient_Telephone').val(data.Telephone);
                        }
                    });
                } else {
                    // Si no hay cliente seleccionado, limpiar campos
                    $('#OtherClient_Address').val('');
                    $('#OtherClient_Telephone').val('');
                }
            });

            // Funcionalidad para OEM/Final Client: al marcar "Other OEM / Final Client"
            $('#chkOtherOEM').on('change', updateOemSectionState);


            $('#ID_OEM').on('change', function() {
                if ($('#chkOtherOEM').is(':checked')) return;
                const oemId = $(this).val();

                const oemName = $(this).find('option:selected').text();

                if (oemId) {
                    $('#OEM_Otro').val(oemName);

                    $.getJSON('@Url.Action("GetOemDetails")', { id: oemId }, function(data) {
                        if (data) {
                            //$('#OEM_Otro').val('');
                            $('#OtherOEM_Address').val(data.Address);
                            $('#OtherOEM_Telephone').val(data.Telephone);
                        }
                    });
                } else {
                    $('#OtherOEM_Address').val('');
                    $('#OtherOEM_Telephone').val('');
                }
            });
            

            $("#ImportRequired").change(function () {
                toggleImportAdditional();
            });

            $("#ID_Material_Owner").change(function () {
                toggleMaterialOwnerAdditional();
            });

            $("#ID_Plant").on("change", function () {
                var selectedPlantId = $(this).val();
                if (selectedPlantId) {
                    $.ajax({
                        url: '/CTZ_Projects/GetProductionLineData',
                        type: 'GET',
                        dataType: 'json',
                        data: {
                            plantId: selectedPlantId,
                            applyDateFilter: true  // <-- ESTA ES LA LÍNEA NUEVA
                        },
                        success: function (response) {
                            if (response.success) {
                                console.log(response)
                                // Recorremos los datos para verificar si algún FY rebasa el 100%
                                response.data.forEach(function (lineData) {
                                    lineData.DataByFY.forEach(function (fyItem) {
                                        var totalPercentage = 0;
                                        if (fyItem.Breakdown && fyItem.Breakdown.length > 0) {
                                            fyItem.Breakdown.forEach(function (b) {
                                                totalPercentage += b.Percentage;
                                            });
                                        }
                                        if (totalPercentage > 100) {
                                            // Mostrar un toast de advertencia para esta línea y FY
                                            toastr.warning(
                                                "Line " + lineData.LineName + " in " + fyItem.FiscalYear +
                                                " exceeds 100% capacity (" + totalPercentage.toFixed(2) + "%)"
                                            );
                                        }
                                    });
                                });

                                // Luego se generan las gráficas con la función generateCharts
                                generateCharts(response.data);
                            } else {
                                toastr.error("Error: " + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            toastr.error("Ha ocurrido un error: " + error);
                        }
                    });
                } else {
                    $("#chartsContainer").empty();
                }
            });

            //la primera vez que carga llama al evento change
            $('#ID_Plant').trigger('change');
            handleClientFields();
            updateOemSectionState();
        });

        const totalLabelPlugin = {
            id: 'totalLabelPlugin',
            // Se ejecuta después de dibujar los datasets
            afterDatasetsDraw(chart, args, options) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;

                ctx.save();
                ctx.font = options.font || 'bold 12px sans-serif';
                ctx.fillStyle = options.textColor || '#000';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';

                //las etiquetas se reparten uniformemente a lo largo del eje X
                const numLabels = chart.data.labels.length;
                const colWidth = (chartArea.right - chartArea.left) / numLabels;

                chart.data.labels.forEach((label, index) => {
                    // Calcular la suma de los valores en esa posición (acumulado)
                    let total = 0;
                    chart.data.datasets.forEach(dataset => {
                        total += dataset.data[index] || 0;
                    });

                    // Obtener la posición en Y para el valor total
                    let yPos = yScale.getPixelForValue(total);
                    // Obtener la posición en X como el centro de la "columna"
                    let xPos = chartArea.left + colWidth * index + colWidth / 2;

                    // Dibujar el texto (con dos decimales y "%")
                    ctx.fillText(total.toFixed(2) + "%", xPos, yPos - 2);
                });

                ctx.restore();
            }
        };

        // Plugin personalizado para dibujar una línea vertical al mover el mouse
        const verticalLinePlugin = {
            id: 'verticalLinePlugin',
            afterDatasetsDraw(chart, args, options) {

                // Verificar si hay un punto activo (tooltip visible)
                if (chart.tooltip && chart.tooltip._active && chart.tooltip._active.length) {
                    // Tomamos el primer punto activo (index)
                    let activePoint = chart.tooltip._active[0];
                    let ctx = chart.ctx;
                    let x = activePoint.element.x;
                    let topY = chart.chartArea.top;
                    let bottomY = chart.chartArea.bottom;

                    // Dibujamos la línea
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, topY);
                    ctx.lineTo(x, bottomY);
                    ctx.lineWidth = options.lineWidth || 2;       // grosor
                    ctx.strokeStyle = options.lineColor || 'pink'; // color
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };

        function handleClientFields() {
            if ($('#chkOtherClient').is(':checked')) {
                // MODO "OTHER": Habilitar campos para entrada manual
                $('#ID_Client').val("").trigger('change.select2').prop('disabled', true);
                $('#Cliente_Otro, #OtherClient_Address, #OtherClient_Telephone').prop('readonly', false).val('');
                $('#Cliente_Otro').focus();
            } else {
                console.log('no seleccionadoentra')

                // MODO "SELECCIÓN": Deshabilitar campos y llenarlos desde la BD
                $('#ID_Client').prop('disabled', false);
                $('#Cliente_Otro, #OtherClient_Address, #OtherClient_Telephone').prop('readonly', true).val('');
                // Disparar el evento change para (re)cargar los datos del cliente seleccionado
                $('#ID_Client').trigger('change');
            }
        }
             

        function generateCharts(data) {
            // Limpiar el contenedor principal de gráficos
            $("#chartsContainer").empty();
            var currentRow = null;
            var charts = [];      // <-- aquí acumularemos las instancias


            // Iterar sobre cada línea de producción (cada gráfica)
            data.forEach(function (lineData, index) {
                // Comenzar una nueva fila cada 2 gráficos
                if (index % 2 === 0) {
                    currentRow = $('<div class="row" style="margin-bottom:20px;"></div>');
                    $("#chartsContainer").append(currentRow);
                }

                // Crear un contenedor de columna (col-md-6)
                var colDiv = $('<div class="col-md-6"></div>');

                // --- Paso 1: Filtrar los años fiscales que tienen datos ---
                var fyData = lineData.DataByFY;
                var startIdx = 0, endIdx = fyData.length - 1;
                for (let i = 0; i < fyData.length; i++) {
                    if (fyData[i].Breakdown && fyData[i].Breakdown.some(b => b.Percentage > 0)) {
                        startIdx = i;
                        break;
                    }
                }
                for (let i = fyData.length - 1; i >= 0; i--) {
                    if (fyData[i].Breakdown && fyData[i].Breakdown.some(b => b.Percentage > 0)) {
                        endIdx = i;
                        break;
                    }
                }
                var filteredFYData = (startIdx <= endIdx) ? fyData.slice(startIdx, endIdx + 1) : fyData;
                var labels = filteredFYData.map(fy => fy.FiscalYear);

                // --- Paso 2: Armar datasets agrupados por estatus ---
                var statusMap = {};  // Key: StatusId, Value: { label, data: [], backgroundColor }
                filteredFYData.forEach(function (fyItem) {
                    if (fyItem.Breakdown) {
                        fyItem.Breakdown.forEach(function (b) {
                            if (!statusMap[b.StatusId]) {
                                statusMap[b.StatusId] = {
                                    statusId: b.StatusId,
                                    label: statusLabels[b.StatusId] || ("Status " + b.StatusId),
                                    data: [],
                                    backgroundColor: statusColors[b.StatusId] || "#999999"
                                };
                            }
                        });
                    }
                });
                Object.keys(statusMap).forEach(function (statusId) {
                    filteredFYData.forEach(function (fyItem) {
                        var entry = (fyItem.Breakdown || []).find(b => b.StatusId == statusId);
                        statusMap[statusId].data.push(entry ? entry.Percentage : 0);
                    });
                });
                // Ordenar los datasets según el orden deseado
                var desiredOrder = ["POH", "Casi Casi", "Carry Over", "Quotes"];
                var datasets = Object.values(statusMap).sort(function (a, b) {
                    var indexA = desiredOrder.indexOf(a.label);
                    var indexB = desiredOrder.indexOf(b.label);
                    indexA = indexA === -1 ? desiredOrder.length : indexA;
                    indexB = indexB === -1 ? desiredOrder.length : indexB;
                    return indexA - indexB;
                });

                // --- Paso 3: Calcular el máximo acumulado para configurar el eje Y ---
                var maxAcc = 0;
                for (let i = 0; i < filteredFYData.length; i++) {
                    let sum = 0;
                    datasets.forEach(ds => {
                        sum += ds.data[i] || 0;
                    });
                    if (sum > maxAcc) {
                        maxAcc = sum;
                    }
                }
                var maxPercentage = Math.ceil(Math.max(100, maxAcc) * 1.1);

                // --- Paso 4: Crear el canvas para la gráfica y agregarlo a la columna ---
                colDiv.append('<h4>' + lineData.LineName + '</h4>');
                var canvasId = "chartLine_" + lineData.LineId;
                colDiv.append('<canvas id="' + canvasId + '"></canvas>');
                currentRow.append(colDiv);

                // --- Paso 5: Generar la gráfica con Chart.js ---
                var ctx = document.getElementById(canvasId).getContext("2d");
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets.map(function (ds) {
                            return {
                                label: ds.label,
                                data: ds.data,
                                backgroundColor: ds.backgroundColor,
                                borderColor: ds.backgroundColor,
                                fill: true,
                                stack: 'CapacityStack',
                                tension: 0,  // Líneas rectas
                                pointRadius: 0
                            };
                        })
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: "Fiscal Year"
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: maxPercentage,
                                title: {
                                    display: true,
                                    text: "Capacity (%)"
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var label = context.dataset.label || "";
                                        var value = context.parsed.y;
                                        return label + ": " + value + "%";
                                    },
                                    footer: function (tooltipItems) {
                                        var total = tooltipItems.reduce((acc, item) => acc + item.parsed.y, 0);
                                        return "Total: " + total.toFixed(2) + "%";
                                    },
                                    title: function (tooltipItems) {
                                        return "Fiscal Year: " + tooltipItems[0].label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line100: {
                                        type: 'line',
                                        yMin: 100,
                                        yMax: 100,
                                        borderColor: 'red',
                                        borderWidth: 3,
                                        label: {
                                            enabled: false,
                                            content: '100% capacity',
                                            position: 'end',
                                            backgroundColor: 'rgba(255,0,0,0.7)',
                                            color: '#fff'
                                        }
                                    },
                                    line85: {
                                        type: 'line',
                                        yMin: 85,
                                        yMax: 85,
                                        borderColor: 'orange',
                                        borderWidth: 3,
                                        label: {
                                            enabled: false,
                                            content: '85% capacity',
                                            position: 'end',
                                            backgroundColor: 'rgba(255,165,0,0.7)',
                                            color: '#fff'
                                        }
                                    },
                                    line25: {
                                        type: 'line',
                                        yMin: 25,
                                        yMax: 25,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [8,3,3,3],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '1st shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line53: {
                                        type: 'line',
                                        yMin: 53,
                                        yMax: 53,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [3, 3],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '2nd shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line80: {
                                        type: 'line',
                                        yMin: 80,
                                        yMax: 80,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [8, 4],        // guion-espacio
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: false,
                                            content: '3rd shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                    line100_2: {
                                        type: 'line',
                                        yMin: 100,
                                        yMax: 100,
                                        borderColor: '#555555',
                                        borderWidth: 1,
                                        borderDash: [5, 10],
                                        clip: false,            // permite dibujar fuera del área “chartArea”
                                        label: {
                                            enabled: true,
                                            content: '4th shift',
                                            position: 'start',      // ancla al extremo derecho de la línea
                                            xAdjust: 10,          // lo mueve 10px hacia la derecha, fuera de la gráfica
                                            yAdjust: -5,          // opcional: lo mueve 5px hacia arriba
                                            backgroundColor: 'transparent',
                                            color: '#555555'
                                        }
                                    },
                                }
                            },
                            // Opcional: configuración para verticalLinePlugin
                            verticalLinePlugin: {
                                lineWidth: 1,
                                lineColor: '#e91e63'
                            },
                            totalLabelPlugin: {
                                font: "bold 14px sans-serif",
                                textColor: "#6d6d6d"
                            }
                        }
                    },
                    plugins: [totalLabelPlugin, verticalLinePlugin]
                });
                charts.push(chart);   // <-- lo guardamos

            });

            if (charts.length > 0) {
                // Usamos la primera gráfica para extraer las anotaciones
                buildShiftLegend(charts[0].options.plugins.annotation.annotations);
            }

            // Mostrar el mensaje solo si hay alguna gráfica generada
            if ($("#chartsContainer").children().length > 0) {
                $("#chartsNote").show();
                $("#shiftLegend").show();
            } else {
                $("#chartsNote").hide();
                $("#shiftLegend").hide();

            }
        }

        function buildShiftLegend(annotations) {
            var legend = document.getElementById('shiftLegend');
            legend.innerHTML = '';

            // Contador de turnos
            Object.values(annotations).forEach(function (a) {
                // Solo procesamos las anotaciones con borderDash definido
                if (Array.isArray(a.borderDash)) {
                    // Construimos el atributo dash-array si existe
                    var dashArray = a.borderDash.length
                        ? ' stroke-dasharray="' + a.borderDash.join(',') + '"'
                        : '';

                    // Creamos un SVG con una línea horizontal
                    var svg =
                        '<svg width="30" height="6" ' +
                        'style="vertical-align:middle;">' +
                        '<line x1="0" y1="3" x2="30" y2="3" ' +
                        'stroke="' + a.borderColor + '" ' +
                        'stroke-width="2"' +
                        dashArray +
                        '/>' +
                        '</svg>';

                    // Obtenemos el texto de la etiqueta (si lo tenías guardado en label.content)
                    var text = (a.label && a.label.content)
                        ? a.label.content
                        : '';

                    // Añadimos al contenedor
                    var item = document.createElement('span');
                    item.className = 'legend-item';
                    item.innerHTML = svg + ' ' + text;
                    legend.appendChild(item);
                }
            });
        }

        function toggleImportAdditional() {
            if ($("#ImportRequired").is(":checked")) {
                $("#importAdditionalSection").slideDown();
            } else {
                $("#importAdditionalSection").slideUp();
                // Opcional: limpiar inputs de la sección adicional
                $("#importAdditionalSection").find("input").val("");
            }
        }

        function toggleMaterialOwnerAdditional() {
            // Suponemos que el valor "1" corresponde a la opción OWN.
            if ($("#ID_Material_Owner").val() === "1") {
                $("#materialOwnerAdditionalSection").slideDown();
            } else {
                $("#materialOwnerAdditionalSection").slideUp();
                // Opcional: limpiar inputs de la sección adicional
                $("#materialOwnerAdditionalSection").find("input").val("");
            }
        }


        // ===== NUEVA FUNCIÓN UNIFICADA =====
        function updateOemSectionState() {
            const vehType = $("#ID_VehicleType").val();

            if (vehType === "1") { // "1" es el ID para "Automotriz"
                // El vehículo ES Automotriz: La sección OEM debe estar activa.
                $('#chkOtherOEM').prop('disabled', false);

                if ($('#chkOtherOEM').is(':checked')) {
                    // Modo "Other": Deshabilita el dropdown y habilita los campos de texto.
                    $('#ID_OEM').val("").trigger("change.select2").prop('disabled', true);
                    $('#OEM_Otro, #OtherOEM_Address, #OtherOEM_Telephone').prop('readonly', false).val('');
                } else {
                    // Modo "Selección": Habilita el dropdown y deshabilita los campos de texto.
                    $('#ID_OEM').prop('disabled', false);
                    $('#OEM_Otro, #OtherOEM_Address, #OtherOEM_Telephone').prop('readonly', true).val('');
                }
            } else {
                // El vehículo NO ES Automotriz: Toda la sección OEM debe estar deshabilitada.
                $('#chkOtherOEM').prop('checked', false).prop('disabled', true); // Desmarca y deshabilita el check.
                $('#ID_OEM').val("").trigger("change.select2").prop('disabled', true);
                // Limpia, y deshabilita los campos de texto.
                $('#OEM_Otro, #OtherOEM_Address, #OtherOEM_Telephone').val('').prop('readonly', true).val('');
            }
        }

       
    </script>
}

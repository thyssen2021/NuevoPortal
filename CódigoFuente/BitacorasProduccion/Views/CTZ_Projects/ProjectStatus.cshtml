@model IEnumerable<Portal_2_0.Controllers.ProjectStatusItem>
@{
    ViewBag.Title = "Project Tracker";
    ViewBag.PrimerNivel = "cotizador";
    ViewBag.SegundoNivel = "index_cotizaciones";
    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    ViewBag.nav_style = "nav-sm";
}

@section estilos {
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Handsontable CSS -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css" rel="stylesheet" />

    <style>
        /* Encapsula filtros en un “card” */
        .filter-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

            .filter-card .form-group {
                margin-right: 1rem;
                margin-bottom: .5rem;
            }

            .filter-card .form-control {
                border: 1px solid #ccc;
                padding: .375rem .75rem;
                border-radius: 4px;
            }

        /* Clear Filters button */
        #btnClearFilters {
            background-color: #009ff5;
            border-color: #009ff5;
            color: #fff;
        }

            #btnClearFilters i {
                margin-right: .25rem;
            }

        /* Container scroll */
        .htContainerWrapper {
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        /* Header color */
        .ht_clone_top th {
            background-color: #009ff5 !important;
            color: #fff !important;
        }

        /* Cell statuses */

        .htDimmed {
            background-color: #f3f3f3 !important;            
        }

        .htEmpty {
            background-color: #ffffff !important;
            text-align: right !important;
        }
        .htPending {
            background-color: #fff3cd !important;
            color: #856404 !important;
            font-weight: bold !important;
            text-align: right !important; /* texto a la derecha */
            position: relative;
        }

        .htPending::before {
            content: "\f017"; /* ícono de reloj FontAwesome */
            font-family: "Font Awesome 5 Free";
            font-weight: 900; /* solid */
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(133, 100, 4, 0.50); /* color con 25% alpha */
            margin-right: 4px;
        }


        .htApproved {
            background-color: #d4edda !important;
            color: #155724 !important;
            font-weight: bold !important;
            text-align: right !important;
            position: relative;
        }

        .htApproved::before {
            content: "\f00c"; /* ícono de check */
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(21, 87, 36, 0.50);
            margin-right: 4px;
        }

        .htRejected {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            font-weight: bold !important;
            text-align: right !important;
            position: relative;
        }

        .htRejected::before {
            content: "\f00d"; /* ícono de cruz */
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(114, 28, 36, 0.50);
            margin-right: 4px;
        }

        .htInProgress {
            background-color: #cce5ff !important;
            color: #004085 !important;
            font-weight: bold !important;
            text-align: right !important;
            position: relative;
        }

            .htInProgress::before {
                content: "\f110"; /* icono spinner-alt */
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                position: absolute;
                left: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: rgba(0,64,133,0.50);
            }

        .htOnHold {    
            background-color: #e5e5e4 !important;
            color: #898888 !important;
            font-weight: bold !important;
            text-align: right !important;
            position: relative;
        }

            .htOnHold::before {
                content: "\f04c"; /* icono pause */
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                position: absolute;
                left: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: rgb(128, 128, 128, 0.50);
            }

        .htOnReviewed {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
            font-weight: bold !important;
            text-align: right !important;
            position: relative;
        }

            .htOnReviewed::before {
                content: "\f06e"; /* icono eye */
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                position: absolute;
                left: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: rgba(12,84,96,0.50);
            }

        .htFinalized {
            background-color: #d4edda !important;
            color: #155724 !important;
            font-weight: bold !important;
            text-align: right !important;
            position: relative;
        }

            .htFinalized::before {
                content: "\f0a1"; /* icono flag-checkered */
                font-family: "Font Awesome 5 Free";
                font-weight: 900;
                position: absolute;
                left: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: rgba(21,87,36,0.50);
            }

        /* en tu sección estilos */
        .htContainerWrapper {
            max-height: 800px; /* altura máxima deseada */
            overflow-x: auto; /* para scroll horizontal de columnas */
            overflow-y: auto; /* para scroll vertical de filas */
        }
        .legend-container {
            font-size: 0.9rem;
            line-height: 2.5rem;
        }

        .legend-item {
            display: inline-block;
            padding: .2rem .8rem; /* solo .2rem arriba/abajo */
            margin-left: .5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 1rem;
            line-height: 1.2; /* evitar mucho espacio interno */
        }

        .legend-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .legend-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .legend-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* clases para la leyenda */
        .legend-inprogress {
            background-color: #cce5ff;
            color: #004085;
        }

        .legend-onhold {
            background-color: #e5e5e4;
            color: #898888;
        }

        .legend-onreviewed {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .legend-finalized {
            background-color: #d4edda;
            color: #155724;
        }
        .legend-empty {
            background-color: #e0e0e0;
            color: #6c757d;
        }

    </style>
}

<div class="right_col" role="main">
    <div class="">
        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">

                        <!-- filtros -->
                        <div class="filter-card">
                            <form id="filterForm" method="get" action="@Url.Action("ProjectStatus")" class="form-inline">
                                <div class="form-group">
                                    <label for="projectStatusFilter" class="mr-1">Project Status</label>
                                    @Html.DropDownList(
                                      "projectStatusFilter",
                                      (SelectList)ViewBag.ProjectStatusList,
                                      new { @class = "form-control select2", style = "width:180px;" })
                                </div>
                                <div class="form-group">
                                    <label for="assignmentStatusFilter" class="mr-1">Assignment Status</label>
                                    @Html.DropDownList(
                                      "assignmentStatusFilter",
                                      (SelectList)ViewBag.AssignmentStatusList,
                                      new { @class = "form-control select2", style = "width:180px;" })
                                </div>
                                <div class="form-group">
                                    <label for="from" class="mr-1">From</label>
                                    <input type="date" id="from" name="from" value="@ViewBag.FromDate" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label for="to" class="mr-1">To</label>
                                    <input type="date" id="to" name="to" value="@ViewBag.ToDate" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label for="quoteID" class="mr-1">Quote ID</label>
                                    <input type="text" id="quoteID" name="quoteID" value="@ViewBag.QuoteID" class="form-control" placeholder="Search…" />
                                </div>
                                <div class="form-group">
                                    <button type="button" id="btnClearFilters" class="btn">
                                        <i class="fa fa-times-circle"></i> Clear Filters
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- leyenda de colores -->
                        <div class="d-flex justify-content-end mb-2">
                            <div class="legend-container">
                                <strong>Legend:</strong>
                                <span class="legend-item legend-pending">
                                    <i class="fa fa-clock" style="font-size:14px;opacity:0.5"></i> Pending
                                </span>
                                <span class="legend-item legend-inprogress">
                                    <i class="fa fa-spinner" style="font-size:14px;opacity:0.5"></i> In Progress
                                </span>
                                <span class="legend-item legend-onhold">
                                    <i class="fa fa-pause" style="font-size:14px;opacity:0.5"></i> On Hold
                                </span>
                                <span class="legend-item legend-onreviewed">
                                    <i class="fa fa-eye" style="font-size:14px;opacity:0.5"></i> On Reviewed
                                </span>
                                <span class="legend-item legend-approved">
                                    <i class="fa fa-check" style="font-size:14px;opacity:0.5"></i> Approved
                                </span>
                                <span class="legend-item legend-rejected">
                                    <i class="fa fa-times" style="font-size:14px;opacity:0.5"></i> Rejected
                                </span>
                                @*<span class="legend-item legend-finalized">
                                    <i class="fa fa-flag-checkered"></i> Finalized
                                </span>
                                <span class="legend-item legend-empty">
                                    <i class="fa fa-minus"></i> No Data
                                </span>*@
                            </div>
                        </div>
                        <!-- tabla -->
                        <div class="htContainerWrapper">
                            <div id="hotContainer"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Handsontable JS -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>

    <script>
  $(function() {
    // Inicializar Select2
    $('.select2').select2({ placeholder: 'Select…' });

    // Debounce
    function debounce(fn, delay) {
      let timer;
      return function() {
        clearTimeout(timer);
        timer = setTimeout(fn, delay);
      }
    }

    // Auto-submit
    $('#projectStatusFilter, #assignmentStatusFilter').on('change', () => $('#filterForm').submit());
    $('#from, #to, #quoteID').on('input', debounce(() => $('#filterForm').submit(), 800));

    // Clear
    $('#btnClearFilters').click(function(){
      $('#projectStatusFilter, #assignmentStatusFilter').val('All').trigger('change');
      $('#from, #to, #quoteID').val('');
      $('#filterForm').submit();
    });

    // Handsontable
    var data = @Html.Raw(ViewBag.StatusDataJson);
      var container = document.getElementById('hotContainer');



    new Handsontable(container, {
      data: data,
        colHeaders: [
            "ID", "Quote ID", "Project Status",
            "Assignment Status", "Sales",
            "Engineering", "Foreign Trade",
            "Disposition", "Data Management"
        ],
        columns: [
            { data: 'ID_Project', type: 'numeric', readOnly: true },
            { data: 'QuoteID', type: 'text', readOnly: true },
            { data: 'ProjectStatus', type: 'text', readOnly: true },
            { data: 'AssignmentStatus', type: 'text', readOnly: true },
            // Ahora mostramos el elapsed, no el raw
            { data: 'SalesElapsed', type: 'text', readOnly: true },
            { data: 'EngineeringElapsed', type: 'text', readOnly: true },
            { data: 'ForeignTradeElapsed', type: 'text', readOnly: true },
            { data: 'DispositionElapsed', type: 'text', readOnly: true },
            { data: 'DataManagementElapsed', type: 'text', readOnly: true }
        ],
      rowHeaders: true,
      width: '100%',
      stretchH: 'all',
      filters: true,
      dropdownMenu: true,
      autoRowSize: true,    // Calcula alto de cada fila automáticamente
      height: 'auto',       // Deja que el contenedor crezca según contenido
      hiddenColumns: { columns: [0] },
      licenseKey: 'non-commercial-and-evaluation',
        // pintamos según el raw que vive en cada objeto bajo la propiedad *Raw
        cells: function (row, col) {
            var cellProps = {};
            var colDef = this.instance.getSettings().columns[col];
            var propName = colDef.data;

            // Solo para las columnas de *Elapsed*
            if (propName.endsWith("Elapsed")) {
                // Localizar el valor “raw” del estado en la misma fila:
                var rawProp = propName.replace("Elapsed", "Raw");
                var rawVal = this.instance.getSourceDataAtRow(row)[rawProp];

                // Asignar clase según el estado
                switch (rawVal) {
                    case null:
                    case undefined:
                    case "--":
                        cellProps.className = "htEmpty";
                        break;
                    case "PENDING":
                        cellProps.className = "htPending";
                        break;
                    case "IN_PROGRESS":
                        cellProps.className = "htInProgress";
                        break;
                    case "ON_HOLD":
                        cellProps.className = "htOnHold";
                        break;
                    case "ON_REVIEWED":
                        cellProps.className = "htOnReviewed";
                        break;
                    case "APPROVED":
                        cellProps.className = "htApproved";
                        break;
                    case "REJECTED":
                        cellProps.className = "htRejected";
                        break;
                    case "FINALIZED":
                        cellProps.className = "htFinalized";
                        break;
                    default:
                        // Si es cualquier otro texto, lo dejamos neutro
                        cellProps.className = "htEmpty";
                }
            }

            return cellProps;
        },
        contextMenu: {
            items: {
                "manage_assignments": {
                    name: '<i class="fa fa-users mr-2"></i>Manage Assignments...',
                    callback: function(key, selection, clickEvent) {
                        // Obtener el ID del proyecto de la fila seleccionada
                        const selectedRow = selection[0].start.row;
                        const projectId = this.getSourceDataAtRow(selectedRow).ID_Project;

                        // Redirigir a la nueva página de gestión
                        window.location.href = '@Url.Action("ManageAssignments", "CTZ_Projects")/' + projectId;
                    }
                },
                "hsep1": "---------", // Separador
                "view_details": {
                    name: '<i class="fa fa-info-circle mr-2"></i>View Project Details',
                    callback: function(key, selection, clickEvent) {
                        const selectedRow = selection[0].start.row;
                        const projectId = this.getSourceDataAtRow(selectedRow).ID_Project;
                        window.location.href = '@Url.Action("EditProject", "CTZ_Projects")/' + projectId;
                    }
                }
            }
        },
    });
  });
    </script>
}

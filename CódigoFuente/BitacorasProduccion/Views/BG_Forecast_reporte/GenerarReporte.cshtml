@model Portal_2_0.Models.ReporteBudgetForecastViewModel
@{
    ViewBag.Title = "Reporte Budget-Forecast";
    ViewBag.PrimerNivel = "budget_forecast";
    ViewBag.SegundoNivel = "reporte_forecast";
    ViewBag.ControllerName = "BG_Forecast_reporte";
}

<!-- Select2 -->
<link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet">
<link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet">

@section estilos
{
    <style>
        .numero-positivo::placeholder {
            color: #c8c8c8;
        }

        .btn-dropdown-cm {
            color: white;
        }

            .btn-dropdown-cm:hover {
                color: #cccccc;
            }

        .progress-container {
            width: 100%;
            height: 30px;
            border-radius: 20px;
            overflow: hidden;
            background-color: #f3f3f3;
            border: 2px solid #ccc;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .progress-bar {
            height: 100%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            font-size: 14px;
            border-radius: 20px 0 0 20px;
            transition: width 0.4s ease, background-color 0.4s ease;
            background-color: #f1f1f1 !important;
            color: white;
        }

            .progress-bar.normal {
                background: linear-gradient(to right, #009ff5, #4fc1ff); /* Rojo */
            }



        #progressText {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #333;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
    </style>
}
<div class="right_col" role="main">
    <div class="">

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12  ">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <ul class="nav navbar-right panel_toolbox">
                            @*Utilizado para mover a la derecha los iconos del card*@
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa-solid fa-gear"></i> Opciones
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a href="@Url.Action("EditarReporteGeneral", ViewBag.ControllerName, new { id = ViewContext.RouteData.Values["id"]})" class="btn btn-info btn-sm dropdown-item btn-dropdown-cm" style="background-color: #8e0607">
                                        <i class="fa-solid fa-file-lines"></i> Editar Generales
                                    </a>
                                    <a href="@Url.Action("EditarReporte", ViewBag.ControllerName, new { id = ViewContext.RouteData.Values["id"]})" class="btn btn-success btn-sm dropdown-item btn-dropdown-cm">
                                        <i class="fa-regular fa-pen-to-square"></i> Editar Valores
                                    </a>
                                    <a href="@Url.Action("EditarAsociacionIHS", ViewBag.ControllerName, new { id = ViewContext.RouteData.Values["id"]})" class="btn btn-sm dropdown-item btn-dropdown-cm" style="background-color: #0159f6">
                                        <i class="fa-solid fa-tags"></i> Editar Asociaciones
                                    </a>
                                    <a href="@Url.Action("GenerarReporte", ViewBag.ControllerName, new { id = ViewContext.RouteData.Values["id"]})" class="btn btn-primary btn-sm dropdown-item btn-dropdown-cm" style="background-color: #00487c">
                                        <i class="fa-solid fa-book"></i> Generar Reporte
                                    </a>
                                    <a href="@Url.Action("Details", ViewBag.ControllerName, new { id = ViewContext.RouteData.Values["id"]})" class="btn btn-sm dropdown-item btn-dropdown-cm" style="background-color:gray">
                                        <i class="fa fa-info-circle"></i>  Detalles
                                    </a>
                                    <a href="@Url.Action("ClonarReporte", ViewBag.ControllerName, new { id = ViewContext.RouteData.Values["id"]})" class="btn btn-primary btn-sm dropdown-item btn-dropdown-cm" style="background-color:blue">
                                        <i class="fa-regular fa-clone"></i> Clonar Reporte
                                    </a>
                                    <button class="btn btn-info btn-sm dropdown-toggle dropdown-item btn-dropdown-cm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa-solid fa-database"></i> Catálogos
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <a href="@Url.Action("Index", "BG_forecast_cat_inventory_own", new { id_reporte = ViewContext.RouteData.Values["id"]})" class="dropdown-item">
                                            Inventory OWN
                                        </a>
                                    </div>
                                    <a href="@Url.Action("Index", ViewBag.ControllerName)" class="btn btn-sm dropdown-item btn-dropdown-cm" style="background-color:#dc0904">
                                        <i class="fa-solid fa-arrow-left"></i> Volver al Listado
                                    </a>
                                </div>
                            </div>
                        </ul>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <div class="form-group row">
                            <span style="color:black"><b>DATOS GENERALES</b></span>
                        </div>
                        <div class="ln_solid"></div>
                        @using (Html.BeginForm(null, null, FormMethod.Post, new { @class = "form-horizontal form-label-left", @id = "my-form", @target = "" }))
                        {
                            @Html.AntiForgeryToken()

                            if (!Html.ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger" role="alert">
                                    @Html.ValidationSummary("", new { @class = "text-white" })
                                </div>
                            }

                            @Html.HiddenFor(model => model.id_reporte)

                            <div class="item form-group row">
                                <div class="col-md-4">
                                    <div class="form-group row">
                                        @Html.LabelFor(model => model.id_reporte)
                                        <input type="text" class="form-control" value="@Html.DisplayFor(modelItem => Model.reporte.ConcatCodigo)" readonly />
                                        @Html.ValidationMessageFor(model => model.id_reporte, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group row">
                                        @Html.LabelFor(model => model.reporte.id_ihs_version)
                                        <input type="text" class="form-control" value="@Html.DisplayFor(modelItem => Model.reporte.BG_IHS_versiones.ConcatVersion)" readonly />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group row">
                                        @Html.LabelFor(model => model.demanda)
                                        @Html.DropDownList("demanda", null, htmlAttributes: new { @class = "form-control select2bs4", @style = "width:100%", @required = "required" })
                                        @Html.ValidationMessageFor(model => model.demanda, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="cambio_form" id="cambio_form" value="0" />
                            <div class="item form-group row">
                                <div class="col-md-12">
                                    <div class="ln_solid"></div>
                                </div>
                            </div>

                            <div class="item form-group">
                                <div class="col-md-11 col-sm-11">
                                    <button type="button" id="form-btn" class="btn btn-lg btn-success float-right" style="background-color:#1D6F42"><i class="fa-regular fa-file-excel"></i> Generar</button>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="row">
                        <div class="progress-container">
                            <div id="progressBar" class="progress-bar">
                                <span id="progressText"></span>
                            </div>
                        </div>
                    </div>
                    <hr />
                </div>
                <div>
                    <br />
                    <a href="@Url.Action("Index", ViewBag.ControllerName)" class="btn btn-round btn-info btm-sm" title="Volver">
                        <i class="fa fa-arrow-circle-left"></i> Volver al listado
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="/signalr/hubs"></script>
    <script>
        $(document).ready(function () {
            // Initialize Select2 Elements (debe ir después de asignar el valor)
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            })

            $("#form-btn").click(function () {
                setTimeout(ChangeForm, 2000)
                $("#my-form").submit();
            });

            // Recibe señales de progreso
            $(function () {
                const budgetForecastHub = $.connection.budgetForecastHub;

                // Función que se ejecutará cuando se reciba una actualización desde el servidor
                budgetForecastHub.client.recibirProgresoExcel = function (porcentaje, registrosProcesados, totalRegistros, mensaje) {

                    const progressBar = $("#progressBar");
                    const progressText = $("#progressText");

                    // Establecer el ancho de la barra
                    progressBar.css("width", porcentaje + "%").attr("aria-valuenow", porcentaje);

                    // Actualizar el texto
                    //progressText.text(`${mensaje}: ${porcentaje}% (${registrosProcesados}/${totalRegistros} registros procesados)`);
                    progressText.text(`${mensaje}: ${porcentaje}%`);

                    // Cambiar el estilo dinámicamente
                    progressBar.addClass("normal");
                };

                // Reporte listo
                budgetForecastHub.client.reporteListo = function (url) {
                    console.log('Reporte Listo: ' + url)
                    //alert("El reporte está listo para descargar.");
                    window.location.href = `/BG_Forecast_reporte/DescargarReporte?filePath=${encodeURIComponent(url)}`;

                };

                // Manejo de errores
                budgetForecastHub.client.recibirError = function (mensaje) {
                    alert(mensaje);
                };

                // Conectar al hub
                $.connection.hub.start().done(function () {
                    console.log("Conectado al Hub de Reporte.");
                });
            });
        });

        //variable global para el id
        var num = 0;

        function ChangeForm() {
            document.getElementById('cambio_form').value = ++num;
        }
        window.onload = function () {
            clicMenu(1);
        }
    </script>
}



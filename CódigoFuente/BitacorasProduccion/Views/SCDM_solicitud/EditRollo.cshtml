@model Portal_2_0.Models.SCDM_solicitud

@{
    ViewBag.Title = "Formato de Creación de Rollos";
    ViewBag.PrimerNivel = "scdm_mm";
    ViewBag.SegundoNivel = "mis_solicitudes_mm";

    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    Clases.Util.MensajesSweetAlert mensajeAlerta = (Clases.Util.MensajesSweetAlert)ViewBag.MensajeAlert;

    //lee los valores necesarios para los dropdowns
    string[] tipoVentasArray = (string[])ViewBag.TipoVentaArray;
    string[] clientesArray = (string[])ViewBag.ClientesArray;
    string[] proveedoresArray = (string[])ViewBag.ProveedoresArray;
    string[] molinosArray = (string[])ViewBag.MolinosArray;
    string[] tipoPalletArray = (string[])ViewBag.TipoPalletArray;
    string[] tipoTransporteArray = (string[])ViewBag.TipoTransporteArray;
    string[] tipoMetalArray = (string[])ViewBag.TipoMetalArray;
    string[] unidadMedidaArray = (string[])ViewBag.UnidadMedidaArray;
    string[] tipoMaterialArray = (string[])ViewBag.TipoMaterialArray;
    string[] tipoAprovisionamientoArray = (string[])ViewBag.TipoAprovisionamientoArray;
    string[] pesoRecubrimientoArray = (string[])ViewBag.PesoRecubrimientoArray;
    string[] tipoIntExtArray = (string[])ViewBag.TipoIntExtArray;
    string[] posicionRolloArray = (string[])ViewBag.PosicionRolloArray;
    string[] modeloNegocioArray = (string[])ViewBag.ModeloNegocioArray;
    string[] transitoArray = (string[])ViewBag.TransitoArray;
    string[] disponentesArray = (string[])ViewBag.DisponentesArray;
    string[] diametroInteriorArray = (string[])ViewBag.DiametroInteriorArray;
    string[] gradoCalidadArray = (string[])ViewBag.GradoCalidadArray;

    ViewBag.nav_style = "nav-sm";

    string comentario = string.Empty;


}


@section estilos
{
    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet">
    <!-- iCheck -->
    <link href="@Url.Content("~/Content/vendors/iCheck/skins/flat/green.css")" rel="stylesheet">
    <!--Handsontable -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/14.3.0/handsontable.full.min.css"/>
    <link href="~/Content/css/HansontableHeaderColors.css" rel="stylesheet" />
    <style>

        dl {
            border: 3px double #ccc;
            padding: 0.5em;
            background-color: #fffdf0
        }

        dt {
            font-weight: bold;
            color: green;
        }

        dd {
            font-weight: bold;
            color: #454545;
        }

        dt::after {
            content: ":";
        }

        .fondo_verde > td {
            background-color: green;
            color: #fffdf0;
            font-weight: bolder;
        }

        .fondo_amarillo > td {
            background-color: orange;
            color: #221f1f;
            font-weight: bolder;
        }

        .fondo_rojo > td {
            background-color: red;
            color: #fffdf0;
            font-weight: bolder;
        }

        input {
            text-align: right;
        }
              
        .wf-accordion-group {
            margin-top: 15px;
        }

            /* All elements succeeding an accordion group use margin-top to create white space */
            .wf-accordion-group + * {
                margin-top: 30px;
            }

        /* All accordions have borders… */
        .wf-accordion {
            border-top: 1px solid #bfbfbf;
            border-bottom: 1px solid #bfbfbf;
            border-left: 1px solid #bfbfbf;
            border-right: 1px solid #bfbfbf;
        }

            /* …unless they directly succeed another accordion, in which case we reset the top-border
          to avoid duplicate white space */
            .wf-accordion + .wf-accordion {
                border-top-width: 0;
            }

        .wf-accordion__header {
            color: #616163;
        }

        /* Please note: The trigger element is a <button> create via JS. To achieve consistent aesthetics,
           the native button styles have to be resetted here */
        .wf-accordion__trigger {
            /* baseline resets */
            background: transparent;
            border-width: 0;
            border-radius: 0;
            box-sizing: border-box;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            font-size: inherit;
            letter-spacing: inherit;
            line-height: inherit;
            margin: 0;
            padding: 0;
            text-align: left;
            text-decoration: none;
            /* end of baseline resets */
            /* additional styles for the demo */
            display: block;
            padding: 10px 1.25em 10px 8px;
            position: relative;
            width: 100%;
        }

            .wf-accordion__trigger::after {
                content: '';
                border: solid #fff;
                border-width: 0 2px 2px 0;
                height: 0.5em;
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-60%) rotate(45deg);
                width: 0.5em;
            }

            .wf-accordion__trigger[aria-disabled=true] {
                cursor: not-allowed;
                opacity: 0.5;
            }

            .wf-accordion__trigger[aria-expanded=true]::after {
                transform: translateY(-30%) rotate(-135deg);
            }

            .wf-accordion__trigger:hover,
            .wf-accordion__trigger:focus {
                opacity: 0.8;
                /*  background: #f5f5f5;
                color: #161616;*/
            }

                .wf-accordion__trigger:hover::after,
                .wf-accordion__trigger:focus::after {
                    border-color: #fff;
                }

        .wf-accordion__panel {
            background-color: #fff;
            padding: 10px 8px;
        }

            .wf-accordion__panel[aria-hidden=true] {
                display: none;
            }

        .fondo-pendiente {
            background-color: #009ff5;
        }

        .fondo-completado {
            background-color: #009ff5;
        }
        /*Para color de celdas readonly*/
        .handsontable .htDimmed {
            background: #f2f1f1;
        }

        .handsontable .celdaSinConfirmar {
            background-color: #ffe8bd; /* Rojo claro para indicar que no está confirmado */
            border: 2px solid #ff0000; /* Borde rojo para resaltar */
        }

        .handsontable .celdaConfirmada {
            background-color: #ccffcc; /* Verde claro para indicar que la celda ha sido confirmada */
        }

        .custom-swal-container {
            font-family: Arial, sans-serif;
        }

        .custom-swal-popup {
            border-radius: 10px;
            background-color: #f4f6f9;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .custom-swal-title {
            color: #333;
            font-weight: bold;
            font-size: 1.2rem; /* Tamaño de fuente reducido */
        }

        .custom-swal-button-text {
            font-size: 0.9rem; /* Tamaño reducido para un aspecto más limpio */
        }

        .custom-swal-confirm-button,
        .custom-swal-deny-button,
        .custom-swal-cancel-button {
            border-radius: 8px;
            padding: 8px 16px;
        }

        .custom-swal-confirm-button {
            background-color: #4CAF50; /* Verde claro */
            color: white;
        }

        .custom-swal-deny-button {
            background-color: #f44336; /* Rojo claro */
            color: white;
        }

        .custom-swal-cancel-button {
            background-color: #ffc107; /* Amarillo claro */
            color: white;
        }

            .custom-swal-confirm-button:hover,
            .custom-swal-deny-button:hover,
            .custom-swal-cancel-button:hover {
                filter: brightness(0.9);
            }           
    </style>

}

@{Html.RenderPartial("_BlockUI", Model);}

@*Para SweetAlert*@
@if (mensajeAlerta != null)
{
    <input type="hidden" value="@mensajeAlerta.Mensaje" id="mensajeAlert" />
    <input type="hidden" value="@mensajeAlerta.getTipoMensaje()" id="mensajeAlertTipo" />
}

<div class="right_col" role="main">
    <div class="">

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12  ">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <div class="col-sm-12">
                            <div class="card-box ">
                                <dl class="row">
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.id)</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_tipo_solicitud)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.SCDM_cat_tipo_solicitud.descripcion)</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_solicitante)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.empleados.ConcatNombre)</dd>
                                    @if (Model.SCDM_rel_solicitud_materiales_solicitados.Count > 0 && (Model.id_tipo_solicitud == 1 || Model.id_tipo_solicitud == 2 || Model.id_tipo_solicitud == 5))
                                    {
                                        <dt class="col-sm-2">Tipo de Materiales</dt>
                                        <dd class="col-sm-2">@String.Join(", ", @Model.SCDM_rel_solicitud_materiales_solicitados.Select(x => x.SCDM_cat_tipo_materiales_solicitud.descripcion).Distinct().ToList())</dd>
                                    }
                                    @if (Model.id_tipo_solicitud == 3)
                                    {
                                        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_tipo_cambio)</dt>
                                        <dd class="col-sm-2">@Html.DisplayFor(model => model.SCDM_cat_tipo_cambio.descripcion)</dd>
                                    }
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_prioridad)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.SCDM_cat_prioridad.descripcion)</dd>
                                    <dt class="col-sm-2">Plantas</dt>
                                    <dd class="col-sm-2">@String.Join(", ", @Model.SCDM_rel_solicitud_plantas.Select(x => x.plantas.descripcion).Distinct().ToList())</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.descripcion)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.descripcion)</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.justificacion)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.justificacion)</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="ln_solid"></div>
                            <div class="form-group row">
                                <h4 style="color:#7c7c7c"><b>Elementos de la Solicitud</b></h4>
                            </div>
                        </div>
                        <div class="col-sm-12">

                            <div class="wf-accordion-group js-accordion-group">
                                @if (Model.SCDM_rel_solicitud_secciones_activas.Any(x => x.id_seccion == (int)Bitacoras.Util.SCDMSeccionesSolicitud.ROLLO))
                                {
                                    comentario = Model.SCDM_rel_solicitud_secciones_activas.FirstOrDefault(x => x.id_seccion == (int)Bitacoras.Util.SCDMSeccionesSolicitud.ROLLO).comentario;

                                    //3 = Rollo
                                    <div class="wf-accordion js-accordion" data-wf-accordion-expanded="">
                                        <div class="wf-accordion__header js-accordion__header">
                                            <h3><button class="wf-accordion__trigger js-accordion__trigger fondo-completado" aria-expanded="true" aria-controls="accordion-1__panel-0" id="accordion-1__header-0">Rollos</button></h3>
                                        </div>
                                        <div class="wf-accordion__panel js-accordion__panel " aria-hidden="false" id="accordion-1__panel-0" aria-labelledby="accordion-1__header-0">
                                            <!--Ejemplo Handsontable-->
                                            <div id="example" class="hot handsontable htRowHeaders htColumnHeaders" data-originalstyle="height: 320px; overflow: hidden; width: 100%;"></div>
                                            <p>
                                                <br />
                                                <button class="btn btn-warning btn-sm float-right" onclick="insertaFila()">
                                                    <i class="fa-regular fa-square-plus"></i>
                                                    Agregar
                                                </button>
                                                <button class="btn btn-danger btn-sm float-left" onclick="borrarFila()">
                                                    <i class="fa-regular fa-trash-can"></i>
                                                    Borrar fila seleccionada
                                                </button>
                                                <button id="btn-ver-celdas-sin-confirmar" class="btn btn-warning btn-sm"><i class="fa-solid fa-list-check"></i> Ver Campos Sin Confirmar</button>
                                                <button id="btn-confirmar-celdas" class="btn btn-primary btn-sm "><i class="fa-regular fa-circle-check"></i> Confirmar Campos</button>


                                            </p>
                                            <div class="form-group row">

                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        <!-- Inicio Comentario -->
                        <div class="col-sm-12">
                            <div class="wf-accordion-group js-accordion-group">
                                <div class="wf-accordion js-accordion" data-wf-accordion-expanded="">
                                    <div class="wf-accordion__header js-accordion__header">
                                        <h3><button class="wf-accordion__trigger js-accordion__trigger fondo-completado" aria-expanded="true" aria-controls="accordion-1__panel-0" id="accordion-1__header-0">Comentario Adicional</button></h3>
                                    </div>
                                    <div class="wf-accordion__panel js-accordion__panel " aria-hidden="false" id="accordion-1__panel-0" aria-labelledby="accordion-1__header-0">
                                        <!--Comentario-->
                                        <div class="form-group row">
                                            <div class="col-md-12 col-sm-12 ">
                                                <textarea id="comentario" name="comentario" class="form-control" rows="4" autocomplete="off" placeholder="Ingresa un comentario adicional..." maxlength="255">@Html.DisplayFor(model => comentario)</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Fin Comentario -->
                        <div class="col-md-12">
                            <div class="ln_solid"></div>
                            <button type="button" id="btn-submit-salir" class="btn btn-info btn-lg float-lg-right"><i class="fa-solid fa-save"></i>  Guardar y salir</button>
                            <button type="button" id="btn-submit" class="btn btn-success btn-lg float-lg-right"><i class="fa-solid fa-save"></i>  Guardar y continuar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <br />
                    <a href="@Url.Action("EditarSolicitud", ViewBag.ControllerName, new {id=Model.id, viewUser = Request.Params["viewUser"] })" class="btn btn-round btn-info btm-sm" title="Volver" style="color:white">
                        <i class="fa fa-arrow-circle-left"></i> Volver al listado
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render(Url.Content("~/Content/vendors/jquery-iu/jquery-ui.min.js"))
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    @Scripts.Render(Url.Content("~/Content/vendors/moment/moment.js"))
    <!-- SweetAlert2 (css incluido) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.all.min.js" integrity="sha512-/iBgV43zPirSC0tue+PT/1VHGs7En24twBmT+sVMgn9PTaOpKfbgIyL5YsGKlbAIxcwz9S8W/YEnYjpIYj2Axw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    @Scripts.Render(Url.Content("~/Scripts/AlertasSweetAlertColored.js"))
    <!-- iCheck -->
    @Scripts.Render(Url.Content("~/Content/vendors/iCheck/icheck.min.js"))https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/includes
    <script src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.min.js"></script>
    <script src="~/Content/vendors/wfaccordion/wf.accordion.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/14.3.0/handsontable.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/languages/es-MX.js"></script>


    <script>
        //variable para saber si ha cambiado el formulario y asi no se detenga por doble submit
        var documento_soporte_cambios = 1;
        var hot;

        var headers = ['ID', 'Número Material', 'Material del cliente', 'Tipo de Venta', 'Núm. ODC cliente', 'Núm. cliente', 'Requiere PPAP\'s', 'Req. IMDS', 'Proveedor', 'Nombre Molino', 'Tipo Metal',
            'Unidad Base Medida', 'Grado/Calidad', 'Tipo de Material', '¿Aprovisionamiento?', 'Núm. parte del cliente',
            'Descripción núm. de parte', 'Norma de referencia', 'Espesor (mm)', 'Tolerancia espesor negativa (mm)', 'Tolerancia espesor positiva (mm)', 'Ancho (mm)', 'Tolerancia ancho negativa (mm)',
            'Tolerancia ancho positiva (mm)', 'Descripción Material (ES)', 'Descripción Material (EN)', 'Diametro interior (mm)', 'Diametro exterior máximo (mm)', 'Peso del recubrimiento',
            'Transito', 'Procesadores Ext.', 'Número procesador Ext.', 'Núm. antigüo material',
            'Planicidad (mm)', 'MSA (Honda)', 'Fecha validez', 'Disponente asignado', 'Unidad Medida Ventas',
            /*BUDGET*/
            'Tipo de Material (Budget)', 'Parte Int/Ext', 'Posición del Rollo para embarque', 'Modelo de negocio', 'Peso bruto REAL bascula (kg)', 'Peso neto REAL bascula (kg)', 'Ángulo A', 'Ángulo B',
            'Scrap permitido (%)', 'Piezas Dobles', 'Reaplicación', 'Req. conciliación Puntas y colas', 'Conciliación Scrap Ingenieria',
            'Pais S&P','S&P 1 (antes IHS)', 'S&P 2 (antes IHS)', 'S&P 3 (antes IHS)', 'Propulsion System', 'Program', '¿Almacen Norte?', 'Tipo Transporte', 'Stacks por Paquete', 'Tipo de Pallet', 'tkMM SOP', 'tkMM EOP'
            , 'Piezas por auto', 'Piezas por golpe', 'Piezas por paquete', 'Peso Inicial', 'Peso Max (KG)', 'Peso Maximo Tolerancia Positiva', 'Peso Maximo Tolerancia Negativa'
            , 'Peso Min (KG)', 'Peso Mínimo Tolerancia Positiva', 'Peso Mínimo Tolerancia Negativa'
        ]

        const columnasQueNecesitanValidacion = [
            //"Tipo Metal",
            //"Tipo de Venta",
            //"Modelo de negocio",
            //"Posición del Rollo para embarque",
            //"S&P 1 (antes IHS)",
            //"Peso Max (KG)",
            //"Peso Min (KG)",
            //"Req. conciliación Puntas y colas",
            //"Conciliación Scrap Ingenieria",
            // Añade más columnas según sea necesario
        ];

        let confirmaciones = {};

        // Ejemplo de clave: "0-IHS 1" representaría la fila 0 y la columna "IHS 1"
        function valorConfirmado(row, header) {
            return confirmaciones[`${row}-${header}`] === true;
        }

        var nestedHeaders = [
            [
                { label: '', colspan: 1 }, // 'ID' sin título adicional
                { label: 'Datos Base', colspan: 10, className: 'nested-header-rollo' },
                { label: 'Datos Base', colspan: 10, className: 'nested-header-rollo' },
                { label: 'Datos Base', colspan: 10, className: 'nested-header-rollo' },
                { label: 'Datos Base', colspan: 7, className: 'nested-header-rollo' },
                { label: 'Datos de Budget', colspan: 10, className: 'nested-header-budget' },
                { label: 'Datos de Budget', colspan: 10, className: 'nested-header-budget' },
                { label: 'Datos de Budget', colspan: 10, className: 'nested-header-budget' },
                { label: 'Datos de Budget', colspan: 10, className: 'nested-header-budget' },
            ],
            headers // Este es el arreglo de encabezados existente
        ];

        var toastMixin = Swal.mixin({
            toast: true,
            icon: 'success',
            iconColor: 'white',
            customClass: {
                popup: 'colored-toast'
            },
            animation: false,
            position: 'top-right',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });


        //variables para array
        var si_noArray = ['SÍ', 'NO'];
        var piezasDoblesArray = ['X'];
        var tipoVentaArray = @Html.Raw(Json.Encode(tipoVentasArray));
        var clientesArray = @Html.Raw(Json.Encode(clientesArray));
        var proveedoresArray = @Html.Raw(Json.Encode(proveedoresArray));
        var molinosArray = @Html.Raw(Json.Encode(molinosArray));
        var tipoTransporteArray = @Html.Raw(Json.Encode(tipoTransporteArray));
        var tipoPalletArray = @Html.Raw(Json.Encode(tipoPalletArray));
        var tipoMetalArray = @Html.Raw(Json.Encode(tipoMetalArray));
        var unidadMedidaArray = @Html.Raw(Json.Encode(unidadMedidaArray));
        var tipoMaterialArray = @Html.Raw(Json.Encode(tipoMaterialArray));
        var tipoAprovisionamientoArray = @Html.Raw(Json.Encode(tipoAprovisionamientoArray));
        var pesoRecubrimientoArray = @Html.Raw(Json.Encode(pesoRecubrimientoArray));
        var tipoIntExtArray = @Html.Raw(Json.Encode(tipoIntExtArray));
        var posicionRolloArray = @Html.Raw(Json.Encode(posicionRolloArray));
        var modeloNegocioArray = @Html.Raw(Json.Encode(modeloNegocioArray));
        var transitoArray = @Html.Raw(Json.Encode(transitoArray));
        var disponentesArray = @Html.Raw(Json.Encode(disponentesArray));
        var diametroInteriorArray = @Html.Raw(Json.Encode(diametroInteriorArray));
        var gradoCalidadArray = @Html.Raw(Json.Encode(gradoCalidadArray));

        const countryArray      = @Html.Raw(Json.Encode(ViewBag.Countries));
        const IHSMEXArray    = @Html.Raw(Json.Encode(ViewBag.IHSMEXArray));
        const IHSUSAArray    = @Html.Raw(Json.Encode(ViewBag.IHSUSAArray));



        $(document).ready(function () {


            //inicializa hansontable
            inicializaHandsontable();
            DefineValidadores();
            cargaDatosIniciales();

            $("#btn-submit").on("click", function () { EnviaFormulario(false) });
            $("#btn-submit-salir").on("click", function () { EnviaFormulario(true) });

            //inicia el proceso de confirmación de celdas
            $("#btn-confirmar-celdas").on("click", function () {
                iniciarConfirmacionCeldas();
            });


            $.unblockUI();
        });

        // Función para confirmar celdas
        function iniciarConfirmacionCeldas() {
            let celdasNoConfirmadas = [];

            // Recorre todas las filas de la tabla
            hot.getData().forEach((fila, rowIndex) => {
                headers.forEach((header, colIndex) => {
                    if (colNecesitaValidacion(header) && !valorConfirmado(rowIndex, header)) {
                        // Si la celda necesita validación y no está confirmada, la agrega a la lista para confirmación
                        celdasNoConfirmadas.push({ rowIndex, header, colIndex });
                    }
                });
            });

            // Recorre cada celda no confirmada y muestra la ventana de confirmación
            confirmarCeldasPendientes(celdasNoConfirmadas);
        }

        // Función para confirmar celdas pendientes
        function confirmarCeldasPendientes(celdasNoConfirmadas) {
            if (celdasNoConfirmadas.length === 0) {
                // Si no hay celdas sin confirmar, mostramos un mensaje indicando que todas han sido confirmadas
                Swal.fire({
                    icon: 'success',
                    title: 'Confirmación Completa',
                    text: 'Todas las celdas han sido confirmadas exitosamente.',
                    confirmButtonText: 'Aceptar'
                });
                //guarda en BD
                EnviaFormulario(false);
                return;
            }

            const celda = celdasNoConfirmadas.shift();
            const { rowIndex, header, colIndex } = celda;

            mostrarConfirmacion(rowIndex, header, colIndex).then(() => {
                // Después de confirmar la celda, sigue con la siguiente
                confirmarCeldasPendientes(celdasNoConfirmadas);
            }).catch(() => {
                // Si se selecciona "Omitir por ahora" o se cancela la confirmación, no la marca como confirmada y sigue con la siguiente
                if (celdasNoConfirmadas.length === 0) {
                    // Si quedan celdas sin confirmar al finalizar
                    Swal.fire({
                        icon: 'warning',
                        title: 'Confirmación Incompleta',
                        text: 'Algunas celdas quedaron sin confirmar. Por favor, revisa las celdas pendientes antes de continuar.',
                        confirmButtonText: 'Aceptar'
                    });
                } else {
                    // Continuar con las demás celdas sin confirmar
                    confirmarCeldasPendientes(celdasNoConfirmadas);
                }
            });
        }


        // Evento para mostrar las celdas sin confirmar
        document.getElementById("btn-ver-celdas-sin-confirmar").addEventListener("click", function () {
            const celdasNoConfirmadas = [];
            const totalRows = hot.countRows();
            const totalCols = hot.countCols();

            // Recorre todas las filas de la tabla
            hot.getData().forEach((fila, rowIndex) => {
                headers.forEach((header, colIndex) => {
                    if (colNecesitaValidacion(header) && !valorConfirmado(rowIndex, header)) {
                        // Obtener el encabezado de la columna y el número de material para contexto
                        const header = hot.getColHeader(colIndex);
                        const numeroMaterial = hot.getDataAtCell(rowIndex, GetColFromName("Número Material"));

                        // Agregar la información de la celda no confirmada a la lista
                        celdasNoConfirmadas.push(`Fila ${rowIndex + 1}, Número Material: ${numeroMaterial}, Columna: "${header}"`);
                    }
                });
            });


            //for (let row = 0; row < totalRows; row++) {
            //    for (let col = 0; col < totalCols; col++) {
            //        const cellClass = hot.getCellMeta(row, col).className;
            //        if (cellClass === "celdaSinConfirmar") {
            //            // Obtener el encabezado de la columna y el número de material para contexto
            //            const header = hot.getColHeader(col);
            //            const numeroMaterial = hot.getDataAtCell(row, GetColFromName("Número Material"));

            //            // Agregar la información de la celda no confirmada a la lista
            //            celdasNoConfirmadas.push(`Fila ${row + 1}, Número Material: ${numeroMaterial}, Columna: "${header}"`);
            //        }
            //    }
            //}

            if (celdasNoConfirmadas.length > 0) {
                // Mostrar las celdas no confirmadas en un mensaje
                Swal.fire({
                    title: "Celdas Sin Confirmar",
                    width: '700px',
                    html: `<ul style="text-align:left">${celdasNoConfirmadas.map(celda => `<li>${celda}</li>`).join('')}</ul>`,
                    icon: "warning",
                    confirmButtonText: "Aceptar"
                });
            } else {
                // No hay celdas sin confirmar
                Swal.fire({
                    icon: 'success',
                    title: 'Todas las celdas han sido confirmadas',
                    confirmButtonText: 'Aceptar'
                });
            }
        });

        function colNecesitaValidacion(header) {
            // Verifica si la columna está en la lista de columnas que requieren confirmación
            return columnasQueNecesitanValidacion.includes(header);
        }

        function mostrarConfirmacion(row, header, col) {
            return new Promise((resolve, reject) => {
                const valorActual = hot.getDataAtCell(row, col);
                const numeroMaterial = hot.getDataAtCell(row, GetColFromName("Número Material")) || "(sin número de material)";
                const valorInput = valorActual == null ? "" : valorActual;

                Swal.fire({
                    title: `<span class="custom-swal-title">¿Confirma que el valor ingresado en "${header}" (Fila ${row + 1}, Material: ${numeroMaterial}) es correcto?</span>`,
                    html: `
                <input type="text" id="nuevoValor" placeholder="Vacío" style="width: 100%; height: 40px; font-size: 0.9rem; text-align: left;" value="${valorInput}">
                <span style="font-size:14px;">Ingrese un nuevo valor y haga clic en 'Cambiar' para aplicarlo, o haga clic en 'Confirmar Actual' para aceptar el valor actual.</span>
            `,
                    width: '600px',  // Ajusta el ancho del popup para mejor presentación
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: '<span class="custom-swal-button-text">Confirmar Actual</span>',
                    denyButtonText: '<span class="custom-swal-button-text">Cambiar</span>',
                    cancelButtonText: '<span class="custom-swal-button-text">Omitir por ahora</span>',
                    allowOutsideClick: false, // No permite hacer clic fuera para cerrar el popup
                    preConfirm: () => {
                        return document.getElementById('nuevoValor').value;
                    },
                    preDeny: () => {
                        return document.getElementById('nuevoValor').value;
                    },
                    customClass: {
                        container: 'custom-swal-container',
                        popup: 'custom-swal-popup',
                        title: 'custom-swal-title',
                        confirmButton: 'custom-swal-confirm-button',
                        denyButton: 'custom-swal-deny-button',
                        cancelButton: 'custom-swal-cancel-button'
                    },
                    didOpen: () => {
                        // Referencia al botón "Cambiar"
                        const denyButton = Swal.getDenyButton();
                        denyButton.style.display = 'none'; // Inicialmente oculta el botón "Cambiar"

                        // Agrega un evento para detectar cuando el valor cambia
                        document.getElementById('nuevoValor').addEventListener('input', function () {
                            const currentValue = this.value;

                            if (currentValue !== valorInput) {
                                // Si el valor es diferente al original, muestra el botón "Cambiar"
                                denyButton.style.display = 'inline-block';
                            } else {
                                // Si el valor vuelve a ser igual al original, oculta el botón "Cambiar"
                                denyButton.style.display = 'none';
                            }
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        confirmaciones[`${row}-${header}`] = true;
                        hot.setCellMeta(row, col, 'className', 'celdaConfirmada');
                        resolve();
                    } else if (result.isDenied) {
                        const nuevoValor = result.value;

                        if (nuevoValor !== valorActual) {
                            Swal.fire({
                                html: `<p>¿Desea cambiar este valor?: <br><br>De:<br><br><span style="color:red; font-weight:bold;">${valorActual}</span> <br><br>a:<br><br> <span style="color:green; font-weight:bold;">${nuevoValor}</span><p>`,
                                width: '600px',
                                showDenyButton: true,
                                confirmButtonText: '<span class="custom-swal-button-text">Sí, cambiar</span>',
                                denyButtonText: '<span class="custom-swal-button-text">No</span>',
                                allowOutsideClick: false, // No permite hacer clic fuera para cerrar el popup
                                customClass: {
                                    confirmButton: 'custom-swal-confirm-button',
                                    denyButton: 'custom-swal-deny-button'
                                }
                            }).then((cambioResult) => {
                                if (cambioResult.isConfirmed) {
                                    const valorFinal = nuevoValor === "" ? null : nuevoValor;
                                    hot.setDataAtCell(row, col, valorFinal);
                                    confirmaciones[`${row}-${header}`] = true;
                                    hot.setCellMeta(row, col, 'className', 'celdaConfirmada');
                                    resolve();
                                } else {
                                    confirmaciones[`${row}-${header}`] = false;
                                    hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                                    reject();
                                }
                            });
                        } else {
                            reject();
                        }
                    } else {
                        confirmaciones[`${row}-${header}`] = false;
                        hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                        reject();
                    }
                    hot.render();
                });
            });
        }


        function inicializaHandsontable() {
            const container = document.querySelector('#example');

            hot = new Handsontable(container, {
                autoWrapRow: true,
                colHeaders: headers,
                nestedHeaders: nestedHeaders, // Encabezados anidados
                afterGetColHeader: function (col, TH) {
                    var TR = TH.parentNode;
                    var THEAD = TR.parentNode;
                    var headerLevel = (-1) * THEAD.childNodes.length + Array.prototype.indexOf.call(THEAD.childNodes, TR);

                    function applyClass(elem, className) {
                        if (!Handsontable.dom.hasClass(elem, className)) {
                            Handsontable.dom.addClass(elem, className);
                        }
                    }

                    if (headerLevel === -2) {
                        if (col >= 1 && col<=37)
                            applyClass(TH, 'HTDatosBase');
                        else if (col>37)
                            applyClass(TH, 'HTBudget');

                    } else {

                        switch (col) {
                            case -1:
                                applyClass(TH, 'HTgray');
                                break;
                            case GetColFromName("Número Material"):
                            case GetColFromName("Descripción Material (ES)"):
                            case GetColFromName("Descripción Material (EN)"):
                            case GetColFromName("Diametro exterior máximo (mm)"):
                            case GetColFromName("Peso Min (KG)"):
                            case GetColFromName("Peso Max (KG)"):
                            case GetColFromName("Tipo de Material (Budget)"):
                            case GetColFromName("Propulsion System"):
                            case GetColFromName("Program"):
                                applyClass(TH, 'HTgreen');
                                break;
                            case GetColFromName("Núm. parte del cliente"):
                            case GetColFromName("Descripción núm. de parte"):
                            case GetColFromName("Espesor (mm)"):
                            case GetColFromName("Tolerancia espesor negativa (mm)"):
                            case GetColFromName("Tolerancia espesor positiva (mm)"):
                            case GetColFromName("Ancho (mm)"):
                            case GetColFromName("Tolerancia ancho negativa (mm)"):
                            case GetColFromName("Tolerancia ancho positiva (mm)"):
                            case GetColFromName("Núm. antigüo material"):
                            case GetColFromName("Planicidad (mm)"):
                            case GetColFromName("MSA (Honda)"):
                            case GetColFromName("Req. conciliación Puntas y colas"):
                            case GetColFromName("Scrap permitido (%)"):
                            case GetColFromName("Fecha validez"):
                            case GetColFromName("Disponente asignado"):
                                applyClass(TH, 'HTred');
                                break;
                            case GetColFromName("Material del cliente"):
                            case GetColFromName("Tipo de Venta"):
                            case GetColFromName("Núm. cliente"):
                            case GetColFromName("Requiere PPAP\'s"):
                            case GetColFromName("Req. IMDS"):
                            case GetColFromName("Proveedor"):
                            case GetColFromName("Nombre Molino"):
                            case GetColFromName("Tipo Metal"):
                            case GetColFromName("Unidad Base Medida"):
                            case GetColFromName("Grado/Calidad"):
                            case GetColFromName("Tipo de Material"):
                            case GetColFromName("¿Aprovisionamiento?"):
                            case GetColFromName("Diametro interior (mm)"):
                            case GetColFromName("Peso del recubrimiento"):
                            case GetColFromName("Parte Int/Ext"):
                            case GetColFromName("Posición del Rollo para embarque"):
                            case GetColFromName("S&P 1 (antes IHS)"):
                            case GetColFromName("Modelo de negocio"):
                            case GetColFromName("Transito"):
                            case GetColFromName("Procesadores Ext."):
                            case GetColFromName("Número procesador Ext."):
                                applyClass(TH, 'HTPurple');
                                break;
                            case GetColFromName("Núm. ODC cliente"):
                            case GetColFromName("Norma de referencia"):
                            case GetColFromName("Unidad Medida Ventas"):
                                //budget
                            case GetColFromName("Peso bruto REAL bascula (kg)"):
                            case GetColFromName("Peso neto REAL bascula (kg)"):
                            case GetColFromName("Ángulo A"):
                            case GetColFromName("Ángulo B"):
                            case GetColFromName("Piezas Dobles"):
                            case GetColFromName("Reaplicación"):
                            case GetColFromName("Conciliación Scrap Ingenieria"):
                            case GetColFromName("Piezas por auto"):
                            case GetColFromName("Piezas por golpe"):
                            case GetColFromName("Piezas por paquete"):
                            case GetColFromName("Peso Inicial"):
                            case GetColFromName("Peso Maximo Tolerancia Positiva"):
                            case GetColFromName("Peso Maximo Tolerancia Negativa"):
                            case GetColFromName("Peso Mínimo Tolerancia Positiva"):
                            case GetColFromName("Peso Mínimo Tolerancia Negativa"):
                            case GetColFromName("S&P 2 (antes IHS)"):
                            case GetColFromName("S&P 3 (antes IHS)"):
                            case GetColFromName("¿Almacen Norte?"):
                            case GetColFromName("Tipo Transporte"):
                            case GetColFromName("Stacks por Paquete"):
                            case GetColFromName("Tipo de Pallet"):
                            case GetColFromName("tkMM SOP"):
                            case GetColFromName("tkMM EOP"):
                            case GetColFromName("Pais S&P"):
                                applyClass(TH, 'HTOrange');
                                break;
                            case 0: //columna fijada
                                applyClass(TH, 'HTgreen');

                                break;
                            //case GetColFromName("Tipo de Material (Budget)"):
                            //    applyClass(TH, 'HTBudget');
                            //    break;
                        }
                    }

                },
                columns: [
                    { readOnly: true }, //hidden
                    { readOnly: true },  //num material
                    { //material del cliente?
                        type: 'autocomplete', source: si_noArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !si_noArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //tipo de venta
                        type: 'autocomplete', source: tipoVentaArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !tipoVentaArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //numero ODC cliente
                        validator: function (value, callback) {
                            let tipoVenta = hot.getDataAtCell(this.row, GetColFromName("Tipo de Venta"));
                            let max = 10;

                            //if (tipoVenta == "Serie" && (value == null || value == '')) {
                            //    toastMixin.fire({ title: 'Núm de ODC de cliente es obligatorio en tipo de venta SERIE.', icon: 'warning' });
                            //    callback(false);
                            //} else {

                            if (value != null && value.length > max) {
                                toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            }
                            else {
                                if (value == null || (!isNaN(value.toString()) && (value.length <= max || value.length == 0)))
                                    callback(true);
                                else {
                                    toastMixin.fire({ title: 'Ingrese un valor válido para ODC cliente.', icon: 'warning' });
                                    callback(false)
                                }
                            }
                            //}
                        }
                    },
                    { //cliente
                        type: 'autocomplete', source: clientesArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value == null || value == '' || !clientesArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //requiere paps
                        type: 'autocomplete', source: si_noArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios

                            let aplicaPPAPs = hot.getDataAtCell(this.row, GetColFromName("Tipo de Venta"));

                            if ((aplicaPPAPs != null && aplicaPPAPs.toUpperCase().includes("SPOT") && (value == null || value == ''))) {
                                toastMixin.fire({ title: 'Este campo es obligatorio en venta spot.', icon: 'warning' });
                                callback(false);
                            } else {
                                if ((value != null && value != '') && !si_noArray.includes(value)) {
                                    callback(false);
                                }
                                else {
                                    callback(true);
                                }
                            }
                        }
                    },
                    { //requiere IMDs
                        type: 'autocomplete', source: si_noArray, strict: false,
                        validator: function (value, callback) {

                            let aplicaIMDSs = hot.getDataAtCell(this.row, GetColFromName("Material del Cliente"));
                            //valida vacios
                            if ((aplicaIMDSs != null && aplicaIMDSs.toUpperCase().includes("NO") && (value == null || value == ''))) {
                                toastMixin.fire({ title: 'Este campo es obligatorio.', icon: 'warning' });
                                callback(false);
                            } else {
                                if ((value != null && value != '') && !si_noArray.includes(value)) {
                                    callback(false);
                                }
                                else {
                                    callback(true);
                                }
                            }
                        }
                    },
                    {//proveedor
                        type: 'autocomplete', strict: false, filter: true, source: proveedoresArray,
                        validator: function (value, callback) {
                            let max = 120;
                            let aplicaProveedor = hot.getDataAtCell(this.row, GetColFromName("Material del Cliente"));

                            if ((aplicaProveedor != null && aplicaProveedor.toUpperCase().includes("NO") && (value == null || value == ''))) {
                                toastMixin.fire({ title: 'Este campo es obligatorio.', icon: 'warning' });
                                callback(false);
                            } else {

                                if (value != null && value.length > max) {
                                    toastMixin.fire({ title: 'El campo Proveedor debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                    callback(false);
                                } else {
                                    callback(true);
                                }
                            }
                        }

                    },
                    {//molino
                        type: 'autocomplete', strict: false, filter: true, source: molinosArray,
                        validator: function (value, callback) {
                            let max = 30;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Molino debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    {//tipo metal
                        type: 'autocomplete', source: tipoMetalArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !tipoMetalArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //unidad medida
                        type: 'autocomplete', source: unidadMedidaArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !unidadMedidaArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {   //grado calidad
                        type: 'autocomplete', strict: false, filter: true, source: gradoCalidadArray,
                        validator: function (value, callback) {
                            let max = 50;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Grado/calidad debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    { //tipo material
                        type: 'autocomplete', source: tipoMaterialArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !tipoMaterialArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //tipo de aprovisionamiento
                        type: 'autocomplete', source: tipoAprovisionamientoArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !tipoAprovisionamientoArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {  //numero parte
                        validator: function (value, callback) {
                            let max = 18;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Número de parte ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {  //descripcion numero parte
                        validator: function (value, callback) {
                            let max = 30;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {  //norma referencia
                        validator: function (value, callback) {
                            let max = 30;
                            if (value != null && value.length > max) {
                                toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {//espesor
                        type: 'numeric', validator: 'CustomNumbersValidator'
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia espesor -
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia espesor +
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //ancho
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia ancho -
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia ancho +
                    { //descripcion ES
                        readOnly: false,
                        validator: function (value, callback) {
                            let max = 40;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Descripción (ES) debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    {//descripcion EN
                        readOnly: false,
                        validator: function (value, callback) {
                            let max = 40;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Descripción (EN) debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                //    this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                                callback(false);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    {//diametro interior
                        type: 'dropdown', source: diametroInteriorArray, validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !diametroInteriorArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator', readOnly: false }, //diametro exterior máx
                    { //peso recubrimiento
                        type: 'autocomplete', strict: false, filter: true, source: pesoRecubrimientoArray,
                        validator: function (value, callback) {
                            let max = 60;
                            if ((value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Peso del Recubrimiento debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    { //transito
                        type: 'autocomplete', source: transitoArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !transitoArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //procesador externo
                        type: 'autocomplete', source: si_noArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !si_noArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //num procesador externo
                        type: 'autocomplete', strict: false, filter: true, source: proveedoresArray,
                        validator: function (value, callback) {
                            let max = 120;
                            let aplicaPE = hot.getDataAtCell(this.row, GetColFromName("Procesadores Ext."));

                            if ((aplicaPE != null && aplicaPE.toUpperCase().includes("SÍ") && (value == null || value == ''))) {
                                toastMixin.fire({ title: 'Este campo es obligatorio.', icon: 'warning' });
                                callback(false);
                            } else {

                                if (value != null && value.length > max) {
                                    toastMixin.fire({ title: 'El campo Procesador Externo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                    callback(false);
                                } else {
                                    callback(true);
                                }
                            }
                        }
                    },
                    { //num antigüo material
                        validator: function (value, callback) {
                            let max = 18;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //planicidad
                    { //msa honda
                        validator: function (value, callback) {
                            let max = 18;
                            let clienteNumero = hot.getDataAtCell(this.row, GetColFromName("Núm. cliente"));

                            if ((clienteNumero != null && clienteNumero.toUpperCase().includes("HONDA") && (value == null || value == ''))) {
                                toastMixin.fire({ title: 'Este campo es obligatorio en cliente Honda.', icon: 'warning' });
                                callback(false);
                            } else {

                                if (value != null && value.length > max) {
                                    toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                    callback(false);
                                    // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                                }
                                else {
                                    callback(true);
                                }
                            }
                        }
                    },
                    { // fecha validez  (necesita moment JS)
                        type: 'date', dateFormat: 'DD/MM/YYYY',
                        validator: function (value, callback) {
                            //determina si es obligatorio, según tipo de venta
                            let tipoVenta = hot.getDataAtCell(this.row, GetColFromName("Tipo de Venta"));

                            //obtiene si la fecha es valida
                            let fechaValida = moment(value, 'DD/MM/YYYY', true).isValid()
                            let fechaPasado = false;

                            if (fechaValida) {
                                let fechaActual = moment();
                                let fechaEnviada = moment(value, 'DD/MM/YYYY').add(1, 'd');
                                fechaPasado = fechaEnviada.isBefore(fechaActual);
                            }


                            if (tipoVenta == "Reaplicación" || tipoVenta == "Venta Spot" || tipoVenta == "Factory Assist" || tipoVenta == "Pre-serie") {
                                //  si fecha valida
                                if (fechaValida) {
                                    callback(true)
                                    //if (!fechaPasado) {
                                    //    callback(true)
                                    //} else {
                                    //    toastMixin.fire({ title: 'La fecha de Validez no puede estar en el pasado.', icon: 'warning' });
                                    //    callback(false)
                                    //}
                                } else {
                                    toastMixin.fire({ title: 'El campo Fecha de Validez es obligatorio en Reaplicación, Venta Spot, Factory Assist y Pre-serie.', icon: 'warning' });
                                    callback(false)
                                }
                            } else {
                                //si fecha valida o vacio
                                if (value == null || value == '') {
                                    callback(true);
                                } else {
                                    //  si fecha valida
                                    callback(fechaValida)
                                    //if (!fechaPasado) {
                                    //    callback(fechaValida)
                                    //} else {
                                    //    toastMixin.fire({ title: 'La fecha de Validez no puede estar en el pasado.', icon: 'warning' });
                                    //    callback(false)
                                    //}
                                }
                            }

                        },
                        correctFormat: true,
                    },
                    { type: 'autocomplete', source: disponentesArray, strict: false }, //Disponente asignado
                    { //unidad medida ventas
                        type: 'autocomplete', source: unidadMedidaArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value != null && value != '') && !unidadMedidaArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    //Budget
                    { readOnly: true }, //tipo material
                    {  //int/ext
                        type: 'autocomplete', source: tipoIntExtArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !tipoIntExtArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {//posición del rollo
                        type: 'autocomplete', source: posicionRolloArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !posicionRolloArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //modelo Negocio
                        type: 'autocomplete', source: modeloNegocioArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !modeloNegocioArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso bruto REAL bascula (kg)
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso neto REAL bascula (kg)
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Ángulo A
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Ángulo B
                    { type: 'numeric', renderer: 'porcentaje_render', validator: 'percentageNumbers' }, //Scrap permitido %
                    { //piezas dobles
                        type: 'autocomplete', source: piezasDoblesArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value == null || value == '' || piezasDoblesArray.includes(value)) {
                                callback(true);
                            }
                            else {
                                callback(false);
                            }
                        }
                    },
                    { // Reaplicacion
                        type: 'checkbox',
                        className: 'htCenter',
                    },
                    { //Req. consiliación puntas y colas
                        type: 'checkbox',
                        className: 'htCenter',
                    },
                    {//conciliacion scrap ing
                        type: 'checkbox',
                        className: 'htCenter',
                    },
                    { //Pais S&P
                        type: 'autocomplete', strict: true, filter: true, source: countryArray,
                        validator: function (value, callback) {
                            if (!countryArray.includes(value)) {
                                callback(false);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    {
                        // IHS1
                        type: 'autocomplete',
                        strict: false,
                        filter: true,
                        source: function (query, process) {
                            const country = hot.getDataAtCell(this.row, GetColFromName("Pais S&P"));
                            const list = country === 'MEX'
                                ? IHSMEXArray
                                : country === 'USA'
                                    ? IHSUSAArray
                                    : [];
                            process(list);
                        },
                        validator: function (value, cb) {
                            // 1) Vacío → OK
                            
                            // 2) Debe estar en la lista del país
                            const country = hot.getDataAtCell(this.row, GetColFromName("Pais S&P"));
                            const list = country === 'MEX'
                                ? IHSMEXArray
                                : country === 'USA'
                                    ? IHSUSAArray
                                    : [];
                            if (!list.includes(value)) {
                                return cb(false);
                            }

                            // 3) Si no es “Otros” ya está cubierto
                            if (value !== 'Others' && value !== 'Otros') {
                                return cb(true);
                            }

                            // 4) Si es “Otros”, hacemos la llamada SÍNCRONA
                            let allow = true;
                            try {
                                const cliente = hot.getDataAtCell(this.row, GetColFromName("Núm. cliente"));
                                const xhr = $.ajax({
                                    url: '/SCDM_solicitud/CheckIfClientIsAutomotive',
                                    type: 'POST',
                                    data: { cliente },
                                    async: false,           // <- clave: bloquea hasta la respuesta
                                    dataType: 'json'
                                });
                                // xhr.responseJSON contiene la respuesta
                                if (xhr.status === 200 && xhr.responseJSON) {
                                    allow = !xhr.responseJSON.isAutomotive;
                                }
                            } catch (e) {
                                // en caso de error de red dejamos pasar
                                allow = true;
                            }

                            return cb(allow);
                        }
                    },
                    // IHS2 → idéntico a IHS1
                    {
                        type: 'autocomplete',
                        strict: false,
                        filter: true,
                        source: function (q, process) {
                            const country = hot.getDataAtCell(this.row, GetColFromName("Pais S&P"));
                            process(country === 'MEX' ? IHSMEXArray : country === 'USA' ? IHSUSAArray : []);
                        },
                        validator: function (v, cb) {
                            if (!v) return cb(true);
                            const country = hot.getDataAtCell(this.row, GetColFromName("Pais S&P"));
                            const list = country === 'MEX' ? IHSMEXArray : country === 'USA' ? IHSUSAArray : [];
                            cb(list.includes(v));
                        }
                    },
                    // IHS3 → idéntico
                    {
                        type: 'autocomplete',
                        strict: false,
                        filter: true,
                        source: function (q, process) {
                            const country = hot.getDataAtCell(this.row, GetColFromName("Pais S&P"));
                            process(country === 'MEX' ? IHSMEXArray : country === 'USA' ? IHSUSAArray : []);
                        },
                        validator: function (v, cb) {
                            if (!v) return cb(true);
                            const country = hot.getDataAtCell(this.row, GetColFromName("Pais S&P"));
                            const list = country === 'MEX' ? IHSMEXArray : country === 'USA' ? IHSUSAArray : [];
                            cb(list.includes(v));
                        },
                    },
                    { readOnly: true }, //Propulsion
                    { readOnly: true }, //Program
                    {
                    // ¿Almacén Norte?
                        type: 'autocomplete',
                        source: si_noArray,
                        readOnly: @Model.planta_solicitud !== 1,
                        validator: function (value, callback) {
                            // si está deshabilitada, la consideramos siempre válida
                            if (@Model.planta_solicitud !== 1) {
                                return callback(true);
                            }
                            // obligatorio cuando plantaSolicitud == 1
                            if (value == null || value === '') {
                                toastMixin.fire({
                                    title: 'El campo Almacén Norte es obligatorio para esta planta.',
                                    icon: 'warning'
                                });
                                return callback(false);
                            }
                            // si no está vacío, debe venir del array
                            if (!si_noArray.includes(value)) {
                                toastMixin.fire({
                                    title: 'Selecciona "SÍ" o "NO".',
                                    icon: 'warning'
                                });
                                return callback(false);
                            }
                            callback(true);
                        }
                    },
                    { // Tipo Transporte
                        type: 'autocomplete',
                        source: tipoTransporteArray,
                        filter: true,
                        validator: function (value, callback) {
                            // siempre obligatorio
                            if (value == null || value === '') {
                                toastMixin.fire({
                                    title: 'Tipo de Transporte es obligatorio.',
                                    icon: 'warning'
                                });
                                return callback(false);
                            }
                            if (!tipoTransporteArray.includes(value)) {
                                toastMixin.fire({
                                    title: 'Selecciona un valor válido de la lista.',
                                    icon: 'warning'
                                });
                                return callback(false);
                            }
                            callback(true);
                        }
                    },
                    {
                        // Stacks por Paquete
                        type: 'numeric',
                        // opcional: permitimos vacío
                        validator: function (value, callback) {
                            // si está vacío, es válido
                            if (value == null || value === '') {
                                return callback(true);
                            }
                            // si no, tiene que ser un entero ≥ 0
                            // nota: Handsontable pasa value como número siempre que el usuario no escriba texto
                            // pero por si acaso lo convertimos a string:
                            const s = value.toString();
                            if (/^[0-9]+$/.test(s)) {
                                return callback(true);
                            }
                            // inválido: notifica y marca
                            toastMixin.fire({
                                title: 'Stacks por Paquete debe ser un número entero ≥ 0 o quedar vacío.',
                                icon: 'warning'
                            });
                            callback(false);
                        }
                    },
                    { // Tipo de Pallet
                        type: 'autocomplete',
                        source: tipoPalletArray,
                        filter: true,
                        strict: false, // permitimos libre edición y no forzamos una selección
                        validator: function (value, callback) {
                            // opcional: vacío siempre válido
                            if (value == null || value === '') {
                                return callback(true);
                            }
                            // longitud máxima 20
                            if (value.length > 20) {
                                toastMixin.fire({
                                    title: 'El campo Tipo de Pallet debe tener como máximo 20 caracteres.',
                                    icon: 'warning'
                                });
                                return callback(false);
                            }
                            // si quisieras restringir sólo a los del array, descomenta esto:
                            // if (!tipoPalletArray.includes(value)) return callback(false);
                            // pero como permites nuevos, simplemente devolvemos verdadero
                            callback(true);
                        }
                    },
                    // tkMM SOP (OBLIGATORIO)
                    {
                        type: 'date',
                        dateFormat: 'YYYY-MM',
                        correctFormat: true,
                        validator: function (value, callback) {
                            const row = this.row;
                            const colE = GetColFromName('tkMM EOP');

                            // 1) Normalizo/extraigo el SOP y EOP
                            let sop = normalizeDateValue(value);
                            let eop = normalizeDateValue(hot.getDataAtCell(row, colE));

                            // 2) Verifico que SOP no esté vacío
                            if (!sop) {
                                toastMixin.fire({ icon: 'warning', title: 'Campo SOP es obligatorio.' });
                                return callback(false);
                            }

                            // 3) Valido formato YYYY-MM
                            if (!moment(sop, 'YYYY-MM', true).isValid()) {
                                toastMixin.fire({ icon: 'warning', title: 'Formato SOP inválido. Use AAAA-MM' });
                                return callback(false);
                            }

                            // 4) Si ya existe EOP, compruebo que SOP < EOP
                            if (eop) {
                                if (!moment(sop).isBefore(moment(eop))) {
                                    toastMixin.fire({ icon: 'warning', title: 'SOP debe ser anterior a EOP' });
                                    return callback(false);
                                }
                            }

                            // 5) Si llegó hasta aquí, pasamos
                            callback(true);
                        }
                    },
                    // tkMM EOP (se permite vacío aunque exista SOP)
                    {
                        type: 'date',
                        dateFormat: 'YYYY-MM',
                        correctFormat: true,
                        validator: function (value, callback) {
                            const row = this.row;
                            const colS = GetColFromName('tkMM SOP');
                            // Obtenemos SOP en su forma normalizada:
                            let sop = normalizeDateValue(hot.getDataAtCell(row, colS));
                            // Normalizamos el valor que viene como EOP:
                            let eop = normalizeDateValue(value);

                            // 1) Si EOP está vacío, siempre es válido (no importa SOP)
                            if (!eop) {
                                return callback(true);
                            }

                            // 2) Validar formato YYYY-MM
                            if (!moment(eop, 'YYYY-MM', true).isValid()) {
                                toastMixin.fire({ icon: 'warning', title: 'Formato EOP inválido. Use AAAA-MM' });
                                return callback(false);
                            }

                            // 3) Si existe SOP y existe EOP, verificar que SOP < EOP
                            if (sop) {
                                // moment(sop) ya está garantizado que sea un YYYY-MM válido (por el validador de SOP)
                                if (!moment(sop).isBefore(moment(eop))) {
                                    toastMixin.fire({ icon: 'warning', title: 'EOP debe ser posterior a SOP' });
                                    return callback(false);
                                }
                            }

                            // 4) Si llegó hasta aquí, todo OK
                            callback(true);
                        }
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Piezas por auto
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Piezas por golpe
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Piezas por paquete
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Inicial
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Máximo
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Maximo Tolerancia Positiva
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Maximo Tolerancia Negativa
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Minimo
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Mínimo Tolerancia Positiva
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Mínimo Tolerancia Negativa
                ],
                colWidths: [
                    0,                 // ID
                    120,               // Número Material
                    130,               // Material del cliente
                    150,               // Tipo de Venta
                    120,               // Núm. ODC cliente
                    300,               // Núm. cliente
                    100,               // Requiere PPAP's
                    80,                // Req. IMDS
                    300,               // Proveedor
                    150,               // Nombre Molino
                    200,               // Tipo Metal
                    130,               // Unidad Base Medida
                    220,               // Grado/Calidad
                    210,               // Tipo de Material
                    200,               // ¿Aprovisionamiento?
                    150,               // Núm. parte del cliente
                    180,               // Descripción núm. de parte
                    130,               // Norma de referencia
                    110,               // Espesor (mm)
                    200,               // Tolerancia espesor negativa (mm)
                    200,               // Tolerancia espesor positiva (mm)
                    100,               // Ancho (mm)
                    200,               // Tolerancia ancho negativa (mm)
                    200,               // Tolerancia ancho positiva (mm)
                    250,               // Descripción Material (ES)
                    250,               // Descripción Material (EN)
                    150,               // Diametro interior (mm)
                    200,               // Diametro exterior máximo (mm)
                    150,               // Peso del recubrimiento
                    130,               // Transito
                    120,               // Procesadores Ext.
                    350,               // Número procesador Ext.
                    150,               // Núm. antigüo material
                    100,               // Planicidad (mm)
                    100,               // MSA (Honda)
                    100,               // Fecha validez
                    300,               // Disponente asignado
                    150,               // Unidad Medida Ventas
                    //BUDGET
                    160,                //tipo de material
                    100,               // Parte Int/Ext
                    220,               // Posición del Rollo para embarque
                    220,               // Modelo de negocio
                    180,               //Peso bruto REAL bascula (kg)
                    170,               //Peso neto REAL bascula (kg)
                    80,                //Ángulo A
                    80,                //Ángulo A
                    120,               // Scrap permitido (%)
                    100,               //Piezas Dobles
                    100,               //Reaplicación
                    200,               // Req. conciliación Puntas y colas
                    180,               //Conciliación Scrap Ingenieria
                    80,               // Pais S&P
                    500,               // S&P 1 (antes IHS)
                    500,               // S&P 2 (antes IHS)
                    500,               // S&P 3 (antes IHS)
                    400,               // Propulsion System
                    400,               // Program
                    110,               // ¿Almacen Norte?
                    100,               // Tipo Transporte
                    120,               // Stacks por Paquete
                    180,               // Tipo de Pallet
                    100,               // tkMM SOP
                    100,               // tkMM EOP
                    95, // piezas por auto
                    105, // piezas por golpe
                    120, // piezas por paquete
                    80, // peso inicial
                    150, // peso máximo entrega cinta
                    200, // peso minimo tolerancia +
                    200, // peso minimo tolerancia -
                    90, // peso ming KG
                    200, // peso min tol +
                    200, // peso min tol -
                ],
                hiddenColumns: {
                    // specify columns hidden by default
                    columns: [0, GetColFromName("Disponente asignado")
                        , GetColFromName("Piezas por auto")
                        , GetColFromName("Piezas por paquete")
                        , GetColFromName("Peso Inicial")
                        , GetColFromName("Ángulo A")
                        , GetColFromName("Ángulo B")
                        , GetColFromName("Peso neto REAL bascula (kg)")
                        , GetColFromName("Peso bruto REAL bascula (kg)")
                        , GetColFromName("Piezas Dobles")
                        , GetColFromName("Piezas por golpe")
                        , GetColFromName("Stacks por Paquete")
                        , GetColFromName("Tipo de Pallet")
                    ], //contains ID
                },
                rowHeaders: true,
                width: '100%',
                height: '400px',
                renderAllRows : true,
                manualColumnResize: true,
                licenseKey: 'non-commercial-and-evaluation',
                copyPaste: true,
                contextMenu: {
                    items: {
                        'undo': {},
                        'redo': {},
                        '---------': {},
                        'cut': {},
                        'copy': {},
                        // Opción personalizada para "Pegar" que respeta las celdas de solo lectura
                        'customPaste': {
                            name: 'Pegar',
                            callback: function () {
                                if (navigator.clipboard && navigator.clipboard.readText) {
                                    navigator.clipboard.readText().then(function (text) {
                                        // Separa el texto copiado en filas (usualmente separadas por saltos de línea)
                                        let rows = text.split(/\r?\n/);
                                        // Si la última fila está vacía, la eliminamos
                                        if (rows.length && rows[rows.length - 1] === '') {
                                            rows.pop();
                                        }

                                        // Obtiene la celda o rango actualmente seleccionado
                                        let selected = hot.getSelected(); // Ej: [[filaInicio, colInicio, filaFin, colFin]]
                                        if (selected && selected.length) {
                                            let startRow = selected[0][0];
                                            let startCol = selected[0][1];

                                            // Recorre cada fila del bloque copiado
                                            for (let i = 0; i < rows.length; i++) {
                                                // Separa cada fila en columnas (usualmente separadas por tabuladores)
                                                let values = rows[i].split("\t");
                                                for (let j = 0; j < values.length; j++) {
                                                    let targetRow = startRow + i;
                                                    let targetCol = startCol + j;
                                                    // Verifica si la celda destino no es de solo lectura
                                                    let meta = hot.getCellMeta(targetRow, targetCol);
                                                    if (!meta.readOnly) {
                                                        hot.setDataAtCell(targetRow, targetCol, values[j]);
                                                    }
                                                }
                                            }
                                        }
                                    }).catch(function (err) {
                                        alert('Error al acceder al portapapeles: ' + err);
                                    });
                                } else {
                                    alert('La API del portapapeles no está disponible en este navegador.');
                                }
                            }
                        }
                    }
                },
                language: 'es-MX',
                cells: function (row, col) {
                    console.log('entra cells')
                    let cp = {}
                    if (col === GetColFromName("Scrap permitido (%)")) {
                        cp.renderer = myPercentage
                    }

                    return cp
                },
                afterChange: (changes) => {
                    changes?.forEach(([row, prop, oldValue, newValue]) => {

                        // Comprobamos si el valor cambió y si era una celda previamente confirmada
                        if (oldValue !== newValue && valorConfirmado(row, headers[prop])) {
                            // Si hubo un cambio en una celda confirmada, la marcamos como no confirmada
                            confirmaciones[`${row}-${headers[prop]}`] = false;

                            // Removemos la clase de confirmación anterior
                            hot.setCellMeta(row, prop, 'className', 'celdaSinConfirmar');
                            hot.render(); // Re-renderizamos la tabla para reflejar los cambios visuales

                            console.log(`Celda cambiada - Fila: ${row}, Columna: ${prop}, Estado de confirmación actualizado a no confirmado`);
                        }

                        switch (prop) {
                            case GetColFromName("Material del cliente"): //CM
                                CambioMaterialCliente(row, newValue);
                                CambioAluminio(row);
                                RestableceIMDs(row);
                                break;
                            case GetColFromName("Tipo Metal"): //tipo de Metal
                                CambioAluminio(row);
                                cambioPesoMax(row);
                                EstableceIntExt(row);
                                break;
                            case GetColFromName("Espesor (mm)"): //espesor
                            case GetColFromName("Ancho (mm)"): //ancho
                            case GetColFromName("Grado/Calidad"): //grado
                                cambioDescripcion(row);
                                cambioPesoMax(row);
                                break;
                            case GetColFromName("Diametro interior (mm)"): //diametro interior
                                cambioPesoMax(row);
                            case GetColFromName("Tipo de Venta"): //diametro interior
                                RestablecePPAPs(row);
                            case GetColFromName("Parte Int/Ext"): //diametro interior
                                EstablecePorcentajeScrap(row);
                            case GetColFromName("Procesadores Ext."): //diametro interior
                                EstableceProcesadorExterno(row);
                            case GetColFromName("Núm. cliente"): //diametro interior
                                RestableceMSA(row);
                                break;
                            case GetColFromName("S&P 1 (antes IHS)"): //IHS
                            case GetColFromName("S&P 2 (antes IHS)"): //IHS
                            case GetColFromName("S&P 3 (antes IHS)"): //IHS
                                ConcatenaIHS(row, newValue);
                                break;
                            case GetColFromName("Pais S&P"):
                                // 1) Índices de las 3 columnas IHS
                                const ihsHdrs = [
                                    'S&P 1 (antes IHS)',
                                    'S&P 2 (antes IHS)',
                                    'S&P 3 (antes IHS)'
                                ];
                                // 2) Borra sólo esa fila
                                ihsHdrs.forEach(hdr => {
                                    const colIdx = GetColFromName(hdr);
                                    hot.setDataAtCell(row, colIdx, null);
                                });
                                break;


                        }
                    });

                },
                outsideClickDeselects: false,

            });


            //agrega eventos
            hot.addHook('afterCreateRow', (row, amount) => {
                ValidaNumeroMaterial();

            })
            hot.addHook('afterRemoveRow', (row, amount) => {
                ValidaNumeroMaterial();
            })
            //determina los decimales a mostrar
            hot.addHook('beforeChange', (changes, source) => {

                switch (changes[0][1]) {
                    case GetColFromName("Espesor (mm)"): //4 decimales
                    case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                    case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                    case GetColFromName("Ancho (mm)"): //4 decimales
                    case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                    case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                    case GetColFromName("Peso Min (KG)"): //4 decimales
                    case GetColFromName("Peso Mínimo Tolerancia Positiva"): //4 decimales
                    case GetColFromName("Peso Mínimo Tolerancia Negativa"): //4 decimales
                    case GetColFromName("Peso Max (KG)"): //4 decimales
                    case GetColFromName("Peso Maximo Tolerancia Positiva"): //4 decimales
                    case GetColFromName("Peso Maximo Tolerancia Negativa"): //4 decimales
                    case GetColFromName("Peso Inicial"): //4 decimales
                        if (changes[0][3]!='')
                            changes[0][3] = Math.round(changes[0][3] * 10000) / 10000;
                        break;
                    case GetColFromName("Planicidad (mm)"): //3 decimales
                    case GetColFromName("Peso bruto REAL bascula (kg)"): //3 decimales
                    case GetColFromName("Peso neto REAL bascula (kg)"): //3 decimales
                    case GetColFromName("Piezas por golpe"): //3 decimales
                        if (changes[0][3]!='')
                            changes[0][3] = Math.round(changes[0][3] * 1000) / 1000;
                        break;
                    case GetColFromName("Scrap permitido (%)"): //2 decimales
                    case GetColFromName("Ángulo A"): //2 decimales
                    case GetColFromName("Ángulo B"): //2 decimales
                    case GetColFromName("Piezas por auto"): //2 decimales
                        if (changes[0][3]!='')
                            changes[0][3] = Math.round(changes[0][3] * 100) / 100;
                        break;
                    case GetColFromName("Piezas por paquete"): //0 decimales
                        if (changes[0][3] != '')
                            changes[0][3] = Math.round(changes[0][3]);
                        break;

                }


            })

            //actualiza la configuracion de la tabla para habilitar y deshabilitar campos
            hot.updateSettings({

                cells: function (row, col) {
                    //crea variable para almacenar las propiedaes de la celda
                    var cellProperties = {};

                    //determina si de debe habilitar la columna de Req PAPs en base al tipo de venta
                    let tipoVenta = hot.getDataAtCell(this.row, GetColFromName("Tipo de Venta"));
                   //if (col == GetColFromName("Requiere PPAP's")) {
                   //    if (tipoVenta != null && tipoVenta.toUpperCase().includes("SPOT")) {
                   //         cellProperties.readOnly = false;
                   //     } else {
                   //         cellProperties.readOnly = true;
                   //     }
                   // }

                    //determina si habilta la columna de IMDS segun si es CM o OWN
                    let materialCliente = hot.getDataAtCell(this.row, GetColFromName("Material del Cliente"));
                    //if (col == GetColFromName("Req. IMDS")) {
                    //    if (materialCliente != null && materialCliente.toUpperCase().includes("NO")) {
                    //        cellProperties.readOnly = false;
                    //    } else {
                    //        cellProperties.readOnly = true;
                    //    }
                    //}

                    //determina si debe habilitar proveedor
                    //if (col == GetColFromName("Proveedor")) {
                    //    if (materialCliente != null && materialCliente.toUpperCase().includes("NO")) {
                    //        cellProperties.readOnly = false;
                    //    } else {
                    //        cellProperties.readOnly = true;
                    //    }
                    //}

                    //determina si habilita la celda de procesador externo
                    let AplicaProcesadorExterno = hot.getDataAtCell(this.row, GetColFromName("Procesadores Ext."));
                    if (col == GetColFromName("Número procesador Ext.")) {
                        if (AplicaProcesadorExterno != null && AplicaProcesadorExterno.toUpperCase().includes("SÍ")) {
                            cellProperties.readOnly = false;
                        } else {
                            cellProperties.readOnly = true;
                        }
                    }

                    //determina si la celda de int esta habilitada o no
                    let tipoMetal = hot.getDataAtCell(this.row, GetColFromName("Tipo Metal"));
                    if (col === GetColFromName("Parte Int/Ext")) {
                        if (tipoMetal != null && tipoMetal != '' && !tipoMetal.toUpperCase().includes("EXPUESTO")) {
                            cellProperties.readOnly = false;
                        } else {
                            cellProperties.readOnly = true;
                        }
                    }

                    //determina si MSA honda es requerido o no
                    let clienteNumero = hot.getDataAtCell(this.row, GetColFromName("Núm. cliente"));
                    if (col === GetColFromName("MSA (Honda)")) {
                        if (clienteNumero != null && clienteNumero != '' && clienteNumero.toUpperCase().includes("HONDA")) {
                            cellProperties.readOnly = false;
                        } else {
                            cellProperties.readOnly = true;
                        }
                    }

                    //determina si angulo A y B están habilitados
                    if (col == GetColFromName("Fecha validez")) {
                        if (tipoVenta != null && tipoVenta.toUpperCase().includes("FACTORY ASSIST")
                            || tipoVenta != null && tipoVenta.toUpperCase().includes("SPOT")
                            || tipoVenta != null && tipoVenta.toUpperCase().includes("REAPLICACIÓN")
                        ) {
                            cellProperties.readOnly = false;
                        } else {
                            cellProperties.readOnly = true;
                        }
                    }

                    //aplica el estilo a la celda de scrap
                    if (col === GetColFromName("Scrap permitido (%)")) {
                        cellProperties.readOnly = true;
                        cellProperties.renderer = myPercentage
                    }
                    //retorna las propiedades de la celda
                    return cellProperties;
                },
            });


        }

        function normalizeDateValue(val) {
            if (val instanceof Date && !isNaN(val)) {
                // lo pasamos a YYYY-MM
                return moment(val).format('YYYY-MM');
            }
            return val;
        }

        //en caso de que se modifique Tipo de venta, restablece el valor de Req PPAPs si el Tipo Venta no es SPOT
        function RestablecePPAPs(row) {
            let tipoVenta = hot.getDataAtCell(row, GetColFromName("Tipo de Venta"));
            if (tipoVenta != null && !tipoVenta.toUpperCase().includes("SPOT")) {
                hot.setDataAtCell(row, GetColFromName("Requiere PPAP's"), '', null);
            }

            //tambien restablece fecha validez
            if (tipoVenta != null && !tipoVenta.toUpperCase().includes("FACTORY ASSIST")
                && !tipoVenta.toUpperCase().includes("SPOT")
                && !tipoVenta.toUpperCase().includes("REAPLICACIÓN")
            ) {
                hot.setDataAtCell(row, GetColFromName("Fecha validez"), '', null);
            }

        }
         //en caso de que se modifique Material Cliente, restablece el valor de IMDS si es diferente de NO
        function RestableceIMDs(row) {
            let materialCliente = hot.getDataAtCell(row, GetColFromName("Material del Cliente"));
            if (materialCliente != null && !materialCliente.toUpperCase().includes("NO")) {
                hot.setDataAtCell(row, GetColFromName("Req. IMDS"),'', null);
            }
            //tambien restablece proveedor
            //if (materialCliente != null && !materialCliente.toUpperCase().includes("NO")) {
            //    hot.setDataAtCell(row, GetColFromName("Proveedor"), '', null);
            //}
        }
          //en caso de que se modifique el cliente y ya no sea Honda
        function RestableceMSA(row) {
            let cliente = hot.getDataAtCell(row, GetColFromName("Núm. cliente"));
            if (cliente != null && !cliente.toUpperCase().includes("HONDA")) {
                hot.setDataAtCell(row, GetColFromName("MSA (Honda)"),'', null);
            }
        }
        //Si el matierial es OWN no aplica procesador Externo
        function EstableceProcesadorExterno(row) {
            let AplicaProcesadorExterno = hot.getDataAtCell(row, GetColFromName("Procesadores Ext."));
            if (AplicaProcesadorExterno != null && !AplicaProcesadorExterno.toUpperCase().includes("SÍ")) {
                hot.setDataAtCell(row, GetColFromName("Número Procesador Ext."),'', null);
            }
        }
         //Establece el porcentaje de scrap segun si es int/exterior
        function EstablecePorcentajeScrap(row) {
            let tipoExposicion = hot.getDataAtCell(row, GetColFromName("Parte Int/Ext"));
            if (tipoExposicion != null && tipoExposicion.toUpperCase().includes("INT")) {
                hot.setDataAtCell(row, GetColFromName("Scrap permitido (%)"),'1.5', null);
            } else if (tipoExposicion != null && tipoExposicion.toUpperCase().includes("EXT")) {
                hot.setDataAtCell(row, GetColFromName("Scrap permitido (%)"), '2.5', null);
            }
        }
        //Establece si es Interno o Externo
        function EstableceIntExt(row) {
            let tipoMetal = hot.getDataAtCell(row, GetColFromName("Tipo Metal"));
            if (tipoMetal != null && tipoMetal.toUpperCase().includes("NO EXPUESTO")) {
                hot.setDataAtCell(row, GetColFromName("Parte Int/Ext"), 'Interior', null);
            } else if (tipoMetal != null && tipoMetal.toUpperCase().includes("EXPUESTO")) {
                hot.setDataAtCell(row, GetColFromName("Parte Int/Ext"), 'Exterior', null);
            } else {
                hot.setDataAtCell(row, GetColFromName("Parte Int/Ext"), '', null);
            }
        }

        function ValidaNumeroMaterial() {
            //valida nuevamente los numero material
            for (var i = 0; i < hot.countRows(); i++) {
                let valorActual = hot.getDataAtCell(i, GetColFromName("Número Material"));

                if (valorActual == null || valorActual.includes("Rollo"))
                    hot.setDataAtCell(i, GetColFromName("Número Material"), "Rollo" + (i + 1));

                //coloca Rollo en Material
                hot.setDataAtCell(i, GetColFromName("Tipo de Material (Budget)"), "ROLLO");

            }
        }

        function cambioPesoMax(row) {
            let diametroInt = hot.getDataAtCell(row, GetColFromName("Diametro interior (mm)"));
            let tipoMetal = hot.getDataAtCell(row, GetColFromName("Tipo Metal"));
            let ancho = hot.getDataAtCell(row, GetColFromName("Ancho (mm)"));
            let densidad = 0;

            //determina la densidad segun el tipo de metal
            switch (tipoMetal) {
                case tipoMetalArray[0]: //acero expuesto
                case tipoMetalArray[1]: //acero no expuesto
                case tipoMetalArray[2]: //acero de alta resistencia
                    densidad = 7850;
                    break;
                case tipoMetalArray[3]: //aluminio no expuesto
                case tipoMetalArray[4]: //aluminio expuesto
                    densidad = 2700;
                    break;
            }

            console.log('dI: ' + diametroInt + ', ancho: ' + ancho + ",  densidad: " + densidad);

            let pesoMax = ((((Math.pow((2000 / 2), 2)) * 3.1416 * ancho * densidad) / 1000000000) - (((Math.pow((diametroInt / 2), 2)) * 3.1416 * ancho * densidad) / 1000000000))

            if (pesoMax > 24500) {
                pesoMax = 24500;
            } else {
                pesoMax = Math.floor((pesoMax / 500)) * 500
            }

            let pesoMin = pesoMax * 0.9;

            //signa los valores a la tabla
            hot.setDataAtCell(row, GetColFromName("Diametro exterior máximo (mm)"), 2000);
            hot.setDataAtCell(row, GetColFromName("Peso Min (KG)"), Math.round(pesoMin/100)*100);
            hot.setDataAtCell(row, GetColFromName("Peso Max (KG)"), pesoMax);

        }
        function CambioMaterialCliente(row, newValue) {
            hot.setDataAtCell(row, GetColFromName("Unidad Base Medida"), "KG");
            if (newValue == si_noArray[0]) {
                hot.setDataAtCell(row, GetColFromName("Tipo de Material"), "Z_CM --> Customer Material");
            }
            hot.setDataAtCell(row, GetColFromName("¿Aprovisionamiento?"), "Acopio Externo");
            //DISPONENTE PENDIENTE
        }

        function cambioDescripcion(row) {
            let espesor = hot.getDataAtCell(row, GetColFromName("Espesor (mm)"));
            let ancho = hot.getDataAtCell(row, GetColFromName("Ancho (mm)"));
            let grado = hot.getDataAtCell(row, GetColFromName("Grado/Calidad"));

            if (grado != null)
                grado = grado.toUpperCase();

            if (espesor == null || espesor == '')
                espesor = 0;
            if (ancho == null || ancho == '')
                ancho = 0;
            if (grado == null)
                grado = '';

            //español
            hot.setDataAtCell(row, GetColFromName("Descripción Material (ES)"), `${espesor}X${ancho} ROL (${grado})`);
            //ingles
            hot.setDataAtCell(row, GetColFromName("Descripción Material (EN)"), `${espesor}X${ancho} COI (${grado})`);

        }

         function CambioAluminio(row) {
             let tipo_material = hot.getDataAtCell(row, GetColFromName("Tipo Metal"));
             let cm = hot.getDataAtCell(row, GetColFromName("Material del cliente"));

            if (cm != si_noArray[0] && tipo_material != null && tipo_material.includes("Aluminio")) {
                hot.setDataAtCell(row, GetColFromName("Tipo de Material"), "Z_AL --> Aluminizado");
             }
        }

        function GuardaComentario() {

            let comentario = $('#comentario').val();
            //llamada ajax para obtener el detalle del item  seleccionado
            $.ajax({
                type: 'POST',
                url: '/SCDM_solicitud/GuardaComentario',
                data: { id_solicitud: @Model.id, id_seccion: @((int)Bitacoras.Util.SCDMSeccionesSolicitud.ROLLO), comentario: comentario },
                success: function (data) {
                    console.log(data);
                    try {
                        console.log(data[0].resultado);
                        //hot.setDataAtCell(row, GetColFromName("Tipo Material<br>(componente)"), data[0].tipo_material );
                    }
                    catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error al guardar el comentario: ' + error,
                            confirmButtonText: 'Aceptar',
                        })
                    }
                },
                async: false
            });
        }

        //en caso de que se modifique el IHS
        function ConcatenaIHS(row, newValue) {

            let spValues = [
                hot.getDataAtCell(row, GetColFromName("S&P 1 (antes IHS)")),
                hot.getDataAtCell(row, GetColFromName("S&P 2 (antes IHS)")),
                hot.getDataAtCell(row, GetColFromName("S&P 3 (antes IHS)")),
            ];

            // Realiza la llamada AJAX para concatenar los valores IHS
            //if (newValue != null && newValue !== '') {
                $.ajax({
                    type: 'POST',
                    url: '/SCDM_solicitud/ConcatenateIHS',
                    data: { spValues: spValues },
                    success: function (data) {
                        // Actualiza la celda correspondiente con el valor concatenado
                        hot.setDataAtCell(row, GetColFromName("Program"), data.concatenatedIHS);
                        hot.setDataAtCell(row, GetColFromName("Propulsion System"), data.concatenatedPropulsionSystems);
                        hot.setDataAtCell(row, GetColFromName("tkMM EOP"), data.eop);

                    },
                    error: function () {
                        console.error('Error al concatenar los valores IHS.');
                    }
                });
            //}

            if (newValue === 'Otros') {

                //determina si el cliente es automotriz
                let cliente = hot.getDataAtCell(row, GetColFromName("Núm. cliente"));

                // Realiza la llamada AJAX para verificar si el cliente es automotriz
                $.ajax({
                    type: 'POST',
                    url: '/SCDM_solicitud/CheckIfClientIsAutomotive',
                    data: { cliente: cliente },
                    success: function (data) {
                        if (data.isAutomotive) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Advertencia',
                                text: 'El valor de S&P no debe ser "Otros" cuando el cliente es de tipo automotriz.',
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    },
                    error: function () {
                        console.error('Error al verificar el tipo de cliente.');
                    }
                });
            }

        }

        function EnviaFormulario(salir) {
            hot.validateCells((valid) => {
                if (valid) {

                    // Validación adicional para confirmar campos
                    let validacionExtra = true;
                    for (let row = 0; row < hot.countRows(); row++) {
                        for (let col = 0; col < hot.countCols(); col++) {
                            if (colNecesitaValidacion(headers[col]) && !valorConfirmado(row, headers[col])) {
                                validacionExtra = false;
                                // Resaltar las celdas no confirmadas visualmente
                                hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                            }
                        }
                    }

                    hot.render(); // Re-renderizar para aplicar los estilos

                    if (!validacionExtra) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Atención',
                            text: 'Por favor, confirme todos los campos requeridos antes de continuar.',
                            showCancelButton: true,
                            confirmButtonText: 'Confirmar Campos',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                iniciarConfirmacionCeldas();
                            }
                        });
                        return;
                    }

                    GuardaComentario();
                    // ... code for validated cells
                    console.log(hot.getData());
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        url: '/SCDM_solicitud/EnviaRollosForm?id='+@Model.id,
                        data: JSON.stringify(hot.getData()),
                        success: function (data) {

                            try {
                                let result = data.result == null ? data[0].result : data.result;

                                toastMixin.fire({
                                    icon: data.icon == null ? data[0].icon : data.icon,
                                    title: data.message == null ? data[0].message : data.message,
                                    timer: 2000,
                                });

                                if (salir && result == "OK") {
                                    window.location.href = "../EditarSolicitud/@Model.id?viewUser=@Request.Params["viewUser"] ";
                                }

                                //asigna los ids guardados y modificados
                                for (i = 0; i < data.length; i++) {
                                    if (data[i] != null && data[i].result == "OK") {
                                        hot.setDataAtCell(data[i].fila, 0, data[i].id);
                                    }
                                    else {
                                        console.log(data[i]);
                                    }
                                }


                            }
                            catch (error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Ocurrió un error obteniendo la información: ' + error,
                                    confirmButtonText: 'Aceptar',
                                })
                            }
                        },
                        error: function (textStatus, errorThrown) {
                            //en caso de error en la llamada ajax
                            Swal.fire({
                                icon: 'error',
                                title: 'Ocurrió un error',
                                text: 'Intente nuevamente.'
                            })
                        },
                        async: true
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Mensaje',
                        text: 'Para continuar, verifica que no haya celdas marcadas en color rojo.',
                    })
                    console.log(hot.getData());
                }
            })

        }

        //crea validadores
        function DefineValidadores() {

            //validador número positivos
            (Handsontable => {
                function customValidator(query, callback) {
                    try {
                        let obligatorio = false;
                        let positivo = false;
                        let negativo = false;
                        let cero = false;

                        //determina los obligatorios
                        switch (this.col) {
                            case GetColFromName("Espesor (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                            case GetColFromName("Ancho (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                            //case GetColFromName("Planicidad (mm)"): //3 decimales
                            case GetColFromName("Diametro exterior máximo (mm)"): //3 decimales
                            case GetColFromName("Peso Min (KG)"): //3 decimales
                            case GetColFromName("Peso Max (KG)"): //3 decimales
                                obligatorio = true;
                                break;
                        }

                        //permite positivos
                        switch (this.col) {
                            case GetColFromName("Espesor (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                            case GetColFromName("Ancho (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                            case GetColFromName("Planicidad (mm)"): //3 decimales
                            case GetColFromName("Diametro exterior máximo (mm)"): //3 decimales
                            case GetColFromName("Peso Min (KG)"): //3 decimales
                            case GetColFromName("Peso Max (KG)"): //3 decimales
                            case GetColFromName("Peso bruto REAL bascula (kg)"):
                            case GetColFromName("Peso neto REAL bascula (kg)"):
                            case GetColFromName("Ángulo A"):
                            case GetColFromName("Ángulo B"):
                            case GetColFromName("Piezas por auto"):
                            case GetColFromName("Piezas por golpe"):
                            case GetColFromName("Piezas por paquete"):
                            case GetColFromName("Peso Inicial"):
                            case GetColFromName("Peso Maximo Tolerancia Positiva"):
                            case GetColFromName("Peso Mínimo Tolerancia Positiva"):
                                positivo = true;
                                break;
                        }

                        //permite negativos
                        switch (this.col) {
                           case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                            case GetColFromName("Peso Maximo Tolerancia Negativa"):
                            case GetColFromName("Peso Mínimo Tolerancia Negativa"):
                                negativo = true;
                                break;
                        }
                        //permite cero
                        switch (this.col) {
                            case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                            case GetColFromName("Peso Min (KG)"): //3 decimales
                            case GetColFromName("Peso Max (KG)"): //3 decimales
                            case GetColFromName("Peso Maximo Tolerancia Negativa"):
                            case GetColFromName("Peso Mínimo Tolerancia Negativa"):
                            case GetColFromName("Peso Maximo Tolerancia Positiva"):
                            case GetColFromName("Peso Mínimo Tolerancia Positiva"):
                                cero = true;
                                break;
                        }

                        //if (GetColFromName("Tolerancia ancho positiva (mm)") == this.col) {
                        //    console.log('obligatorio= ' + obligatorio + ', positivo = ' + positivo+', negativo= '+negativo)
                        //}

                        let num = parseFloat(query);

                        if (!isNaN(query) && num > 0 && positivo || ((query == null || query === '') && !obligatorio) || (num == 0 && cero)) {
                            //valida limite positivos
                            if (this.col == GetColFromName("Espesor (mm)") && (num < .30 || num > 6)) {
                                toastMixin.fire({ title: 'El espesor debe estar entre 0.30 mm y 6.00 mm', icon: 'warning' });
                                callback(false)
                            } else if (this.col == GetColFromName("Ancho (mm)") && num > 2150) {
                                toastMixin.fire({ title: 'El ancho no puede ser mayor a 2150 mm', icon: 'warning' });
                                callback(false)
                            }
                            else {
                                callback(true);
                            }
                        } else if (!isNaN(query) && num < 0 && negativo || ((query == null || query === '') && !obligatorio) || (num == 0 && cero)) {
                            //aqui se validarian los limites en negativos
                            //if (this.col == GetColFromName("Espesor (mm)") &&   num <-3) {
                            //    toastMixin.fire({ title: 'El espesor no debe ser menor a  -0.30 mm', icon: 'warning' });
                            //    callback(false)
                            //} else{callback(true);}
                            callback(true);
                        }
                        else {
                            if (num == 0 && cero)
                                toastMixin.fire({ title: 'Ingrese un número válido.', icon: 'warning' });
                            else if (positivo && !negativo && !cero)
                                toastMixin.fire({ title: 'Sólo se permiten números positivos.', icon: 'warning' });
                            else if (!positivo && negativo && !cero)
                                toastMixin.fire({ title: 'Sólo se permiten números negativos.', icon: 'warning' });
                            else if (positivo && !negativo && cero)
                                toastMixin.fire({ title: 'Sólo se permiten números positivos y cero.', icon: 'warning' });
                            else if (!positivo && negativo && cero)
                                toastMixin.fire({ title: 'Sólo se permiten números negativos y cero.', icon: 'warning' });
                            else
                                toastMixin.fire({ title: 'Número no válido. Favor de verificar', icon: 'warning' });

                            callback(false);
                        }

                        //valida que las tolerancia  de espesores no mayores a espesores
                        if (this.col == GetColFromName("Tolerancia espesor negativa (mm)") || this.col == GetColFromName("Tolerancia espesor positiva (mm)")) {
                            let espesor = parseFloat(hot.getDataAtCell(this.row, GetColFromName("Espesor (mm)")));
                            if (!Number.isNaN(espesor) && espesor != null && espesor != '' && Math.abs(num) >= espesor) {
                                toastMixin.fire({ title: 'La tolerancia debe ser menor al espesor.', icon: 'warning' });
                                callback(false)
                            }
                        }

                    } catch (error) {
                        console.log('error al validar positivo: '+error)
                        callback(false);
                    }
                }

                // Register an alias
                Handsontable.validators.registerValidator('CustomNumbersValidator', customValidator);

            })(Handsontable);



            //validador porcentaje 0-100
            (Handsontable => {
                function customValidator(query, callback) {
                    try {
                        let num = parseFloat(query);
                        if (!isNaN(query) && num >= 0 && num<=100 /*|| (query == null || query === '')*/)
                            callback(true);
                        else
                            callback(false);
                    } catch (error) {
                        console.log('error al validar negativo: ' + error)
                        callback(false);
                    }
                }

                // Register an alias
                Handsontable.validators.registerValidator('percentageNumbers', customValidator);

            })(Handsontable);


        }

        //render para porcentaje
        function myPercentage(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            //console.log(value)
            if (!isNaN(value) && value!= null && value !='') {
                td.innerHTML = `${value} %`
            }

        }

        function GetColFromName(name) {
            var n_cols = headers.length;
            var i = 1;

            for (i = 1; i <= n_cols; i++) {
                if (headers[i] === undefined) {
                    console.log(headers[i] + ' - ' + name)
                }
                if (name.toLowerCase() == headers[i].toLowerCase()) {
                    return i;
                }
            }
            return -1; //return -1 if nothing can be found
        }

        function cargaDatosIniciales() {

             //llamada ajax para obtener el detalle del item  seleccionado
                $.ajax({
                    type: 'POST',
                    url: '/SCDM_solicitud/CargaRollos',
                    data: { id_solicitud: @Model.id},
                    success: function (data) {
                        try {
                            console.log(data);
                            hot.loadData(data);

                            // Aplicar clase 'celdaSinConfirmar' a las celdas que requieren confirmación
                            const totalRows = hot.countRows();
                            const totalCols = hot.countCols();

                            for (let row = 0; row < totalRows; row++) {
                                for (let col = 0; col < totalCols; col++) {
                                    const header = headers[col];

                                    // Verifica si el encabezado de la columna está en la lista de columnas que requieren validación
                                    if (columnasQueNecesitanValidacion.includes(header)) {
                                        hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                                    }
                                }
                            }
                            // Renderizar la tabla nuevamente para aplicar los cambios visuales
                            hot.render();
                        }
                        catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Ocurrió un error obteniendo la información: ' + error,
                                confirmButtonText: 'Aceptar',
                            })
                        }
                    },
                    error: function (errorMsg) {
                        //Execute this function when the request fails
                        Swal.fire({
                            icon: 'error',
                            text: 'Ocurrió un error al obtener la información.',
                        })
                    },
                    async: false
                });
        }

        function insertaFila() {
            // 1) índice de la nueva fila = countRows() (porque alter('insert_row_below', idx,1) inserta tras esa posición)
            const newRowIndex = hot.countRows();

            // 2) inserta la fila
            hot.alter('insert_row_below', newRowIndex, 1);

            // 3) valor por defecto en "Pais S&P"
            const countryCol = GetColFromName("Pais S&P");
            hot.setDataAtCell(newRowIndex, countryCol, "MEX");

            // 5) reaplica tu lógica de "celdas sin confirmar" si usas validación
            const totalCols = hot.countCols();
            for (let colIndex = 0; colIndex < totalCols; colIndex++) {
                const header = hot.getColHeader(colIndex);
                if (colNecesitaValidacion(header)) {
                    hot.setCellMeta(newRowIndex, colIndex, 'className', 'celdaSinConfirmar');
                }
            }

            // 6) refresca la tabla
            hot.render();
        }


        function borrarFila() {

            let seleccion = hot.getSelectedLast();

            if (typeof seleccion === 'undefined') {
                toastMixin.fire({ title: 'No se detectó ninguna fila seleccionada.', icon: 'warning' });
            } else {
                let filaSeleccionada = seleccion[0];

                if (seleccion[0] == -1)
                    toastMixin.fire({ title: 'Seleccione sólo una celda.', icon: 'warning' });
                else {

                    Swal.fire({
                        title: "¿Quieres borrar la fila #" + (filaSeleccionada + 1) + " ?",
                        showDenyButton: true,
                        confirmButtonText: "Borrar",
                        denyButtonText: `Cancelar`
                    }).then((result) => {
                        /* Read more about isConfirmed, isDenied below */
                        if (result.isConfirmed) {

                            let valorActual = hot.getDataAtCell(filaSeleccionada, GetColFromName("Número Material"));

                            if (valorActual != null && !valorActual.includes("Rollo")) {
                                toastMixin.fire({ title: 'No se puede eliminar un material que ya ha sido creado: ' + valorActual, icon: 'warning' });
                                return false;
                            } else {
                                hot.alter('remove_row', filaSeleccionada);
                                hot.deselectCell()
                                toastMixin.fire({ title: 'Fila borrada.', icon: 'success' });
                            }
                        }

                    });
                }
            }

        }

        $(window).resize(function () {
            hot.render();
        });
    </script>
}


@model Portal_2_0.Models.SCDM_solicitud

@{
    ViewBag.Title = "Formato de Creación con Referencia";
    ViewBag.PrimerNivel = "scdm_mm";
    ViewBag.SegundoNivel = "mis_solicitudes_mm";

    ViewBag.ControllerName = ViewContext.RouteData.Values["controller"];
    Clases.Util.MensajesSweetAlert mensajeAlerta = (Clases.Util.MensajesSweetAlert)ViewBag.MensajeAlert;


    //lee los valores necesarios para los dropdowns
    string[] tipoVentasArray = (string[])ViewBag.TipoVentaArray;
    string[] tipoMaterialArray = (string[])ViewBag.TipoMaterialArray;
    string[] plantaArray = (string[])ViewBag.PlantaArray;
    string[] motivoCreacionArray = (string[])ViewBag.MotivoCreacionArray;
    string[] unidadMedidaArray = (string[])ViewBag.UnidadMedidaArray;
    string[] commodityArray = (string[])ViewBag.CommodityArray;
    string[] gradoCalidadArray = (string[])ViewBag.GradoCalidadArray;
    string[] superficieArray = (string[])ViewBag.SuperficieArray;
    string[] tratamientoSuperficialArray = (string[])ViewBag.TratamientoSuperficialArray;
    string[] pesoRecubrimientoArray = (string[])ViewBag.PesoRecubrimientoArray;
    string[] molinosArray = (string[])ViewBag.MolinosArray;
    string[] formaArray = (string[])ViewBag.FormaArray;
    string[] clientesArray = (string[])ViewBag.ClientesArray;
    string[] diametroInteriorArray = (string[])ViewBag.DiametroInteriorArray;
    string[] tipoMetalArray = (string[])ViewBag.TipoMetalArray;
    string[] iHSArray = (string[])ViewBag.IHSArray;
    string[] modeloNegocioArray = (string[])ViewBag.ModeloNegocioArray;
    string[] posicionRolloArray = (string[])ViewBag.PosicionRolloArray;


    ViewBag.nav_style = "nav-sm";
    string comentario = string.Empty;

}


@section estilos
{
    <!-- Select2 -->
    <link href="@Url.Content("~/Content/vendors/select2/css/select2.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/vendors/select2-bootstrap4-theme/select2-bootstrap4.min.css")" rel="stylesheet">
    <!-- iCheck -->
    <link href="@Url.Content("~/Content/vendors/iCheck/skins/flat/green.css")" rel="stylesheet">
    <!--Handsontable -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <link href="~/Content/css/HansontableHeaderColors.css" rel="stylesheet" />

    <style>

        dl {
            border: 3px double #ccc;
            padding: 0.5em;
            background-color: #fffdf0
        }

        dt {
            font-weight: bold;
            color: green;
        }

        dd {
            font-weight: bold;
            color: #454545;
        }

        dt::after {
            content: ":";
        }

        .fondo_verde > td {
            background-color: green;
            color: #fffdf0;
            font-weight: bolder;
        }

        .fondo_amarillo > td {
            background-color: orange;
            color: #221f1f;
            font-weight: bolder;
        }

        .fondo_rojo > td {
            background-color: red;
            color: #fffdf0;
            font-weight: bolder;
        }

        input {
            text-align: right;
        }

        /**
        * Accordion example styles
        */

        /**
         * Accordion example styles
         */

        .wf-accordion-group {
            margin-top: 15px;
        }

            /* All elements succeeding an accordion group use margin-top to create white space */
            .wf-accordion-group + * {
                margin-top: 30px;
            }

        /* All accordions have borders… */
        .wf-accordion {
            border-top: 1px solid #bfbfbf;
            border-bottom: 1px solid #bfbfbf;
            border-left: 1px solid #bfbfbf;
            border-right: 1px solid #bfbfbf;
        }

            /* …unless they directly succeed another accordion, in which case we reset the top-border
          to avoid duplicate white space */
            .wf-accordion + .wf-accordion {
                border-top-width: 0;
            }

        .wf-accordion__header {
            color: #616163;
        }

        /* Please note: The trigger element is a <button> create via JS. To achieve consistent aesthetics,
           the native button styles have to be resetted here */
        .wf-accordion__trigger {
            /* baseline resets */
            background: transparent;
            border-width: 0;
            border-radius: 0;
            box-sizing: border-box;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            font-size: inherit;
            letter-spacing: inherit;
            line-height: inherit;
            margin: 0;
            padding: 0;
            text-align: left;
            text-decoration: none;
            /* end of baseline resets */
            /* additional styles for the demo */
            display: block;
            padding: 10px 1.25em 10px 8px;
            position: relative;
            width: 100%;
        }

            .wf-accordion__trigger::after {
                content: '';
                border: solid #fff;
                border-width: 0 2px 2px 0;
                height: 0.5em;
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-60%) rotate(45deg);
                width: 0.5em;
            }

            .wf-accordion__trigger[aria-disabled=true] {
                cursor: not-allowed;
                opacity: 0.5;
            }

            .wf-accordion__trigger[aria-expanded=true]::after {
                transform: translateY(-30%) rotate(-135deg);
            }

            .wf-accordion__trigger:hover,
            .wf-accordion__trigger:focus {
                opacity: 0.8;
                /*  background: #f5f5f5;
                color: #161616;*/
            }

                .wf-accordion__trigger:hover::after,
                .wf-accordion__trigger:focus::after {
                    border-color: #fff;
                }

        .wf-accordion__panel {
            background-color: #fff;
            padding: 10px 8px;
        }

            .wf-accordion__panel[aria-hidden=true] {
                display: none;
            }

        .fondo-pendiente {
            background-color: #009ff5;
        }

        .fondo-completado {
            background-color: #009ff5;
        }
        /*Para color de celdas readonly*/
        .handsontable .htDimmed {
            background: #f2f1f1;
        }

        .alert {
            border-left: 4px solid #009ff5 !important;
            border-top: 1px solid #009ff5 !important;
            border-right: 1px solid #009ff5 !important;
            border-bottom: 1px solid #009ff5 !important;
            background-color: #009ff50d !important;
            margin-bottom: 2px !important;
        }

        .alert-title {
            color: #2457bf;
        }

        .alert-title {
            margin-top: 0;
            margin-bottom: 2px;
            font-size: 18px;
        }

        .alert-content {
            margin: 0;
            font-size: 14px;
            color: #616163 !important;
        }

        .handsontable .celdaSinConfirmar {
            background-color: #ffe8bd; /* Rojo claro para indicar que no está confirmado */
            border: 2px solid #ff0000; /* Borde rojo para resaltar */
        }

        .handsontable .celdaConfirmada {
            background-color: #ccffcc; /* Verde claro para indicar que la celda ha sido confirmada */
        }

        .custom-swal-container {
            font-family: Arial, sans-serif;
        }

        .custom-swal-popup {
            border-radius: 10px;
            background-color: #f4f6f9;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .custom-swal-title {
            color: #333;
            font-weight: bold;
            font-size: 1.2rem; /* Tamaño de fuente reducido */
        }

        .custom-swal-button-text {
            font-size: 0.9rem; /* Tamaño reducido para un aspecto más limpio */
        }

        .custom-swal-confirm-button,
        .custom-swal-deny-button,
        .custom-swal-cancel-button {
            border-radius: 8px;
            padding: 8px 16px;
        }

        .custom-swal-confirm-button {
            background-color: #4CAF50; /* Verde claro */
            color: white;
        }

        .custom-swal-deny-button {
            background-color: #f44336; /* Rojo claro */
            color: white;
        }

        .custom-swal-cancel-button {
            background-color: #ffc107; /* Amarillo claro */
            color: white;
        }

            .custom-swal-confirm-button:hover,
            .custom-swal-deny-button:hover,
            .custom-swal-cancel-button:hover {
                filter: brightness(0.9);
            }       
    </style>

}


@{Html.RenderPartial("_BlockUI", Model);}

@*Para SweetAlert*@
@if (mensajeAlerta != null)
{
    <input type="hidden" value="@mensajeAlerta.Mensaje" id="mensajeAlert" />
    <input type="hidden" value="@mensajeAlerta.getTipoMensaje()" id="mensajeAlertTipo" />
}



<div class="right_col" role="main">
    <div class="">

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12  ">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>@ViewBag.Title</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <div class="col-sm-12">
                            <div class="card-box ">
                                <dl class="row">
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.id)</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_tipo_solicitud)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.SCDM_cat_tipo_solicitud.descripcion)</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_solicitante)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.empleados.ConcatNombre)</dd>
                                    @if (Model.SCDM_rel_solicitud_materiales_solicitados.Count > 0 && (Model.id_tipo_solicitud == 1 || Model.id_tipo_solicitud == 2 || Model.id_tipo_solicitud == 5))
                                    {
                                        <dt class="col-sm-2">Tipo de Materiales</dt>
                                        <dd class="col-sm-2">@String.Join(", ", @Model.SCDM_rel_solicitud_materiales_solicitados.Select(x => x.SCDM_cat_tipo_materiales_solicitud.descripcion).Distinct().ToList())</dd>
                                    }
                                    @if (Model.id_tipo_solicitud == 3)
                                    {
                                        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_tipo_cambio)</dt>
                                        <dd class="col-sm-2">@Html.DisplayFor(model => model.SCDM_cat_tipo_cambio.descripcion)</dd>
                                    }
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.id_prioridad)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.SCDM_cat_prioridad.descripcion)</dd>
                                    <dt class="col-sm-2">Plantas</dt>
                                    <dd class="col-sm-2">@String.Join(", ", @Model.SCDM_rel_solicitud_plantas.Select(x => x.plantas.descripcion).Distinct().ToList())</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.descripcion)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.descripcion)</dd>
                                    <dt class="col-sm-2">@Html.DisplayNameFor(model => model.justificacion)</dt>
                                    <dd class="col-sm-2">@Html.DisplayFor(model => model.justificacion)</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="ln_solid"></div>
                            <div class="form-group row">
                                <h4 style="color:#7c7c7c"><b>Elementos de la Solicitud</b></h4>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="alert alert-2-secondary">
                                <p class="alert-content">
                                    <i class="fa-solid fa-triangle-exclamation" style="color: #ff9924;"></i> Creaciones con referencia a materiales existentes, solo se debe utilizar bajo los siguientes motivos:
                                    <ul>
                                        <li>Se crea un material id&eacute;ntico a uno existente pero que proviene de un molino diferente.</li>
                                        <li>Se crea un material id&eacute;ntico a uno existente que se va a reportar para un número de cliente diferente.</li>
                                        <li>Se debe especificar Selling Type(Tipo de Venta).</li>
                                        <li>Debes colocar el número de material y los datos que deseas cambiar.</li>
                                        <li>En caso de cambiar el peso bruto o neto, debes indicar ambos pesos en la soliditud.</li>
                                        <li>Al indicar un cambio de espesor, ancho o avance. Se deben indicar también las tolerancias positivas o negativas.</li>
                                    </ul>
                                </p>
                            </div>
                        </div>

                        <div class="col-sm-12">

                            <div class="wf-accordion-group js-accordion-group">
                                @if (Model.SCDM_rel_solicitud_secciones_activas.Any(x => x.id_seccion == (int)Bitacoras.Util.SCDMSeccionesSolicitud.CREACION_REFERENCIA))
                                {
                                    //3 = formato CREACION_REFERENCIA
                                    comentario = Model.SCDM_rel_solicitud_secciones_activas.FirstOrDefault(x => x.id_seccion == (int)Bitacoras.Util.SCDMSeccionesSolicitud.CREACION_REFERENCIA).comentario;

                                    <div class="wf-accordion js-accordion" data-wf-accordion-expanded="">
                                        <div class="wf-accordion__header js-accordion__header">
                                            <h3><button class="wf-accordion__trigger js-accordion__trigger fondo-completado" aria-expanded="true" aria-controls="accordion-1__panel-0" id="accordion-1__header-0">Creaci&oacute;n con Referencia</button></h3>
                                        </div>
                                        <div class="wf-accordion__panel js-accordion__panel " aria-hidden="false" id="accordion-1__panel-0" aria-labelledby="accordion-1__header-0">
                                            <!--Ejemplo Handsontable-->
                                            <div id="example" class="hot handsontable htRowHeaders htColumnHeaders" data-originalstyle="height: 320px; overflow: hidden; width: 100%;"></div>
                                            <p>
                                                <br />
                                                <button class="btn btn-warning btn-sm float-right" onclick="insertaFila()">
                                                    <i class="fa-regular fa-square-plus"></i>
                                                    Agregar
                                                </button>
                                                <button class="btn btn-danger btn-sm float-left" onclick="borrarFila()">
                                                    <i class="fa-regular fa-trash-can"></i>
                                                    Borrar fila seleccionada
                                                </button>
                                                <button id="btn-ver-celdas-sin-confirmar" class="btn btn-warning btn-sm"><i class="fa-solid fa-list-check"></i> Ver Campos Sin Confirmar</button>
                                                <button id="btn-confirmar-celdas" class="btn btn-primary btn-sm "><i class="fa-regular fa-circle-check"></i> Confirmar Campos</button>
                                            </p>
                                            <div class="form-group row">

                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        <!-- Inicio Comentario -->
                        <div class="col-sm-12">
                            <div class="wf-accordion-group js-accordion-group">
                                <div class="wf-accordion js-accordion" data-wf-accordion-expanded="">
                                    <div class="wf-accordion__header js-accordion__header">
                                        <h3><button class="wf-accordion__trigger js-accordion__trigger fondo-completado" aria-expanded="true" aria-controls="accordion-1__panel-0" id="accordion-1__header-0">Comentario Adicional</button></h3>
                                    </div>
                                    <div class="wf-accordion__panel js-accordion__panel " aria-hidden="false" id="accordion-1__panel-0" aria-labelledby="accordion-1__header-0">
                                        <!--Comentario-->
                                        <div class="form-group row">
                                            <div class="col-md-12 col-sm-12 ">
                                                <textarea id="comentario" name="comentario" class="form-control" rows="4" autocomplete="off" placeholder="Ingresa un comentario adicional..." maxlength="255">@Html.DisplayFor(model => comentario)</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Fin Comentario -->
                        <div class="col-md-12">
                            <div class="ln_solid"></div>
                            <button type="button" id="btn-submit-salir" class="btn btn-info btn-lg float-lg-right"><i class="fa-solid fa-save"></i>  Guardar y salir</button>
                            <button type="button" id="btn-submit" class="btn btn-success btn-lg float-lg-right"><i class="fa-solid fa-save"></i>  Guardar y continuar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <br />
                    <a href="@Url.Action("EditarSolicitud", ViewBag.ControllerName, new {id=Model.id, viewUser = Request.Params["viewUser"] })" class="btn btn-round btn-info btm-sm" title="Volver" style="color:white">
                        <i class="fa fa-arrow-circle-left"></i> Volver al listado
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render(Url.Content("~/Content/vendors/jquery-iu/jquery-ui.min.js"))
    @Scripts.Render(Url.Content("~/Content/vendors/select2/js/select2.full.min.js"))
    <!-- SweetAlert2 (css incluido) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.all.min.js" integrity="sha512-/iBgV43zPirSC0tue+PT/1VHGs7En24twBmT+sVMgn9PTaOpKfbgIyL5YsGKlbAIxcwz9S8W/YEnYjpIYj2Axw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    @Scripts.Render(Url.Content("~/Scripts/AlertasSweetAlert.js"))
    <!-- iCheck -->
    @Scripts.Render(Url.Content("~/Content/vendors/iCheck/icheck.min.js"))
    <script src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.min.js"></script>
    <script src="~/Content/vendors/wfaccordion/wf.accordion.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/languages/es-MX.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.all.min.js" integrity="sha512-/iBgV43zPirSC0tue+PT/1VHGs7En24twBmT+sVMgn9PTaOpKfbgIyL5YsGKlbAIxcwz9S8W/YEnYjpIYj2Axw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        //variable para saber si ha cambiado el formulario y asi no se detenga por doble submit
        var documento_soporte_cambios = 1;
        var hot;

        var headers = ['ID','Cambios', 'Nuevo Material', 'Material Existente', 'Planta', 'Motivo de la creacion',
            'Núm. antigüo material', 'Peso Bruto (KG)', 'Peso Neto (KG)', 'Unidad Base Medida', 'Descripción ES (Original)', 'Descripción EN (Original)' ,  'Descripción (ES)', 'Descripción (EN)', 'Commodity', 'Grado/Calidad',
            'Espesor (mm)', 'Tolerancia espesor negativa (mm)', 'Tolerancia espesor positiva (mm)',
            'Ancho (mm)', 'Tolerancia ancho negativa (mm)', 'Tolerancia ancho positiva (mm)',
            'Avance (mm)', 'Tolerancia avance negativa (mm)', 'Tolerancia avance positiva (mm)',
            'Planicidad (mm)', 'Superficie', 'Tratamiento Superficial', 'Peso del recubrimiento', 'Nombre Molino', 'Forma', 'Núm. cliente', 'Núm. parte del cliente',
            'MSA (Honda)','Diametro Exterior', 'Diametro Interior',
              /*BUDGET*/
            'Tipo de Material', 'Selling Type (Budget)', 'Tipo Metal', 'Posición del Rollo para embarque', 'Modelo de negocio', 'Peso bruto REAL bascula (kg)',
            'Peso neto REAL bascula (kg)', 'Trapecio: ángulo A', 'Trapecio: ángulo B',
            'Scrap permitido (%)', 'Piezas Dobles', 'Reaplicación', 'Req. conciliación Puntas y colas', 'Conciliacion Scrap Ingeniería',
            'S&P 1 (antes IHS)', 'S&P 2 (antes IHS)', 'S&P 3 (antes IHS)', 'S&P 4 (antes IHS)', 'S&P 5 (antes IHS)'
            , 'Piezas por auto', 'Pzas por Golpe', 'Pzas por paquete', 'Peso Inicial', 'Peso Max (KG)', 'Peso Maximo Tolerancia Positiva', 'Peso Maximo Tolerancia Negativa'
            , 'Peso Min (KG)', 'Peso Mínimo Tolerancia Positiva', 'Peso Mínimo Tolerancia Negativa',
            /* FIN Budget*/
            'Otro Dato', 'Comentario Adicional', 'Valido',
        ];
        const columnasQueNecesitanValidacion = [
            "Tipo Metal",
            "Selling Type (Budget)",
            "Modelo de negocio",
            "S&P 1 (antes IHS)",
            //"Req. conciliación Puntas y colas",
            "Scrap permitido (%)",
          /*  "Conciliación Scrap Ingenieria",*/
           // 'Piezas por auto',
           // 'Pzas por Golpe',
            'Peso Inicial',
            // Añade más columnas según sea necesario
        ];

        let confirmaciones = {};

        // Ejemplo de clave: "0-IHS 1" representaría la fila 0 y la columna "IHS 1"
        function valorConfirmado(row, header) {
            return confirmaciones[`${row}-${header}`] === true;
        }

        var nestedHeaders = [
            [
                { label: '', colspan: 1 }, // 'ID' sin título adicional
                { label: 'Datos Base', colspan: 10, className: 'nested-header-rollo' },
                { label: 'Datos Base', colspan: 10, className: 'nested-header-rollo' },
                { label: 'Datos Base', colspan: 10, className: 'nested-header-budget' },
                { label: 'Datos Base', colspan: 5, className: 'nested-header-budget' },
                { label: 'Datos de Budget', colspan: 10, className: 'nested-header-budget' },
                { label: 'Datos de Budget', colspan: 10, className: 'nested-header-budget' },
                { label: 'Datos de Budget', colspan: 9, className: 'nested-header-budget' },
                { label: 'Otros Datos', colspan: 10, className: 'nested-header-budget' },
            ],
            headers // Este es el arreglo de encabezados existente
        ];

        var toastMixin = Swal.mixin({
            toast: true,
            icon: 'success',
            iconColor: 'white',
            customClass: {
                popup: 'colored-toast'
            },
            animation: false,
            position: 'top-right',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        //variables para array
        var si_noArray = ['SÍ', 'NO'];
        var piezasDoblesArray = ['X'];
        var tipoVentasArray = @Html.Raw(Json.Encode(tipoVentasArray));
        var tipoMaterialArray = @Html.Raw(Json.Encode(tipoMaterialArray));
        var plantaArray = @Html.Raw(Json.Encode(plantaArray));
        var motivoCreacionArray = @Html.Raw(Json.Encode(motivoCreacionArray));
        var unidadMedidaArray = @Html.Raw(Json.Encode(unidadMedidaArray));
        var commodityArray = @Html.Raw(Json.Encode(commodityArray));
        var gradoCalidadArray = @Html.Raw(Json.Encode(gradoCalidadArray));
        var superficieArray = @Html.Raw(Json.Encode(superficieArray));
        var tratamientoSuperficialArray = @Html.Raw(Json.Encode(tratamientoSuperficialArray));
        var pesoRecubrimientoArray = @Html.Raw(Json.Encode(pesoRecubrimientoArray));
        var clientesArray = @Html.Raw(Json.Encode(clientesArray));
        var molinosArray = @Html.Raw(Json.Encode(molinosArray));
        var formaArray = @Html.Raw(Json.Encode(formaArray));
        var diametroInteriorArray = @Html.Raw(Json.Encode(diametroInteriorArray));
        var tipoMetalArray = @Html.Raw(Json.Encode(tipoMetalArray));
        var iHSArray = @Html.Raw(Json.Encode(iHSArray));
        var modeloNegocioArray = @Html.Raw(Json.Encode(modeloNegocioArray));
        var posicionRolloArray = @Html.Raw(Json.Encode(posicionRolloArray));


        $(document).ready(function () {


            //inicializa hansontable
            inicializaHandsontable();
            DefineValidadores();
            cargaDatosIniciales();

            $("#btn-submit").on("click", function () { EnviaFormulario(false) });
            $("#btn-submit-salir").on("click", function () { EnviaFormulario(true) });

            //inicia el proceso de confirmación de celdas
            $("#btn-confirmar-celdas").on("click", function () {
                iniciarConfirmacionCeldas();
            });

            $.unblockUI();
        });

        // Función para confirmar celdas
        function iniciarConfirmacionCeldas() {
            let celdasNoConfirmadas = [];

            // Recorre todas las filas de la tabla
            hot.getData().forEach((fila, rowIndex) => {
                headers.forEach((header, colIndex) => {
                    if (colNecesitaValidacion(header) && !valorConfirmado(rowIndex, header)) {
                        // Si la celda necesita validación y no está confirmada, la agrega a la lista para confirmación
                        celdasNoConfirmadas.push({ rowIndex, header, colIndex });
                    }
                });
            });

            // Recorre cada celda no confirmada y muestra la ventana de confirmación
            confirmarCeldasPendientes(celdasNoConfirmadas);
        }

        // Función para confirmar celdas pendientes
        function confirmarCeldasPendientes(celdasNoConfirmadas) {
            if (celdasNoConfirmadas.length === 0) {
                // Si no hay celdas sin confirmar, mostramos un mensaje indicando que todas han sido confirmadas
                Swal.fire({
                    icon: 'success',
                    title: 'Confirmación Completa',
                    text: 'Todas las celdas han sido confirmadas exitosamente.',
                    confirmButtonText: 'Aceptar'
                });
                //guarda en BD
                EnviaFormulario(false);
                return;
            }

            const celda = celdasNoConfirmadas.shift();
            const { rowIndex, header, colIndex } = celda;

            mostrarConfirmacion(rowIndex, header, colIndex).then(() => {
                // Después de confirmar la celda, sigue con la siguiente
                confirmarCeldasPendientes(celdasNoConfirmadas);
            }).catch(() => {
                // Si se selecciona "Omitir por ahora" o se cancela la confirmación, no la marca como confirmada y sigue con la siguiente
                if (celdasNoConfirmadas.length === 0) {
                    // Si quedan celdas sin confirmar al finalizar
                    Swal.fire({
                        icon: 'warning',
                        title: 'Confirmación Incompleta',
                        text: 'Algunas celdas quedaron sin confirmar. Por favor, revisa las celdas pendientes antes de continuar.',
                        confirmButtonText: 'Aceptar'
                    });
                } else {
                    // Continuar con las demás celdas sin confirmar
                    confirmarCeldasPendientes(celdasNoConfirmadas);
                }
            });
        }


        // Evento para mostrar las celdas sin confirmar
        document.getElementById("btn-ver-celdas-sin-confirmar").addEventListener("click", function () {
            const celdasNoConfirmadas = [];
            const totalRows = hot.countRows();
            const totalCols = hot.countCols();


            // Recorre todas las filas de la tabla
            hot.getData().forEach((fila, rowIndex) => {
                headers.forEach((header, colIndex) => {
                    if (colNecesitaValidacion(header) && !valorConfirmado(rowIndex, header)) {
                        // Obtener el encabezado de la columna y el número de material para contexto
                        const header = hot.getColHeader(colIndex);
                        const numeroMaterial = hot.getDataAtCell(rowIndex, GetColFromName("Nuevo Material"));

                        // Agregar la información de la celda no confirmada a la lista
                        celdasNoConfirmadas.push(`Fila ${rowIndex + 1}, Número Material: ${numeroMaterial}, Columna: "${header}"`);
                    }
                });
            });

            //for (let row = 0; row < totalRows; row++) {
            //    for (let col = 0; col < totalCols; col++) {
            //        const cellClass = hot.getCellMeta(row, col).className;
            //        if (cellClass === "celdaSinConfirmar") {
            //            // Obtener el encabezado de la columna y el número de material para contexto
            //            const header = hot.getColHeader(col);
            //            const numeroMaterial = hot.getDataAtCell(row, GetColFromName("Nuevo Material"));

            //            // Agregar la información de la celda no confirmada a la lista
            //            celdasNoConfirmadas.push(`Fila ${row + 1}, Número Material: ${numeroMaterial}, Columna: "${header}"`);
            //        }
            //    }
            //}

            if (celdasNoConfirmadas.length > 0) {
                // Mostrar las celdas no confirmadas en un mensaje
                Swal.fire({
                    title: "Celdas Sin Confirmar",
                    width: '700px',
                    html: `<ul style="text-align:left">${celdasNoConfirmadas.map(celda => `<li>${celda}</li>`).join('')}</ul>`,
                    icon: "warning",
                    confirmButtonText: "Aceptar"
                });
            } else {
                // No hay celdas sin confirmar
                Swal.fire({
                    icon: 'success',
                    title: 'Todas las celdas han sido confirmadas',
                    confirmButtonText: 'Aceptar'
                });
            }
        });

        function colNecesitaValidacion(header) {
            // Verifica si la columna está en la lista de columnas que requieren confirmación
            return columnasQueNecesitanValidacion.includes(header);
        }

        function mostrarConfirmacion(row, header, col) {
            return new Promise((resolve, reject) => {
                const valorActual = hot.getDataAtCell(row, col);
                const numeroMaterial = hot.getDataAtCell(row, GetColFromName("Nuevo Material")) || "(sin número de material)";
                const valorInput = valorActual == null ? "" : valorActual;

                Swal.fire({
                    title: `<span class="custom-swal-title">¿Confirma que el valor ingresado en "${header}" (Fila ${row + 1}, Material: ${numeroMaterial}) es correcto?</span>`,
                    html: `
    <input type="text" id="nuevoValor" placeholder="Vacío" style="width: 100%; height: 40px; font-size: 0.9rem; text-align: left;" value="${valorInput}">
    <span style="font-size:14px;">Ingrese un nuevo valor y haga clic en 'Cambiar' para aplicarlo, o haga clic en 'Confirmar Actual' para aceptar el valor actual.</span>
`,
                    width: '600px',  // Ajusta el ancho del popup para mejor presentación
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: '<span class="custom-swal-button-text">Confirmar Actual</span>',
                    denyButtonText: '<span class="custom-swal-button-text">Cambiar</span>',
                    cancelButtonText: '<span class="custom-swal-button-text">Omitir por ahora</span>',
                    allowOutsideClick: false, // No permite hacer clic fuera para cerrar el popup
                    preConfirm: () => {
                        return document.getElementById('nuevoValor').value;
                    },
                    preDeny: () => {
                        return document.getElementById('nuevoValor').value;
                    },
                    customClass: {
                        container: 'custom-swal-container',
                        popup: 'custom-swal-popup',
                        title: 'custom-swal-title',
                        confirmButton: 'custom-swal-confirm-button',
                        denyButton: 'custom-swal-deny-button',
                        cancelButton: 'custom-swal-cancel-button'
                    },
                    didOpen: () => {
                        // Referencia al botón "Cambiar"
                        const denyButton = Swal.getDenyButton();
                        denyButton.style.display = 'none'; // Inicialmente oculta el botón "Cambiar"

                        // Agrega un evento para detectar cuando el valor cambia
                        document.getElementById('nuevoValor').addEventListener('input', function () {
                            const currentValue = this.value;

                            if (currentValue !== valorInput) {
                                // Si el valor es diferente al original, muestra el botón "Cambiar"
                                denyButton.style.display = 'inline-block';
                            } else {
                                // Si el valor vuelve a ser igual al original, oculta el botón "Cambiar"
                                denyButton.style.display = 'none';
                            }
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        confirmaciones[`${row}-${header}`] = true;
                        hot.setCellMeta(row, col, 'className', 'celdaConfirmada');
                        resolve();
                    } else if (result.isDenied) {
                        const nuevoValor = result.value;

                        if (nuevoValor !== valorActual) {
                            Swal.fire({
                                html: `<p>¿Desea cambiar este valor?: <br><br>De:<br><br><span style="color:red; font-weight:bold;">${valorActual}</span> <br><br>a:<br><br> <span style="color:green; font-weight:bold;">${nuevoValor}</span><p>`,
                                width: '600px',
                                showDenyButton: true,
                                confirmButtonText: '<span class="custom-swal-button-text">Sí, cambiar</span>',
                                denyButtonText: '<span class="custom-swal-button-text">No</span>',
                                allowOutsideClick: false, // No permite hacer clic fuera para cerrar el popup
                                customClass: {
                                    confirmButton: 'custom-swal-confirm-button',
                                    denyButton: 'custom-swal-deny-button'
                                }
                            }).then((cambioResult) => {
                                if (cambioResult.isConfirmed) {
                                    const valorFinal = nuevoValor === "" ? null : nuevoValor;
                                    hot.setDataAtCell(row, col, valorFinal);
                                    confirmaciones[`${row}-${header}`] = true;
                                    hot.setCellMeta(row, col, 'className', 'celdaConfirmada');
                                    resolve();
                                } else {
                                    confirmaciones[`${row}-${header}`] = false;
                                    hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                                    reject();
                                }
                            });
                        } else {
                            reject();
                        }
                    } else {
                        confirmaciones[`${row}-${header}`] = false;
                        hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                        reject();
                    }
                    hot.render();
                });
            });
        }

        function inicializaHandsontable() {
            const container = document.querySelector('#example');

            //obtiene el index de la columna con porcentaje
            var porcentajeCol = GetColFromName("Scrap permitido (%)");

            hot = new Handsontable(container, {
                autoWrapRow: true,
                nestedHeaders: nestedHeaders,
                //colHeaders: headers,
                afterGetColHeader: function (col, TH) {
                    var TR = TH.parentNode;
                    var THEAD = TR.parentNode;
                    var headerLevel = (-1) * THEAD.childNodes.length + Array.prototype.indexOf.call(THEAD.childNodes, TR);

                    function applyClass(elem, className) {
                        if (!Handsontable.dom.hasClass(elem, className)) {
                            Handsontable.dom.addClass(elem, className);
                        }
                    }

                    if (headerLevel === -2) {
                        if (col >= 1 && col <= 35)
                            applyClass(TH, 'HTDatosBase');
                        else if (col > 35 && col <= 64)
                            applyClass(TH, 'HTBudget');
                        else if (col > 64 )
                            applyClass(TH, 'HTgreen');

                    } else {
                        switch (col) {
                            case -1:
                                applyClass(TH, 'HTgray');
                                break;
                            case GetColFromName("Tipo de Material"):
                            case GetColFromName("Planta"):
                            case GetColFromName("Motivo de la creacion"):
                            case GetColFromName("Selling Type (Budget)"):
                            case GetColFromName("Tipo Metal"):
                            case GetColFromName("Modelo de negocio"):
                            case GetColFromName("S&P 1 (antes IHS)"):
                                applyClass(TH, 'HTPurple');
                                break;
                            case GetColFromName("Nuevo Material"):
                            case GetColFromName("Otro Dato"):
                            case GetColFromName("Comentario Adicional"):
                            case GetColFromName("Descripción ES (Original)"):
                            case GetColFromName("Descripción EN (Original)"):
                            case GetColFromName("Descripción (ES)"):
                            case GetColFromName("Descripción (EN)"):
                            case GetColFromName("Cambios"):
                                applyClass(TH, 'HTgreen');
                                break;
                            case GetColFromName("Material Existente"):
                                applyClass(TH, 'HTred');
                                break;
                            case GetColFromName("Núm. antigüo material"):
                            case GetColFromName("Peso Bruto (KG)"):
                            case GetColFromName("Peso Neto (KG)"):
                            case GetColFromName("Unidad Base Medida"):
                            case GetColFromName("Commodity"):
                            case GetColFromName("Grado/Calidad"):
                            case GetColFromName("Espesor (mm)"):
                            case GetColFromName("Tolerancia espesor negativa (mm)"):
                            case GetColFromName("Tolerancia espesor positiva (mm)"):
                            case GetColFromName("Ancho (mm)"):
                            case GetColFromName("Tolerancia ancho negativa (mm)"):
                            case GetColFromName("Tolerancia ancho positiva (mm)"):
                            case GetColFromName("Avance (mm)"):
                            case GetColFromName("Tolerancia avance negativa (mm)"):
                            case GetColFromName("Tolerancia avance positiva (mm)"):
                            case GetColFromName("Planicidad (mm)"):
                            case GetColFromName("Superficie"):
                            case GetColFromName("Tratamiento Superficial"):
                            case GetColFromName("Peso del recubrimiento"):
                            case GetColFromName("Nombre Molino"):
                            case GetColFromName("Forma"):
                            case GetColFromName("Núm. cliente"):
                            case GetColFromName("Núm. parte del cliente"):
                            case GetColFromName("MSA (Honda)"):
                            case GetColFromName("Diametro Exterior"):
                            case GetColFromName("Diametro Interior"):
                                //Budget
                            case GetColFromName("Posición del Rollo para embarque"):
                            case GetColFromName("Peso bruto REAL bascula (kg)"):
                            case GetColFromName("Peso neto REAL bascula (kg)"):
                            case GetColFromName("Trapecio: ángulo A"):
                            case GetColFromName("Trapecio: ángulo B"):
                            case GetColFromName("Scrap permitido (%)"):
                            case GetColFromName("Piezas Dobles"):
                            case GetColFromName("Reaplicación"):
                            case GetColFromName("Req. conciliación Puntas y colas"):
                            case GetColFromName("Conciliacion Scrap Ingeniería"):
                            case GetColFromName("S&P 2 (antes IHS)"):
                            case GetColFromName("S&P 3 (antes IHS)"):
                            case GetColFromName("S&P 4 (antes IHS)"):
                            case GetColFromName("S&P 5 (antes IHS)"):
                            case GetColFromName("Piezas por auto"):
                            case GetColFromName("Pzas por Golpe"):
                            case GetColFromName("Pzas por paquete"):
                            case GetColFromName("Peso Inicial"):
                            case GetColFromName("Peso Max (KG)"):
                            case GetColFromName("Peso Maximo Tolerancia Positiva"):
                            case GetColFromName("Peso Maximo Tolerancia Negativa"):
                            case GetColFromName("Peso Min (KG)"):
                            case GetColFromName("Peso Mínimo Tolerancia Positiva"):
                            case GetColFromName("Peso Mínimo Tolerancia Negativa"):

                                applyClass(TH, 'HTOrange');
                                break;
                        }
                    }
                },
                 columns: [
                    { readOnly: true }, //hidden
                    { readOnly: true }, //hidden
                    { readOnly: true },  //num material
                    { //material existente
                        validator: function (value, callback) {
                            let max = 7;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                toastMixin.fire({ title: 'El campo Material Existente debe ser de ' + max + ' carácteres.', icon: 'warning' });
                                callback(false);
                            } else {
                                let esValido = hot.getDataAtCell(this.row, GetColFromName("Valido"));
                                if (esValido == "true") {
                                    callback(true);
                                } else {
                                    if (!toastMixin.isVisible()) {
                                        toastMixin.fire({ title: 'El material de referencia no es válido.' + max + ' carácteres.', icon: 'warning' });
                                    }

                                    callback(false);
                                }
                            }
                        }
                    },
                    { //planta
                        // type: 'autocomplete', source: plantaArray, strict: false,
                        type: 'text',
                        validator: function (value, callback) {
                            //valida vacios
                            if ((value == null || value == '') || !plantaArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        },
                        readOnly: true
                    },
                    { //motivo de creación
                        type: 'autocomplete', strict: false, filter: true, source: motivoCreacionArray,
                        validator: function (value, callback) {
                            let max = 100;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El campo Motivo de la Creación debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            } else {
                                callback(true);
                            }
                        }
                     },
                    { //num antigüo material
                        validator: function (value, callback) {
                            let max = 18;
                            if ((value != null && value.length > max)) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator' },         //peso bruto
                    { type: 'numeric', validator: 'CustomNumbersValidator' },         //peso neto
                    { //unidad medida
                        type: 'autocomplete', source: unidadMedidaArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value != null && value != '' && !unidadMedidaArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                     },
                     { readOnly: true },  //descripción original ES
                     { readOnly: true },  //descripción original EN
                     { //descripcion ES
                         readOnly: false,
                         validator: function (value, callback) {
                             let max = 40;
                             if ((value == null || value == '') || (value != null && value.length > max)) {
                                 if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El campo Descripción (ES) debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                 callback(false);
                                 // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                     {//descripcion EN
                         readOnly: false,
                         validator: function (value, callback) {
                             let max = 40;
                             if ((value == null || value == '') || (value != null && value.length > max)) {
                                 if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El campo Descripción (EN) debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                 //    this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                                 callback(false);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                    { //Commodity
                        type: 'autocomplete', source: commodityArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value != null && value != '' && !commodityArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    {   //grado calidad
                        type: 'autocomplete', strict: false, filter: true, source: gradoCalidadArray,
                        validator: function (value, callback) {
                            let max = 50;
                            if ((value == null || value == '') || (value != null && value.length > max)) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El campo Grado/calidad debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                                //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                            } else {
                                callback(true);
                            }
                        }
                    },
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //espesor
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia espesor -
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia espesor +
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //ancho
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia ancho -
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia ancho +
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //avance
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia avance -
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //tolerancia avance +
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //planicidad
                    { //Superficie
                        type: 'autocomplete', source: superficieArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value != null && value != '' && !superficieArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //Tratamiento Superficial
                        type: 'autocomplete', source: tratamientoSuperficialArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value != null && value != '' && !tratamientoSuperficialArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                    { //Peso del recubrimiento
                        type: 'autocomplete', source: pesoRecubrimientoArray, strict: false,
                        validator: function (value, callback) {
                            let max = 35;
                            if ( (value != null && value.length > max)) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El campo Peso del Recubrimiento debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                            } else {
                                callback(true);
                            }
                        }
                    },
                   { //Molino
                        type: 'autocomplete', source: molinosArray, strict: false,
                       validator: function (value, callback) {
                           let max = 30;
                           if ((value == null || value == '') || (value != null && value.length > max)) {
                               if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El campo Molino debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                               callback(false);
                               //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                           } else {
                               callback(true);
                           }
                       }
                    },
                   { //Forma
                        type: 'autocomplete', source: formaArray, strict: false,
                        validator: function (value, callback) {
                            //valida vacios
                            if (value == null || value == '' || !formaArray.includes(value)) {
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                     { //Cliente
                         type: 'autocomplete', strict: false, filter: true, source: clientesArray,
                       validator: function (value, callback) {
                           //let max = 120;
                           if ((value == null || value == '') /*|| (value != null && value.length > max)*/ || !clientesArray.includes(value)) {
                               //if (!toastMixin.isVisible() )
                               //     toastMixin.fire({ title: 'El campo cliente debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                               callback(false);
                               //this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                           } else {
                               callback(true);
                           }
                       }
                    },
                    {   //Numero de parte
                        validator: function (value, callback) {
                            let max = 25;
                            if (value != null && value.length > max) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                callback(false);
                            }
                            else {
                                callback(true);
                            }
                        }
                    },
                     { //msa honda
                         validator: function (value, callback) {
                             let max = 18;
                             let clienteNumero = hot.getDataAtCell(this.row, GetColFromName("Núm. cliente"));

                             if ((clienteNumero != null && clienteNumero.toUpperCase().includes("HONDA") && (value == null || value == ''))) {
                                 if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'Este campo es obligatorio en cliente Honda.', icon: 'warning' });
                                 callback(false);
                             } else {

                                 if (value != null && value.length > max) {
                                     if (!toastMixin.isVisible())
                                        toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                     callback(false);
                                     // this.instance.setDataAtCell(this.row, this.col, value.substring(0, max), null);
                                 }
                                 else {
                                     callback(true);
                                 }
                             }
                         }
                     },
                    { type: 'numeric', validator: 'CustomNumbersValidator' }, //diametro exterior
                     { //diametro interior
                         type: 'autocomplete', source: diametroInteriorArray, strict: false,
                         validator: function (value, callback) {
                             //valida vacios
                             if (value != null && value != '' && !diametroInteriorArray.includes(value)) {
                                 callback(false);
                             }
                             else {
                                 callback(true);
                             }
                         }
                     },
                     /* BUDGET */
                     { readOnly: true }, //tipo material
                     { //tipo de venta
                         type: 'autocomplete', source: tipoVentasArray, strict: false,
                         validator: function (value, callback) {
                             //valida vacios
                             if ((value == null || value == '') || !tipoVentasArray.includes(value)) {
                                 callback(false);
                             }
                             else {
                                 callback(true);
                             }
                         }
                     },
                     {//tipo metal
                         type: 'autocomplete', source: tipoMetalArray, strict: false,
                         validator: function (value, callback) {
                             //valida vacios
                             if ((value == null || value == '') || !tipoMetalArray.includes(value)) {
                                 callback(false);
                             }
                             else {
                                 callback(true);
                             }
                         }
                     },
                     {//posición del rollo
                         type: 'autocomplete', source: posicionRolloArray, strict: false,
                         validator: function (value, callback) {
                             let max = 80;
                             let tipoMaterial = hot.getDataAtCell(this.row, GetColFromName("Tipo de Material"));

                             if ((tipoMaterial && (tipoMaterial.toUpperCase().includes("ROLLO") || tipoMaterial.toUpperCase().includes("CINTA"))) && (!value || value.trim() === "")) {
                                 // Si el tipo de material incluye "ROLLO" o "CINTA" y el valor es nulo o vacío, muestra advertencia
                                 if (!toastMixin.isVisible()) {
                                     toastMixin.fire({ title: 'El valor de "Posición del Rollo para embarque" es obligatorio cuando el tipo de material es "ROLLO" o "CINTA".', icon: 'warning' });
                                 }
                                 callback(false);
                             } else if (value && value.length > max) {
                                 // Si el valor excede el límite de caracteres
                                 if (!toastMixin.isVisible()) {
                                     toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' caracteres o menos.', icon: 'warning' });
                                 }
                                 callback(false);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                     { //modelo Negocio
                         type: 'autocomplete', source: modeloNegocioArray, strict: false,
                         validator: function (value, callback) {
                             //valida vacios
                             if ((value == null || value == '') || !modeloNegocioArray.includes(value)) {
                                 callback(false);
                             }
                             else {
                                 callback(true);
                             }
                         }
                     },
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso bruto REAL bascula (kg)
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso neto REAL bascula (kg)
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Ángulo A
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Ángulo B
                     { type: 'numeric', renderer: 'porcentaje_render', validator: 'percentageNumbers' }, //Scrap permitido %
                     { //piezas dobles
                         type: 'autocomplete', source: piezasDoblesArray, strict: false,
                         validator: function (value, callback) {
                             //valida vacios
                             if (value == null || value == '' || piezasDoblesArray.includes(value)) {
                                 callback(true);
                             }
                             else {
                                 callback(false);
                             }
                         }
                     },
                     { // Reaplicacion
                         type: 'checkbox',
                         className: 'htCenter',
                     },
                     { //Req. consiliación puntas y colas
                         type: 'checkbox',
                         className: 'htCenter',
                     },
                     {//conciliacion scrap ing
                         type: 'checkbox',
                         className: 'htCenter',
                     },
                     { //IHS1 - obligatorio
                         type: 'autocomplete', strict: false, filter: true, source: iHSArray,
                         validator: function (value, callback) {
                             let max = 250;
                             if (!iHSArray.includes(value)) {
                                 //toastMixin.fire({ title: 'El campo IHS 1 debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                 callback(false);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                     { //IHS2
                         type: 'autocomplete', strict: false, filter: true, source: iHSArray,
                         validator: function (value, callback) {
                             let max = 250;
                             if ((value != null && value != '') && !iHSArray.includes(value)) {
                                 callback(false);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                     { //IHS3
                         type: 'autocomplete', strict: false, filter: true, source: iHSArray,
                         validator: function (value, callback) {
                             let max = 250;
                             if ((value != null && value != '') && !iHSArray.includes(value)) {
                                 callback(false);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                     { //IHS4
                         type: 'autocomplete', strict: false, filter: true, source: iHSArray,
                         validator: function (value, callback) {
                             let max = 250;
                             if ((value != null && value != '') && !iHSArray.includes(value)) {
                                 callback(false);
                             } else {
                                 callback(true);
                             }
                         }
                     },
                     { readOnly: true }, //IHS 5
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Piezas por auto
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Piezas por golpe
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Piezas por paquete
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Inicial
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Máximo
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Maximo Tolerancia Positiva
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Maximo Tolerancia Negativa
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Minimo
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Mínimo Tolerancia Positiva
                     { type: 'numeric', validator: 'CustomNumbersValidator' }, //Peso Mínimo Tolerancia Negativa
                     /* Fin budget */
                     {   //Nuevo dato
                         validator: function (value, callback) {
                             let max = 300;
                             if (value != null && value.length > max) {
                                 if (!toastMixin.isVisible())
                                     toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                 callback(false);
                             }
                             else {
                                 callback(true);
                             }
                         }
                     },
                     {   //Comentario Adicional
                         validator: function (value, callback) {
                             let max = 120;
                             if (value != null && value.length > max) {
                                 if (!toastMixin.isVisible())
                                     toastMixin.fire({ title: 'Este campo debe ser de ' + max + ' carácteres o menos.', icon: 'warning' });
                                 callback(false);
                             }
                             else {
                                 callback(true);
                             }
                         }
                     },
                     { readOnly: true }, //hidden
                ],
                colWidths: [0, //ID
                    0, //cambios
                    150,//nuevo material
                    130,//material existente
                    170,//Planta
                    250,//Motivo de creación
                    150, //num antiguo material
                    120, //peso neto
                    120, //peso bruto
                    130,//unidad base medida
                    310, 310, 310, 310, //descripciones en/es
                    180,//Commodity
                    220,//Grado Calidad
                    110,//Espesor mm
                    200,//tolerancia espesor negativa
                    200,//tolerancia espesor positiva
                    130,//ancho
                    200,//tolerancia ancho negativa
                    200,//tolerancia ancho positiva
                    130,//avance
                    200,//tolerancia avance negativa
                    200,//tolerancia avance positiva
                    100, //planiciadad
                    150, //superficie
                    170, //Tratamiento superficial
                    150, //peso del recubrimiento
                    250, //nombre del molino
                    100, //forma
                    300, //cliente
                    150,//Número parte del cliente
                    120, //MSA (Honda)
                    120, //Diametro Exterior
                    120, //Diametro Interior
                    /* BUDGET */
                    160,  //tipo de material
                    150,//tipo de Venta
                    200,//Tipo metal
                    220, //posicion del rollo
                    220, //modelo de negocio
                    180,               //Peso bruto REAL bascula (kg)
                    170,               //Peso neto REAL bascula (kg)
                    130,                //Ángulo A
                    130,                //Ángulo A
                    120, //scrap permitido
                    100,               //Piezas Dobles
                    100,               //Reaplicación
                    200,               //Req. conciliación puntas y colas
                    180,               //Conciliación Scrap Ingenieria
                    500, 500, 500, 500, 500, //IHS 1-5
                    95, // piezas por auto
                    105, // piezas por golpe
                    120, // piezas por paquete
                    80, // peso inicial
                    200, // peso máximo entrega cinta
                    200, // peso minimo tolerancia +
                    200, // peso minimo tolerancia -
                    90, // peso ming KG
                    200, // peso min tol +
                    200, // peso min tol -
                    400,//Nuevo Dato
                    300,//Comentarios
                    0,//Comentarios
                ],
                hiddenColumns: {
                    // specify columns hidden by default
                    columns: [0, GetColFromName("Cambios"), GetColFromName("Valido"), GetColFromName("Unidad Base Medida")], //contains ID
                },
                licenseKey: 'non-commercial-and-evaluation',
                rowHeaders: true,
                autoColumnSize: true,
                //width: '100%',
                height: '400px',
                manualColumnResize: true,
                outsideClickDeselects: false,
                licenseKey: 'non-commercial-and-evaluation',
                copyPaste: true,
                contextMenu: {
                    items: {
                        'undo': {},
                        'redo': {},
                        '---------': {},
                        'cut': {},
                        'copy': {},
                        // Opción personalizada para "Pegar" que respeta las celdas de solo lectura
                        'customPaste': {
                            name: 'Pegar',
                            callback: function () {
                                if (navigator.clipboard && navigator.clipboard.readText) {
                                    navigator.clipboard.readText().then(function (text) {
                                        // Separa el texto copiado en filas (usualmente separadas por saltos de línea)
                                        let rows = text.split(/\r?\n/);
                                        // Si la última fila está vacía, la eliminamos
                                        if (rows.length && rows[rows.length - 1] === '') {
                                            rows.pop();
                                        }

                                        // Obtiene la celda o rango actualmente seleccionado
                                        let selected = hot.getSelected(); // Ej: [[filaInicio, colInicio, filaFin, colFin]]
                                        if (selected && selected.length) {
                                            let startRow = selected[0][0];
                                            let startCol = selected[0][1];

                                            // Recorre cada fila del bloque copiado
                                            for (let i = 0; i < rows.length; i++) {
                                                // Separa cada fila en columnas (usualmente separadas por tabuladores)
                                                let values = rows[i].split("\t");
                                                for (let j = 0; j < values.length; j++) {
                                                    let targetRow = startRow + i;
                                                    let targetCol = startCol + j;
                                                    // Verifica si la celda destino no es de solo lectura
                                                    let meta = hot.getCellMeta(targetRow, targetCol);
                                                    if (!meta.readOnly) {
                                                        hot.setDataAtCell(targetRow, targetCol, values[j]);
                                                    }
                                                }
                                            }
                                        }
                                    }).catch(function (err) {
                                        alert('Error al acceder al portapapeles: ' + err);
                                    });
                                } else {
                                    alert('La API del portapapeles no está disponible en este navegador.');
                                }
                            }
                        }
                    }
                },
                language: 'es-MX',
                cells: function (row, col) {
                    let cp = {}
                    if (col === porcentajeCol) { //columna de porcentajes
                        cp.renderer = myPercentage
                    }
                    return cp
                },
                afterChange: (changes) => {
                    changes?.forEach(([row, prop, oldValue, newValue]) => {

                        // Comprobamos si el valor cambió y si era una celda previamente confirmada
                        if (oldValue !== newValue && valorConfirmado(row, headers[prop])) {
                            // Si hubo un cambio en una celda confirmada, la marcamos como no confirmada
                            confirmaciones[`${row}-${headers[prop]}`] = false;

                            // Removemos la clase de confirmación anterior
                            hot.setCellMeta(row, prop, 'className', 'celdaSinConfirmar');
                            hot.render(); // Re-renderizamos la tabla para reflejar los cambios visuales

                            console.log(`Celda cambiada - Fila: ${row}, Columna: ${prop}, Estado de confirmación actualizado a no confirmado`);
                        }

                        //determina los cambios a aplicar según la columna que se cambie
                        switch (prop) {
                            case GetColFromName("Espesor (mm)"): //espesor
                            case GetColFromName("Ancho (mm)"): //espesor
                            case GetColFromName("Avance (mm)"): //espesor
                             CambioDimensiones(row);
                                break;

                            case GetColFromName("Núm. cliente"): //diametro interior
                                RestableceMSA(row);
                                //cambioDescripcion(row);
                                break;
                            case GetColFromName("S&P 1 (antes IHS)"): //IHS
                            case GetColFromName("S&P 2 (antes IHS)"): //IHS
                            case GetColFromName("S&P 3 (antes IHS)"): //IHS
                            case GetColFromName("S&P 4 (antes IHS)"): //IHS
                                ConcatenaIHS(row, newValue);
                                break;
                            case GetColFromName("Tipo Metal"): //tipo de Metal
                                if (newValue && newValue.toLowerCase().includes("no expuesto")) {
                                    // Si el tipo de metal es "No expuesto", establecer el valor de Scrap permitido a 1.5
                                    hot.setDataAtCell(row, GetColFromName("Scrap permitido (%)"), 1.5);
                                } else if (newValue && newValue.toLowerCase().includes("expuesto")) {
                                    // Si el tipo de metal es "Expuesto", establecer el valor de Scrap permitido a 2.5
                                    hot.setDataAtCell(row, GetColFromName("Scrap permitido (%)"), 2.5);
                                }
                                break;
                        }


                    });
                },

            });

            //agrega eventos
            hot.addHook('afterCreateRow', (row, amount) => {
                ValidaNumeroMaterial();
            })
            hot.addHook('afterRemoveRow', (row, amount) => {
                ValidaNumeroMaterial();
            })

            //determina los decimales a mostrar
            hot.addHook('beforeChange', (changes, source) => {

                switch (changes[0][1]) {
                    case GetColFromName("Espesor (mm)"): //4 decimales
                    case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                    case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                    case GetColFromName("Ancho (mm)"): //4 decimales
                    case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                    case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                    case GetColFromName("Avance (mm)"): //4 decimales
                    case GetColFromName("Tolerancia avance negativa (mm)"): //4 decimales
                    case GetColFromName("Tolerancia avance positiva (mm)"): //4 decimales
                    case GetColFromName("Diametro Exterior"): //4 decimales
                        //case GetColFromName("Diametro Interior"): //4 decimales
                        if (changes[0][3] != '')
                            changes[0][3] = Math.round(changes[0][3] * 10000) / 10000;
                        break;
                    case GetColFromName("Peso Bruto (KG)"): //3 decimales
                    case GetColFromName("Peso Neto (KG)"): //3 decimales
                    case GetColFromName("Planicidad (mm)"): //3 decimales
                    case GetColFromName("Peso bruto REAL bascula (kg)"): //3 decimales
                    case GetColFromName("Peso neto REAL bascula (kg)"): //3 decimales
                    case GetColFromName("Pzas por Golpe"): //3 decimales
                    case GetColFromName("Peso Inicial"): //3 decimales
                    case GetColFromName("Peso Max (KG)"): //4 decimales
                    case GetColFromName("Peso Maximo Tolerancia Positiva"): //4 decimales
                    case GetColFromName("Peso Maximo Tolerancia Negativa"): //4 decimales
                    case GetColFromName("Peso Min (KG)"): //4 decimales
                    case GetColFromName("Peso Mínimo Tolerancia Positiva"): //4 decimales
                    case GetColFromName("Peso Mínimo Tolerancia Negativa"): //4 decimales
                        if (changes[0][3] != '')
                            changes[0][3] = Math.round(changes[0][3] * 1000) / 1000;
                        break;
                    case GetColFromName("Scrap permitido (%)"): //2 decimales
                    //case GetColFromName("% de Scrap (puntas y colas)"): //2 decimales
                    case GetColFromName("Trapecio: ángulo A"): //2 decimales
                    case GetColFromName("Trapecio: ángulo B"): //2 decimales
                    case GetColFromName("Piezas por auto"): //2 decimales
                        if (changes[0][3] != '')
                            changes[0][3] = Math.round(changes[0][3] * 100) / 100;
                        break;
                    case GetColFromName("Pzas por paquete"): //0 decimales
                        if (changes[0][3] != '')
                            changes[0][3] = Math.round(changes[0][3]);
                        break;
                    //en caso de cambio en material existente
                    case GetColFromName("Material Existente"):
                        let nuevoMaterial = hot.getDataAtCell(changes[0][0], GetColFromName("Nuevo Material"));
                        if (!nuevoMaterial.includes("CreacionReferencia")) { //si ya está creado el materla
                            if (changes[0][2] != changes[0][3]) {
                                toastMixin.fire({ title: 'No se puede cambiar la referencia de un material ya creado.', icon: 'warning' });
                                changes[0][3] = changes[0][2]
                            }
                        } else {
                            if (changes[0][3] != '' && changes[0][3].length == 7)
                                cargaDatosMaterialReferencia(changes[0][3], changes[0][0]);
                        }
                        break;
                    case GetColFromName("Tipo de Material"): //tipo de Metal
                    case GetColFromName("Tipo Metal"): //tipo de Metal
                    case GetColFromName("Grado/Calidad"): //grado
                    case GetColFromName("Peso del recubrimiento"): //coating weight

                        if ((changes[0][2] != '' && typeof changes[0][2] !== 'undefined' && changes[0][2] != null) && changes[0][2] != changes[0][3]) //si no era vacio

                            setTimeout(() => {

                                Swal.fire({
                                    title: "¡Aviso!",
                                    text: "Recuerda cambiar la descripción del material, de ser necesario.",
                                    icon: "warning"
                                });
                            }, 700);

                    break;
                }


            });

            //actualiza la configuracion de la tabla para habilitar y deshabilitar campos
            hot.updateSettings({
                cells: function (row, col) {
                    //crea variable para almacenar las propiedaes de la celda
                    var cellProperties = {};

                    //determina si MSA honda es requerido o no
                    let clienteNumero = hot.getDataAtCell(this.row, GetColFromName("Núm. cliente"));
                    if (col === GetColFromName("MSA (Honda)")) {
                        if (clienteNumero != null && clienteNumero != '' && clienteNumero.toUpperCase().includes("HONDA")) {
                            cellProperties.readOnly = false;
                        } else {
                            cellProperties.readOnly = true;
                        }
                    }

                    let nuevoMaterial = hot.getDataAtCell(this.row, GetColFromName("Nuevo Material"));
                    if (col === GetColFromName("Material Existente")) {
                        if (nuevoMaterial != null && nuevoMaterial != '' && nuevoMaterial.toUpperCase().includes("CREACIONREFERENCIA")) {
                            cellProperties.readOnly = false;
                        } else {
                            cellProperties.readOnly = true;
                        }
                    }

                    // Obtén el valor de la columna "Tipo de Material"
                    let tipoMaterial = hot.getDataAtCell(row, GetColFromName("Tipo de Material"));

                    // Determina si la celda de "Posición del Rollo para embarque" debe ser editable o no
                    if (col === GetColFromName("Posición del Rollo para embarque")) {
                        if (tipoMaterial && (tipoMaterial.toUpperCase().includes("ROLLO") || tipoMaterial.toUpperCase().includes("CINTA"))) {
                            cellProperties.readOnly = false; // Hacerla editable
                        } else {
                            cellProperties.readOnly = true; // Hacerla de solo lectura
                        }
                    }

                    // Verificar si la columna es "Piezas Dobles" o "Pzas por Golpe"
                    if (col === GetColFromName("Piezas Dobles") || col === GetColFromName("Pzas por Golpe")) {
                        if (tipoMaterial && (tipoMaterial.toUpperCase().includes("PLATINA") || tipoMaterial.toUpperCase().includes("SHEARING"))) {
                            cellProperties.readOnly = false; // Habilitar edición si el tipo de material es "PLATINA" o "SHEARING"
                        } else {
                            cellProperties.readOnly = true; // Desactivar edición si no se cumple la condición
                        }
                    }

                    // Determina si la celda de "Piezas por auto" debe ser editable o no
                    if (col === GetColFromName("Piezas por auto")) {
                        if (tipoMaterial && (tipoMaterial.toUpperCase().includes("PLATINA") || tipoMaterial.toUpperCase().includes("SHEARING"))) {
                            cellProperties.readOnly = false; // Hacerla editable
                        } else {
                            cellProperties.readOnly = true; // Hacerla de solo lectura
                        }
                    }

                    // Obtener el valor de la columna "Forma"
                    let forma = hot.getDataAtCell(row, GetColFromName("Forma"));

                    // Verificar si la columna es "Trapecio: ángulo A" o "Trapecio: ángulo B"
                    if (col === GetColFromName("Trapecio: ángulo A") || col === GetColFromName("Trapecio: ángulo B")) {
                        if (forma && forma.toLowerCase() === "trapezoide") {
                            cellProperties.readOnly = false; // Habilitar edición si la forma es "Trapezoide"
                        } else {
                            cellProperties.readOnly = true; // Desactivar edición si la forma no es "Trapezoide"
                        }
                    }

                    //aplica el estilo a la celda de scrap
                    if (col === GetColFromName("Scrap permitido (%)")) {
                        cellProperties.readOnly = false;
                        cellProperties.renderer = myPercentage
                    }

                    //retorna las propiedades de la celda
                    return cellProperties;
                },
            });
        }

        //en caso de que se modifique el cliente y ya no sea Honda
        function RestableceMSA(row) {

            let cliente = hot.getDataAtCell(row, GetColFromName("Núm. cliente"));
            if (cliente != null && !cliente.toUpperCase().includes("HONDA")) {
                hot.setDataAtCell(row, GetColFromName("MSA (Honda)"), '', null);
            }
        }

        //en caso de que se modifique el IHS
        function ConcatenaIHS(row, newValue) {

            let spValues = [
                hot.getDataAtCell(row, GetColFromName("S&P 1 (antes IHS)")),
                hot.getDataAtCell(row, GetColFromName("S&P 2 (antes IHS)")),
                hot.getDataAtCell(row, GetColFromName("S&P 3 (antes IHS)")),
                hot.getDataAtCell(row, GetColFromName("S&P 4 (antes IHS)"))
            ];

            // Realiza la llamada AJAX para concatenar los valores IHS
            $.ajax({
                type: 'POST',
                url: '/SCDM_solicitud/ConcatenateIHS',
                data: { spValues: spValues },
                success: function (data) {
                    // Actualiza la celda correspondiente con el valor concatenado
                    hot.setDataAtCell(row, GetColFromName("S&P 5 (antes IHS)"), data.concatenatedIHS);
                },
                error: function () {
                    console.error('Error al concatenar los valores IHS.');
                }
            });

            if (newValue === 'Otros') {

                //determina si el cliente es automotriz
                let cliente = hot.getDataAtCell(row, GetColFromName("Núm. cliente"));

                // Realiza la llamada AJAX para verificar si el cliente es automotriz
                $.ajax({
                    type: 'POST',
                    url: '/SCDM_solicitud/CheckIfClientIsAutomotive',
                    data: { cliente: cliente },
                    success: function (data) {
                        if (data.isAutomotive) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Advertencia',
                                text: 'El valor de S&P no debe ser "Otros" cuando el cliente es de tipo automotriz.',
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    },
                    error: function () {
                        console.error('Error al verificar el tipo de cliente.');
                    }
                });
            }

        }

        function GuardaComentario() {

              let comentario = $('#comentario').val();
              //llamada ajax para obtener el detalle del item  seleccionado
              $.ajax({
                  type: 'POST',
                  url: '/SCDM_solicitud/GuardaComentario',
                  data: { id_solicitud: @Model.id, id_seccion: @((int)Bitacoras.Util.SCDMSeccionesSolicitud.CREACION_REFERENCIA), comentario: comentario },
                  success: function (data) {
                      console.log(data);
                      try {
                          console.log(data[0].resultado);
                          //hot.setDataAtCell(row, GetColFromName("Tipo Material<br>(componente)"), data[0].tipo_material );
                      }
                      catch (error) {
                          Swal.fire({
                              icon: 'error',
                              title: 'Error',
                              text: 'Ocurrió un error al guardar el comentario: ' + error,
                              confirmButtonText: 'Aceptar',
                          })
                      }
                  },
                  async: false
              });
          }
        function EnviaFormulario(salir) {
            hot.validateCells((valid) => {
                if (valid) {

                    // Validación adicional para confirmar campos
                    let validacionExtra = true;
                    for (let row = 0; row < hot.countRows(); row++) {
                        for (let col = 0; col < hot.countCols(); col++) {
                            if (colNecesitaValidacion(headers[col]) && !valorConfirmado(row, headers[col])) {
                                validacionExtra = false;
                                // Resaltar las celdas no confirmadas visualmente
                                hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                            }
                        }
                    }

                    hot.render(); // Re-renderizar para aplicar los estilos

                    if (!validacionExtra) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Atención',
                            text: 'Por favor, confirme todos los campos requeridos antes de continuar.',
                            showCancelButton: true,
                            confirmButtonText: 'Confirmar Campos',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                iniciarConfirmacionCeldas();
                            }
                        });
                        return;
                    }

                    GuardaComentario();
                    // ... code for validated cells
                      $.ajax({
                       type: "POST",
                       dataType: "json",
                       contentType: 'application/json; charset=utf-8',
                       url: '/SCDM_solicitud/EnviaCreacionReferenciaForm?id='+@Model.id,
                       data: JSON.stringify(hot.getData()),
                       success: function (data) {

                           try {

                               let result = data.result == null ? data[0].result : data.result;

                               toastMixin.fire({
                                   icon: data.icon == null ? data[0].icon : data.icon,
                                   title: data.message == null ? data[0].message : data.message
                               });

                               if (salir && result == "OK") {
                                   window.location.href = "../EditarSolicitud/@Model.id?viewUser=@Request.Params["viewUser"] ";
                               }
                               //asigna los ids guardados y modificados
                               for (i = 0; i < data.length; i++) {
                                   if (data[i] != null && data[i].result == "OK") {
                                       hot.setDataAtCell(data[i].fila, 0, data[i].id);
                                   }
                                   else {
                                       //console.log(data[i]);
                                   }
                               }


                           }
                           catch (error) {
                               Swal.fire({
                                   icon: 'error',
                                   title: 'Error',
                                   text: 'Ocurrió un error obteniendo la información: ' + error,
                                   confirmButtonText: 'Aceptar',
                               })
                           }
                       },
                       error: function (textStatus, errorThrown) {
                           //en caso de error en la llamada ajax
                           Swal.fire({
                               icon: 'error',
                               title: 'Ocurrió un error',
                               text: 'Intente nuevamente.'
                           })
                       },
                       async: true
                   });

                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Mensaje',
                        text: 'Para continuar, verifica que no haya celdas marcadas en color rojo.',
                    })
                   // console.log(hot.getData());
                }
            })

        }

        //crea validadores
        function DefineValidadores() {

            //validador número positivos
            (Handsontable => {
                function customValidator(query, callback) {
                    try {
                        let obligatorio = false;
                        let positivo = false;
                        let negativo = false;
                        let cero = false;
                        let forma = hot.getDataAtCell(this.row, GetColFromName("Forma"));
                        let material = hot.getDataAtCell(this.row, GetColFromName("Tipo de Material"));

                       //determina los obligatorios
                        switch (this.col) {
                            case GetColFromName("Peso Bruto (KG)"): //4 decimales
                            case GetColFromName("Peso Neto (KG)"): //4 decimales
                            case GetColFromName("Espesor (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                            case GetColFromName("Ancho (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                                obligatorio = true;
                                break;
                            case GetColFromName("Trapecio: ángulo A"): //2 decimales
                            case GetColFromName("Trapecio: ángulo B"): //2 decimales
                                obligatorio = forma != null && forma == "Trapezoide" ? true : false;
                                break;
                            case GetColFromName("Piezas por auto"): //2 decimales
                            case GetColFromName("Pzas por Golpe"): //2 decimales
                                obligatorio = material && (material.toUpperCase().includes("PLATINA") || material.toUpperCase().includes("SHEARING"));
                                break;
                        }

                        //permite positivos
                        switch (this.col) {
                            case GetColFromName("Peso Bruto (KG)"): //4 decimales
                            case GetColFromName("Peso Neto (KG)"): //4 decimales
                            case GetColFromName("Espesor (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                            case GetColFromName("Ancho (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                            case GetColFromName("Avance (mm)"): //4 decimales
                            case GetColFromName("Tolerancia avance positiva (mm)"): //4 decimales
                            case GetColFromName("Planicidad (mm)"): //4 decimales
                            case GetColFromName("Diametro Exterior"): //4 decimales
                            case GetColFromName("Diametro Interior"): //4 decimales
                            case GetColFromName("Trapecio: ángulo A"): //2 decimales
                            case GetColFromName("Trapecio: ángulo B"): //2 decimales
                            case GetColFromName("Peso bruto REAL bascula (kg)"):
                            case GetColFromName("Peso neto REAL bascula (kg)"):
                            case GetColFromName("Pzas por Golpe"): //0 decimales
                            case GetColFromName("Pzas por paquete"): //0 decimales
                            case GetColFromName("Piezas por auto"): //0 decimales
                            case GetColFromName("Peso Inicial"): //3 decimales
                            case GetColFromName("Peso Min (KG)"): //3 decimales
                            case GetColFromName("Peso Max (KG)"): //3 decimales
                            case GetColFromName("Peso Maximo Tolerancia Positiva"):
                            case GetColFromName("Peso Mínimo Tolerancia Positiva"):

                                positivo = true;
                                break;
                        }

                        //permite negativos
                        switch (this.col) {
                            case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia avance negativa (mm)"): //4 decimales
                            case GetColFromName("Peso Maximo Tolerancia Negativa"):
                            case GetColFromName("Peso Mínimo Tolerancia Negativa"):
                                negativo = true;
                                break;
                        }

                        //permite cero
                        switch (this.col) {
                            case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                            case GetColFromName("Tolerancia avance negativa (mm)"): //4 decimales
                            case GetColFromName("Tolerancia avance positiva (mm)"): //4 decimales
                            case GetColFromName("Peso Inicial"): //3 decimales
                            case GetColFromName("Peso Maximo Tolerancia Negativa"):
                            case GetColFromName("Peso Mínimo Tolerancia Negativa"):
                            case GetColFromName("Peso Maximo Tolerancia Positiva"):
                            case GetColFromName("Peso Mínimo Tolerancia Positiva"):
                            case GetColFromName("Pzas por Golpe"): //0 decimales
                            case GetColFromName("Pzas por paquete"): //0 decimales
                            case GetColFromName("Piezas por auto"): //0 decimales
                                cero = true;
                                break;
                        }


                        //valida tolerancias espesores
                        if (GetColFromName("Espesor (mm)") == this.col || GetColFromName("Tolerancia espesor negativa (mm)") == this.col || GetColFromName("Tolerancia espesor positiva (mm)") == this.col) {
                            let espesor = GetColFromName("Espesor (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Espesor (mm)")));
                            let espesor_negativa = GetColFromName("Tolerancia espesor negativa (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Tolerancia espesor negativa (mm)")));
                            let espesor_positiva = GetColFromName("Tolerancia espesor positiva (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Tolerancia espesor positiva (mm)")));

                            //console.log('Espesor: ' + espesor + ' Neg: ' + espesor_negativa + ' Pos: ' + espesor_positiva)

                            switch (this.col) {
                                case GetColFromName("Espesor (mm)"): //4 decimales
                                    if ((query === null || query==='') && (!isNaN(espesor_negativa) || !isNaN(espesor_positiva))) {
                                        //console.log('Query: ' + query)
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para espesores', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Tolerancia espesor negativa (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor) || !isNaN(espesor_positiva))) {
                                        //console.log('Query: ' + query)
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para espesores', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Tolerancia espesor positiva (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor) || !isNaN(espesor_negativa))) {
                                        //console.log('Query: ' + query)
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para espesores', icon: 'warning' });
                                        return;
                                    }
                                    break;
                            }
                        }

                        //valida talerancia anchos
                        if (GetColFromName("Ancho (mm)") == this.col || GetColFromName("Tolerancia ancho negativa (mm)") == this.col || GetColFromName("Tolerancia ancho positiva (mm)") == this.col) {
                            let espesor = GetColFromName("Ancho (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Ancho (mm)")));
                            let espesor_negativa = GetColFromName("Tolerancia ancho negativa (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Tolerancia ancho negativa (mm)")));
                            let espesor_positiva = GetColFromName("Tolerancia ancho positiva (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Tolerancia ancho positiva (mm)")));

                            //console.log('Espesor: ' + espesor + ' Neg: ' + espesor_negativa + ' Pos: ' + espesor_positiva)

                            switch (this.col) {
                                case GetColFromName("Ancho (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor_negativa) || !isNaN(espesor_positiva))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para ancho', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Tolerancia ancho negativa (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor) || !isNaN(espesor_positiva))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para ancho', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Tolerancia ancho positiva (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor) || !isNaN(espesor_negativa))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para ancho', icon: 'warning' });
                                        return;
                                    }
                                    break;
                            }
                        }

                        //Valida tolerancia avance
                        if (GetColFromName("Avance (mm)") == this.col || GetColFromName("Tolerancia avance negativa (mm)") == this.col || GetColFromName("Tolerancia avance positiva (mm)") == this.col) {
                            let espesor = GetColFromName("Avance (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Avance (mm)")));
                            let espesor_negativa = GetColFromName("Tolerancia avance negativa (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Tolerancia avance negativa (mm)")));
                            let espesor_positiva = GetColFromName("Tolerancia avance positiva (mm)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Tolerancia avance positiva (mm)")));

                            //console.log('Espesor: ' + espesor + ' Neg: ' + espesor_negativa + ' Pos: ' + espesor_positiva)

                            switch (this.col) {
                                case GetColFromName("Avance (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor_negativa) || !isNaN(espesor_positiva))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para avance', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Tolerancia avance negativa (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor) || !isNaN(espesor_positiva))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para avance', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Tolerancia avance positiva (mm)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(espesor) || !isNaN(espesor_negativa))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Valor obligatorio para avance', icon: 'warning' });
                                        return;
                                    }
                                    break;
                            }
                        }

                        //Valida peso bruto y neto
                        if (GetColFromName("Peso Bruto (KG)") == this.col || GetColFromName("Peso Neto (KG)") == this.col ) {
                            let peso_bruto = GetColFromName("Peso Bruto (KG)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Peso Bruto (KG)")));
                            let peso_neto = GetColFromName("Peso Neto (KG)") == this.col ? parseFloat(query) : parseFloat(hot.getDataAtCell(this.row, GetColFromName("Peso Neto (KG)")));


                            switch (this.col) {
                                case GetColFromName("Peso Bruto (KG)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(peso_neto))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Peso Bruto y Peso Neto son obligatorio cuando se indican pesos.', icon: 'warning' });
                                        return;
                                    }
                                    break;
                                case GetColFromName("Peso Neto (KG)"): //4 decimales
                                    if ((query === null || query === '') && (!isNaN(peso_bruto))) {
                                        callback(false);
                                        if (!toastMixin.isVisible())
                                            toastMixin.fire({ title: 'Peso Bruto y Peso Neto son obligatorio cuando se indican pesos.', icon: 'warning' });
                                        return;
                                    }
                                    break;
                            }
                        }


                        //if (GetColFromName("Espesor (mm)") == this.col) {
                        //console.log('obligatorio= ' + obligatorio + ', positivo = ' + positivo+', negativo= '+negativo)
                        //}

                        let num = parseFloat(query);
                        if (!isNaN(query) && num > 0 && positivo || ((query == null || query === '') && !obligatorio) || (num == 0 && cero)) {
                            //valida limite positivos
                            if (this.col == GetColFromName("Espesor (mm)") && (num < .30 || num > 6)) {
                                if (!toastMixin.isVisible()) if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El espesor debe estar entre 0.30 mm y 6.00 mm', icon: 'warning' });
                                callback(false)
                            } else if (this.col == GetColFromName("Ancho (mm)") && num > 2150) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El ancho no puede ser mayor a 2150 mm', icon: 'warning' });
                                callback(false)
                            }
                            else {
                                callback(true);
                            }
                        } else if (!isNaN(query) && num < 0 && negativo || ((query == null || query === '') && !obligatorio) || (num == 0 && cero)) {
                            //aqui se validarian los limites en negativos
                            //if (this.col == GetColFromName("Espesor (mm)") &&   num <-3) {
                            //    toastMixin.fire({ title: 'El espesor no debe ser menor a  -0.30 mm', icon: 'warning' });
                            //    callback(false)
                            //} else{callback(true);}
                            callback(true);
                        }
                        else {
                            //console.log('num: ' + num + ' cero: ' + cero+ ' ')
                            if (num == 0 && cero)
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'Ingrese un número válido.', icon: 'warning' });
                            if (positivo && !negativo)
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'Sólo se permiten números positivos.', icon: 'warning' });
                            if (!positivo && negativo)
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'Sólo se permiten números negativos.', icon: 'warning' });

                            callback(false);
                        }

                        //valida peso neto
                        if (GetColFromName("Peso Neto (KG)") == this.col) {
                            let peso_bruto = parseFloat(hot.getDataAtCell(this.row, GetColFromName("Peso Bruto (KG)")));
                            let peso_neto = parseFloat(query);

                            if (isNaN(peso_bruto))
                                peso_bruto = 0;
                            if (isNaN(peso_neto))
                                peso_neto = 0;

                            if (peso_neto > peso_bruto && (!isNaN(parseFloat(hot.getDataAtCell(this.row, GetColFromName("Peso Bruto (KG)")))))) {
                                if (!toastMixin.isVisible())
                                    toastMixin.fire({ title: 'El peso neto debe ser menor o igual al peso bruto.', icon: 'warning' });
                                callback(false);
                            }
                        }

                        //valida que las tolerancia  de espesores no mayores a espesores
                        if (this.col == GetColFromName("Tolerancia espesor negativa (mm)") || this.col == GetColFromName("Tolerancia espesor positiva (mm)")) {
                            let espesor = parseFloat(hot.getDataAtCell(this.row, GetColFromName("Espesor (mm)")));
                            if (!Number.isNaN(espesor) && espesor != null && espesor != '' && Math.abs(num) >= espesor) {
                                toastMixin.fire({ title: 'La tolerancia debe ser menor al espesor.', icon: 'warning' });
                                callback(false)
                            }
                        }

                    } catch (error) {
                        console.log('error al validar numero: ' + error)
                        callback(false);
                    }
                }

                // Register an alias
                Handsontable.validators.registerValidator('CustomNumbersValidator', customValidator);

            })(Handsontable);



            //validador porcentaje 0-100
            (Handsontable => {
                function customValidator(query, callback) {
                    try {
                        let num = parseFloat(query);
                        if (!isNaN(query) && num >= 0 && num <= 100 /*|| (query == null || query == '')*/)
                            callback(true);
                        else {
                            callback(false);
                            //toastMixin.fire({ title: 'Valide que el número ingresado se encuentre entre 0% - 100%.', icon: 'warning' });
                        }
                    } catch (error) {
                        console.log('error al validar porcentaje: ' + error)
                        callback(false);
                    }
                }

                // Register an alias
                Handsontable.validators.registerValidator('percentageNumbers', customValidator);

            })(Handsontable);


        }

        //render para porcentaje
        function myPercentage(instance, td, row, col, prop, value, cellProperties) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            //console.log(value)
            if (!isNaN(value) && value != null && value != '') {
                td.innerHTML = `${value} %`
            }

        }


        function cargaDatosMaterialReferencia(material, row) {
            //llamada ajax para obtener el detalle del item  seleccionado
           let plantaSapSolicitud = '@Html.Raw(String.Join(", ", @Model.SCDM_rel_solicitud_plantas.Select(x => x.plantas.codigoSap).Distinct().ToList()))'
           $.ajax({
               type: 'POST',
               url: '/SCDM_solicitud/ObtieneValoresMaterialReferencia',
               data: { material: material, plantaSolicitud: plantaSapSolicitud },
               success: function (data) {
                   try {
                       console.log(data[0]);
                       if (data[0].existe == "1") {

                           hot.setDataAtCell(row, GetColFromName("Núm. antigüo material"), data[0].numero_antiguo_material);
                           hot.setDataAtCell(row, GetColFromName("Peso Bruto (KG)"), data[0].peso_bruto);
                           hot.setDataAtCell(row, GetColFromName("Peso Neto (KG)"), data[0].peso_neto);
                           hot.setDataAtCell(row, GetColFromName("Unidad Base Medida"), data[0].unidad_base_medida);
                           hot.setDataAtCell(row, GetColFromName("Commodity"), data[0].commodity);
                           hot.setDataAtCell(row, GetColFromName("Grado/Calidad"), data[0].grado);
                           hot.setDataAtCell(row, GetColFromName("Espesor (mm)"), data[0].espesor);
                           hot.setDataAtCell(row, GetColFromName("Tolerancia espesor negativa (mm)"), data[0].espesor_min);
                           hot.setDataAtCell(row, GetColFromName("Tolerancia espesor positiva (mm)"), data[0].espesor_max);
                           hot.setDataAtCell(row, GetColFromName("Ancho (mm)"), data[0].ancho);
                           hot.setDataAtCell(row, GetColFromName("Tolerancia ancho negativa (mm)"), data[0].ancho_min);
                           hot.setDataAtCell(row, GetColFromName("Tolerancia ancho positiva (mm)"), data[0].ancho_max);
                           hot.setDataAtCell(row, GetColFromName("Avance (mm)"), data[0].avance);
                           hot.setDataAtCell(row, GetColFromName("Tolerancia avance negativa (mm)"), data[0].avance_min);
                           hot.setDataAtCell(row, GetColFromName("Tolerancia avance positiva (mm)"), data[0].avance_max);
                           hot.setDataAtCell(row, GetColFromName("Planicidad (mm)"), data[0].planicidad);
                           hot.setDataAtCell(row, GetColFromName("Superficie"), data[0].superficie);
                           hot.setDataAtCell(row, GetColFromName("Tratamiento Superficial"), data[0].tratamiento_superficial);
                           hot.setDataAtCell(row, GetColFromName("Peso del recubrimiento"), data[0].peso_recubrimiento);
                           hot.setDataAtCell(row, GetColFromName("Nombre Molino"), data[0].molino);
                           hot.setDataAtCell(row, GetColFromName("Forma"), data[0].forma);
                           hot.setDataAtCell(row, GetColFromName("Núm. cliente"), data[0].cliente);
                           hot.setDataAtCell(row, GetColFromName("Núm. parte del cliente"), data[0].numero_parte_cliente);
                           hot.setDataAtCell(row, GetColFromName("MSA (Honda)"), data[0].msa);
                           hot.setDataAtCell(row, GetColFromName("Diametro Exterior"), data[0].diametro_exterior);
                           hot.setDataAtCell(row, GetColFromName("Diametro Interior"), data[0].diametro_interior);
                           hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), data[0].descripcion_es);
                           hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), data[0].descripcion_en);
                           hot.setDataAtCell(row, GetColFromName("Tipo Metal"), data[0].tipo_metal);
                           hot.setDataAtCell(row, GetColFromName("Tipo de Material"), data[0].tipo_material);
                           hot.setDataAtCell(row, GetColFromName("Selling Type (Budget)"), data[0].type_selling);
                           hot.setDataAtCell(row, GetColFromName("Planta"), data[0].planta_string);
                           //nuevos datos
                           hot.setDataAtCell(row, GetColFromName("Posición del Rollo para embarque"), data[0].posicionRollo);
                           hot.setDataAtCell(row, GetColFromName("Modelo de negocio"), data[0].modelo_negocio);
                           hot.setDataAtCell(row, GetColFromName("Peso bruto REAL bascula (kg)"), data[0].peso_bruto_real_bascula);
                           hot.setDataAtCell(row, GetColFromName("Peso neto REAL bascula (kg)"), data[0].peso_neto_real_bascula);
                           hot.setDataAtCell(row, GetColFromName("Trapecio: ángulo A"), data[0].angulo_a);
                           hot.setDataAtCell(row, GetColFromName("Trapecio: ángulo B"), data[0].angulo_b);
                           hot.setDataAtCell(row, GetColFromName("Scrap permitido (%)"), data[0].scrap_permitido_puntas_colas);
                           hot.setDataAtCell(row, GetColFromName("Piezas Dobles"), data[0].piezas_dobles);
                           hot.setDataAtCell(row, GetColFromName("Reaplicación"), data[0].reaplicacion);
                           hot.setDataAtCell(row, GetColFromName("Req. conciliación Puntas y colas"), data[0].conciliacion_puntas_colas);
                           hot.setDataAtCell(row, GetColFromName("Conciliacion Scrap Ingeniería"), data[0].conciliacion_scrap_ingenieria);
                           hot.setDataAtCell(row, GetColFromName("S&P 1 (antes IHS)"), data[0].ihs_1);
                           hot.setDataAtCell(row, GetColFromName("S&P 2 (antes IHS)"), data[0].ihs_2);
                           hot.setDataAtCell(row, GetColFromName("S&P 3 (antes IHS)"), data[0].ihs_3);
                           hot.setDataAtCell(row, GetColFromName("S&P 4 (antes IHS)"), data[0].ihs_4);
                           hot.setDataAtCell(row, GetColFromName("S&P 5 (antes IHS)"), data[0].ihs_5);
                           hot.setDataAtCell(row, GetColFromName("Piezas por auto"), data[0].piezas_por_auto);
                           hot.setDataAtCell(row, GetColFromName("Pzas por Golpe"), data[0].piezas_por_golpe);
                           hot.setDataAtCell(row, GetColFromName("Pzas por paquete"), data[0].piezas_por_paquete);
                           hot.setDataAtCell(row, GetColFromName("Peso Inicial"), data[0].peso_inicial);
                           hot.setDataAtCell(row, GetColFromName("Peso Max (KG)"), data[0].peso_maximo);
                           hot.setDataAtCell(row, GetColFromName("Peso Maximo Tolerancia Positiva"), data[0].peso_maximo_tolerancia_positiva);
                           hot.setDataAtCell(row, GetColFromName("Peso Maximo Tolerancia Negativa"), data[0].peso_maximo_tolerancia_negativa);
                           hot.setDataAtCell(row, GetColFromName("Peso Min (KG)"), data[0].peso_minimo);
                           hot.setDataAtCell(row, GetColFromName("Peso Mínimo Tolerancia Positiva"), data[0].peso_minimo_tolerancia_positiva);
                           hot.setDataAtCell(row, GetColFromName("Peso Mínimo Tolerancia Negativa"), data[0].peso_minimo_tolerancia_negativa);


                           if (data[0].planta == plantaSapSolicitud) {
                               toastMixin.fire({ title: 'Se cargaron los datos correctamente', icon: 'success' });
                               hot.setDataAtCell(row, GetColFromName("Valido"), "true");

                               setTimeout(() => {
                                   hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), data[0].descripcion_es);
                                   hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), data[0].descripcion_en);
                                   hot.setDataAtCell(row, GetColFromName("Descripción ES (Original)"), data[0].descripcion_es);
                                   hot.setDataAtCell(row, GetColFromName("Descripción EN (Original)"), data[0].descripcion_en);

                                   //llama metodo para concatenar IHS
                                   ConcatenaIHS(row, '');

                               }, 500);

                           } else {
                             //  toastMixin.fire({ title: 'El material de referencia no corresponde con la planta de la solicitud: '+ data[0].planta+ ' != '+'@Html.Raw(String.Join(", ", @Model.SCDM_rel_solicitud_plantas.Select(x => x.plantas.codigoSap).Distinct().ToList()))', icon: 'warning' });
                               Swal.fire({
                                   //title: "Good job!",
                                   html: 'El material de referencia no corresponde con la planta de la solicitud: Referencia: '+ data[0].planta+ '; Solicitud: '+'@Html.Raw(String.Join(", ", @Model.SCDM_rel_solicitud_plantas.Select(x => x.plantas.codigoSap).Distinct().ToList()))<br/>Seleccione un material válido para continuar.',
                                   icon: "warning"
                               });
                               hot.setDataAtCell(row, GetColFromName("Valido"), "falso");
                           }

                       } else {
                           toastMixin.fire({ title: 'No se encontró el material de referencia.', icon: 'warning' });
                           hot.setDataAtCell(row, GetColFromName("Valido"), "falso");
                       }
                   }
                   catch (error) {
                       Swal.fire({
                           icon: 'error',
                           title: 'Error',
                           text: 'Ocurrió un error obteniendo la información: ' + error,
                           confirmButtonText: 'Aceptar',
                       })
                       hot.setDataAtCell(row, GetColFromName("Valido"), "falso");

                   }
               },
               error: function (errorMsg) {
                   //Execute this function when the request fails
                   Swal.fire({
                       icon: 'error',
                       text: 'Ocurrió un error al obtener la información.',
                   })
               },
               async: false
           });
        }

        function CambioDimensiones(row) {

            let descripcionES = hot.getDataAtCell(row, GetColFromName("Descripción (ES)"))
            let descripcionEN = hot.getDataAtCell(row, GetColFromName("Descripción (EN)"))


            if (descripcionES != null && descripcionEN != null) {

                let dimensionesES = reemplazaDimension(descripcionES, row);
                let dimensionesEN = reemplazaDimension(descripcionEN, row);

                //español
               hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), dimensionesES);
                //ingles
                hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), dimensionesEN);
            }
        }

        function reemplazaDimension(text, row) {
            //variables
            let espesor = hot.getDataAtCell(row, GetColFromName("Espesor (mm)"));
            let ancho = hot.getDataAtCell(row, GetColFromName("Ancho (mm)"));
            let avance = hot.getDataAtCell(row, GetColFromName("Avance (mm)"));


            //obtener el simbolo X o x
            let charx = "x";
            let charX = "X";
            let charResult = "";
            let index_x = text.indexOf(charx);
            let index_X = text.indexOf(charX);

            //si no se encuentra asigna un valor alto
            if (index_x < 0)
                index_x = 99;
            if (index_X < 0)
                index_X = 99;

            if (index_x < index_X)
                charResult = charx;
            if (index_X < index_x)
                charResult = charX;



            let codingRegex = /[(?<=^| )\d+(\.\d+)?(?=$| )]{1,9}[X|x][(?<=^| )\d+(\.\d+)?(?=$| )]{1,9}[X|x]*[(?<=^| )\d+(\.\d+)?(?=$| )]*/;
            let result = text.match(codingRegex);


            if (result != null) {
                let parteDimensiones = result[0].trim();

                //divide en partes
                const dimensionesArray = parteDimensiones.split(charResult);


                //identifica la dimension y susutituye
                if (dimensionesArray.length >= 1 && Number(espesor) != Number(dimensionesArray[0]))
                    dimensionesArray[0] = espesor;
                if (dimensionesArray.length >= 2 && Number(ancho) != Number(dimensionesArray[1]))
                    dimensionesArray[1] = ancho;
                if (dimensionesArray.length >= 3 && Number(avance) != Number(dimensionesArray[2]))
                    dimensionesArray[2] = avance;

                let nuevaDimensiones = dimensionesArray.join(charResult);
                //console.log("|"+parteDimensiones+"|")
                //console.log("|" + nuevaDimensiones + "|")

                return text.replace(parteDimensiones, nuevaDimensiones);
            } else {
                return text;
            }
        }


        function cambioDescripcion(row) {


            let tipoMaterial = hot.getDataAtCell(row, GetColFromName("Tipo de Material"));

            let espesor = hot.getDataAtCell(row, GetColFromName("Espesor (mm)"));
            let ancho = hot.getDataAtCell(row, GetColFromName("Ancho (mm)"));
            let avance = hot.getDataAtCell(row, GetColFromName("Avance (mm)"));
            let grado = hot.getDataAtCell(row, GetColFromName("Grado/Calidad"));
            let exp = hot.getDataAtCell(row, GetColFromName("Tipo Metal"));
            let peso_recubrimiento = hot.getDataAtCell(row, GetColFromName("Peso del recubrimiento"));
            let clienteNumero = hot.getDataAtCell(row, GetColFromName("Núm. cliente"));

            if (grado != null)
                grado = grado.toUpperCase();

            if (espesor == null || espesor == '')
                espesor = 0;
            if (ancho == null || ancho == '')
                ancho = 0;
            if (grado == null)
                grado = '';


            switch (tipoMaterial) {
                case "ROLLO":
                    if ((clienteNumero != null && clienteNumero.toUpperCase().includes("HONDA"))) {

                        let t = '';
                        let p = '';
                        if (exp != null && exp.toUpperCase().includes("NO EXPUESTO"))
                            t = "NOEX"
                        else if (exp != null && exp.toUpperCase().includes("EXPUESTO"))
                            t = "EX"
                        if (peso_recubrimiento != null && peso_recubrimiento != '')
                            p = ' ' + peso_recubrimiento.toUpperCase();


                        //español
                        hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), `${espesor}X${ancho} ROL (${t} ${grado}${p})`);
                        //ingles
                        hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), `${espesor}X${ancho} COI (${t} ${grado}${p})`);
                    } else {
                        //español
                        hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), `${espesor}X${ancho} ROL (${grado})`);
                        //ingles
                        hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), `${espesor}X${ancho} COI (${grado})`);
                    }
                        //muestra el toast
                    if (!toastMixin.isVisible()) {
                        toastMixin.fire({ title: 'Se calculó la descripción automáticamente. Favor de verificar.', icon: 'info' });
                    }
                    break;
                case "CINTA":
                    // DEscripción para Honda
                    if ((clienteNumero != null && clienteNumero.toUpperCase().includes("HONDA"))) {

                        let t = '';
                        let p = '';
                        if (exp != null && exp.toUpperCase().includes("NO EXPUESTO"))
                            t = "NOEX"
                        else if (exp != null && exp.toUpperCase().includes("EXPUESTO"))
                            t = "EX"
                        if (peso_recubrimiento != null && peso_recubrimiento != '')
                            p = ' ' + peso_recubrimiento.toUpperCase();


                        //español
                        hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), `${espesor}X${ancho} CIN (${t} ${grado}${p})`);
                        //ingles
                        hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), `${espesor}X${ancho} SLT (${t} ${grado}${p})`);
                    } else {
                        //español
                        hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), `${espesor}X${ancho} CIN (${grado})`);
                        //ingles
                        hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), `${espesor}X${ancho} SLT (${grado})`);
                    }
                    //muestra el toast
                    if (!toastMixin.isVisible()) {
                        toastMixin.fire({ title: 'Se calculó la descripción automáticamente. Favor de verificar.', icon: 'info' });
                    }
                    break;
                case "PLATINA":
                case "SHEARING":
                case "PLATINA SOLDADA":
                    let tipoES = '';
                    let tipoEN = '';

                    switch (tipoMaterial) {
                        case "PLATINA":
                            tipoES = 'PLA';
                            tipoEN = 'BLK';
                            break;
                        case "SHEARING":
                            tipoES = 'SHR';
                            tipoEN = 'SHR';
                            break;
                        case "PLATINA SOLDADA":
                            tipoES = 'PLS';
                            tipoEN = 'WLD';
                            break;
                        case "BARRENO":
                            tipoES = 'BAR';
                            tipoEN = 'BAR';
                            break;
                    }

                    // DEscripción para Honda
                    if ((clienteNumero != null && clienteNumero.toUpperCase().includes("HONDA"))) {

                        let t = '';
                        let p = '';
                        if (exp != null && exp.toUpperCase().includes("NO EXPUESTO"))
                            t = "NOEX"
                        else if (exp != null && exp.toUpperCase().includes("EXPUESTO"))
                            t = "EX"
                        if (peso_recubrimiento != null && peso_recubrimiento != '')
                            p = ' '+peso_recubrimiento.toUpperCase();

                        //español
                        hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), `${espesor}X${ancho}X${avance} ${tipoES} (${t} ${grado}${p})`);
                        //ingles
                        hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), `${espesor}X${ancho}X${avance} ${tipoEN} (${t} ${grado}${p})`);
                    } else {
                        //español
                        hot.setDataAtCell(row, GetColFromName("Descripción (ES)"), `${espesor}X${ancho}X${avance} ${tipoES} (${grado})`);
                        //ingles
                        hot.setDataAtCell(row, GetColFromName("Descripción (EN)"), `${espesor}X${ancho}X${avance} ${tipoEN} (${grado})`);
                    }

                    //muestra el toast
                    if (!toastMixin.isVisible()) {
                        toastMixin.fire({ title: 'Se calculó la descripción automáticamente. Favor de verificar.', icon: 'info' });
                    }

                    break;
                case "C&B":
                    //do nothing
                    //console.log("C&B")
                    break;

            }



        }

        function cargaDatosIniciales() {

             //llamada ajax para obtener el detalle del item  seleccionado
                $.ajax({
                    type: 'POST',
                    url: '/SCDM_solicitud/CargaCreacionReferencia',
                    data: { id_solicitud: @Model.id},
                    success: function (data) {
                        try {
                            console.log(data);
                            hot.loadData(data);

                            // Aplicar clase 'celdaSinConfirmar' a las celdas que requieren confirmación
                            const totalRows = hot.countRows();
                            const totalCols = hot.countCols();

                            for (let row = 0; row < totalRows; row++) {
                                for (let col = 0; col < totalCols; col++) {
                                    const header = headers[col];

                                    // Verifica si el encabezado de la columna está en la lista de columnas que requieren validación
                                    if (columnasQueNecesitanValidacion.includes(header)) {
                                        hot.setCellMeta(row, col, 'className', 'celdaSinConfirmar');
                                    }
                                }
                            }
                            // Renderizar la tabla nuevamente para aplicar los cambios visuales
                            hot.render();

                        }
                        catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Ocurrió un error obteniendo la información: ' + error,
                                confirmButtonText: 'Aceptar',
                            })
                        }
                    },
                    error: function (errorMsg) {
                        //Execute this function when the request fails
                        Swal.fire({
                            icon: 'error',
                            text: 'Ocurrió un error al obtener la información.',
                        })
                    },
                    async: false
                });
        }


           function ValidaNumeroMaterial() {
               //valida nuevamente los numero material
               for (var i = 0; i < hot.countRows(); i++) {
                   let valorActual = hot.getDataAtCell(i, GetColFromName("Nuevo Material"));

                   if (valorActual == null || valorActual.includes("CreacionReferencia"))
                       hot.setDataAtCell(i, GetColFromName("Nuevo Material"), "CreacionReferencia" + (i + 1));
               }
            }

        function insertaFila() {
            var col = hot.countRows();
            hot.alter('insert_row_below', col, 1);
            hot.setDataAtCell(col, GetColFromName("Planta"), "@Html.Raw(String.Join(", ", @Model.SCDM_rel_solicitud_plantas.Select(x => x.plantas.ConcatPlantaSap).Distinct().ToList()))");

            // Aplicar la clase 'celdaSinConfirmar' a las celdas de la nueva fila que necesitan confirmación
            const totalCols = hot.countCols();
            const rowIndex = col; // La nueva fila agregada es la última

            for (let colIndex = 0; colIndex < totalCols; colIndex++) {
                const header = hot.getColHeader(colIndex);
                if (colNecesitaValidacion(header)) {
                    hot.setCellMeta(rowIndex, colIndex, 'className', 'celdaSinConfirmar');
                }
            }
            hot.render(); // Re-renderizar para aplicar los estilos a la nueva fila
        }

        function GetColFromName(name) {
            var n_cols = headers.length;
            var i = 1;

            for (i = 1; i <= n_cols; i++) {
                if (headers[i] === undefined) {
                    console.log(headers[i] + ' - ' + name)
                }
                if (name.toLowerCase() == headers[i].toLowerCase()) {
                    return i;
                }
            }
            return -1; //return -1 if nothing can be found
        }

        function borrarFila() {

            let seleccion = hot.getSelectedLast();

            if (typeof seleccion === 'undefined') {
                toastMixin.fire({ title: 'No se detectó ninguna fila seleccionada.', icon: 'warning' });
            } else {
                let filaSeleccionada = seleccion[0];

                if (seleccion[0] == -1)
                    toastMixin.fire({ title: 'Seleccione sólo una celda.', icon: 'warning' });
                else {

                    Swal.fire({
                        title: "¿Quieres borrar la fila #" + (filaSeleccionada + 1) + " ?",
                        showDenyButton: true,
                        confirmButtonText: "Borrar",
                        denyButtonText: `Cancelar`
                    }).then((result) => {
                        /* Read more about isConfirmed, isDenied below */
                        if (result.isConfirmed) {

                            let valorActual = hot.getDataAtCell(filaSeleccionada, GetColFromName("Nuevo Material"));

                            if (valorActual != null && !valorActual.includes("CreacionReferencia")) {
                                toastMixin.fire({ title: 'No se puede eliminar un material que ya ha sido creado: ' + valorActual, icon: 'warning' });
                                return false;
                            } else {
                                hot.alter('remove_row', filaSeleccionada);
                                hot.deselectCell()
                                toastMixin.fire({ title: 'Fila borrada.', icon: 'success' });
                            }
                        }

                    });
                }
            }

        }

        $(window).resize(function () {
            hot.render();
        });


    </script>

}
